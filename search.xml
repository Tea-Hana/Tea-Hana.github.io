<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Scala学习笔记</title>
      <link href="/2022/03/13/scala-xue-xi-bi-ji/"/>
      <url>/2022/03/13/scala-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://www.runoob.com/scala/scala-intro.html">scala菜鸟教程</a></p></blockquote><h2 id="1-1-Scala特性"><a href="#1-1-Scala特性" class="headerlink" title="1.1 Scala特性"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_11-scala%E7%89%B9%E6%80%A7">1.1 Scala特性</a></h2><h3 id="1-1-1-面向对象特性"><a href="#1-1-1-面向对象特性" class="headerlink" title="1.1.1 面向对象特性"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_111-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%89%B9%E6%80%A7">1.1.1 面向对象特性</a></h3><p> <strong>Scala是一种纯面向对象的语言，每个值都是对象</strong>。对象的数据类型以及行为由类和特质描述。</p><p> 类抽象机制的扩展有两种途径：一种途径是子类继承，另一种途径是灵活的混入机制。这两种途径能避免多重继承的种种问题。</p><h3 id="1-1-2-函数式编程"><a href="#1-1-2-函数式编程" class="headerlink" title="1.1.2 函数式编程"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_112-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B">1.1.2 函数式编程</a></h3><p> <strong>Scala也是一种函数式语言，其函数也能当成值来使用</strong>。Scala提供了轻量级的语法用以定义匿名函数，支持高阶函数，允许嵌套多层函数，并支持柯里化。Scala的case class及其内置的模式匹配相当于函数式编程语言中常用的代数类型。</p><p> 更进一步，程序员可以利用Scala的模式匹配，编写类似正则表达式的代码处理XML数据。</p><h3 id="1-1-3-静态类型"><a href="#1-1-3-静态类型" class="headerlink" title="1.1.3 静态类型"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_113-%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B">1.1.3 静态类型</a></h3><p><strong>Scala具备类型系统，通过编译时检查，保证代码的安全性和一致性</strong>。类型系统具体支持以下特性：</p><ul><li>  泛型类</li><li>  协变和逆变</li><li>  标注</li><li>  类型参数的上下限约束</li><li>  把类别和抽象类型作为对象成员</li><li>  复合类型</li><li>  引用自己时显式指定类型</li><li>  视图</li><li>  多态方法</li></ul><h3 id="1-1-4-扩展性"><a href="#1-1-4-扩展性" class="headerlink" title="1.1.4 扩展性"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_114-%E6%89%A9%E5%B1%95%E6%80%A7">1.1.4 扩展性</a></h3><p> Scala的设计秉承一项事实，即在实践中，某个领域特定的应用程序开发往往需要特定于该领域的语言扩展。Scala提供了许多独特的语言机制，可以以库的形式轻易无缝添加新的语言结构：</p><ul><li>  <strong>任何方法可用作前缀或后缀操作符</strong></li><li>  <strong>可以根据预期类型自动构造闭包</strong></li></ul><h3 id="1-1-5-并发性"><a href="#1-1-5-并发性" class="headerlink" title="1.1.5 并发性"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_115-%E5%B9%B6%E5%8F%91%E6%80%A7">1.1.5 并发性</a></h3><blockquote><p><a href="https://www.jianshu.com/p/d803e2a7de8e">Actor模型</a></p></blockquote><p> <strong>Scala使用Actor作为其并发模型，Actor是类似线程的实体，通过邮箱发收消息</strong>。</p><p> <strong>Actor可以复用线程，因此可以在程序中可以使用数百万个Actor,而线程只能创建数千个</strong>。</p><p> 在2.10之后的版本中，使用Akka作为其默认Actor实现。</p><h2 id="1-2-谁使用了Scala"><a href="#1-2-谁使用了Scala" class="headerlink" title="1.2 谁使用了Scala"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_12-%E8%B0%81%E4%BD%BF%E7%94%A8%E4%BA%86scala">1.2 谁使用了Scala</a></h2><ul><li>  2009年4月，Twitter宣布他们已经把大部分后端程序从Ruby迁移到Scala，其余部分也打算要迁移。</li><li>  此外，Wattzon已经公开宣称，其整个平台都已经是基于Scala基础设施编写的。</li><li>  瑞银集团把Scala用于一般产品中。</li><li>  Coursera把Scala作为服务器语言使用。</li></ul><h2 id="1-3-Scala-Web-框架"><a href="#1-3-Scala-Web-框架" class="headerlink" title="1.3 Scala Web 框架"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_13-scala-web-%E6%A1%86%E6%9E%B6">1.3 Scala Web 框架</a></h2><p>以下列出了两个目前比较流行的 Scala 的 Web应用框架：</p><ul><li>  <a href="http://liftweb.net/">Lift 框架</a></li><li>  <a href="http://www.playframework.org/">Play 框架</a></li></ul><p> Scala 与 Java 的最大区别是：Scala 语句末尾的分号 ; 是可选的。</p><p> 我们可以认为 Scala 程序是对象的集合，通过调用彼此的方法来实现消息传递。接下来我们来理解下，类，对象，方法，实例变量的概念：</p><ul><li>  <strong>对象 -</strong> 对象有属性和行为。例如：一只狗的属性有：颜色，名字，行为有：叫、跑、吃等。对象是一个类的实例。</li><li>  <strong>类 -</strong> 类是对象的抽象，而对象是类的具体实例。</li><li>  <strong>方法 -</strong> 方法描述的基本的行为，一个类可以包含多个方法。</li><li>  <strong>字段 -</strong> 每个对象都有它唯一的实例变量集合，即字段。对象的属性通过给字段赋值来创建。</li></ul><h2 id="2-1-Scala编程"><a href="#2-1-Scala编程" class="headerlink" title="2.1 Scala编程"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_21-scala%E7%BC%96%E7%A8%8B">2.1 Scala编程</a></h2><h3 id="2-1-1-交互式编程"><a href="#2-1-1-交互式编程" class="headerlink" title="2.1.1 交互式编程"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_211-%E4%BA%A4%E4%BA%92%E5%BC%8F%E7%BC%96%E7%A8%8B">2.1.1 交互式编程</a></h3><p>交互式编程不需要创建脚本文件，可以通过以下命令调用：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalaWelcome to Scala version <span class="token number">2.11</span><span class="token number">.7</span> <span class="token punctuation">(</span>Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span><span class="token operator">-</span>Bit Server VM<span class="token punctuation">,</span> Java <span class="token number">1.8</span><span class="token number">.0</span>_31<span class="token punctuation">)</span><span class="token punctuation">.</span>Type in expressions to <span class="token namespace">have</span> them evaluated<span class="token punctuation">.</span>Type <span class="token operator">:</span>help <span class="token keyword">for</span> more information<span class="token punctuation">.</span>scala<span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span>res0<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">2</span>scala<span class="token operator">&gt;</span> println<span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span>Hello World<span class="token operator">!</span>scala<span class="token operator">&gt;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-1-2-脚本形式"><a href="#2-1-2-脚本形式" class="headerlink" title="2.1.2 脚本形式"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_212-%E8%84%9A%E6%9C%AC%E5%BD%A2%E5%BC%8F">2.1.2 脚本形式</a></h3><p>我们也可以通过创建一个 HelloWorld.scala 的文件来执行代码，HelloWorld.scala 代码如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> HelloWorld <span class="token punctuation">{</span>  <span class="token comment">/* 这是我的第一个 Scala 程序    * 以下程序将输出'Hello World!'     */</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span> <span class="token comment">// 输出 Hello World</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来我们使用 scalac 命令编译它：(试了一下，确实是生成两个<code>.class</code>文件)</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac HelloWorld<span class="token punctuation">.</span>scala $ lsHelloWorld$<span class="token punctuation">.</span><span class="token keyword">class</span>    HelloWorld<span class="token punctuation">.</span>scalaHelloWorld<span class="token punctuation">.</span><span class="token keyword">class</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>编译后我们可以看到目录下生成了 HelloWorld.class 文件，<strong>该文件可以在Java Virtual Machine (JVM)上运行</strong>。编译后，我们可以使用以下命令来执行程序：(试了下<code>scala HelloWorld$</code>会报错)</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scala HelloWorldHello<span class="token punctuation">,</span> world<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="2-2-基本语法"><a href="#2-2-基本语法" class="headerlink" title="2.2 基本语法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_22-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95">2.2 基本语法</a></h2><p>Scala 基本语法需要注意以下几点：</p><ul><li><p><strong>区分大小写</strong> - Scala是大小写敏感的，这意味着标识Hello 和 hello在Scala中会有不同的含义。</p></li><li><p><strong>类名</strong> - 对于所有的类名的第一个字母要大写。 如果需要使用几个单词来构成一个类的名称，每个单词的第一个字母要大写。</p><p>示例：<em>class MyFirstScalaClass</em></p></li><li><p><strong>方法名称</strong> - 所有的方法名称的第一个字母用小写。 如果若干单词被用于构成方法的名称，则每个单词的第一个字母应大写。</p><p>示例：<em>def myMethodName()</em></p></li><li><p><strong>程序文件名</strong> - 程序文件的名称应该与对象名称完全匹配(新版本不需要了，但建议保留这种习惯)。 保存文件时，应该保存它使用的对象名称（记住Scala是区分大小写），并追加”.scala”为文件扩展名。 （如果文件名和对象名称不匹配，程序将无法编译）。</p><p>示例: 假设”HelloWorld”是对象的名称。那么该文件应保存为’HelloWorld.scala”</p></li><li><p><strong>def main(args: Array[String])</strong> - Scala程序从main()方法开始处理，这是每一个Scala程序的强制程序入口部分。</p></li></ul><h2 id="2-3-标识符"><a href="#2-3-标识符" class="headerlink" title="2.3 标识符"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_23-%E6%A0%87%E8%AF%86%E7%AC%A6">2.3 标识符</a></h2><p>Scala 可以使用两种形式的标志符，字符数字和符号。</p><p>字符数字使用字母或是下划线开头，后面可以接字母或是数字，符号”$”在 Scala 中也看作为字母。</p><p><strong>然而以”$”开头的标识符为保留的 Scala 编译器产生的标志符使用，应用程序应该避免使用”$”开始的标识符，以免造成冲突</strong>。</p><p>Scala 的命名规则采用和 Java 类似的 camel 命名规则，首字符小写，比如 toString。类名的首字符还是使用大写。此外也应该<strong>避免使用以下划线结尾的标志符以避免冲突</strong>。符号标志符包含一个或多个符号，如+，:，? 等，比如:</p><pre class="line-numbers language-none"><code class="language-none">+ ++ ::: &lt; ?&gt; :-&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>Scala 内部实现时会使用转义的标志符，比如:-&gt; 使用 $colon$minus$greater 来表示这个符号。因此如果你需要在 Java 代码中访问:-&gt;方法，你需要使用 Scala 的内部名称 $colon$minus$greater。</strong> </p><p>混合标志符由字符数字标志符后面跟着一个或多个符号组成，比如 unary_+ 为 Scala 对+方法的内部实现时的名称。字面量标志符为使用”定义的字符串，比如 <code>`x`</code> , <code>`yield`</code>。</p><p><strong>你可以在”之间使用任何有效的 Scala 标志符，Scala 将它们解释为一个 Scala 标志符</strong>，一个典型的使用为 Thread 的 yield 方法， 在 Scala 中你不能使用 Thread.yield()是因为 yield 为 Scala 中的关键字， 你必须使用 Thread.<code>`yield`</code>()来使用这个方法。</p><h2 id="2-4-Scala-关键字"><a href="#2-4-Scala-关键字" class="headerlink" title="2.4 Scala 关键字"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_24-scala-%E5%85%B3%E9%94%AE%E5%AD%97">2.4 Scala 关键字</a></h2><p>下表列出了 scala 保留关键字，我们不能使用以下关键字作为变量：</p><table><thead><tr><th>abstract</th><th>case</th><th>catch</th><th>class</th></tr></thead><tbody><tr><td>def</td><td>do</td><td>else</td><td>extends</td></tr><tr><td>false</td><td>final</td><td>finally</td><td>for</td></tr><tr><td>forSome</td><td>if</td><td>implicit</td><td>import</td></tr><tr><td>lazy</td><td>match</td><td>new</td><td>null</td></tr><tr><td>object</td><td>override</td><td>package</td><td>private</td></tr><tr><td>protected</td><td>return</td><td>sealed</td><td>super</td></tr><tr><td>this</td><td>throw</td><td>trait</td><td>try</td></tr><tr><td>true</td><td>type</td><td>val</td><td>var</td></tr><tr><td>while</td><td>with</td><td>yield</td><td></td></tr><tr><td>-</td><td>:</td><td>=</td><td>=&gt;</td></tr><tr><td>&lt;-</td><td>&lt;:</td><td>&lt;%</td><td>&gt;:</td></tr><tr><td>#</td><td>@</td><td></td><td></td></tr></tbody></table><h2 id="2-5-Scala-注释"><a href="#2-5-Scala-注释" class="headerlink" title="2.5 Scala 注释"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_25-scala-%E6%B3%A8%E9%87%8A">2.5 Scala 注释</a></h2><p>Scala 类似 Java 支持单行和多行注释。多行注释可以嵌套，但必须正确嵌套，一个注释开始符号对应一个结束符号。注释在 Scala 编译中会被忽略，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> HelloWorld <span class="token punctuation">{</span>  <span class="token comment">/* 这是一个 Scala 程序    * 这是一行注释    * 这里演示了多行注释    */</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 输出 Hello World</span>    <span class="token comment">// 这是一个单行注释</span>    println<span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-6-空行和空格"><a href="#2-6-空行和空格" class="headerlink" title="2.6 空行和空格"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_26-%E7%A9%BA%E8%A1%8C%E5%92%8C%E7%A9%BA%E6%A0%BC">2.6 空行和空格</a></h2><p>一行中只有空格或者带有注释，Scala 会认为其是空行，会忽略它。标记可以被空格或者注释来分割。</p><h2 id="2-7-换行符"><a href="#2-7-换行符" class="headerlink" title="2.7 换行符"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_27-%E6%8D%A2%E8%A1%8C%E7%AC%A6">2.7 换行符</a></h2><p>Scala是面向行的语言，语句可以用分号（;）结束或换行符。Scala 程序里,语句末尾的分号通常是可选的。如果你愿意可以输入一个,但若一行里仅 有一个语句也可不写。另一方面,如果一行里写多个语句那么分号是需要的。例如</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> s <span class="token operator">=</span> <span class="token string">"菜鸟教程"</span><span class="token punctuation">;</span> println<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-8-Scala包"><a href="#2-8-Scala包" class="headerlink" title="2.8 Scala包"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_28-scala%E5%8C%85">2.8 Scala包</a></h2><h3 id="2-8-1-定义包"><a href="#2-8-1-定义包" class="headerlink" title="2.8.1 定义包"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_281-%E5%AE%9A%E4%B9%89%E5%8C%85">2.8.1 定义包</a></h3><p>Scala 使用 package 关键字定义包，在Scala将代码定义到某个包中有两种方式：</p><p>第一种方法和 Java 一样，在文件的头定义包名，这种方法就后续所有代码都放在该包中。 比如：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>runoob</span><span class="token keyword">class</span> HelloWorld<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>第二种方法有些类似 C#，如：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>runoob</span> <span class="token punctuation">{</span>  <span class="token keyword">class</span> HelloWorld <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>第二种方法，可以在一个文件中定义多个包。</p><h3 id="2-8-2-引用"><a href="#2-8-2-引用" class="headerlink" title="2.8.2 引用"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_282-%E5%BC%95%E7%94%A8">2.8.2 引用</a></h3><blockquote><p><a href="https://blog.csdn.net/liangzelei/article/details/80509306">scala 重命名和隐藏方法</a></p></blockquote><p>Scala 使用 import 关键字引用包。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span>Color  <span class="token comment">// 引入Color</span> <span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span>_  <span class="token comment">// 引入包内所有成员</span> <span class="token keyword">def</span> handler<span class="token punctuation">(</span>evt<span class="token operator">:</span> event<span class="token punctuation">.</span>ActionEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// java.awt.event.ActionEvent</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment">// 因为引入了java.awt，所以可以省去前面的部分</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>import语句可以出现在任何地方，而不是只能在文件顶部。import的效果从开始延伸到语句块的结束。这可以大幅减少名称冲突的可能性。</p><p><strong>如果想要引入包中的几个成员，可以使用selector（选取器）</strong>：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Color<span class="token punctuation">,</span> Font<span class="token punctuation">}</span> <span class="token comment">// 重命名成员</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token punctuation">{</span>HashMap <span class="token keyword">=&gt;</span> JavaHashMap<span class="token punctuation">}</span> <span class="token comment">// 隐藏成员 </span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token punctuation">{</span>HashMap <span class="token keyword">=&gt;</span> _<span class="token punctuation">,</span> _<span class="token punctuation">}</span> <span class="token comment">// 引入了util包的所有成员，但是HashMap被隐藏了</span><span class="token comment">// 现在，HashMap很明确的便指向了scala.collection.mutable.HashMap，因为java.util.HashMap被隐藏起来了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>*_注意：**_默认情况下，Scala 总会引入 java.lang._ 、 scala._ 和 Predef._，这里也能解释，为什么以scala开头的包，在使用时都是省去scala.的。*</p></blockquote><p>Scala 与 Java有着相同的数据类型，下表列出了 Scala 支持的数据类型：</p><table><thead><tr><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>Byte</td><td>8位有符号补码整数。数值区间为 -128 到 127</td></tr><tr><td>Short</td><td>16位有符号补码整数。数值区间为 -32768 到 32767</td></tr><tr><td>Int</td><td>32位有符号补码整数。数值区间为 -2147483648 到 2147483647</td></tr><tr><td>Long</td><td>64位有符号补码整数。数值区间为 -9223372036854775808 到 9223372036854775807</td></tr><tr><td>Float</td><td>32 位, IEEE 754 标准的单精度浮点数</td></tr><tr><td>Double</td><td>64 位 IEEE 754 标准的双精度浮点数</td></tr><tr><td>Char</td><td>16位无符号Unicode字符, 区间值为 U+0000 到 U+FFFF</td></tr><tr><td>String</td><td>字符序列</td></tr><tr><td>Boolean</td><td>true或false</td></tr><tr><td>Unit</td><td><strong>表示无值，和其他语言中void等同</strong>。用作不返回任何结果的方法的结果类型。Unit只有一个实例值，写成()。</td></tr><tr><td>Null</td><td>null 或空引用</td></tr><tr><td>Nothing</td><td><strong>Nothing类型在Scala的类层级的最底端；它是任何其他类型的子类型</strong></td></tr><tr><td>Any</td><td><strong>Any是所有其他类的超类</strong></td></tr><tr><td>AnyRef</td><td><strong>AnyRef类是Scala里所有引用类(reference class)的基类</strong></td></tr></tbody></table><p><strong>上表中列出的数据类型都是对象，也就是说scala没有java中的原生类型</strong>。</p><p>在scala是可以对数字等基础类型调用方法的。</p><h2 id="3-1-Scala-基础字面量"><a href="#3-1-Scala-基础字面量" class="headerlink" title="3.1 Scala 基础字面量"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_31-scala-%E5%9F%BA%E7%A1%80%E5%AD%97%E9%9D%A2%E9%87%8F">3.1 Scala 基础字面量</a></h2><p>Scala 非常简单且直观。接下来我们会详细介绍 Scala 字面量。</p><h3 id="3-1-1-整型字面量"><a href="#3-1-1-整型字面量" class="headerlink" title="3.1.1 整型字面量"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_311-%E6%95%B4%E5%9E%8B%E5%AD%97%E9%9D%A2%E9%87%8F">3.1.1 整型字面量</a></h3><p>整型字面量用于 Int 类型，如果表示 Long，可以在数字后面添加 L 或者小写 l 作为后缀。：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token number">0</span><span class="token number">035</span><span class="token number">21</span><span class="token number">0xFFFFFFFF</span> <span class="token number">0777L</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-1-2-浮点型字面量"><a href="#3-1-2-浮点型字面量" class="headerlink" title="3.1.2 浮点型字面量"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_312-%E6%B5%AE%E7%82%B9%E5%9E%8B%E5%AD%97%E9%9D%A2%E9%87%8F">3.1.2 浮点型字面量</a></h3><p>如果浮点数后面有f或者F后缀时，表示这是一个Float类型，否则就是一个Double类型的。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token number">0.0</span> <span class="token number">1e30f</span> <span class="token number">3.14159f</span> <span class="token number">1.0e100</span><span class="token number">.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-1-3-布尔型字面量"><a href="#3-1-3-布尔型字面量" class="headerlink" title="3.1.3 布尔型字面量"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_313-%E5%B8%83%E5%B0%94%E5%9E%8B%E5%AD%97%E9%9D%A2%E9%87%8F">3.1.3 布尔型字面量</a></h3><p>布尔型字面量有 true 和 false。</p><h3 id="3-1-4-符号字面量"><a href="#3-1-4-符号字面量" class="headerlink" title="3.1.4 符号字面量"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_314-%E7%AC%A6%E5%8F%B7%E5%AD%97%E9%9D%A2%E9%87%8F">3.1.4 符号字面量</a></h3><blockquote><p><a href="https://blog.csdn.net/iamiman/article/details/53537427">case class 和 class的区别</a></p><p><a href="https://www.cnblogs.com/PerkinsZhu/p/9307460.html">case class 和class的区别以及构造器参数辨析</a></p><p>case class 主要就是为了方便模式匹配</p></blockquote><p>符号字面量被写成： <strong>‘&lt;标识符&gt;</strong> ，这里 <strong>&lt;标识符&gt;</strong> 可以是任何字母或数字的标识（注意：不能以数字开头）。这种字面量被映射成预定义类scala.Symbol的实例。</p><p>如： 符号字面量 <strong>‘x</strong> 是表达式 <strong>scala.Symbol(“x”)</strong> 的简写，符号字面量定义如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">package</span> <span class="token namespace">scala</span><span class="token keyword">final</span> <span class="token keyword">case</span> <span class="token keyword">class</span> Symbol <span class="token keyword">private</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token keyword">override</span> <span class="token keyword">def</span> toString<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"'"</span> <span class="token operator">+</span> name<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-1-5-字符字面量"><a href="#3-1-5-字符字面量" class="headerlink" title="3.1.5 字符字面量"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_315-%E5%AD%97%E7%AC%A6%E5%AD%97%E9%9D%A2%E9%87%8F">3.1.5 字符字面量</a></h3><p>在 Scala 字符变量使用单引号 <strong>‘</strong> 来定义，如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token char">'a'</span> <span class="token char">'\u0041'</span><span class="token char">'\n'</span><span class="token char">'\t'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>其中 <strong><code>\</code></strong> 表示转义字符，其后可以跟 <strong>u0041</strong> 数字或者 <strong>\r\n</strong> 等固定的转义字符。</p><h3 id="3-1-6-字符串字面量"><a href="#3-1-6-字符串字面量" class="headerlink" title="3.1.6 字符串字面量"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_316-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E9%9D%A2%E9%87%8F">3.1.6 字符串字面量</a></h3><p>在 Scala 字符串字面量使用双引号**“**来定义，如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token string">"Hello,\nWorld!"</span><span class="token string">"菜鸟教程官网：www.runoob.com"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="3-1-7-多行字符串的表示方法"><a href="#3-1-7-多行字符串的表示方法" class="headerlink" title="3.1.7 多行字符串的表示方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_317-%E5%A4%9A%E8%A1%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E8%A1%A8%E7%A4%BA%E6%96%B9%E6%B3%95">3.1.7 多行字符串的表示方法</a></h3><p>多行字符串用三个双引号来表示分隔符，格式为：**“”” … “””**。</p><p>实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> foo <span class="token operator">=</span> <span class="token triple-quoted-string string">"""菜鸟教程www.runoob.comwww.w3cschool.ccwww.runnoob.com以上三个地址都能访问"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-1-8-Null-值"><a href="#3-1-8-Null-值" class="headerlink" title="3.1.8 Null 值"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_318-null-%E5%80%BC">3.1.8 Null 值</a></h3><p>空值是 scala.Null 类型。</p><p>Scala.Null和scala.Nothing是用统一的方式处理Scala面向对象类型系统的某些”边界情况”的特殊类型。</p><p><strong>Null类是null引用对象的类型，它是每个引用类（继承自AnyRef的类）的子类。Null不兼容值类型。</strong> </p><h3 id="3-1-9-Scala-转义字符"><a href="#3-1-9-Scala-转义字符" class="headerlink" title="3.1.9 Scala 转义字符"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_319-scala-%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6">3.1.9 Scala 转义字符</a></h3><p>下表列出了常见的转义字符：</p><table><thead><tr><th>转义字符</th><th>Unicode</th><th>描述</th></tr></thead><tbody><tr><td>\b</td><td>\u0008</td><td>退格(BS) ，将当前位置移到前一列</td></tr><tr><td>\t</td><td>\u0009</td><td>水平制表(HT) （跳到下一个TAB位置）</td></tr><tr><td>\n</td><td>\u000a</td><td>换行(LF) ，将当前位置移到下一行开头</td></tr><tr><td>\f</td><td>\u000c</td><td>换页(FF)，将当前位置移到下页开头</td></tr><tr><td>\r</td><td>\u000d</td><td>回车(CR) ，将当前位置移到本行开头</td></tr><tr><td>“</td><td>\u0022</td><td>代表一个双引号(“)字符</td></tr><tr><td>‘</td><td>\u0027</td><td>代表一个单引号（’）字符</td></tr><tr><td>\</td><td>\u005c</td><td>代表一个反斜线字符 ‘’</td></tr></tbody></table><p>0 到 255 间的 Unicode 字符可以用一个八进制转义序列来表示，即反斜线‟\‟后跟 最多三个八进制。</p><p>在字符或字符串中，反斜线和后面的字符序列不能构成一个合法的转义序列将会导致 编译错误。</p><p>以下实例演示了一些转义字符的使用：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>   <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"Hello\tWorld\n\n"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestHello    World<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>变量是一种使用方便的占位符，用于引用计算机内存地址，变量创建后会占用一定的内存空间。</p><p>基于变量的数据类型，操作系统会进行内存分配并且决定什么将被储存在保留内存中。因此，通过给变量分配不同的数据类型，你可以在这些变量中存储整数，小数或者字母。</p><h2 id="4-1-变量声明"><a href="#4-1-变量声明" class="headerlink" title="4.1 变量声明"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_41-%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">4.1 变量声明</a></h2><p>在学习如何声明变量与常量之前，我们先来了解一些变量与常量。</p><ul><li>  一、变量： 在程序运行过程中其值可能发生改变的量叫做变量。如：时间，年龄。</li><li>  二、常量： 在程序运行过程中其值不会发生变化的量叫做常量。如：数值 3，字符’A’。</li></ul><p>在 Scala 中，使用关键词 <strong>“var”</strong> 声明变量，使用关键词 <strong>“val”</strong> 声明常量。</p><p>声明变量实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> myVar <span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"Foo"</span><span class="token keyword">var</span> myVar <span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"Too"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>以上定义了变量 myVar，我们可以修改它。</p><p>声明常量实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> myVal <span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"Foo"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以上定义了常量 myVal，它是不能修改的。如果程序尝试修改常量 myVal 的值，程序将会在编译时报错。</p><h2 id="4-2-变量类型声明"><a href="#4-2-变量类型声明" class="headerlink" title="4.2 变量类型声明"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_42-%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B%E5%A3%B0%E6%98%8E">4.2 变量类型声明</a></h2><p>变量的类型在变量名之后等号之前声明。定义变量的类型的语法格式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> VariableName <span class="token operator">:</span> DataType <span class="token punctuation">[</span><span class="token operator">=</span>  Initial Value<span class="token punctuation">]</span>或<span class="token keyword">val</span> VariableName <span class="token operator">:</span> DataType <span class="token punctuation">[</span><span class="token operator">=</span>  Initial Value<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-3-变量类型引用"><a href="#4-3-变量类型引用" class="headerlink" title="4.3 变量类型引用"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_43-%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B%E5%BC%95%E7%94%A8">4.3 变量类型引用</a></h2><p>在 Scala 中声明变量和常量不一定要指明数据类型，在没有指明数据类型的情况下，其数据类型是通过变量或常量的初始值推断出来的。</p><p>所以，如果<strong>在没有指明数据类型的情况下声明变量或常量必须要给出其初始值，否则将会报错</strong>。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> myVar <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">val</span> myVal <span class="token operator">=</span> <span class="token string">"Hello, Scala!"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>以上实例中，myVar 会被推断为 Int 类型，myVal 会被推断为 String 类型。</p><h2 id="4-4-Scala-多个变量声明"><a href="#4-4-Scala-多个变量声明" class="headerlink" title="4.4 Scala 多个变量声明"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_44-scala-%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E">4.4 Scala 多个变量声明</a></h2><p>Scala 支持多个变量的声明：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> xmax<span class="token punctuation">,</span> ymax <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment">// xmax, ymax都声明为100</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果方法返回值是元组，我们可以使用 val 来声明一个元组：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> <span class="token keyword">val</span> pa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token string">"Foo"</span><span class="token punctuation">)</span>pa<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span>Foo<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Scala 访问修饰符基本和Java的一样，分别有：private，protected，public。</p><p><strong>如果没有指定访问修饰符，默认情况下，Scala 对象的访问级别都是 public</strong>。</p><p><strong>Scala 中的 private 限定符，比 Java 更严格，在嵌套类情况下，外层类甚至不能访问被嵌套类的私有成员</strong>。</p><h2 id="5-1-私有-Private-成员"><a href="#5-1-私有-Private-成员" class="headerlink" title="5.1 私有(Private)成员"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_51-%E7%A7%81%E6%9C%89private%E6%88%90%E5%91%98">5.1 私有(Private)成员</a></h2><p>用 private 关键字修饰，带有此标记的成员仅在包含了成员定义的类或对象内部可见，同样的规则还适用内部类。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">class</span> Outer<span class="token punctuation">{</span>  <span class="token keyword">class</span> Inner<span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">def</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>println<span class="token punctuation">(</span><span class="token string">"f"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token keyword">class</span> InnerMost<span class="token punctuation">{</span>      f<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 正确</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token punctuation">(</span><span class="token keyword">new</span> Inner<span class="token punctuation">)</span><span class="token punctuation">.</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//错误</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>(new Inner).f( )</strong> 访问不合法是因为 <strong>f</strong> 在 Inner 中被声明为 private，而访问不在类 Inner 之内。</p><p>但在 InnerMost 里访问 <strong>f</strong> 就没有问题的，因为这个访问包含在 Inner 类之内。</p><blockquote><p>Java中允许这两种访问，因为它允许外部类访问内部类的私有成员。</p></blockquote><h2 id="5-2-保护-Protected-成员"><a href="#5-2-保护-Protected-成员" class="headerlink" title="5.2 保护(Protected)成员"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_52-%E4%BF%9D%E6%8A%A4protected%E6%88%90%E5%91%98">5.2 保护(Protected)成员</a></h2><p>在 scala 中，对保护（Protected）成员的访问比 java 更严格一些。因为<strong>它只允许保护成员在定义了该成员的的类的子类中被访问</strong>。而在java中，用protected关键字修饰的成员，除了定义了该成员的类的子类可以访问，同一个包里的其他类也可以进行访问。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">package</span> <span class="token namespace">p</span><span class="token punctuation">{</span>  <span class="token keyword">class</span> Super<span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token keyword">def</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>println<span class="token punctuation">(</span><span class="token string">"f"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">class</span> Sub <span class="token keyword">extends</span> Super<span class="token punctuation">{</span>    f<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">class</span> Other<span class="token punctuation">{</span>    <span class="token punctuation">(</span><span class="token keyword">new</span> Super<span class="token punctuation">)</span><span class="token punctuation">.</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//错误</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上例中，Sub 类对 f 的访问没有问题，因为 f 在 Super 中被声明为 protected，而 Sub 是 Super 的子类。相反，Other 对 f 的访问不被允许，因为 other 没有继承自 Super。</p><blockquote><p>后者在 java 里同样被认可，因为 Other 与 Sub 在同一包里。</p></blockquote><h2 id="5-3-公共-Public-成员"><a href="#5-3-公共-Public-成员" class="headerlink" title="5.3 公共(Public)成员"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_53-%E5%85%AC%E5%85%B1public%E6%88%90%E5%91%98">5.3 公共(Public)成员</a></h2><p>Scala 中，如果没有指定任何的修饰符，则默认为 public。这样的成员在任何地方都可以被访问。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">class</span> Outer <span class="token punctuation">{</span>  <span class="token keyword">class</span> Inner <span class="token punctuation">{</span>    <span class="token keyword">def</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> println<span class="token punctuation">(</span><span class="token string">"f"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>    <span class="token keyword">class</span> InnerMost <span class="token punctuation">{</span>      f<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 正确</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token punctuation">(</span><span class="token keyword">new</span> Inner<span class="token punctuation">)</span><span class="token punctuation">.</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 正确因为 f() 是 public</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-4-作用域保护"><a href="#5-4-作用域保护" class="headerlink" title="5.4 作用域保护"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_54-%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%BF%9D%E6%8A%A4">5.4 作用域保护</a></h2><p>Scala中，访问修饰符可以通过使用限定词强调。格式为:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">private</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> 或 <span class="token keyword">protected</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里的x指代某个所属的包、类或单例对象。</p><p><strong>如果写成private[x],读作”这个成员除了对[…]中的类或[…]中的包中的类及它们的伴生对像可见外，对其它所有类都是private</strong>。</p><p>这种技巧在横跨了若干包的大型项目中非常有用，它允许你定义一些在你项目的若干子包中可见但对于项目外部的客户却始终不可见的东西。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">package</span> <span class="token namespace">bobsrockets</span><span class="token punctuation">{</span>  <span class="token keyword">package</span> <span class="token namespace">navigation</span><span class="token punctuation">{</span>    <span class="token keyword">private</span><span class="token punctuation">[</span>bobsrockets<span class="token punctuation">]</span> <span class="token keyword">class</span> Navigator<span class="token punctuation">{</span>      <span class="token keyword">protected</span><span class="token punctuation">[</span>navigation<span class="token punctuation">]</span> <span class="token keyword">def</span> useStarChart<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token keyword">class</span> LegOfJourney<span class="token punctuation">{</span>        <span class="token keyword">private</span><span class="token punctuation">[</span>Navigator<span class="token punctuation">]</span> <span class="token keyword">val</span> distance <span class="token operator">=</span> <span class="token number">100</span>      <span class="token punctuation">}</span>      <span class="token keyword">private</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token keyword">var</span> speed <span class="token operator">=</span> <span class="token number">200</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">package</span> <span class="token namespace">launch</span><span class="token punctuation">{</span>    <span class="token keyword">import</span> <span class="token namespace">navigation<span class="token punctuation">.</span></span>_    <span class="token keyword">object</span> Vehicle<span class="token punctuation">{</span>      <span class="token keyword">private</span><span class="token punctuation">[</span>launch<span class="token punctuation">]</span> <span class="token keyword">val</span> guide <span class="token operator">=</span> <span class="token keyword">new</span> Navigator    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述例子中，类 Navigator 被标记为 private[bobsrockets] 就是说这个类对包含在 bobsrockets 包里的所有的类和对象可见。</p><p>比如说，从 Vehicle 对象里对 Navigator 的访问是被允许的，因为对象 Vehicle 包含在包 launch 中，而 launch 包在 bobsrockets 中，相反，所有在包 bobsrockets 之外的代码都不能访问类 Navigator。</p><p>一个运算符是一个符号，用于告诉编译器来执行指定的数学运算和逻辑运算。</p><p>Scala 含有丰富的内置运算符，包括以下几种类型：</p><ul><li>  算术运算符</li><li>  关系运算符</li><li>  逻辑运算符</li><li>  位运算符</li><li>  赋值运算符</li></ul><p>接下来我们将为大家详细介绍以上各种运算符的应用。</p><h2 id="6-1-算术运算符"><a href="#6-1-算术运算符" class="headerlink" title="6.1 算术运算符"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_61-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%AC%A6">6.1 算术运算符</a></h2><p>下表列出了 Scala 支持的算术运算符。</p><p>假定变量 A 为 10，B 为 20：</p><table><thead><tr><th>运算符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>+</td><td>加号</td><td>A + B 运算结果为 30</td></tr><tr><td>-</td><td>减号</td><td>A - B 运算结果为 -10</td></tr><tr><td>*</td><td>乘号</td><td>A * B 运算结果为 200</td></tr><tr><td>/</td><td>除号</td><td>B / A 运算结果为 2</td></tr><tr><td>%</td><td>取余</td><td>B % A 运算结果为 0</td></tr></tbody></table><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a + b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a - b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a * b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"b / a = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b <span class="token operator">/</span> a<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"b % a = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b <span class="token operator">%</span> a<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c % a = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>c <span class="token operator">%</span> a<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala Testa <span class="token operator">+</span> b <span class="token operator">=</span> <span class="token number">30</span>a <span class="token operator">-</span> b <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">10</span>a <span class="token operator">*</span> b <span class="token operator">=</span> <span class="token number">200</span>b <span class="token operator">/</span> a <span class="token operator">=</span> <span class="token number">2</span>b <span class="token operator">%</span> a <span class="token operator">=</span> <span class="token number">0</span>c <span class="token operator">%</span> a <span class="token operator">=</span> <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-2-关系运算符"><a href="#6-2-关系运算符" class="headerlink" title="6.2 关系运算符"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_62-%E5%85%B3%E7%B3%BB%E8%BF%90%E7%AE%97%E7%AC%A6">6.2 关系运算符</a></h2><p>下表列出了 Scala 支持的关系运算符。</p><p>假定变量 A 为 10，B 为 20：</p><table><thead><tr><th>运算符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>==</td><td>等于</td><td>(A == B) 运算结果为 false</td></tr><tr><td>!=</td><td>不等于</td><td>(A != B) 运算结果为 true</td></tr><tr><td>&gt;</td><td>大于</td><td>(A &gt; B) 运算结果为 false</td></tr><tr><td>&lt;</td><td>小于</td><td>(A &lt; B) 运算结果为 true</td></tr><tr><td>&gt;=</td><td>大于等于</td><td>(A &gt;= B) 运算结果为 false</td></tr><tr><td>&lt;=</td><td>小于等于</td><td>(A &lt;= B) 运算结果为 true</td></tr></tbody></table><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a == b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a != b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a &gt; b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">&gt;</span> b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a &lt; b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"b &gt;= a = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b <span class="token operator">&gt;=</span> a<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"b &lt;= a = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b <span class="token operator">&lt;=</span> a<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala Testa <span class="token operator">==</span> b <span class="token operator">=</span> <span class="token boolean">false</span>a <span class="token operator">!=</span> b <span class="token operator">=</span> <span class="token boolean">true</span>a <span class="token operator">&gt;</span> b <span class="token operator">=</span> <span class="token boolean">false</span>a <span class="token operator">&lt;</span> b <span class="token operator">=</span> <span class="token boolean">true</span>b <span class="token operator">&gt;=</span> a <span class="token operator">=</span> <span class="token boolean">true</span>b <span class="token operator">&lt;=</span> a <span class="token operator">=</span> <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-3-逻辑运算符"><a href="#6-3-逻辑运算符" class="headerlink" title="6.3 逻辑运算符"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_63-%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6">6.3 逻辑运算符</a></h2><p>下表列出了 Scala 支持的逻辑运算符。</p><p>假定变量 A 为 1，B 为 0：</p><table><thead><tr><th>运算符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>&amp;&amp;</td><td>逻辑与</td><td>(A &amp;&amp; B) 运算结果为 false</td></tr><tr><td></td><td></td><td></td></tr><tr><td>!</td><td>逻辑非</td><td>!(A &amp;&amp; B) 运算结果为 true</td></tr></tbody></table><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a &amp;&amp; b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a<span class="token operator">&amp;&amp;</span>b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"a || b = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a<span class="token operator">||</span>b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"!(a &amp;&amp; b) = "</span> <span class="token operator">+</span> <span class="token operator">!</span><span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala Testa <span class="token operator">&amp;&amp;</span> b <span class="token operator">=</span> <span class="token boolean">false</span>a <span class="token operator">||</span> b <span class="token operator">=</span> <span class="token boolean">true</span><span class="token operator">!</span><span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-4-位运算符"><a href="#6-4-位运算符" class="headerlink" title="6.4 位运算符"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_64-%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6">6.4 位运算符</a></h2><p>位运算符用来对二进制位进行操作，**~,&amp;,|,^** 分别为取反，按位与与，按位与或，按位与异或运算，如下表实例：</p><p>| p | q | p &amp; q | p | q | p ^ q |<br>| — | — | — | — | — |<br>| 0 | 0 | 0 | 0 | 0 |<br>| 0 | 1 | 0 | 1 | 1 |<br>| 1 | 1 | 1 | 1 | 0 |<br>| 1 | 0 | 0 | 1 | 1 |</p><p>如果指定 A = 60; 及 B = 13; 两个变量对应的二进制为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">A <span class="token operator">=</span> <span class="token number">0011</span> <span class="token number">1100</span>B <span class="token operator">=</span> <span class="token number">0000</span> <span class="token number">1101</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>位运算<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>A<span class="token operator">&amp;</span>B <span class="token operator">=</span> <span class="token number">0000</span> <span class="token number">1100</span>A<span class="token operator">|</span>B <span class="token operator">=</span> <span class="token number">0011</span> <span class="token number">1101</span>A<span class="token operator">^</span>B <span class="token operator">=</span> <span class="token number">0011</span> <span class="token number">0001</span><span class="token operator">~</span>A  <span class="token operator">=</span> <span class="token number">1100</span> <span class="token number">0011</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Scala 中的按位运算法则如下：</p><table><thead><tr><th>运算符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>&amp;</td><td>按位与运算符</td><td>(a &amp; b) 输出结果 12 ，二进制解释： 0000 1100</td></tr><tr><td></td><td></td><td>按位或运算符</td></tr><tr><td>^</td><td>按位异或运算符</td><td>(a ^ b) 输出结果 49 ，二进制解释： 0011 0001</td></tr><tr><td>~</td><td>按位取反运算符</td><td>(~a ) 输出结果 -61 ，二进制解释： 1100 0011， 在一个有符号二进制数的补码形式。</td></tr><tr><td>&lt;&lt;</td><td>左移动运算符</td><td>a &lt;&lt; 2 输出结果 240 ，二进制解释： 1111 0000</td></tr><tr><td>&gt;&gt;</td><td>右移动运算符</td><td>a &gt;&gt; 2 输出结果 15 ，二进制解释： 0000 1111</td></tr><tr><td>&gt;&gt;&gt;</td><td>无符号右移</td><td>A &gt;&gt;&gt;2 输出结果 15, 二进制解释: 0000 1111</td></tr></tbody></table><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>           <span class="token comment">/* 60 = 0011 1100 */</span>      <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>           <span class="token comment">/* 13 = 0000 1101 */</span>    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> a <span class="token operator">&amp;</span> b<span class="token punctuation">;</span>            <span class="token comment">/* 12 = 0000 1100 */</span>    println<span class="token punctuation">(</span><span class="token string">"a &amp; b = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> a <span class="token operator">|</span> b<span class="token punctuation">;</span>            <span class="token comment">/* 61 = 0011 1101 */</span>    println<span class="token punctuation">(</span><span class="token string">"a | b = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> a <span class="token operator">^</span> b<span class="token punctuation">;</span>            <span class="token comment">/* 49 = 0011 0001 */</span>    println<span class="token punctuation">(</span><span class="token string">"a ^ b = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> <span class="token operator">~</span>a<span class="token punctuation">;</span>               <span class="token comment">/* -61 = 1100 0011 */</span>    println<span class="token punctuation">(</span><span class="token string">"~a = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> a <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>           <span class="token comment">/* 240 = 1111 0000 */</span>    println<span class="token punctuation">(</span><span class="token string">"a &lt;&lt; 2 = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> a <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>           <span class="token comment">/* 15 = 1111 */</span>    println<span class="token punctuation">(</span><span class="token string">"a &gt;&gt; 2  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> a <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">/* 15 = 0000 1111 */</span>    println<span class="token punctuation">(</span><span class="token string">"a &gt;&gt;&gt; 2 = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala Testa <span class="token operator">&amp;</span> b <span class="token operator">=</span> <span class="token number">12</span>a <span class="token operator">|</span> b <span class="token operator">=</span> <span class="token number">61</span>a <span class="token operator">^</span> b <span class="token operator">=</span> <span class="token number">49</span><span class="token operator">~</span>a <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">61</span>a <span class="token operator">&lt;&lt;</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">240</span>a <span class="token operator">&gt;&gt;</span> <span class="token number">2</span>  <span class="token operator">=</span> <span class="token number">15</span>a <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">15</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-4-赋值运算符"><a href="#6-4-赋值运算符" class="headerlink" title="6.4 赋值运算符"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_64-%E8%B5%8B%E5%80%BC%E8%BF%90%E7%AE%97%E7%AC%A6">6.4 赋值运算符</a></h2><p>以下列出了 Scala 语言支持的赋值运算符:</p><table><thead><tr><th>运算符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>=</td><td>简单的赋值运算，指定右边操作数赋值给左边的操作数。</td><td>C = A + B 将 A + B 的运算结果赋值给 C</td></tr><tr><td>+=</td><td>相加后再赋值，将左右两边的操作数相加后再赋值给左边的操作数。</td><td>C += A 相当于 C = C + A</td></tr><tr><td>-=</td><td>相减后再赋值，将左右两边的操作数相减后再赋值给左边的操作数。</td><td>C -= A 相当于 C = C - A</td></tr><tr><td>*=</td><td>相乘后再赋值，将左右两边的操作数相乘后再赋值给左边的操作数。</td><td>C *= A 相当于 C = C * A</td></tr><tr><td>/=</td><td>相除后再赋值，将左右两边的操作数相除后再赋值给左边的操作数。</td><td>C /= A 相当于 C = C / A</td></tr><tr><td>%=</td><td>求余后再赋值，将左右两边的操作数求余后再赋值给左边的操作数。</td><td>C %= A is equivalent to C = C % A</td></tr><tr><td>&lt;&lt;=</td><td>按位左移后再赋值</td><td>C &lt;&lt;= 2 相当于 C = C &lt;&lt; 2</td></tr><tr><td>&gt;&gt;=</td><td>按位右移后再赋值</td><td>C &gt;&gt;= 2 相当于 C = C &gt;&gt; 2</td></tr><tr><td>&amp;=</td><td>按位与运算后赋值</td><td>C &amp;= 2 相当于 C = C &amp; 2</td></tr><tr><td>^=</td><td>按位异或运算符后再赋值</td><td>C ^= 2 相当于 C = C ^ 2</td></tr><tr><td></td><td>=</td><td>按位或运算后再赋值</td></tr></tbody></table><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>          <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c = a + b  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">+=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c += a  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">-=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c -= a = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">*=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c *= a = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>    c <span class="token operator">/=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c /= a  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    c <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>    c <span class="token operator">%=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c %= a  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">&lt;&lt;=</span> <span class="token number">2</span> <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c &lt;&lt;= 2  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">&gt;&gt;=</span> <span class="token number">2</span> <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c &gt;&gt;= 2  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">&gt;&gt;=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c &gt;&gt;= a  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">&amp;=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c &amp;= 2  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">^=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c ^= a  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>    c <span class="token operator">|=</span> a <span class="token punctuation">;</span>    println<span class="token punctuation">(</span><span class="token string">"c |= a  = "</span> <span class="token operator">+</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala Testc <span class="token operator">=</span> a <span class="token operator">+</span> b  <span class="token operator">=</span> <span class="token number">30</span>c <span class="token operator">+=</span> a  <span class="token operator">=</span> <span class="token number">40</span>c <span class="token operator">-=</span> a <span class="token operator">=</span> <span class="token number">30</span>c <span class="token operator">*=</span> a <span class="token operator">=</span> <span class="token number">300</span>c <span class="token operator">/=</span> a  <span class="token operator">=</span> <span class="token number">1</span>c <span class="token operator">%=</span> a  <span class="token operator">=</span> <span class="token number">5</span>c <span class="token operator">&lt;&lt;=</span> <span class="token number">2</span>  <span class="token operator">=</span> <span class="token number">20</span>c <span class="token operator">&gt;&gt;=</span> <span class="token number">2</span>  <span class="token operator">=</span> <span class="token number">5</span>c <span class="token operator">&gt;&gt;=</span> a  <span class="token operator">=</span> <span class="token number">0</span>c <span class="token operator">&amp;=</span> <span class="token number">2</span>  <span class="token operator">=</span> <span class="token number">0</span>c <span class="token operator">^=</span> a  <span class="token operator">=</span> <span class="token number">10</span>c <span class="token operator">|=</span> a  <span class="token operator">=</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运算符优先级取决于所属的运算符组，它会影响算式的的计算。</p><p>实例： x = 7 + 3 * 2; 这里， x 计算结果为 13, 而不是 20，因为乘法（_） 高于加法（+）, 所以它先计算 3_2 再加上 7。</p><p>查看以下表格，优先级从上到下依次递减，最上面具有最高的优先级，逗号操作符具有最低的优先级。</p><table><thead><tr><th>类别</th><th>运算符</th><th>关联性</th></tr></thead><tbody><tr><td>1</td><td>() []</td><td>左到右</td></tr><tr><td>2</td><td>! ~</td><td>右到左</td></tr><tr><td>3</td><td>* / %</td><td>左到右</td></tr><tr><td>4</td><td>+ -</td><td>左到右</td></tr><tr><td>5</td><td>&gt;&gt; &gt;&gt;&gt; &lt;&lt;</td><td>左到右</td></tr><tr><td>6</td><td>&gt; &gt;= &lt; &lt;=</td><td>左到右</td></tr><tr><td>7</td><td>== !=</td><td>左到右</td></tr><tr><td>8</td><td>&amp;</td><td>左到右</td></tr><tr><td>9</td><td>^</td><td>左到右</td></tr><tr><td>10</td><td></td><td></td></tr><tr><td>11</td><td>&amp;&amp;</td><td>左到右</td></tr><tr><td>12</td><td></td><td></td></tr><tr><td>13</td><td>= += -= *= /= %= &gt;&gt;= &lt;&lt;= &amp;= ^=</td><td>=</td></tr><tr><td>14</td><td>,</td><td>左到右</td></tr></tbody></table><p>Scala IF…ELSE 语句是通过一条或多条语句的执行结果（True或者False）来决定执行的代码块。</p><p>可以通过下图来简单了解条件语句的执行过程:</p><p><img src="https://www.runoob.com/wp-content/uploads/2015/12/if.png"></p><h2 id="7-1-if-语句"><a href="#7-1-if-语句" class="headerlink" title="7.1 if 语句"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_71-if-%E8%AF%AD%E5%8F%A5">7.1 if 语句</a></h2><p>if 语句有布尔表达式及之后的语句块组成。</p><p><strong>语法</strong></p><p>if 语句的语法格式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式<span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">// 如果布尔表达式为 true 则执行该语句块</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果布尔表达式为 true 则执行大括号内的语句块，否则跳过大括号内的语句块，执行大括号之后的语句块。</p><p><strong>示例</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> x <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"x &lt; 20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala Testx <span class="token operator">&lt;</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="7-2-if…else-语句"><a href="#7-2-if…else-语句" class="headerlink" title="7.2 if…else 语句"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_72-ifelse-%E8%AF%AD%E5%8F%A5">7.2 if…else 语句</a></h2><p>if 语句后可以紧跟 else 语句，else 内的语句块可以在布尔表达式为 false 的时候执行。</p><p><strong>语法</strong></p><p>if…else 的语法格式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 如果布尔表达式为 true 则执行该语句块</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>  <span class="token comment">// 如果布尔表达式为 false 则执行该语句块</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>示例</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> x <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"x 小于 20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"x 大于 20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala Testx 大于 <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="7-3-if…else-if…else-语句"><a href="#7-3-if…else-if…else-语句" class="headerlink" title="7.3 if…else if…else 语句"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_73-ifelse-ifelse-%E8%AF%AD%E5%8F%A5">7.3 if…else if…else 语句</a></h2><p>if 语句后可以紧跟 else if…else 语句，在多个条件判断语句的情况下很有用。</p><p><strong>语法</strong></p><p>if…else if…else 语法格式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式 <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">// 如果布尔表达式 1 为 true 则执行该语句块</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式 <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">// 如果布尔表达式 2 为 true 则执行该语句块</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式 <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   <span class="token comment">// 如果布尔表达式 3 为 true 则执行该语句块</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>   <span class="token comment">// 如果以上条件都为 false 执行该语句块</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>示例</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> x <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"X 的值为 10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> x <span class="token operator">==</span> <span class="token number">20</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"X 的值为 20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> x <span class="token operator">==</span> <span class="token number">30</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"X 的值为 30"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"无法判断 X 的值"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala TestX 的值为 <span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="7-4-if…else-嵌套语句"><a href="#7-4-if…else-嵌套语句" class="headerlink" title="7.4 if…else 嵌套语句"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_74-ifelse-%E5%B5%8C%E5%A5%97%E8%AF%AD%E5%8F%A5">7.4 if…else 嵌套语句</a></h2><p>if…else 嵌套语句可以实现在 if 语句内嵌入一个或多个 if 语句。</p><p><strong>语法</strong></p><p>if…else 嵌套语句语法格式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式 <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 如果布尔表达式 1 为 true 则执行该语句块</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式 <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">// 如果布尔表达式 2 为 true 则执行该语句块</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>else if…else 的嵌套语句 类似 if…else 嵌套语句。</p><p><strong>示例</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> x <span class="token operator">==</span> <span class="token number">30</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> y <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        println<span class="token punctuation">(</span><span class="token string">"X = 30 , Y = 10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala TestX <span class="token operator">=</span> <span class="token number">30</span> <span class="token punctuation">,</span> Y <span class="token operator">=</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>有的时候，我们可能需要多次执行同一块代码。一般情况下，语句是按顺序执行的：函数中的第一个语句先执行，接着是第二个语句，依此类推。</p><p>编程语言提供了更为复杂执行路径的多种控制结构。</p><p>循环语句允许我们多次执行一个语句或语句组，下面是大多数编程语言中循环语句的流程图：</p><p><img src="https://www.runoob.com/wp-content/uploads/2015/12/loop.png"></p><h2 id="8-1-循环类型"><a href="#8-1-循环类型" class="headerlink" title="8.1 循环类型"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_81-%E5%BE%AA%E7%8E%AF%E7%B1%BB%E5%9E%8B">8.1 循环类型</a></h2><p>Scala 语言提供了以下几种循环类型。点击链接查看每个类型的细节。</p><table><thead><tr><th>循环类型</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://www.runoob.com/scala/scala-while-loop.html">while 循环</a></td><td>运行一系列语句，如果条件为true，会重复运行，直到条件变为false。</td></tr><tr><td><a href="https://www.runoob.com/scala/scala-do-while-loop.html">do…while 循环</a></td><td>类似 while 语句区别在于判断循环条件之前，先执行一次循环的代码块。</td></tr><tr><td><a href="https://www.runoob.com/scala/scala-for-loop.html">for 循环</a></td><td>用来重复执行一系列语句直到达成特定条件达成，一般通过在每次循环完成后增加计数器的值来实现。</td></tr></tbody></table><h3 id="8-1-1-Scala-while-循环"><a href="#8-1-1-Scala-while-循环" class="headerlink" title="8.1.1 Scala while 循环"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_811-scala-while-%E5%BE%AA%E7%8E%AF">8.1.1 Scala while 循环</a></h3><p>只要给定的条件为 true，Scala 语言中的 <strong>while</strong> 循环语句会重复执行循环体内的代码块。</p><p><strong>语法</strong></p><p>Scala 语言中 <strong>while</strong> 循环的语法：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">while</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">{</span>  statement<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在这里，<strong>statement(s)</strong> 可以是一个单独的语句，也可以是几个语句组成的代码块。</p><p><strong>condition</strong> 可以是任意的表达式，当为任意非零值时都为 true。当条件为 true 时执行循环。 当条件为 false 时，退出循环，程序流将继续执行紧接着循环的下一条语句。</p><p><strong>流程图</strong></p><p><img src="https://www.runoob.com/wp-content/uploads/2014/09/cpp_while_loop.png"></p><p>在这里，<em>while</em> 循环的关键点是循环可能一次都不会执行。当条件为 false 时，会跳过循环主体，直接执行紧接着 while 循环的下一条语句。</p><p><strong>示例</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 局部变量</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token comment">// while 循环执行</span>    <span class="token keyword">while</span><span class="token punctuation">(</span> a <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>      a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Testvalue of a<span class="token operator">:</span> <span class="token number">10</span>value of a<span class="token operator">:</span> <span class="token number">11</span>value of a<span class="token operator">:</span> <span class="token number">12</span>value of a<span class="token operator">:</span> <span class="token number">13</span>value of a<span class="token operator">:</span> <span class="token number">14</span>value of a<span class="token operator">:</span> <span class="token number">15</span>value of a<span class="token operator">:</span> <span class="token number">16</span>value of a<span class="token operator">:</span> <span class="token number">17</span>value of a<span class="token operator">:</span> <span class="token number">18</span>value of a<span class="token operator">:</span> <span class="token number">19</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-1-2-Scala-do…while-循环"><a href="#8-1-2-Scala-do…while-循环" class="headerlink" title="8.1.2 Scala do…while 循环"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_812-scala-dowhile-%E5%BE%AA%E7%8E%AF">8.1.2 Scala do…while 循环</a></h3><p>不像 while 循环在循环头部测试循环条件, Scala 语言中，do…while 循环是在循环的尾部检查它的条件。</p><p>do…while 循环与 while 循环类似，但是 do…while 循环会确保至少执行一次循环。</p><p><strong>语法</strong></p><p>Scala 语言中 <strong>while</strong> 循环的语法：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">do</span> <span class="token punctuation">{</span>   statement<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span> condition <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>流程图</strong></p><p><img src="https://www.runoob.com/wp-content/uploads/2014/09/cpp_do_while_loop.jpg"></p><p>请注意，条件表达式出现在循环的尾部，所以循环中的 statement(s) 会在条件被测试之前至少执行一次。</p><p>如果条件为 true，控制流会跳转回上面的 do，然后重新执行循环中的 statement(s)。</p><p>这个过程会不断重复，直到给定条件变为 false 为止。</p><p><strong>示例</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 局部变量</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token comment">// do 循环</span>    <span class="token keyword">do</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>      a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span> a <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Testvalue of a<span class="token operator">:</span> <span class="token number">10</span>value of a<span class="token operator">:</span> <span class="token number">11</span>value of a<span class="token operator">:</span> <span class="token number">12</span>value of a<span class="token operator">:</span> <span class="token number">13</span>value of a<span class="token operator">:</span> <span class="token number">14</span>value of a<span class="token operator">:</span> <span class="token number">15</span>value of a<span class="token operator">:</span> <span class="token number">16</span>value of a<span class="token operator">:</span> <span class="token number">17</span>value of a<span class="token operator">:</span> <span class="token number">18</span>value of a<span class="token operator">:</span> <span class="token number">19</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-1-3-Scala-for循环"><a href="#8-1-3-Scala-for循环" class="headerlink" title="8.1.3 Scala for循环"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_813-scala-for%E5%BE%AA%E7%8E%AF">8.1.3 Scala for循环</a></h3><h4 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=for%E5%BE%AA%E7%8E%AF">for循环</a></h4><p><strong>语法</strong></p><p>Scala 语言中 <strong>for</strong> 循环的语法：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">var</span> x <span class="token keyword">&lt;-</span> Range <span class="token punctuation">)</span><span class="token punctuation">{</span>   statement<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>以上语法中，<strong>Range</strong> 可以是一个数字区间表示 <strong>i to j</strong> ，或者 <strong>i until j</strong>。左箭头 &lt;- 用于为变量 x 赋值。</p><p><strong>示例</strong></p><p>以下是一个使用了 <strong>i to j</strong> 语法(包含 j)的实例:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// for 循环</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> a <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Testvalue of a<span class="token operator">:</span> <span class="token number">1</span>value of a<span class="token operator">:</span> <span class="token number">2</span>value of a<span class="token operator">:</span> <span class="token number">3</span>value of a<span class="token operator">:</span> <span class="token number">4</span>value of a<span class="token operator">:</span> <span class="token number">5</span>value of a<span class="token operator">:</span> <span class="token number">6</span>value of a<span class="token operator">:</span> <span class="token number">7</span>value of a<span class="token operator">:</span> <span class="token number">8</span>value of a<span class="token operator">:</span> <span class="token number">9</span>value of a<span class="token operator">:</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下是一个使用了 <strong>i until j</strong> 语法(不包含 j)的实例:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// for 循环</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> a <span class="token keyword">&lt;-</span> <span class="token number">1</span> until <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Testvalue of a<span class="token operator">:</span> <span class="token number">1</span>value of a<span class="token operator">:</span> <span class="token number">2</span>value of a<span class="token operator">:</span> <span class="token number">3</span>value of a<span class="token operator">:</span> <span class="token number">4</span>value of a<span class="token operator">:</span> <span class="token number">5</span>value of a<span class="token operator">:</span> <span class="token number">6</span>value of a<span class="token operator">:</span> <span class="token number">7</span>value of a<span class="token operator">:</span> <span class="token number">8</span>value of a<span class="token operator">:</span> <span class="token number">9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <strong>for 循环</strong> 中你可以使用分号 (;) 来设置多个区间，它将迭代给定区间所有的可能值。以下实例演示了两个区间的循环实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// for 循环</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> a <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">3</span><span class="token punctuation">;</span> b <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of b: "</span> <span class="token operator">+</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestValue of a<span class="token operator">:</span> <span class="token number">1</span>Value of b<span class="token operator">:</span> <span class="token number">1</span>Value of a<span class="token operator">:</span> <span class="token number">1</span>Value of b<span class="token operator">:</span> <span class="token number">2</span>Value of a<span class="token operator">:</span> <span class="token number">1</span>Value of b<span class="token operator">:</span> <span class="token number">3</span>Value of a<span class="token operator">:</span> <span class="token number">2</span>Value of b<span class="token operator">:</span> <span class="token number">1</span>Value of a<span class="token operator">:</span> <span class="token number">2</span>Value of b<span class="token operator">:</span> <span class="token number">2</span>Value of a<span class="token operator">:</span> <span class="token number">2</span>Value of b<span class="token operator">:</span> <span class="token number">3</span>Value of a<span class="token operator">:</span> <span class="token number">3</span>Value of b<span class="token operator">:</span> <span class="token number">1</span>Value of a<span class="token operator">:</span> <span class="token number">3</span>Value of b<span class="token operator">:</span> <span class="token number">2</span>Value of a<span class="token operator">:</span> <span class="token number">3</span>Value of b<span class="token operator">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="for循环集合"><a href="#for循环集合" class="headerlink" title="for循环集合"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=for%E5%BE%AA%E7%8E%AF%E9%9B%86%E5%90%88">for循环集合</a></h4><p>for 循环集合的语法如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">for</span><span class="token punctuation">(</span> x <span class="token keyword">&lt;-</span> List <span class="token punctuation">)</span><span class="token punctuation">{</span>   statement<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>以上语法中， <strong>List</strong> 变量是一个集合，for 循环会迭代所有集合的元素。</p><p><strong>示例</strong></p><p>以下实例将循环数字集合。我们使用 <em>List()</em> 来创建集合。再以后章节我们会详细介绍集合。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> numList <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// for 循环</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> a <span class="token keyword">&lt;-</span> numList <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Testvalue of a<span class="token operator">:</span> <span class="token number">1</span>value of a<span class="token operator">:</span> <span class="token number">2</span>value of a<span class="token operator">:</span> <span class="token number">3</span>value of a<span class="token operator">:</span> <span class="token number">4</span>value of a<span class="token operator">:</span> <span class="token number">5</span>value of a<span class="token operator">:</span> <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="for循环过滤"><a href="#for循环过滤" class="headerlink" title="for循环过滤"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=for%E5%BE%AA%E7%8E%AF%E8%BF%87%E6%BB%A4">for循环过滤</a></h4><p>Scala 可以使用一个或多个 <strong>if</strong> 语句来过滤一些元素。</p><p>以下是在 for 循环中使用过滤器的语法。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">var</span> x <span class="token keyword">&lt;-</span> List    <span class="token keyword">if</span> condition1<span class="token punctuation">;</span> <span class="token keyword">if</span> condition2<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token punctuation">)</span><span class="token punctuation">{</span>  statement<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>你可以使用分号(;)来为表达式添加一个或多个的过滤条件。</p><p><strong>示例</strong></p><p>以下是 for 循环中过滤的实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> numList <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// for 循环</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> a <span class="token keyword">&lt;-</span> numList        <span class="token keyword">if</span> a <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token keyword">if</span> a <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Testvalue of a<span class="token operator">:</span> <span class="token number">1</span>value of a<span class="token operator">:</span> <span class="token number">2</span>value of a<span class="token operator">:</span> <span class="token number">4</span>value of a<span class="token operator">:</span> <span class="token number">5</span>value of a<span class="token operator">:</span> <span class="token number">6</span>value of a<span class="token operator">:</span> <span class="token number">7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="for使用yield"><a href="#for使用yield" class="headerlink" title="for使用yield"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=for%E4%BD%BF%E7%94%A8yield">for使用yield</a></h4><p>你可以将 for 循环的返回值作为一个变量存储。语法格式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> retVal <span class="token operator">=</span> <span class="token keyword">for</span><span class="token punctuation">{</span> <span class="token keyword">var</span> x <span class="token keyword">&lt;-</span> List                 <span class="token keyword">if</span> condition1<span class="token punctuation">;</span> <span class="token keyword">if</span> condition2<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                <span class="token punctuation">}</span><span class="token keyword">yield</span> x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>注意<strong>大括号</strong>中用于保存变量和条件，<em>retVal</em> 是变量， 循环中的 yield 会把当前的元素记下来，保存在集合中，循环结束后将返回该集合。</p><p><strong>示例</strong></p><p>以下实例演示了 for 循环中使用 yield：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> numList <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// for 循环</span>    <span class="token keyword">var</span> retVal <span class="token operator">=</span> <span class="token keyword">for</span><span class="token punctuation">{</span> a <span class="token keyword">&lt;-</span> numList                     <span class="token keyword">if</span> a <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token keyword">if</span> a <span class="token operator">&lt;</span> <span class="token number">8</span>                    <span class="token punctuation">}</span><span class="token keyword">yield</span> a    <span class="token comment">// 输出返回值</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> a <span class="token keyword">&lt;-</span> retVal<span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Testvalue of a<span class="token operator">:</span> <span class="token number">1</span>value of a<span class="token operator">:</span> <span class="token number">2</span>value of a<span class="token operator">:</span> <span class="token number">4</span>value of a<span class="token operator">:</span> <span class="token number">5</span>value of a<span class="token operator">:</span> <span class="token number">6</span>value of a<span class="token operator">:</span> <span class="token number">7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-2-循环控制语句"><a href="#8-2-循环控制语句" class="headerlink" title="8.2 循环控制语句"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_82-%E5%BE%AA%E7%8E%AF%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5">8.2 循环控制语句</a></h2><p>循环控制语句改变你代码的执行顺序，通过它你可以实现代码的跳转。Scala 以下几种循环控制语句：</p><p>Scala 不支持 break 或 continue 语句，但从 2.8 版本后提供了一种中断循环的方式，点击以下链接查看详情。</p><table><thead><tr><th>控制语句</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://www.runoob.com/scala/scala-break-statement.html">break 语句</a></td><td>中断循环</td></tr></tbody></table><h3 id="8-2-1-Scala-break-语句"><a href="#8-2-1-Scala-break-语句" class="headerlink" title="8.2.1 Scala break 语句"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_821-scala-break-%E8%AF%AD%E5%8F%A5">8.2.1 Scala break 语句</a></h3><h4 id="break"><a href="#break" class="headerlink" title="break"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=break">break</a></h4><p>Scala 语言中默认是没有 break 语句，但是你在 Scala 2.8 版本后可以使用另外一种方式来实现 <em>break</em> 语句。当在循环中使用 <strong>break</strong> 语句，在执行到该语句时，就会中断循环并执行循环体之后的代码块。</p><p><strong>语法</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">Scala 中 break 的语法有点不大一样，格式如下：<span class="token comment">// 导入以下包</span><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>control<span class="token punctuation">.</span></span>_<span class="token comment">// 创建 Breaks 对象</span><span class="token keyword">val</span> loop <span class="token operator">=</span> <span class="token keyword">new</span> Breaks<span class="token punctuation">;</span><span class="token comment">// 在 breakable 中循环</span>loop<span class="token punctuation">.</span>breakable<span class="token punctuation">{</span>  <span class="token comment">// 循环</span>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment">// 循环中断</span>    loop<span class="token punctuation">.</span>break<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>流程图</strong></p><p><img src="https://www.runoob.com/wp-content/uploads/2013/11/cpp_break_statement.jpg"></p><p><strong>示例</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>control<span class="token punctuation">.</span></span>_<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> numList <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> loop <span class="token operator">=</span> <span class="token keyword">new</span> Breaks<span class="token punctuation">;</span>    loop<span class="token punctuation">.</span>breakable <span class="token punctuation">{</span>      <span class="token keyword">for</span><span class="token punctuation">(</span> a <span class="token keyword">&lt;-</span> numList<span class="token punctuation">)</span><span class="token punctuation">{</span>        println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> a <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>          loop<span class="token punctuation">.</span>break<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    println<span class="token punctuation">(</span> <span class="token string">"After the loop"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestValue of a<span class="token operator">:</span> <span class="token number">1</span>Value of a<span class="token operator">:</span> <span class="token number">2</span>Value of a<span class="token operator">:</span> <span class="token number">3</span>Value of a<span class="token operator">:</span> <span class="token number">4</span>After the loop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="中断嵌套循环"><a href="#中断嵌套循环" class="headerlink" title="中断嵌套循环"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=%E4%B8%AD%E6%96%AD%E5%B5%8C%E5%A5%97%E5%BE%AA%E7%8E%AF">中断嵌套循环</a></h4><p>以下实例演示了如何中断嵌套循环：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>control<span class="token punctuation">.</span></span>_<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> numList1 <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> numList2 <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">val</span> outer <span class="token operator">=</span> <span class="token keyword">new</span> Breaks<span class="token punctuation">;</span>    <span class="token keyword">val</span> inner <span class="token operator">=</span> <span class="token keyword">new</span> Breaks<span class="token punctuation">;</span>    outer<span class="token punctuation">.</span>breakable <span class="token punctuation">{</span>      <span class="token keyword">for</span><span class="token punctuation">(</span> a <span class="token keyword">&lt;-</span> numList1<span class="token punctuation">)</span><span class="token punctuation">{</span>        println<span class="token punctuation">(</span> <span class="token string">"Value of a: "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>        inner<span class="token punctuation">.</span>breakable <span class="token punctuation">{</span>          <span class="token keyword">for</span><span class="token punctuation">(</span> b <span class="token keyword">&lt;-</span> numList2<span class="token punctuation">)</span><span class="token punctuation">{</span>            println<span class="token punctuation">(</span> <span class="token string">"Value of b: "</span> <span class="token operator">+</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> b <span class="token operator">==</span> <span class="token number">12</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>              inner<span class="token punctuation">.</span>break<span class="token punctuation">;</span>            <span class="token punctuation">}</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token comment">// 内嵌循环中断</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token comment">// 外部循环中断</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestValue of a<span class="token operator">:</span> <span class="token number">1</span>Value of b<span class="token operator">:</span> <span class="token number">11</span>Value of b<span class="token operator">:</span> <span class="token number">12</span>Value of a<span class="token operator">:</span> <span class="token number">2</span>Value of b<span class="token operator">:</span> <span class="token number">11</span>Value of b<span class="token operator">:</span> <span class="token number">12</span>Value of a<span class="token operator">:</span> <span class="token number">3</span>Value of b<span class="token operator">:</span> <span class="token number">11</span>Value of b<span class="token operator">:</span> <span class="token number">12</span>Value of a<span class="token operator">:</span> <span class="token number">4</span>Value of b<span class="token operator">:</span> <span class="token number">11</span>Value of b<span class="token operator">:</span> <span class="token number">12</span>Value of a<span class="token operator">:</span> <span class="token number">5</span>Value of b<span class="token operator">:</span> <span class="token number">11</span>Value of b<span class="token operator">:</span> <span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-3-无限循环"><a href="#8-3-无限循环" class="headerlink" title="8.3 无限循环"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_83-%E6%97%A0%E9%99%90%E5%BE%AA%E7%8E%AF">8.3 无限循环</a></h2><p>如果条件永远为 true，则循环将变成无限循环。我们可以使用 while 语句来实现无限循环：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token comment">// 无限循环</span>    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"a 的值为 : "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上代码执行后循环会永久执行下去，你可以使用 Ctrl + C 键来中断无限循环。</p><p>Scala 有方法与函数，二者在语义上的区别很小。Scala 方法是类的一部分，而函数是一个对象可以赋值给一个变量。换句话来说在类中定义的函数即是方法。</p><p>Scala 中的方法跟 Java 的类似，方法是组成类的一部分。</p><p>Scala 中的函数则是一个完整的对象，Scala 中的函数其实就是继承了 Trait 的类的对象。</p><p>Scala 中使用 <strong>val</strong> 语句可以定义函数，<strong>def</strong> 语句定义方法。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">class</span> Test<span class="token punctuation">{</span>  <span class="token keyword">def</span> m<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">3</span>  <span class="token keyword">val</span> f <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意：</strong> 有些翻译上函数(function)与方法(method)是没有区别的。</p></blockquote><h2 id="9-1-方法声明"><a href="#9-1-方法声明" class="headerlink" title="9.1 方法声明"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_91-%E6%96%B9%E6%B3%95%E5%A3%B0%E6%98%8E">9.1 方法声明</a></h2><p>Scala 方法声明格式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">def</span> functionName <span class="token punctuation">(</span><span class="token punctuation">[</span>参数列表<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">return</span> <span class="token keyword">type</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果你不写等于号和方法主体，那么方法会被隐式声明为**抽象(abstract)**，包含它的类型于是也是一个抽象类型。</p><h2 id="9-2-方法定义"><a href="#9-2-方法定义" class="headerlink" title="9.2 方法定义"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_92-%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89">9.2 方法定义</a></h2><p>方法定义由一个 <strong>def</strong> 关键字开始，紧接着是可选的参数列表，一个冒号 <strong>:</strong> 和方法的返回类型，一个等于号 <strong>=</strong> ，最后是方法的主体。</p><p>Scala 方法定义格式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">def</span> functionName <span class="token punctuation">(</span><span class="token punctuation">[</span>参数列表<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">return</span> <span class="token keyword">type</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>   function body   <span class="token keyword">return</span> <span class="token punctuation">[</span>expr<span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>以上代码中 <strong>return type</strong> 可以是任意合法的 Scala 数据类型。参数列表中的参数可以使用逗号分隔。</p><p>以下方法的功能是将两个传入的参数相加并求和：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> add<span class="token punctuation">{</span>  <span class="token keyword">def</span> addInt<span class="token punctuation">(</span> a<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span> b<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span>    sum <span class="token operator">=</span> a <span class="token operator">+</span> b    <span class="token keyword">return</span> sum  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果方法没有返回值，可以返回为 <strong>Unit</strong>，这个类似于 Java 的 <strong>void</strong>, 实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Hello<span class="token punctuation">{</span>  <span class="token keyword">def</span> printMe<span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span><span class="token string">"Hello, Scala!"</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="9-3-方法调用"><a href="#9-3-方法调用" class="headerlink" title="9.3 方法调用"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_93-%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8">9.3 方法调用</a></h2><p>Scala 提供了多种不同的方法调用方式：</p><p>以下是调用方法的标准格式：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">functionName<span class="token punctuation">(</span> 参数列表 <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果方法使用了实例的对象来调用，我们可以使用类似java的格式 (使用 <strong>.</strong> 号)：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token punctuation">[</span>instance<span class="token punctuation">.</span><span class="token punctuation">]</span>functionName<span class="token punctuation">(</span> 参数列表 <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以上实例演示了定义与调用方法的实例:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span> <span class="token string">"Returned Value : "</span> <span class="token operator">+</span> addInt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> addInt<span class="token punctuation">(</span> a<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span> b<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span>    sum <span class="token operator">=</span> a <span class="token operator">+</span> b    <span class="token keyword">return</span> sum  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-none"><code class="language-none">$ scalac Test.scala $ scala TestReturned Value : 12<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Scala 也是一种函数式语言，所以函数是 Scala 语言的核心。以下一些函数概念有助于我们更好的理解 Scala 编程：</p><table><thead><tr><th>函数概念解析接案例</th><th></th></tr></thead><tbody><tr><td><a href="https://www.runoob.com/scala/functions-call-by-name.html">函数传名调用(Call-by-Name)</a></td><td><a href="https://www.runoob.com/scala/functions-named-arguments.html">指定函数参数名</a></td></tr><tr><td><a href="https://www.runoob.com/scala/functions-variable-arguments.html">函数 - 可变参数</a></td><td><a href="https://www.runoob.com/scala/recursion-functions.html">递归函数</a></td></tr><tr><td><a href="https://www.runoob.com/scala/functions-default-parameter-values.html">默认参数值</a></td><td><a href="https://www.runoob.com/scala/higher-order-functions.html">高阶函数</a></td></tr><tr><td><a href="https://www.runoob.com/scala/nested-functions.html">内嵌函数</a></td><td><a href="https://www.runoob.com/scala/anonymous-functions.html">匿名函数</a></td></tr><tr><td><a href="https://www.runoob.com/scala/partially-applied-functions.html">偏应用函数</a></td><td><a href="https://www.runoob.com/scala/currying-functions.html">函数柯里化(Function Currying)</a></td></tr></tbody></table><h3 id="9-3-0-方法method和函数function的区别"><a href="#9-3-0-方法method和函数function的区别" class="headerlink" title="9.3.0 方法method和函数function的区别"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_930-%E6%96%B9%E6%B3%95method%E5%92%8C%E5%87%BD%E6%95%B0function%E7%9A%84%E5%8C%BA%E5%88%AB">9.3.0 方法method和函数function的区别</a></h3><blockquote><p><a href="https://www.runoob.com/scala/scala-functions.html">Scala 方法与函数</a> &lt;= 以下内容来自该文章最下面的高分笔记</p></blockquote><h4 id="方法和函数的区别"><a href="#方法和函数的区别" class="headerlink" title="方法和函数的区别"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=%E6%96%B9%E6%B3%95%E5%92%8C%E5%87%BD%E6%95%B0%E7%9A%84%E5%8C%BA%E5%88%AB">方法和函数的区别</a></h4><p>1、函数可作为一个参数传入到方法中，而方法不行。</p><p><img src="https://www.runoob.com/wp-content/uploads/2018/05/scalafunction1.png"></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> MethodAndFunctionDemo <span class="token punctuation">{</span>  <span class="token comment">//定义一个方法</span>  <span class="token comment">//方法 m1 参数要求是一个函数，函数的参数必须是两个Int类型</span>  <span class="token comment">//返回值类型也是Int类型</span>  <span class="token keyword">def</span> m1<span class="token punctuation">(</span>f<span class="token operator">:</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    f<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment">//定义一个函数f1,参数是两个Int类型，返回值是一个Int类型</span>  <span class="token keyword">val</span> f1 <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> x <span class="token operator">+</span> y  <span class="token comment">//再定义一个函数f2</span>  <span class="token keyword">val</span> f2 <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>n<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> m <span class="token operator">*</span> n  <span class="token comment">//main方法</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment">//调用m1方法，并传入f1函数</span>    <span class="token keyword">val</span> r1 <span class="token operator">=</span> m1<span class="token punctuation">(</span>f1<span class="token punctuation">)</span>    println<span class="token punctuation">(</span>r1<span class="token punctuation">)</span>    <span class="token comment">//调用m1方法，并传入f2函数</span>    <span class="token keyword">val</span> r2 <span class="token operator">=</span> m1<span class="token punctuation">(</span>f2<span class="token punctuation">)</span>    println<span class="token punctuation">(</span>r2<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token number">8</span><span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>2、在Scala中无法直接操作方法，如果要操作方法，必须先将其转换成函数。有两种方法可以将方法转换成函数：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> f1 <span class="token operator">=</span> m _<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在方法名称m后面紧跟一个空格和下划线告诉编译器将方法m转换成函数，而不是要调用这个方法。 也可以显示地告诉编译器需要将方法转换成函数：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> f1<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span> <span class="token operator">=</span> m<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>通常情况下编译器会自动将方法转换成函数，例如在一个应该传入函数参数的地方传入了一个方法，编译器会自动将传入的方法转换成函数。</p><p><img src="https://www.runoob.com/wp-content/uploads/2018/05/scalafunction2.png"></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> TestMap <span class="token punctuation">{</span>  <span class="token keyword">def</span> ttt<span class="token punctuation">(</span>f<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> r <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>r<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">val</span> f0 <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> x <span class="token operator">*</span> x  <span class="token comment">//定义了一个方法</span>  <span class="token keyword">def</span> m0<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment">//传递进来的参数乘以10</span>    x <span class="token operator">*</span> <span class="token number">10</span>  <span class="token punctuation">}</span>  <span class="token comment">//将方法转换成函数，利用了神奇的下滑线</span>  <span class="token keyword">val</span> f1 <span class="token operator">=</span> m0 _  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    ttt<span class="token punctuation">(</span>f0<span class="token punctuation">)</span>    <span class="token comment">//通过m0 _将方法转化成函数</span>    ttt<span class="token punctuation">(</span>m0 _<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//如果直接传递的是方法名称，scala相当于是把方法转成了函数</span>    ttt<span class="token punctuation">(</span>m0<span class="token punctuation">)</span>    <span class="token comment">//通过x =&gt; m0(x)的方式将方法转化成函数,这个函数是一个匿名函数，等价：(x:Int) =&gt; m0(x)</span>    ttt<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> m0<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token number">100</span><span class="token number">100</span><span class="token number">100</span><span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>3、函数必须要有参数列表，而方法可以没有参数列表</p><p><img src="https://www.runoob.com/wp-content/uploads/2018/05/131403339175801.png"></p><p>4、在函数出现的地方我们可以提供一个方法</p><p>在需要函数的地方，如果传递一个方法，会自动进行ETA展开（把方法转换为函数）</p><p><img src="https://www.runoob.com/wp-content/uploads/2018/05/1527498797-6462-201504.png"></p><p>如果我们直接把一个方法赋值给变量会报错。如果我们指定变量的类型就是函数，那么就可以通过编译，如下：</p><p><img src="https://www.runoob.com/wp-content/uploads/2018/05/1527498797-2557-201504.png"></p><p>当然我们也可以强制把一个方法转换给函数，这就用到了 scala 中的部分应用函数：</p><p><img src="https://www.runoob.com/wp-content/uploads/2018/05/1527498797-2599-201504.png"></p><hr><h4 id="scala-method-和-function-的区别"><a href="#scala-method-和-function-的区别" class="headerlink" title="scala method 和 function 的区别"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=scala-method-%E5%92%8C-function-%E7%9A%84%E5%8C%BA%E5%88%AB">scala method 和 function 的区别</a></h4><p>英文原文：</p><p>A <strong>Function Type</strong> is (roughly) a type of the form <em>(T1, …, Tn) =&gt; U</em>, which is a shorth and for the trait <code>FunctionN</code> in the standard library. <strong>Anonymous Functions</strong> and <strong>Method Values</strong> have function types, and function types can be used as part of value, variable and function declarations and definitions. In fact, it can be part of a method type.</p><p>A <strong>Method Type</strong> is a <strong><em>non-value type</em></strong>. That means there is <strong><em>no</em></strong> value - no object, no instance - with a method type. As mentioned above, a <strong>Method Value</strong> actually has a <strong>Function Type</strong>. A method type is a <code>def</code> declaration - everything about a <code>def</code> except its body.</p><p>例子：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> <span class="token keyword">def</span> m1<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> x<span class="token operator">+</span><span class="token number">3</span>m1<span class="token operator">:</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token builtin">Int</span>　　　　scala<span class="token operator">&gt;</span> <span class="token keyword">val</span> f1 <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> x<span class="token operator">+</span><span class="token number">3</span>f1<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span>function1<span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看到没，方法定义和函数定义是不是在scala的解析器signature上就有显示了，def m1(x: Int) = x+3就是一个简单的method的定义。signature中m1: (x: Int)Int　表示method m1有一个参数Int型参数x，返回值是Int型。</p><p>val f1 = (x: Int) =&gt; x+3则是function的定义，解析器的signature中f1: Int =&gt; Int = <function1>表示function f1的method体接受一个Int型的参数，输出结果的类型是Int型。</function1></p><p>从上面的例子，得出一个总结：</p><p><strong>方法是一个以def开头的带有参数列表（可以无参数列表）的一个逻辑操作块，这正如object或者class中的成员方法一样。</strong> </p><p><strong>函数是一个赋值给一个变量（或者常量）的匿名方法（带或者不带参数列表），并且通过=&gt;转换符号跟上逻辑代码块的一个表达式。=&gt;转换符号后面的逻辑代码块的写法与method的body部分相同。</strong> </p><h5 id="其他区别"><a href="#其他区别" class="headerlink" title="其他区别"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=%E5%85%B6%E4%BB%96%E5%8C%BA%E5%88%AB">其他区别</a></h5><p>method 可以作为一个表达式的一部分出现（调用函数并传参），但是 method（带参方法）不能作为最终的表达式（无参方法可以，但是这个就成了方法调用，因为 <strong>scala 允许无参方法调用时省略（）括号</strong>），而 function 可以作为最终的表达式出现。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> m1<span class="token generics"><span class="token punctuation">&lt;</span>console<span class="token punctuation">&gt;</span></span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span> error<span class="token operator">:</span> missing arguments <span class="token keyword">for</span> method m1<span class="token punctuation">;</span>follow <span class="token keyword">this</span> method <span class="token keyword">with</span> `_' <span class="token keyword">if</span> you want to <span class="token namespace">treat</span> it as a partially applied function       m1       <span class="token operator">^</span>scala<span class="token operator">&gt;</span> f1res1<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span>function1<span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>method 可以没有参数列表，参数列表也可以为空。但是 function 必须有参数列表（也可以为空）。</p><p><strong>方法名意味着方法调用，函数名只是代表函数自身</strong>：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> <span class="token keyword">def</span> m2 <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>m2<span class="token operator">:</span> <span class="token builtin">Int</span>scala<span class="token operator">&gt;</span> <span class="token keyword">def</span> m3<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>m3<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">Int</span>scala<span class="token operator">&gt;</span> <span class="token keyword">var</span> f2 <span class="token operator">=</span> <span class="token keyword">=&gt;</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token generics"><span class="token punctuation">&lt;</span>console<span class="token punctuation">&gt;</span></span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span> error<span class="token operator">:</span> illegal start of simple expression<span class="token keyword">var</span> f2 <span class="token operator">=</span> <span class="token keyword">=&gt;</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">^</span>scala<span class="token operator">&gt;</span> <span class="token keyword">var</span> f2 <span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">=&gt;</span> <span class="token number">100</span><span class="token punctuation">;</span>f2<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span>function0<span class="token punctuation">&gt;</span></span>scala<span class="token operator">&gt;</span> m2res2<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">100</span>scala<span class="token operator">&gt;</span> m3res3<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">1000</span>scala<span class="token operator">&gt;</span> m3<span class="token punctuation">(</span><span class="token punctuation">)</span>res4<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">1000</span>scala<span class="token operator">&gt;</span> f2res5<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span>function0<span class="token punctuation">&gt;</span></span>scala<span class="token operator">&gt;</span> f2<span class="token punctuation">(</span><span class="token punctuation">)</span>res6<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在函数出现的地方我们可以提供一个方法。</p><p>这是因为，<strong>如果期望出现函数的地方我们提供了一个方法的话，该方法就会自动被转换成函数。该行为被称为 ETA expansion</strong>。</p><p>注意：</p><p>期望出现函数的地方，我们可以使用方法。</p><p><strong>不期望出现函数的地方，方法并不会自动转换成函数</strong>。</p><p><strong>在 scala 中操作符被解释称方法</strong>：　</p><ul><li>  前缀操作符：op obj 被解释称 obj.op</li><li>  中缀操作符：obj1 op obj2 被解释称 obj1.op(obj2)</li><li>  后缀操作符：obj op 被解释称 obj.op</li></ul><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> <span class="token keyword">val</span> ml <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>ml<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>scala<span class="token operator">&gt;</span> ml<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">=&gt;</span><span class="token number">2</span><span class="token operator">*</span>x<span class="token punctuation">)</span>res0<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>scala<span class="token operator">&gt;</span> <span class="token keyword">def</span> m<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>xm<span class="token operator">:</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token builtin">Int</span>scala<span class="token operator">&gt;</span> ml<span class="token punctuation">.</span>map<span class="token punctuation">(</span>m<span class="token punctuation">)</span>res1<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>scala<span class="token operator">&gt;</span> <span class="token keyword">def</span> m<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">*</span>xm<span class="token operator">:</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token builtin">Int</span>scala<span class="token operator">&gt;</span> ml<span class="token punctuation">.</span>map<span class="token punctuation">(</span>m<span class="token punctuation">)</span>res2<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>可以在方法名后面加一个下划线强制变成函数</strong>。</p><p><strong>注意：</strong>  方法名与下划线之间至少有一个空格哟!</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> <span class="token keyword">def</span> m3<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> x <span class="token operator">*</span> x <span class="token operator">*</span> xm3<span class="token operator">:</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token builtin">Int</span>scala<span class="token operator">&gt;</span> <span class="token keyword">val</span> f3 <span class="token operator">=</span> m3_<span class="token generics"><span class="token punctuation">&lt;</span>console<span class="token punctuation">&gt;</span></span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span> error<span class="token operator">:</span> not found<span class="token operator">:</span> value m3_       <span class="token keyword">val</span> f3 <span class="token operator">=</span> m3_                <span class="token operator">^</span>scala<span class="token operator">&gt;</span> <span class="token keyword">val</span> f3 <span class="token operator">=</span> m3 _f3<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token generics"><span class="token punctuation">&lt;</span>function1<span class="token punctuation">&gt;</span></span>scala<span class="token operator">&gt;</span> f3<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>res0<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">27</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-3-1-Scala-函数传名调用-call-by-name"><a href="#9-3-1-Scala-函数传名调用-call-by-name" class="headerlink" title="9.3.1 Scala 函数传名调用(call-by-name)"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_931-scala-%E5%87%BD%E6%95%B0%E4%BC%A0%E5%90%8D%E8%B0%83%E7%94%A8call-by-name">9.3.1 Scala 函数传名调用(call-by-name)</a></h3><p>Scala的解释器在解析函数参数(function arguments)时有两种方式：</p><ul><li>  传值调用（call-by-value）：先计算参数表达式的值，再应用到函数内部；</li><li>  <strong>传名调用（call-by-name）：将未计算的参数表达式直接应用到函数内部</strong></li></ul><p>在进入函数内部前，传值调用方式就已经将参数表达式的值计算完毕，而传名调用是在函数内部进行参数表达式的值计算的。</p><p>这就造成了一种现象，每次使用传名调用时，解释器都会计算一次表达式的值。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>   <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        delayed<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">def</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"获取时间，单位为纳秒"</span><span class="token punctuation">)</span>      System<span class="token punctuation">.</span>nanoTime   <span class="token punctuation">}</span>   <span class="token keyword">def</span> delayed<span class="token punctuation">(</span> t<span class="token operator">:</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Long</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"在 delayed 方法内"</span><span class="token punctuation">)</span>      println<span class="token punctuation">(</span><span class="token string">"参数： "</span> <span class="token operator">+</span> t<span class="token punctuation">)</span>      t   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上实例中我们声明了 delayed 方法， 该方法在<strong>变量名和变量类型使用 =&gt; 符号来设置传名调用</strong>。</p><p>执行以上代码，输出结果如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala $ scala Test在 delayed 方法内获取时间，单位为纳秒参数： <span class="token number">241550840475831</span>获取时间，单位为纳秒<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-3-2-Scala-指定函数参数名"><a href="#9-3-2-Scala-指定函数参数名" class="headerlink" title="9.3.2 Scala 指定函数参数名"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_932-scala-%E6%8C%87%E5%AE%9A%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E5%90%8D">9.3.2 Scala 指定函数参数名</a></h3><p>一般情况下函数调用参数，就按照函数定义时的参数顺序一个个传递。</p><p>但是<strong>我们也可以通过指定函数参数名，并且不需要按照顺序向函数传递参数</strong>，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>   <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        printInt<span class="token punctuation">(</span>b<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> a<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">def</span> printInt<span class="token punctuation">(</span> a<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span> b<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"Value of a : "</span> <span class="token operator">+</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>      println<span class="token punctuation">(</span><span class="token string">"Value of b : "</span> <span class="token operator">+</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestValue of a <span class="token operator">:</span>  <span class="token number">7</span>Value of b <span class="token operator">:</span>  <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-3-3-Scala-函数-可变参数"><a href="#9-3-3-Scala-函数-可变参数" class="headerlink" title="9.3.3 Scala 函数 - 可变参数"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_933-scala-%E5%87%BD%E6%95%B0-%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0">9.3.3 Scala 函数 - 可变参数</a></h3><p>Scala 允许你指明函数的<strong>最后一个参数</strong>可以是重复的，即我们不需要指定函数参数的个数，可以向函数传入可变长度参数列表。</p><p>Scala 通过在参数的类型之后放一个<strong>星号</strong>来设置可变参数(可重复的参数)。例如：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    printStrings<span class="token punctuation">(</span><span class="token string">"Runoob"</span><span class="token punctuation">,</span> <span class="token string">"Scala"</span><span class="token punctuation">,</span> <span class="token string">"Python"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> printStrings<span class="token punctuation">(</span> args<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> i <span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span> arg <span class="token keyword">&lt;-</span> args <span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"Arg value["</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">"] = "</span> <span class="token operator">+</span> arg <span class="token punctuation">)</span><span class="token punctuation">;</span>      i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestArg value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> RunoobArg value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ScalaArg value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Python<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-3-4-Scala-函数-默认参数值"><a href="#9-3-4-Scala-函数-默认参数值" class="headerlink" title="9.3.4 Scala 函数 - 默认参数值"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_934-scala-%E5%87%BD%E6%95%B0-%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0%E5%80%BC">9.3.4 Scala 函数 - 默认参数值</a></h3><p>Scala 可以为函数参数指定默认参数值，使用了默认参数，你在调用函数的过程中可以不需要传递参数，这时函数就会调用它的默认参数值，如果传递了参数，则传递值会取代默认值。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span> <span class="token string">"返回值 : "</span> <span class="token operator">+</span> addInt<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> addInt<span class="token punctuation">(</span> a<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> b<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">7</span> <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span>    sum <span class="token operator">=</span> a <span class="token operator">+</span> b    <span class="token keyword">return</span> sum  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Test返回值 <span class="token operator">:</span> <span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="9-3-5-Scala-函数嵌套"><a href="#9-3-5-Scala-函数嵌套" class="headerlink" title="9.3.5 Scala 函数嵌套"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_935-scala-%E5%87%BD%E6%95%B0%E5%B5%8C%E5%A5%97">9.3.5 Scala 函数嵌套</a></h3><p>我们可以在 Scala 函数内定义函数，<strong>定义在函数内的函数称之为局部函数</strong>。</p><p>以下实例我们实现阶乘运算，并使用内嵌函数：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span> factorial<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> factorial<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> factorial<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> factorial<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> factorial<span class="token punctuation">(</span>i<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">def</span> fact<span class="token punctuation">(</span>i<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> accumulator<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>      accumulator      <span class="token keyword">else</span>      fact<span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> i <span class="token operator">*</span> accumulator<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    fact<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Test<span class="token number">1</span><span class="token number">1</span><span class="token number">2</span><span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-3-6-Scala-匿名函数"><a href="#9-3-6-Scala-匿名函数" class="headerlink" title="9.3.6 Scala 匿名函数"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_936-scala-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0">9.3.6 Scala 匿名函数</a></h3><p>Scala 中定义匿名函数的语法很简单，箭头左边是参数列表，右边是函数体。</p><p>使用匿名函数后，我们的代码变得更简洁了。</p><p>下面的表达式就定义了一个接受一个Int类型输入参数的匿名函数:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> inc <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> x<span class="token operator">+</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上述定义的匿名函数，其实是下面这种写法的简写：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">def</span> add2 <span class="token operator">=</span> <span class="token keyword">new</span> Function1<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">{</span>    <span class="token keyword">def</span> apply<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>以上实例的 inc 现在可作为一个函数，使用方式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> x <span class="token operator">=</span> inc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>同样我们可以在匿名函数中定义多个参数：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> mul <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> x<span class="token operator">*</span>y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>mul 现在可作为一个函数，使用方式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">println<span class="token punctuation">(</span>mul<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们也可以不给匿名函数设置参数，如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> userDir <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span> System<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">"user.dir"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>userDir 现在可作为一个函数，使用方式如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">println<span class="token punctuation">(</span> userDir<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>示例</strong></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Demo <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span> <span class="token string">"multiplier(1) value = "</span> <span class="token operator">+</span>  multiplier<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"multiplier(2) value = "</span> <span class="token operator">+</span>  multiplier<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">var</span> factor <span class="token operator">=</span> <span class="token number">3</span>  <span class="token keyword">val</span> multiplier <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> i <span class="token operator">*</span> factor<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将以上代码保持到 Demo.scala 文件中，执行以下命令：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Demo<span class="token punctuation">.</span>scala$ scala Demo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">multiplier<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token number">3</span>multiplier<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="9-3-7-Scala-递归函数"><a href="#9-3-7-Scala-递归函数" class="headerlink" title="9.3.7 Scala 递归函数"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_937-scala-%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0">9.3.7 Scala 递归函数</a></h3><p>递归函数在函数式编程的语言中起着重要的作用。</p><p>Scala 同样支持递归函数。</p><p>递归函数意味着函数可以调用它本身。</p><p>以上实例使用递归函数来计算阶乘：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token number">10</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">" 的阶乘为: = "</span> <span class="token operator">+</span> factorial<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> factorial<span class="token punctuation">(</span>n<span class="token operator">:</span> BigInt<span class="token punctuation">)</span><span class="token operator">:</span> BigInt <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token number">1</span>      <span class="token keyword">else</span>        n <span class="token operator">*</span> factorial<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Test<span class="token number">1</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token number">2</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token number">3</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token number">4</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">24</span><span class="token number">5</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">120</span><span class="token number">6</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">720</span><span class="token number">7</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">5040</span><span class="token number">8</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">40320</span><span class="token number">9</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">362880</span><span class="token number">10</span> 的阶乘为<span class="token operator">:</span> <span class="token operator">=</span> <span class="token number">3628800</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-3-8-Scala-偏应用函数"><a href="#9-3-8-Scala-偏应用函数" class="headerlink" title="9.3.8 Scala 偏应用函数"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_938-scala-%E5%81%8F%E5%BA%94%E7%94%A8%E5%87%BD%E6%95%B0">9.3.8 Scala 偏应用函数</a></h3><p><strong>Scala 偏应用函数是一种表达式</strong>，你不需要提供函数需要的所有参数，只需要提供部分，或不提供所需参数。</p><p>如下实例，我们打印日志信息：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> date <span class="token operator">=</span> <span class="token keyword">new</span> Date    log<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">"message1"</span> <span class="token punctuation">)</span>    Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>    log<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">"message2"</span> <span class="token punctuation">)</span>    Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>    log<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">"message3"</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> log<span class="token punctuation">(</span>date<span class="token operator">:</span> Date<span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span>date <span class="token operator">+</span> <span class="token string">"----"</span> <span class="token operator">+</span> message<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestMon Dec <span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">41</span> CST <span class="token number">2018</span><span class="token operator">--</span><span class="token operator">--</span>message1Mon Dec <span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">41</span> CST <span class="token number">2018</span><span class="token operator">--</span><span class="token operator">--</span>message2Mon Dec <span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">52</span><span class="token operator">:</span><span class="token number">41</span> CST <span class="token number">2018</span><span class="token operator">--</span><span class="token operator">--</span>message3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实例中，log() 方法接收两个参数：date 和 message。我们在程序执行时调用了三次，参数 date 值都相同，message 不同。</p><p>我们可以使用偏应用函数优化以上方法，绑定第一个 date 参数，第二个参数使用下划线(_)替换缺失的参数列表，并把这个新的函数值的索引的赋给变量。以上实例修改如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> date <span class="token operator">=</span> <span class="token keyword">new</span> Date    <span class="token keyword">val</span> logWithDateBound <span class="token operator">=</span> log<span class="token punctuation">(</span>date<span class="token punctuation">,</span> _ <span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>    logWithDateBound<span class="token punctuation">(</span><span class="token string">"message1"</span> <span class="token punctuation">)</span>    Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>    logWithDateBound<span class="token punctuation">(</span><span class="token string">"message2"</span> <span class="token punctuation">)</span>    Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>    logWithDateBound<span class="token punctuation">(</span><span class="token string">"message3"</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> log<span class="token punctuation">(</span>date<span class="token operator">:</span> Date<span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span>date <span class="token operator">+</span> <span class="token string">"----"</span> <span class="token operator">+</span> message<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestTue Dec <span class="token number">18</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">54</span> CST <span class="token number">2018</span><span class="token operator">--</span><span class="token operator">--</span>message1Tue Dec <span class="token number">18</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">54</span> CST <span class="token number">2018</span><span class="token operator">--</span><span class="token operator">--</span>message2Tue Dec <span class="token number">18</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">54</span> CST <span class="token number">2018</span><span class="token operator">--</span><span class="token operator">--</span>message3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-3-9-高阶函数"><a href="#9-3-9-高阶函数" class="headerlink" title="9.3.9 高阶函数"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_939-%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0">9.3.9 高阶函数</a></h3><blockquote><p><a href="https://www.cnblogs.com/itboys/p/10164173.html">Scala泛型的使用</a></p><ol><li><p>scala的类和方法、函数都可以是泛型。</p></li><li><p>关于对类型边界的限定分为上边界和下边界（对类进行限制）</p><ul><li>  上边界：表达了泛型的类型必须是”某种类型”或某种类型的”子类”，语法为<code>&lt;:</code></li><li>  下边界：表达了泛型的类型必须是”某种类型”或某种类型的”父类”，语法为<code>&gt;:</code></li></ul></li><li><p><code>&lt;%</code> :view bounds可以进行某种神秘的转换，把你的类型在没有知觉的情况下转换成目标类型</p><p>其实你可以认为view bounds是上下边界的加强和补充，语法为：<code>&lt;%</code>，要用到implicit进行隐式转换</p></li><li><p><code>T:classTag</code>:相当于动态类型，你使用时传入什么类型就是什么类型</p><p>（spark的程序的编译和运行是区分了Driver和Executor的，只有在运行的时候才知道完整的类型信息）</p><p>语法为：<code>[T:ClassTag]</code></p></li><li><p>逆变和协变：<code>-T</code>和<code>+T</code>（下面有具体例子）+T可以传入其子类和本身（与继承关系一至）-T可以传入其父类和本身（与继承的关系相反）</p></li><li><p><code>T:Ordering</code> :表示将T变成Ordering[T],可以直接用其方法进行比大小,可完成排序等工作</p><p><strong>scala的类和方法、函数都可以是泛型</strong></p></li></ol></blockquote><p><strong>高阶函数（Higher-Order Function）就是操作其他函数的函数</strong>。</p><p>Scala 中允许使用高阶函数, 高阶函数可以使用其他函数作为参数，或者使用函数作为输出结果。</p><p>以下实例中，apply() 函数使用了另外一个函数 f 和 值 v 作为参数，而函数 f 又调用了参数 v：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>   <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span> apply<span class="token punctuation">(</span> layout<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>   <span class="token punctuation">}</span>   <span class="token comment">// 函数 f 和 值 v 作为参数，而函数 f 又调用了参数 v</span>   <span class="token keyword">def</span> apply<span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token keyword">=&gt;</span> <span class="token builtin">String</span><span class="token punctuation">,</span> v<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> f<span class="token punctuation">(</span>v<span class="token punctuation">)</span>   <span class="token keyword">def</span> layout<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token operator">:</span> A<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"["</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Test<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="9-3-10-函数柯里化-Function-Currying"><a href="#9-3-10-函数柯里化-Function-Currying" class="headerlink" title="9.3.10 函数柯里化(Function Currying)"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_9310-%E5%87%BD%E6%95%B0%E6%9F%AF%E9%87%8C%E5%8C%96function-currying">9.3.10 函数柯里化(Function Currying)</a></h3><p>柯里化(Currying)指的是将原来接受两个参数的函数变成新的接受一个参数的函数的过程。</p><p>新的函数返回一个以原有第二个参数为参数的函数。</p><p><strong>示例</strong></p><p>首先我们定义一个函数:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">def</span> add<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>y<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span>x<span class="token operator">+</span>y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>那么我们应用的时候，应该是这样用：add(1,2)</p><p>现在我们把这个函数变一下形：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">def</span> add<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>y<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> x <span class="token operator">+</span> y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>那么我们应用的时候，应该是这样用：add(1)(2),最后结果都一样是3，这种方式（过程）就叫柯里化。</p><p><strong>实现过程</strong></p><p>add(1)(2) 实际上是依次调用两个普通函数（非柯里化函数），第一次调用使用一个参数 x，返回一个函数类型的值，第二次使用参数y调用这个函数类型的值。</p><p>实质上最先演变成这样一个方法：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">def</span> add<span class="token punctuation">(</span>x<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>y<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token keyword">=&gt;</span>x<span class="token operator">+</span>y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>那么这个函数是什么意思呢？ 接收一个x为参数，返回一个匿名函数，该匿名函数的定义是：接收一个Int型参数y，函数体为x+y。现在我们来对这个方法进行调用。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> result <span class="token operator">=</span> add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>返回一个result，那result的值应该是一个匿名函数：(y:Int)=&gt;1+y</p><p>所以为了得到结果，我们继续调用result。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> sum <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最后打印出来的结果就是3。</p><p><strong>完整示例</strong></p><p>下面是一个完整实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>   <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">val</span> str1<span class="token operator">:</span><span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"Hello, "</span>      <span class="token keyword">val</span> str2<span class="token operator">:</span><span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"Scala!"</span>      println<span class="token punctuation">(</span> <span class="token string">"str1 + str2 = "</span> <span class="token operator">+</span>  strcat<span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span> <span class="token punctuation">)</span>   <span class="token punctuation">}</span>   <span class="token keyword">def</span> strcat<span class="token punctuation">(</span>s1<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s2<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>      s1 <span class="token operator">+</span> s2   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Teststr1 <span class="token operator">+</span> str2 <span class="token operator">=</span> Hello<span class="token punctuation">,</span> Scala<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>闭包是一个函数，返回值依赖于声明在函数外部的一个或多个变量</strong>。</p><p>闭包通常来讲可以简单的认为是可以访问一个函数里面局部变量的另外一个函数。</p><p>如下面这段匿名的函数：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> multiplier <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> i <span class="token operator">*</span> <span class="token number">10</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>函数体内有一个变量 i，它作为函数的一个参数。如下面的另一段代码：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> multiplier <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> i <span class="token operator">*</span> factor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 multiplier 中有两个变量：i 和 factor。其中的一个 i 是函数的形式参数，在 multiplier 函数被调用时，i 被赋予一个新的值。然而，factor不是形式参数，而是自由变量，考虑下面代码：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> factor <span class="token operator">=</span> <span class="token number">3</span>  <span class="token keyword">val</span> multiplier <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> i <span class="token operator">*</span> factor  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这里我们引入一个自由变量 factor，这个变量定义在函数外面。</p><p>这样定义的函数变量 multiplier 成为一个”闭包”，因为它引用到函数外面定义的变量，定义这个函数的过程是将这个自由变量捕获而构成一个封闭的函数。</p><p>完整实例</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span> <span class="token string">"muliplier(1) value = "</span> <span class="token operator">+</span>  multiplier<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      println<span class="token punctuation">(</span> <span class="token string">"muliplier(2) value = "</span> <span class="token operator">+</span>  multiplier<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> factor <span class="token operator">=</span> <span class="token number">3</span>    <span class="token keyword">val</span> multiplier <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> i <span class="token operator">*</span> factor  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala  $  scala Test  muliplier<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token number">3</span>  muliplier<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> value <span class="token operator">=</span> <span class="token number">6</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>自己的尝试（发现闭包引用函数外面的变量时，并不是直接存值，还是类似引用的形式，会跟踪变量的变化。毕竟Scala里都是对象、函数）</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> <span class="token keyword">var</span> value1 <span class="token operator">=</span> <span class="token number">3</span>value1<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">3</span>scala<span class="token operator">&gt;</span> <span class="token keyword">var</span> func1 <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> i <span class="token operator">*</span> value1func1<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token keyword">=&gt;</span> <span class="token builtin">Int</span> <span class="token operator">=</span> $Lambda$<span class="token number">1018</span><span class="token operator">/</span><span class="token number">1586289269</span><span class="token annotation punctuation">@3f049056</span>scala<span class="token operator">&gt;</span> func1<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>res0<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">15</span>scala<span class="token operator">&gt;</span> value1 <span class="token operator">=</span><span class="token number">4</span>value1<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">4</span>scala<span class="token operator">&gt;</span> func1<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>res1<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">24</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以下实例将字符串赋值给一个常量：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">val</span> greeting<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"Hello,World!"</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span> greeting <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上实例定义了变量 greeting，为字符串常量，它的类型为 **String (java.lang.String)**。</p><p><strong>在 Scala 中，字符串的类型实际上是 Java String，它本身没有 String 类</strong>。</p><p><strong>在 Scala 中，String 是一个不可变的对象，所以该对象不可被修改。这就意味着你如果修改字符串就会产生一个新的字符串对象</strong>。（这点和java其实一样的。毕竟用的就是java的String）</p><p>但其他对象，如数组就是可变的对象。接下来我们会为大家介绍常用的 java.lang.String 方法。</p><h2 id="11-1-创建字符串"><a href="#11-1-创建字符串" class="headerlink" title="11.1 创建字符串"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_111-%E5%88%9B%E5%BB%BA%E5%AD%97%E7%AC%A6%E4%B8%B2">11.1 创建字符串</a></h2><p>创建字符串实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> greeting <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span>或<span class="token keyword">var</span> greeting<span class="token operator">:</span><span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你不一定为字符串指定 String 类型，因为 Scala 编译器会自动推断出字符串的类型为 String。</p><p>当然我们也可以直接显示的声明字符串为 String 类型，如下实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">val</span> greeting<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"Hello, World!"</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span> greeting <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala TestHello<span class="token punctuation">,</span> world<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>我们前面提到过 String 对象是不可变的，如果你需要创建一个可以修改的字符串，可以使用 StringBuilder 类，如下实例:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> StringBuilder<span class="token punctuation">;</span>    buf <span class="token operator">+=</span> <span class="token char">'a'</span>    buf <span class="token operator">++</span><span class="token operator">=</span> <span class="token string">"bcdef"</span>    println<span class="token punctuation">(</span> <span class="token string">"buf is : "</span> <span class="token operator">+</span> buf<span class="token punctuation">.</span>toString <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Testbuf is <span class="token operator">:</span> abcdef<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="11-2-字符串长度"><a href="#11-2-字符串长度" class="headerlink" title="11.2 字符串长度"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_112-%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%95%BF%E5%BA%A6">11.2 字符串长度</a></h2><p>我们可以使用 length() 方法来获取字符串长度：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> palindrome <span class="token operator">=</span> <span class="token string">"www.runoob.com"</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> len <span class="token operator">=</span> palindrome<span class="token punctuation">.</span>length<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span> <span class="token string">"String Length is : "</span> <span class="token operator">+</span> len <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Test<span class="token builtin">String</span> Length is <span class="token operator">:</span> <span class="token number">14</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="11-3-字符串连接"><a href="#11-3-字符串连接" class="headerlink" title="11.3 字符串连接"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_113-%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9E%E6%8E%A5">11.3 字符串连接</a></h2><p>String 类中使用 concat() 方法来连接两个字符串：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">string1<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>string2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>实例演示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> <span class="token string">"菜鸟教程官网： "</span><span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token string">"www.runoob.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>res0<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> 菜鸟教程官网： www<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span>com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>同样你也可以使用加号(+)来连接：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">scala<span class="token operator">&gt;</span> <span class="token string">"菜鸟教程官网： "</span> <span class="token operator">+</span> <span class="token string">" www.runoob.com"</span>res1<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> 菜鸟教程官网：  www<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span>com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>让我们看个完整实例:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> str1 <span class="token operator">=</span> <span class="token string">"菜鸟教程官网："</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> str2 <span class="token operator">=</span>  <span class="token string">"www.runoob.com"</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> str3 <span class="token operator">=</span>  <span class="token string">"菜鸟教程的 Slogan 为："</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> str4 <span class="token operator">=</span>  <span class="token string">"学的不仅是技术，更是梦想！"</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span> str1 <span class="token operator">+</span> str2 <span class="token punctuation">)</span><span class="token punctuation">;</span>    println<span class="token punctuation">(</span> str3<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>str4<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Test菜鸟教程官网：www<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span>com菜鸟教程的 Slogan 为：学的不仅是技术，更是梦想！<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="11-4-创建格式化字符串"><a href="#11-4-创建格式化字符串" class="headerlink" title="11.4 创建格式化字符串"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_114-%E5%88%9B%E5%BB%BA%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2">11.4 创建格式化字符串</a></h2><p>String 类中你可以使用 printf() 方法来格式化字符串并输出，String format() 方法可以返回 String 对象而不是 PrintStream 对象。以下实例演示了 printf() 方法的使用：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> floatVar <span class="token operator">=</span> <span class="token number">12.456</span>    <span class="token keyword">var</span> intVar <span class="token operator">=</span> <span class="token number">2000</span>    <span class="token keyword">var</span> stringVar <span class="token operator">=</span> <span class="token string">"菜鸟教程!"</span>    <span class="token keyword">var</span> fs <span class="token operator">=</span> printf<span class="token punctuation">(</span><span class="token string">"浮点型变量为 "</span> <span class="token operator">+</span>                    <span class="token string">"%f, 整型变量为 %d, 字符串为 "</span> <span class="token operator">+</span>                    <span class="token string">" %s"</span><span class="token punctuation">,</span> floatVar<span class="token punctuation">,</span> intVar<span class="token punctuation">,</span> stringVar<span class="token punctuation">)</span>    println<span class="token punctuation">(</span>fs<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">$ scalac Test<span class="token punctuation">.</span>scala$ scala Test浮点型变量为 <span class="token number">12.456000</span><span class="token punctuation">,</span> 整型变量为 <span class="token number">2000</span><span class="token punctuation">,</span> 字符串为  菜鸟教程<span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="11-5-String-方法"><a href="#11-5-String-方法" class="headerlink" title="11.5 String 方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_115-string-%E6%96%B9%E6%B3%95">11.5 String 方法</a></h2><p>下表列出了 java.lang.String 中常用的方法，你可以在 Scala 中使用：</p><table><thead><tr><th>序号</th><th>方法及描述</th></tr></thead><tbody><tr><td>1</td><td>**char charAt(int index)**返回指定位置的字符</td></tr><tr><td>2</td><td>**int compareTo(Object o)**比较字符串与对象</td></tr><tr><td>3</td><td>**int compareTo(String anotherString)**按字典顺序比较两个字符串</td></tr><tr><td>4</td><td>**int compareToIgnoreCase(String str)**按字典顺序比较两个字符串，不考虑大小写</td></tr><tr><td>5</td><td>**String concat(String str)**将指定字符串连接到此字符串的结尾</td></tr><tr><td>6</td><td>**boolean contentEquals(StringBuffer sb)**将此字符串与指定的 StringBuffer 比较。</td></tr><tr><td>7</td><td>**static String copyValueOf(char[] data)**返回指定数组中表示该字符序列的 String</td></tr><tr><td>8</td><td>**static String copyValueOf(char[] data, int offset, int count)**返回指定数组中表示该字符序列的 String</td></tr><tr><td>9</td><td>**boolean endsWith(String suffix)**测试此字符串是否以指定的后缀结束</td></tr><tr><td>10</td><td>**boolean equals(Object anObject)**将此字符串与指定的对象比较</td></tr><tr><td>11</td><td>**boolean equalsIgnoreCase(String anotherString)**将此 String 与另一个 String 比较，不考虑大小写</td></tr><tr><td>12</td><td>**byte getBytes()**使用平台的默认字符集将此 String 编码为 byte 序列，并将结果存储到一个新的 byte 数组中</td></tr><tr><td>13</td><td><strong>byte[] getBytes(String charsetName</strong>使用指定的字符集将此 String 编码为 byte 序列，并将结果存储到一个新的 byte 数组中</td></tr><tr><td>14</td><td>**void getChars(int srcBegin, int srcEnd, char[] dst, int dstBegin)**将字符从此字符串复制到目标字符数组</td></tr><tr><td>15</td><td>**int hashCode()**返回此字符串的哈希码</td></tr><tr><td>16</td><td>**int indexOf(int ch)**返回指定字符在此字符串中第一次出现处的索引</td></tr><tr><td>17</td><td>**int indexOf(int ch, int fromIndex)**返回在此字符串中第一次出现指定字符处的索引，从指定的索引开始搜索</td></tr><tr><td>18</td><td>**int indexOf(String str)**返回指定子字符串在此字符串中第一次出现处的索引</td></tr><tr><td>19</td><td>**int indexOf(String str, int fromIndex)**返回指定子字符串在此字符串中第一次出现处的索引，从指定的索引开始</td></tr><tr><td>20</td><td>**String intern()**返回字符串对象的规范化表示形式</td></tr><tr><td>21</td><td>**int lastIndexOf(int ch)**返回指定字符在此字符串中最后一次出现处的索引</td></tr><tr><td>22</td><td>**int lastIndexOf(int ch, int fromIndex)**返回指定字符在此字符串中最后一次出现处的索引，从指定的索引处开始进行反向搜索</td></tr><tr><td>23</td><td>**int lastIndexOf(String str)**返回指定子字符串在此字符串中最右边出现处的索引</td></tr><tr><td>24</td><td>**int lastIndexOf(String str, int fromIndex)**返回指定子字符串在此字符串中最后一次出现处的索引，从指定的索引开始反向搜索</td></tr><tr><td>25</td><td>**int length()**返回此字符串的长度</td></tr><tr><td>26</td><td>**boolean matches(String regex)**告知此字符串是否匹配给定的正则表达式</td></tr><tr><td>27</td><td>**boolean regionMatches(boolean ignoreCase, int toffset, String other, int ooffset, int len)**测试两个字符串区域是否相等</td></tr><tr><td>28</td><td>**boolean regionMatches(int toffset, String other, int ooffset, int len)**测试两个字符串区域是否相等</td></tr><tr><td>29</td><td>**String replace(char oldChar, char newChar)**返回一个新的字符串，它是通过用 newChar 替换此字符串中出现的所有 oldChar 得到的</td></tr><tr><td>30</td><td><strong>String replaceAll(String regex, String replacement</strong>使用给定的 replacement 替换此字符串所有匹配给定的正则表达式的子字符串</td></tr><tr><td>31</td><td>**String replaceFirst(String regex, String replacement)**使用给定的 replacement 替换此字符串匹配给定的正则表达式的第一个子字符串</td></tr><tr><td>32</td><td>**String[] split(String regex)**根据给定正则表达式的匹配拆分此字符串</td></tr><tr><td>33</td><td>**String[] split(String regex, int limit)**根据匹配给定的正则表达式来拆分此字符串</td></tr><tr><td>34</td><td>**boolean startsWith(String prefix)**测试此字符串是否以指定的前缀开始</td></tr><tr><td>35</td><td>**boolean startsWith(String prefix, int toffset)**测试此字符串从指定索引开始的子字符串是否以指定前缀开始。</td></tr><tr><td>36</td><td>**CharSequence subSequence(int beginIndex, int endIndex)**返回一个新的字符序列，它是此序列的一个子序列</td></tr><tr><td>37</td><td>**String substring(int beginIndex)**返回一个新的字符串，它是此字符串的一个子字符串</td></tr><tr><td>38</td><td>**String substring(int beginIndex, int endIndex)**返回一个新字符串，它是此字符串的一个子字符串</td></tr><tr><td>39</td><td>**char[] toCharArray()**将此字符串转换为一个新的字符数组</td></tr><tr><td>40</td><td>**String toLowerCase()**使用默认语言环境的规则将此 String 中的所有字符都转换为小写</td></tr><tr><td>41</td><td>**String toLowerCase(Locale locale)**使用给定 Locale 的规则将此 String 中的所有字符都转换为小写</td></tr><tr><td>42</td><td>**String toString()**返回此对象本身（它已经是一个字符串！）</td></tr><tr><td>43</td><td>**String toUpperCase()**使用默认语言环境的规则将此 String 中的所有字符都转换为大写</td></tr><tr><td>44</td><td>**String toUpperCase(Locale locale)**使用给定 Locale 的规则将此 String 中的所有字符都转换为大写</td></tr><tr><td>45</td><td>**String trim()**删除指定字符串的首尾空白符</td></tr><tr><td>46</td><td>**static String valueOf(primitive data type x)**返回指定类型参数的字符串表示形式</td></tr></tbody></table><p>Scala 语言中提供的数组是用来存储固定大小的同类型元素，数组对于每一门编辑应语言来说都是重要的数据结构之一。</p><p>声明数组变量并不是声明 number0、number1、…、number99 一个个单独的变量，而是声明一个就像 numbers 这样的变量，然后使用 numbers[0]、numbers[1]、…、numbers[99] 来表示一个个单独的变量。数组中某个指定的元素是通过索引来访问的。</p><p>数组的第一个元素索引为0，最后一个元素的索引为元素总数减1。</p><h2 id="12-1-声明数组"><a href="#12-1-声明数组" class="headerlink" title="12.1 声明数组"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_121-%E5%A3%B0%E6%98%8E%E6%95%B0%E7%BB%84">12.1 声明数组</a></h2><p>以下是 Scala 数组声明的语法格式：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> z<span class="token operator">:</span>Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>或<span class="token keyword">var</span> z <span class="token operator">=</span> <span class="token keyword">new</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上语法中，z 声明一个字符串类型的数组，数组长度为 3 ，可存储 3 个元素。我们可以为每个元素设置值，并通过索引来访问每个元素，如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">z<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"Runoob"</span><span class="token punctuation">;</span> z<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"Baidu"</span><span class="token punctuation">;</span> z<span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"Google"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最后一个元素的索引使用了表达式 <strong>4/2</strong> 作为索引，类似于 **z(2) = “Google”**。</p><p>我们也可以使用以下方式来定义一个数组：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> z <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token string">"Runoob"</span><span class="token punctuation">,</span> <span class="token string">"Baidu"</span><span class="token punctuation">,</span> <span class="token string">"Google"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>下图展示了一个长度为 10 的数组 myList，索引值为 0 到 9：</p><p><img src="https://www.runoob.com/wp-content/uploads/2013/12/java_array.jpg"></p><h2 id="12-2-处理数组"><a href="#12-2-处理数组" class="headerlink" title="12.2 处理数组"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_122-%E5%A4%84%E7%90%86%E6%95%B0%E7%BB%84">12.2 处理数组</a></h2><p>数组的元素类型和数组的大小都是确定的，所以当处理数组元素时候，我们通常使用基本的 for 循环。</p><p>以下实例演示了数组的创建，初始化等处理过程：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> myList <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token number">1.9</span><span class="token punctuation">,</span> <span class="token number">2.9</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span>    <span class="token comment">// 输出所有数组元素</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> x <span class="token keyword">&lt;-</span> myList <span class="token punctuation">)</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span> x <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 计算数组所有元素的总和</span>    <span class="token keyword">var</span> total <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token keyword">&lt;-</span> <span class="token number">0</span> to <span class="token punctuation">(</span>myList<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      total <span class="token operator">+=</span> myList<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    println<span class="token punctuation">(</span><span class="token string">"总和为 "</span> <span class="token operator">+</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 查找数组中的最大元素</span>    <span class="token keyword">var</span> max <span class="token operator">=</span> myList<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token keyword">&lt;-</span> <span class="token number">1</span> to <span class="token punctuation">(</span>myList<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>myList<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&gt;</span> max<span class="token punctuation">)</span> max <span class="token operator">=</span> myList<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    println<span class="token punctuation">(</span><span class="token string">"最大值为 "</span> <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala$ scala Test<span class="token number">1.9</span><span class="token number">2.9</span><span class="token number">3.4</span><span class="token number">3.5</span>总和为 <span class="token number">11.7</span>最大值为 <span class="token number">3.5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="12-3-多维数组"><a href="#12-3-多维数组" class="headerlink" title="12.3 多维数组"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_123-%E5%A4%9A%E7%BB%B4%E6%95%B0%E7%BB%84">12.3 多维数组</a></h2><blockquote><p><a href="https://blog.csdn.net/cumt951045/article/details/107803290">scala中的二维数组_Scala中的多维数组</a></p></blockquote><p>多维数组一个数组中的值可以是另一个数组，另一个数组的值也可以是一个数组。矩阵与表格是我们常见的二维数组。</p><p>以上是一个定义了二维数组的实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> myMatrix <span class="token operator">=</span> Array<span class="token punctuation">.</span>ofDim<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>实例中数组中包含三个数组元素，每个数组元素又含有三个值。</p><p>接下来我们来看一个二维数组处理的完整实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> Array<span class="token punctuation">.</span>_<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> myMatrix <span class="token operator">=</span> Array<span class="token punctuation">.</span>ofDim<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token comment">// 创建矩阵</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> to <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token keyword">&lt;-</span> <span class="token number">0</span> to <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        myMatrix<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 打印二维阵列</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> to <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token keyword">&lt;-</span> <span class="token number">0</span> to <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        print<span class="token punctuation">(</span><span class="token string">" "</span> <span class="token operator">+</span> myMatrix<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      println<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala$ scala Test<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>自己试了下</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> Array<span class="token punctuation">.</span>_<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> arr3 <span class="token operator">=</span> Array<span class="token punctuation">.</span>ofDim<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      arr3<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> k<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      print<span class="token punctuation">(</span>arr3<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">if</span><span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>      println<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出结果如下</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">012012<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="12-4-合并数组"><a href="#12-4-合并数组" class="headerlink" title="12.4 合并数组"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_124-%E5%90%88%E5%B9%B6%E6%95%B0%E7%BB%84">12.4 合并数组</a></h2><p>以下实例中，我们使用 concat() 方法来合并两个数组，concat() 方法中接受多个数组参数：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> Array<span class="token punctuation">.</span>_<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> myList1 <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token number">1.9</span><span class="token punctuation">,</span> <span class="token number">2.9</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> myList2 <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token number">8.9</span><span class="token punctuation">,</span> <span class="token number">7.9</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span>            <span class="token comment">// 这里用的是Array.concat</span>    <span class="token keyword">var</span> myList3 <span class="token operator">=</span>  concat<span class="token punctuation">(</span> myList1<span class="token punctuation">,</span> myList2<span class="token punctuation">)</span>    <span class="token comment">// 输出所有数组元素</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> x <span class="token keyword">&lt;-</span> myList3 <span class="token punctuation">)</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span> x <span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala$ scala Test<span class="token number">1.9</span><span class="token number">2.9</span><span class="token number">3.4</span><span class="token number">3.5</span><span class="token number">8.9</span><span class="token number">7.9</span><span class="token number">0.4</span><span class="token number">1.5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="12-5-创建区间数组"><a href="#12-5-创建区间数组" class="headerlink" title="12.5 创建区间数组"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_125-%E5%88%9B%E5%BB%BA%E5%8C%BA%E9%97%B4%E6%95%B0%E7%BB%84">12.5 创建区间数组</a></h2><p>以下实例中，我们使用了 range() 方法来生成一个区间范围内的数组。range() 方法最后一个参数为步长，默认为 1：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> Array<span class="token punctuation">.</span>_<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> myList1 <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> myList2 <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>    <span class="token comment">// 输出所有数组元素</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> x <span class="token keyword">&lt;-</span> myList1 <span class="token punctuation">)</span> <span class="token punctuation">{</span>      print<span class="token punctuation">(</span> <span class="token string">" "</span> <span class="token operator">+</span> x <span class="token punctuation">)</span>    <span class="token punctuation">}</span>    println<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> x <span class="token keyword">&lt;-</span> myList2 <span class="token punctuation">)</span> <span class="token punctuation">{</span>      print<span class="token punctuation">(</span> <span class="token string">" "</span> <span class="token operator">+</span> x <span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala$ scala Test<span class="token number">10</span> <span class="token number">12</span> <span class="token number">14</span> <span class="token number">16</span> <span class="token number">18</span><span class="token number">10</span> <span class="token number">11</span> <span class="token number">12</span> <span class="token number">13</span> <span class="token number">14</span> <span class="token number">15</span> <span class="token number">16</span> <span class="token number">17</span> <span class="token number">18</span> <span class="token number">19</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="12-6-Scala-数组方法"><a href="#12-6-Scala-数组方法" class="headerlink" title="12.6 Scala 数组方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_126-scala-%E6%95%B0%E7%BB%84%E6%96%B9%E6%B3%95">12.6 Scala 数组方法</a></h2><blockquote><p><a href="https://blog.csdn.net/weixin_40873462/article/details/89670251">Scala学习之路之篇四（数组Array）</a></p></blockquote><p>下表中为 Scala 语言中处理数组的重要方法，使用它前我们需要使用 <strong>import Array._</strong> 引入包。</p><p>这里试了一下菜鸟教程没给示例的<code>Array.tabulate</code></p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test1 <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment">// 下面这个等同 var arr = Array.tabulate(2, 2)((a, b) =&gt; a + b)</span>    <span class="token keyword">var</span> arr <span class="token operator">=</span> Array<span class="token punctuation">.</span>tabulate<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      print<span class="token punctuation">(</span>arr<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    println<span class="token punctuation">(</span><span class="token string">"\n---"</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> arr1 <span class="token operator">=</span> Array<span class="token punctuation">.</span>tabulate<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token keyword">=&gt;</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>item <span class="token keyword">&lt;-</span> arr1<span class="token punctuation">)</span><span class="token punctuation">{</span>      print<span class="token punctuation">(</span>item<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    println<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出如下：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">0112---<span class="token number">45678</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>序号</th><th>方法和描述</th></tr></thead><tbody><tr><td>1</td><td>*_def apply( x: T, xs: T\_ ): Array[T]**创建指定对象 T 的数组, T 的值可以是 Unit, Double, Float, Long, Int, Char, Short, Byte, Boolean。</td></tr><tr><td>2</td><td>**def concat[T]( xss: Array[T]* ): Array[T]**合并数组</td></tr><tr><td>3</td><td><strong>def copy( src: AnyRef, srcPos: Int, dest: AnyRef, destPos: Int, length: Int ): Unit</strong>复制一个数组到另一个数组上。相等于 Java’s System.arraycopy(src, srcPos, dest, destPos, length)。</td></tr><tr><td>4</td><td>**def empty[T]: Array[T]**返回长度为 0 的数组</td></tr><tr><td>5</td><td><strong>def iterate[T]( start: T, len: Int )( f: (T) =&gt; T ): Array[T]**返回指定长度数组，每个数组元素为指定函数的返回值。以上实例数组初始值为 0，长度为 3，计算函数为</strong>a=&gt;a+1**：</td></tr><tr><td><code>scala&gt; Array.iterate(0,3)(a=&gt;a+1)</code></td><td></td></tr><tr><td><code>res1: Array[Int] = Array(0, 1, 2)</code></td><td></td></tr><tr><td>6</td><td>**def fill[T]( n: Int )(elem: =&gt; T): Array[T]**返回数组，长度为第一个参数指定，同时每个元素使用第二个参数进行填充。</td></tr><tr><td>7</td><td>**def fill[T]( n1: Int, n2: Int )( elem: =&gt; T ): Array[Array[T]]**返回二数组，长度为第一个参数指定，同时每个元素使用第二个参数进行填充。</td></tr><tr><td>8</td><td>**def ofDim[T]( n1: Int ): Array[T]**创建指定长度的数组</td></tr><tr><td>9</td><td>**def ofDim[T]( n1: Int, n2: Int ): Array[Array[T]]**创建二维数组</td></tr><tr><td>10</td><td>**def ofDim[T]( n1: Int, n2: Int, n3: Int ): Array[Array[Array[T]]]**创建三维数组</td></tr><tr><td>11</td><td>**def range( start: Int, end: Int, step: Int ): Array[Int]**创建指定区间内的数组，step 为每个元素间的步长</td></tr><tr><td>12</td><td>**def range( start: Int, end: Int ): Array[Int]**创建指定区间内的数组</td></tr><tr><td>13</td><td>**def tabulate[T]( n: Int )(f: (Int)=&gt; T): Array[T]**返回指定长度数组，每个数组元素为指定函数的返回值，默认从 0 开始。以上实例返回 3 个元素：</td></tr><tr><td><code>scala&gt; Array.tabulate(3)(a =&gt; a + 5)</code></td><td></td></tr><tr><td><code>res0: Array[Int] = Array(5, 6, 7)</code></td><td></td></tr><tr><td>14</td><td>**def tabulate[T]( n1: Int, n2: Int )( f: (Int, Int ) =&gt; T): Array[Array[T]]**返回指定长度的二维数组，每个数组元素为指定函数的返回值，默认从 0 开始。</td></tr></tbody></table><p>Scala提供了一套很好的集合实现，提供了一些集合类型的抽象。</p><p><strong>Scala 集合分为可变的和不可变的集合</strong>。</p><p>可变集合可以在适当的地方被更新或扩展。这意味着你可以修改，添加，移除一个集合的元素。</p><p><strong>而不可变集合类，相比之下，永远不会改变。不过，你仍然可以模拟添加，移除或更新操作。但是这些操作将在每一种情况下都返回一个新的集合，同时使原来的集合不发生改变</strong>。</p><p>接下来我们将为大家介绍几种常用集合类型的应用：</p><table><thead><tr><th>序号</th><th>集合及描述</th></tr></thead><tbody><tr><td>1</td><td><a href="https://www.runoob.com/scala/scala-lists.html">Scala List(列表)</a>List的特征是其元素以线性方式存储，集合中可以存放重复对象。参考 <a href="http://www.scala-lang.org/api/current/scala/collection/immutable/List.html">API文档</a></td></tr><tr><td>2</td><td><a href="https://www.runoob.com/scala/scala-sets.html">Scala Set(集合)</a>Set是最简单的一种集合。集合中的对象不按特定的方式排序，并且没有重复对象。参考 <a href="http://www.scala-lang.org/api/current/scala/collection/immutable/Set.html">API文档</a></td></tr><tr><td>3</td><td><a href="https://www.runoob.com/scala/scala-maps.html">Scala Map(映射)</a>Map 是一种把键对象和值对象映射的集合，它的每一个元素都包含一对键对象和值对象。参考 <a href="http://www.scala-lang.org/api/current/scala/collection/immutable/Map.html">API文档</a></td></tr><tr><td>4</td><td><a href="https://www.runoob.com/scala/scala-tuples.html">Scala 元组</a>元组是不同类型的值的集合</td></tr><tr><td>5</td><td><a href="https://www.runoob.com/scala/scala-options.html">Scala Option</a>Option[T] 表示有可能包含值的容器，也可能不包含值。</td></tr><tr><td>6</td><td><a href="https://www.runoob.com/scala/scala-iterators.html">Scala Iterator（迭代器）</a>迭代器不是一个容器，更确切的说是逐一访问容器内元素的方法。</td></tr></tbody></table><p>示例：</p><p>以下代码判断，演示了所有以上集合类型的定义实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token comment">// 定义整型 List</span><span class="token keyword">val</span> x <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">// 定义 Set</span><span class="token keyword">val</span> x <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token comment">// 定义 Map</span><span class="token keyword">val</span> x <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"one"</span> <span class="token operator">-&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"two"</span> <span class="token operator">-&gt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"three"</span> <span class="token operator">-&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">// 创建两个不同类型元素的元组</span><span class="token keyword">val</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"Runoob"</span><span class="token punctuation">)</span><span class="token comment">// 定义 Option</span><span class="token keyword">val</span> x<span class="token operator">:</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Some<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>Scala 程序使用 Option 非常频繁，在 Java 中使用 null 来表示空值，代码中很多地方都要添加 null 关键字检测，不然很容易出现 NullPointException。因此 Java 程序需要关心那些变量可能是 null,而这些变量出现 null 的可能性很低，但一但出现，很难查出为什么出现 NullPointerException。</p><p>Scala 的 Option 类型可以避免这种情况，因此 Scala 应用推荐使用 Option 类型来代表一些可选值。</p><p>使用 Option 类型，读者一眼就可以看出这种类型的值可能为 None。</p><p>参考链接：<a href="https://www.runoob.com/w3cnote/scala-option-some-none.html">Scala 使用Option、Some、None，避免使用 null</a></p></blockquote><h2 id="13-1-Scala-List-列表"><a href="#13-1-Scala-List-列表" class="headerlink" title="13.1 Scala List(列表)"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_131-scala-list%E5%88%97%E8%A1%A8">13.1 Scala List(列表)</a></h2><p>Scala 列表类似于数组，它们所有元素的类型都相同，但是它们也有所不同：列表是不可变的，值一旦被定义了就不能改变，其次<strong>列表具有递归的结构（也就是链接表结构）</strong>而数组不是。。</p><p>列表的元素类型 T 可以写成 List[T]。例如，以下列出了多种类型的列表：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token comment">// 字符串列表</span><span class="token keyword">val</span> site<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token string">"Runoob"</span><span class="token punctuation">,</span> <span class="token string">"Google"</span><span class="token punctuation">,</span> <span class="token string">"Baidu"</span><span class="token punctuation">)</span><span class="token comment">// 整型列表</span><span class="token keyword">val</span> nums<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">// 空列表</span><span class="token keyword">val</span> empty<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Nothing</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 二维列表</span><span class="token keyword">val</span> dim<span class="token operator">:</span> List<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span>    List<span class="token punctuation">(</span>      List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      List<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         List<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构造列表的两个基本单位是 <strong>Nil</strong> 和 <strong>::</strong></p><p><strong>Nil</strong> 也可以表示为一个空列表。</p><p>以上实例我们可以写成如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token comment">// 字符串列表</span><span class="token keyword">val</span> site <span class="token operator">=</span> <span class="token string">"Runoob"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Google"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Baidu"</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 整型列表</span><span class="token keyword">val</span> nums <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 空列表</span><span class="token keyword">val</span> empty <span class="token operator">=</span> Nil<span class="token comment">// 二维列表</span><span class="token keyword">val</span> dim <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span>          <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span>          <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> Nil<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-1-列表基本操作"><a href="#13-1-1-列表基本操作" class="headerlink" title="13.1.1 列表基本操作"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1311-%E5%88%97%E8%A1%A8%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C">13.1.1 列表基本操作</a></h3><p>Scala列表有三个基本操作：</p><ul><li>  <code>head</code> 返回列表第一个元素</li><li>  <code>tail</code> <strong>返回一个列表，包含除了第一元素之外的其他元素</strong></li><li>  <code>isEmpty</code> 在列表为空时返回true</li></ul><p>对于Scala列表的任何操作都可以使用这三个基本操作来表达。实例如下:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token comment">// 字符串列表</span><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> site <span class="token operator">=</span> <span class="token string">"Runoob"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Google"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Baidu"</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> nums <span class="token operator">=</span> Nil    println<span class="token punctuation">(</span> <span class="token string">"第一网站是 : "</span> <span class="token operator">+</span> site<span class="token punctuation">.</span>head <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"最后一个网站是 : "</span> <span class="token operator">+</span> site<span class="token punctuation">.</span>tail <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"查看列表 site 是否为空 : "</span> <span class="token operator">+</span> site<span class="token punctuation">.</span>isEmpty <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"查看 nums 是否为空 : "</span> <span class="token operator">+</span> nums<span class="token punctuation">.</span>isEmpty <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala 第一网站是 <span class="token builtin class-name">:</span> Runoob最后一个网站是 <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span>Google, Baidu<span class="token punctuation">)</span>查看列表 site 是否为空 <span class="token builtin class-name">:</span> <span class="token boolean">false</span>查看 nums 是否为空 <span class="token builtin class-name">:</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-2-连接列表"><a href="#13-1-2-连接列表" class="headerlink" title="13.1.2 连接列表"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1312-%E8%BF%9E%E6%8E%A5%E5%88%97%E8%A1%A8">13.1.2 连接列表</a></h3><p>你可以使用 <strong>:::</strong> 运算符或 <strong>List.:::()</strong> 方法或 <strong>List.concat()</strong> 方法来连接两个或多个列表。实例如下:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> site1 <span class="token operator">=</span> <span class="token string">"Runoob"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Google"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Baidu"</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> site2 <span class="token operator">=</span> <span class="token string">"Facebook"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Taobao"</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span>    <span class="token comment">// 使用 ::: 运算符</span>    <span class="token keyword">var</span> fruit <span class="token operator">=</span> site1 <span class="token operator">::</span><span class="token operator">:</span> site2    println<span class="token punctuation">(</span> <span class="token string">"site1 ::: site2 : "</span> <span class="token operator">+</span> fruit <span class="token punctuation">)</span>    <span class="token comment">// 使用 .:::() 方法 这个是添加到前面，::: 和 concat 都体添加到末尾</span>    fruit <span class="token operator">=</span> site1<span class="token punctuation">.</span><span class="token punctuation">:</span><span class="token operator">::</span><span class="token punctuation">(</span>site2<span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"site1.:::(site2) : "</span> <span class="token operator">+</span> fruit <span class="token punctuation">)</span>    <span class="token comment">// 使用 concat 方法</span>    fruit <span class="token operator">=</span> List<span class="token punctuation">.</span>concat<span class="token punctuation">(</span>site1<span class="token punctuation">,</span> site2<span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"List.concat(site1, site2) : "</span> <span class="token operator">+</span> fruit  <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala site1 ::: site2 <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span>Runoob, Google, Baidu, Facebook, Taobao<span class="token punctuation">)</span>site1.:::<span class="token punctuation">(</span>site2<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span>Facebook, Taobao, Runoob, Google, Baidu<span class="token punctuation">)</span>List.concat<span class="token punctuation">(</span>site1, site2<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span>Runoob, Google, Baidu, Facebook, Taobao<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-3-List-fill"><a href="#13-1-3-List-fill" class="headerlink" title="13.1.3 List.fill()"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1313-listfill">13.1.3 List.fill()</a></h3><p>我们可以使用 List.fill() 方法来创建一个指定重复数量的元素列表：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> site <span class="token operator">=</span> List<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"Runoob"</span><span class="token punctuation">)</span> <span class="token comment">// 重复 Runoob 3次</span>    println<span class="token punctuation">(</span> <span class="token string">"site : "</span> <span class="token operator">+</span> site  <span class="token punctuation">)</span>    <span class="token keyword">val</span> num <span class="token operator">=</span> List<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>         <span class="token comment">// 重复元素 2, 10 次</span>    println<span class="token punctuation">(</span> <span class="token string">"num : "</span> <span class="token operator">+</span> num  <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala site <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span>Runoob, Runoob, Runoob<span class="token punctuation">)</span>num <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">2</span>, <span class="token number">2</span>, <span class="token number">2</span>, <span class="token number">2</span>, <span class="token number">2</span>, <span class="token number">2</span>, <span class="token number">2</span>, <span class="token number">2</span>, <span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-4-List-tabulate"><a href="#13-1-4-List-tabulate" class="headerlink" title="13.1.4 List.tabulate()"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1314-listtabulate">13.1.4 List.tabulate()</a></h3><p>List.tabulate() 方法是通过给定的函数来创建列表。</p><p>方法的第一个参数为元素的数量，可以是二维的，第二个参数为指定的函数，我们通过指定的函数计算结果并返回值插入到列表中，起始值为 0，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 通过给定的函数创建 5 个元素</span>    <span class="token keyword">val</span> squares <span class="token operator">=</span> List<span class="token punctuation">.</span>tabulate<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">(</span>n <span class="token keyword">=&gt;</span> n <span class="token operator">*</span> n<span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"一维 : "</span> <span class="token operator">+</span> squares  <span class="token punctuation">)</span>    <span class="token comment">// 创建二维列表</span>    <span class="token keyword">val</span> mul <span class="token operator">=</span> List<span class="token punctuation">.</span>tabulate<span class="token punctuation">(</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> _ <span class="token operator">*</span> _ <span class="token punctuation">)</span>          println<span class="token punctuation">(</span> <span class="token string">"多维 : "</span> <span class="token operator">+</span> mul  <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala 一维 <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">4</span>, <span class="token number">9</span>, <span class="token number">16</span>, <span class="token number">25</span><span class="token punctuation">)</span>多维 <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span>List<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>, List<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span>, <span class="token number">4</span><span class="token punctuation">)</span>, List<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">2</span>, <span class="token number">4</span>, <span class="token number">6</span>, <span class="token number">8</span><span class="token punctuation">)</span>, List<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">3</span>, <span class="token number">6</span>, <span class="token number">9</span>, <span class="token number">12</span><span class="token punctuation">))</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-5-List-reverse"><a href="#13-1-5-List-reverse" class="headerlink" title="13.1.5 List.reverse"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1315-listreverse">13.1.5 List.reverse</a></h3><p>List.reverse 用于将列表的顺序反转，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> site <span class="token operator">=</span> <span class="token string">"Runoob"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Google"</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token string">"Baidu"</span> <span class="token operator">::</span> Nil<span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"site 反转前 : "</span> <span class="token operator">+</span> site <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"site 反转后 : "</span> <span class="token operator">+</span> site<span class="token punctuation">.</span>reverse <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala site 反转前 <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span>Runoob, Google, Baidu<span class="token punctuation">)</span>site 反转后 <span class="token builtin class-name">:</span> List<span class="token punctuation">(</span>Baidu, Google, Runoob<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-6-Scala-List-常用方法"><a href="#13-1-6-Scala-List-常用方法" class="headerlink" title="13.1.6 Scala List 常用方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1316-scala-list-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95">13.1.6 Scala List 常用方法</a></h3><p>下表列出了 Scala List 常用的方法：</p><table><thead><tr><th>序号</th><th>方法及描述</th></tr></thead><tbody><tr><td>1</td><td>**def +:(elem: A): List[A]**为列表预添加元素</td></tr><tr><td><code>scala&gt; val x = List(1)</code></td><td></td></tr><tr><td><code>x: List[Int] = List(1)</code></td><td></td></tr><tr><td><code>scala&gt; val y = 2 +: x</code></td><td></td></tr><tr><td><code>y: List[Int] = List(2, 1)</code></td><td></td></tr><tr><td><code>scala&gt; println(x) List(1)</code></td><td></td></tr><tr><td>2</td><td>**def ::(x: A): List[A]**在列表开头添加元素</td></tr><tr><td>3</td><td>**def :::(prefix: List[A]): List[A]**在列表开头添加指定列表的元素</td></tr><tr><td>4</td><td>**def :+(elem: A): List[A]**复制添加元素后列表。</td></tr><tr><td><code>scala&gt; val a = List(1)</code></td><td></td></tr><tr><td><code>a: List[Int] = List(1)</code></td><td></td></tr><tr><td><code>scala&gt; val b = a :+ 2</code></td><td></td></tr><tr><td><code>b: List[Int] = List(1, 2)</code></td><td></td></tr><tr><td><code>scala&gt; println(a)</code></td><td></td></tr><tr><td><code>List(1)</code></td><td></td></tr><tr><td>5</td><td><strong>def addString(b: StringBuilder): StringBuilder</strong>将列表的所有元素添加到 StringBuilder</td></tr><tr><td>6</td><td><strong>def addString(b: StringBuilder, sep: String): StringBuilder</strong>将列表的所有元素添加到 StringBuilder，并指定分隔符</td></tr><tr><td>7</td><td><strong>def apply(n: Int): A</strong>通过列表索引获取元素</td></tr><tr><td>8</td><td><strong>def contains(elem: Any): Boolean</strong>检测列表中是否包含指定的元素</td></tr><tr><td>9</td><td><strong>def copyToArray(xs: Array[A], start: Int, len: Int): Unit</strong>将列表的元素复制到数组中。</td></tr><tr><td>10</td><td>**def distinct: List[A]**去除列表的重复元素，并返回新列表</td></tr><tr><td>11</td><td>**def drop(n: Int): List[A]**丢弃前n个元素，并返回新列表</td></tr><tr><td>12</td><td>**def dropRight(n: Int): List[A]**丢弃最后n个元素，并返回新列表</td></tr><tr><td>13</td><td>**def dropWhile(p: (A) =&gt; Boolean): List[A]**从左向右丢弃元素，直到条件p不成立</td></tr><tr><td>14</td><td><strong>def endsWith[B](that: Seq[B]): Boolean</strong>检测列表是否以指定序列结尾</td></tr><tr><td>15</td><td><strong>def equals(that: Any): Boolean</strong>判断是否相等</td></tr><tr><td>16</td><td><strong>def exists(p: (A) =&gt; Boolean): Boolean</strong>判断列表中指定条件的元素是否存在。</td></tr><tr><td>判断l是否存在某个元素:</td><td></td></tr><tr><td><code>scala&gt; l.exists(s =&gt; s == "Hah")</code></td><td></td></tr><tr><td><code>res7: Boolean = true</code></td><td></td></tr><tr><td>17</td><td>**def filter(p: (A) =&gt; Boolean): List[A]**输出符号指定条件的所有元素。过滤出长度为3的元素:</td></tr><tr><td><code>scala&gt; l.filter(s =&gt; s.length == 3)</code></td><td></td></tr><tr><td><code>res8: List[String] = List(Hah, WOW)</code></td><td></td></tr><tr><td>18</td><td><strong>def forall(p: (A) =&gt; Boolean): Boolean</strong>检测所有元素。</td></tr><tr><td>例如：判断所有元素是否以”H”开头：</td><td></td></tr><tr><td><code>scala&gt; l.forall(s =&gt; s.startsWith("H"))</code></td><td></td></tr><tr><td><code>res10: Boolean = false</code></td><td></td></tr><tr><td>19</td><td><strong>def foreach(f: (A) =&gt; Unit): Unit</strong>将函数应用到列表的所有元素</td></tr><tr><td>20</td><td><strong>def head: A</strong>获取列表的第一个元素</td></tr><tr><td>21</td><td><strong>def indexOf(elem: A, from: Int): Int</strong>从指定位置 from 开始查找元素第一次出现的位置</td></tr><tr><td>22</td><td>**def init: List[A]**返回所有元素，除了最后一个</td></tr><tr><td>23</td><td>**def intersect(that: Seq[A]): List[A]**计算多个集合的交集</td></tr><tr><td>24</td><td><strong>def isEmpty: Boolean</strong>检测列表是否为空</td></tr><tr><td>25</td><td>**def iterator: Iterator[A]**创建一个新的迭代器来迭代元素</td></tr><tr><td>26</td><td><strong>def last: A</strong>返回最后一个元素</td></tr><tr><td>27</td><td><strong>def lastIndexOf(elem: A, end: Int): Int</strong>在指定的位置 end 开始查找元素最后出现的位置</td></tr><tr><td>28</td><td><strong>def length: Int</strong>返回列表长度</td></tr><tr><td>29</td><td>**def map[B](f: (A) =&gt; B): List[B]**通过给定的方法将所有元素重新计算</td></tr><tr><td>30</td><td><strong>def max: A</strong>查找最大元素</td></tr><tr><td>31</td><td><strong>def min: A</strong>查找最小元素</td></tr><tr><td>32</td><td><strong>def mkString: String</strong>列表所有元素作为字符串显示</td></tr><tr><td>33</td><td><strong>def mkString(sep: String): String</strong>使用分隔符将列表所有元素作为字符串显示</td></tr><tr><td>34</td><td>**def reverse: List[A]**列表反转</td></tr><tr><td>35</td><td>**def sorted[B &gt;: A]: List[A]**列表排序</td></tr><tr><td>36</td><td><strong>def startsWith[B](that: Seq[B], offset: Int): Boolean</strong>检测列表在指定位置是否包含指定序列</td></tr><tr><td>37</td><td><strong>def sum: A</strong>计算集合元素之和</td></tr><tr><td>38</td><td>**def tail: List[A]**返回所有元素，除了第一个</td></tr><tr><td>39</td><td>**def take(n: Int): List[A]**提取列表的前n个元素</td></tr><tr><td>40</td><td>**def takeRight(n: Int): List[A]**提取列表的后n个元素</td></tr><tr><td>41</td><td>**def toArray: Array[A]**列表转换为数组</td></tr><tr><td>42</td><td>**def toBuffer[B &gt;: A]: Buffer[B]**返回缓冲区，包含了列表的所有元素</td></tr><tr><td>43</td><td>**def toMap[T, U]: Map[T, U]**List 转换为 Map</td></tr><tr><td>44</td><td>**def toSeq: Seq[A]**List 转换为 Seq</td></tr><tr><td>45</td><td>**def toSet[B &gt;: A]: Set[B]**List 转换为 Set</td></tr><tr><td>46</td><td><strong>def toString(): String</strong>列表转换为字符串</td></tr></tbody></table><blockquote><p>更多方法可以参考 <a href="http://www.scala-lang.org/api/current/scala/collection/immutable/List.html">API文档</a></p></blockquote><h2 id="13-2-Scala-Set-集合"><a href="#13-2-Scala-Set-集合" class="headerlink" title="13.2 Scala Set(集合)"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_132-scala-set%E9%9B%86%E5%90%88">13.2 Scala Set(集合)</a></h2><p>Scala Set(集合)是没有重复的对象集合，所有的元素都是唯一的。</p><p>Scala 集合分为可变的和不可变的集合。</p><p>默认情况下，Scala 使用的是不可变集合，如果你想使用可变集合，需要引用 <strong>scala.collection.mutable.Set</strong> 包。</p><p>默认引用 scala.collection.immutable.Set，不可变集合实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> set <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>println<span class="token punctuation">(</span>set<span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getName<span class="token punctuation">)</span> <span class="token comment">//</span>println<span class="token punctuation">(</span>set<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>_ <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//true</span>println<span class="token punctuation">(</span>set<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//Set(2,3)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果需要使用可变集合需要引入 scala.collection.mutable.Set：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>Set <span class="token comment">// 可以在任何地方引入 可变集合</span><span class="token keyword">val</span> mutableSet <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>println<span class="token punctuation">(</span>mutableSet<span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getName<span class="token punctuation">)</span> <span class="token comment">// scala.collection.mutable.HashSet</span>mutableSet<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>mutableSet<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>mutableSet <span class="token operator">+=</span> <span class="token number">5</span>mutableSet <span class="token operator">-=</span> <span class="token number">2</span>println<span class="token punctuation">(</span>mutableSet<span class="token punctuation">)</span> <span class="token comment">// Set(5, 3, 4)</span><span class="token keyword">val</span> another <span class="token operator">=</span> mutableSet<span class="token punctuation">.</span>toSetprintln<span class="token punctuation">(</span>another<span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getName<span class="token punctuation">)</span> <span class="token comment">// scala.collection.immutable.Set</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注意：</strong>  <em>虽然可变Set和不可变Set都有添加或删除元素的操作，但是有一个非常大的差别。对不可变Set进行操作，会产生一个新的set，原来的set并没有改变，这与List一样。 而对可变Set进行操作，改变的是该Set本身，与ListBuffer类似。</em></p></blockquote><h3 id="13-2-1-集合基本操作"><a href="#13-2-1-集合基本操作" class="headerlink" title="13.2.1 集合基本操作"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1321-%E9%9B%86%E5%90%88%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C">13.2.1 集合基本操作</a></h3><p>Scala集合有三个基本操作：</p><ul><li>  <code>head</code> 返回集合第一个元素</li><li>  <code>tail</code> <strong>返回一个集合，包含除了第一元素之外的其他元素</strong></li><li>  <code>isEmpty</code> 在集合为空时返回true</li></ul><p>对于Scala集合的任何操作都可以使用这三个基本操作来表达。实例如下:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> site <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token string">"Runoob"</span><span class="token punctuation">,</span> <span class="token string">"Google"</span><span class="token punctuation">,</span> <span class="token string">"Baidu"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> nums<span class="token operator">:</span> Set<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"第一网站是 : "</span> <span class="token operator">+</span> site<span class="token punctuation">.</span>head <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"最后一个网站是 : "</span> <span class="token operator">+</span> site<span class="token punctuation">.</span>tail <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"查看列表 site 是否为空 : "</span> <span class="token operator">+</span> site<span class="token punctuation">.</span>isEmpty <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"查看 nums 是否为空 : "</span> <span class="token operator">+</span> nums<span class="token punctuation">.</span>isEmpty <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala 第一网站是 <span class="token builtin class-name">:</span> Runoob最后一个网站是 <span class="token builtin class-name">:</span> Set<span class="token punctuation">(</span>Google, Baidu<span class="token punctuation">)</span>查看列表 site 是否为空 <span class="token builtin class-name">:</span> <span class="token boolean">false</span>查看 nums 是否为空 <span class="token builtin class-name">:</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-2-2-连接集合"><a href="#13-2-2-连接集合" class="headerlink" title="13.2.2 连接集合"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1322-%E8%BF%9E%E6%8E%A5%E9%9B%86%E5%90%88">13.2.2 连接集合</a></h3><p>你可以使用 <strong>++</strong> 运算符或 <strong>Set.++()</strong> 方法来连接两个集合。如果元素有重复的就会移除重复的元素。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> site1 <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token string">"Runoob"</span><span class="token punctuation">,</span> <span class="token string">"Google"</span><span class="token punctuation">,</span> <span class="token string">"Baidu"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> site2 <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token string">"Faceboook"</span><span class="token punctuation">,</span> <span class="token string">"Taobao"</span><span class="token punctuation">)</span>    <span class="token comment">// ++ 作为运算符使用</span>    <span class="token keyword">var</span> site <span class="token operator">=</span> site1 <span class="token operator">++</span> site2    println<span class="token punctuation">(</span> <span class="token string">"site1 ++ site2 : "</span> <span class="token operator">+</span> site <span class="token punctuation">)</span>    <span class="token comment">//  ++ 作为方法使用</span>    site <span class="token operator">=</span> site1<span class="token punctuation">.</span>+<span class="token operator">+</span><span class="token punctuation">(</span>site2<span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"site1.++(site2) : "</span> <span class="token operator">+</span> site <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala site1 ++ site2 <span class="token builtin class-name">:</span> Set<span class="token punctuation">(</span>Faceboook, Taobao, Google, Baidu, Runoob<span class="token punctuation">)</span>site1.++<span class="token punctuation">(</span>site2<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> Set<span class="token punctuation">(</span>Faceboook, Taobao, Google, Baidu, Runoob<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-2-3-查找集合中最大与最小元素"><a href="#13-2-3-查找集合中最大与最小元素" class="headerlink" title="13.2.3 查找集合中最大与最小元素"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1323-%E6%9F%A5%E6%89%BE%E9%9B%86%E5%90%88%E4%B8%AD%E6%9C%80%E5%A4%A7%E4%B8%8E%E6%9C%80%E5%B0%8F%E5%85%83%E7%B4%A0">13.2.3 查找集合中最大与最小元素</a></h3><p>你可以使用 <strong>Set.min</strong> 方法来查找集合中的最小元素，使用 <strong>Set.max</strong> 方法查找集合中的最大元素。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> num <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">)</span>    <span class="token comment">// 查找集合中最大与最小元素</span>    println<span class="token punctuation">(</span> <span class="token string">"Set(5,6,9,20,30,45) 集合中的最小元素是 : "</span> <span class="token operator">+</span> num<span class="token punctuation">.</span>min <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"Set(5,6,9,20,30,45) 集合中的最大元素是 : "</span> <span class="token operator">+</span> num<span class="token punctuation">.</span>max <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala Set<span class="token punctuation">(</span><span class="token number">5,6</span>,9,20,30,45<span class="token punctuation">)</span> 集合中的最小元素是 <span class="token builtin class-name">:</span> <span class="token number">5</span>Set<span class="token punctuation">(</span><span class="token number">5,6</span>,9,20,30,45<span class="token punctuation">)</span> 集合中的最大元素是 <span class="token builtin class-name">:</span> <span class="token number">45</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-2-4-交集"><a href="#13-2-4-交集" class="headerlink" title="13.2.4 交集"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1324-%E4%BA%A4%E9%9B%86">13.2.4 交集</a></h3><p>你可以使用 <strong>Set.&amp;</strong> 方法或 <strong>Set.intersect</strong> 方法来查看两个集合的交集元素。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> num1 <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> num2 <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">)</span>    <span class="token comment">// 交集</span>    println<span class="token punctuation">(</span> <span class="token string">"num1.&amp;(num2) : "</span> <span class="token operator">+</span> num1<span class="token punctuation">.</span>&amp;<span class="token punctuation">(</span>num2<span class="token punctuation">)</span> <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"num1.intersect(num2) : "</span> <span class="token operator">+</span> num1<span class="token punctuation">.</span>intersect<span class="token punctuation">(</span>num2<span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vim</span> Test.scala $ scala Test.scala num1.<span class="token operator">&amp;</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> Set<span class="token punctuation">(</span><span class="token number">20</span>, <span class="token number">9</span><span class="token punctuation">)</span>num1.intersect<span class="token punctuation">(</span>num2<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> Set<span class="token punctuation">(</span><span class="token number">20</span>, <span class="token number">9</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-2-5-Scala-Set-常用方法"><a href="#13-2-5-Scala-Set-常用方法" class="headerlink" title="13.2.5 Scala Set 常用方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1325-scala-set-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95">13.2.5 Scala Set 常用方法</a></h3><p>下表列出了 Scala Set 常用的方法：</p><table><thead><tr><th>序号</th><th>方法及描述</th></tr></thead><tbody><tr><td>1</td><td>**def +(elem: A): Set[A]**为集合添加新元素，x并创建一个新的集合，除非元素已存在</td></tr><tr><td>2</td><td>**def -(elem: A): Set[A]**移除集合中的元素，并创建一个新的集合</td></tr><tr><td>3</td><td><strong>def contains(elem: A): Boolean</strong>如果元素在集合中存在，返回 true，否则返回 false。</td></tr><tr><td>4</td><td>**def &amp;(that: Set[A]): Set[A]**返回两个集合的交集</td></tr><tr><td>5</td><td>**def &amp;~(that: Set[A]): Set[A]**返回两个集合的差集</td></tr><tr><td>6</td><td>*_def +(elem1: A, elem2: A, elems: A\_): Set[A]**通过添加传入指定集合的元素创建一个新的不可变集合</td></tr><tr><td>7</td><td>**def ++(elems: A): Set[A]**合并两个集合</td></tr><tr><td>8</td><td>*_def -(elem1: A, elem2: A, elems: A\_): Set[A]**通过移除传入指定集合的元素创建一个新的不可变集合</td></tr><tr><td>9</td><td><strong>def addString(b: StringBuilder): StringBuilder</strong>将不可变集合的所有元素添加到字符串缓冲区</td></tr><tr><td>10</td><td><strong>def addString(b: StringBuilder, sep: String): StringBuilder</strong>将不可变集合的所有元素添加到字符串缓冲区，并使用指定的分隔符</td></tr><tr><td>11</td><td>**def apply(elem: A)**检测集合中是否包含指定元素</td></tr><tr><td>12</td><td><strong>def count(p: (A) =&gt; Boolean): Int</strong>计算满足指定条件的集合元素个数</td></tr><tr><td>13</td><td><strong>def copyToArray(xs: Array[A], start: Int, len: Int): Unit</strong>复制不可变集合元素到数组</td></tr><tr><td>14</td><td>**def diff(that: Set[A]): Set[A]**比较两个集合的差集</td></tr><tr><td>15</td><td>**def drop(n: Int): Set[A]]**返回丢弃前n个元素新集合</td></tr><tr><td>16</td><td>**def dropRight(n: Int): Set[A]**返回丢弃最后n个元素新集合</td></tr><tr><td>17</td><td>**def dropWhile(p: (A) =&gt; Boolean): Set[A]**从左向右丢弃元素，直到条件p不成立</td></tr><tr><td>18</td><td><strong>def equals(that: Any): Boolean</strong>equals 方法可用于任意序列。用于比较系列是否相等。</td></tr><tr><td>19</td><td><strong>def exists(p: (A) =&gt; Boolean): Boolean</strong>判断不可变集合中指定条件的元素是否存在。</td></tr><tr><td>20</td><td>**def filter(p: (A) =&gt; Boolean): Set[A]**输出符合指定条件的所有不可变集合元素。</td></tr><tr><td>21</td><td>**def find(p: (A) =&gt; Boolean): Option[A]**查找不可变集合中满足指定条件的第一个元素</td></tr><tr><td>22</td><td><strong>def forall(p: (A) =&gt; Boolean): Boolean</strong>查找指定条件是否适用于此集合的所有元素</td></tr><tr><td>23</td><td><strong>def foreach(f: (A) =&gt; Unit): Unit</strong>将函数应用到不可变集合的所有元素</td></tr><tr><td>24</td><td><strong>def head: A</strong>获取不可变集合的第一个元素</td></tr><tr><td>25</td><td>**def init: Set[A]**返回所有元素，除了最后一个</td></tr><tr><td>26</td><td>**def intersect(that: Set[A]): Set[A]**计算两个集合的交集</td></tr><tr><td>27</td><td><strong>def isEmpty: Boolean</strong>判断集合是否为空</td></tr><tr><td>28</td><td>**def iterator: Iterator[A]**创建一个新的迭代器来迭代元素</td></tr><tr><td>29</td><td><strong>def last: A</strong>返回最后一个元素</td></tr><tr><td>30</td><td>**def map[B](f: (A) =&gt; B): immutable.Set[B]**通过给定的方法将所有元素重新计算</td></tr><tr><td>31</td><td><strong>def max: A</strong>查找最大元素</td></tr><tr><td>32</td><td><strong>def min: A</strong>查找最小元素</td></tr><tr><td>33</td><td><strong>def mkString: String</strong>集合所有元素作为字符串显示</td></tr><tr><td>34</td><td><strong>def mkString(sep: String): String</strong>使用分隔符将集合所有元素作为字符串显示</td></tr><tr><td>35</td><td><strong>def product: A</strong>返回不可变集合中数字元素的积。</td></tr><tr><td>36</td><td><strong>def size: Int</strong>返回不可变集合元素的数量</td></tr><tr><td>37</td><td>**def splitAt(n: Int): (Set[A], Set[A])**把不可变集合拆分为两个容器，第一个由前 n 个元素组成，第二个由剩下的元素组成</td></tr><tr><td>38</td><td><strong>def subsetOf(that: Set[A]): Boolean</strong>如果集合中含有子集返回 true，否则返回false</td></tr><tr><td>39</td><td><strong>def sum: A</strong>返回不可变集合中所有数字元素之和</td></tr><tr><td>40</td><td>**def tail: Set[A]**返回一个不可变集合中除了第一元素之外的其他元素</td></tr><tr><td>41</td><td>**def take(n: Int): Set[A]**返回前 n 个元素</td></tr><tr><td>42</td><td>**def takeRight(n: Int):Set[A]**返回后 n 个元素</td></tr><tr><td>43</td><td>**def toArray: Array[A]**将集合转换为数组</td></tr><tr><td>44</td><td>**def toBuffer[B &gt;: A]: Buffer[B]**返回缓冲区，包含了不可变集合的所有元素</td></tr><tr><td>45</td><td>**def toList: List[A]**返回 List，包含了不可变集合的所有元素</td></tr><tr><td>46</td><td>**def toMap[T, U]: Map[T, U]**返回 Map，包含了不可变集合的所有元素</td></tr><tr><td>47</td><td>**def toSeq: Seq[A]**返回 Seq，包含了不可变集合的所有元素</td></tr><tr><td>48</td><td><strong>def toString(): String</strong>返回一个字符串，以对象来表示</td></tr></tbody></table><blockquote><p>更多方法可以参考 <a href="http://www.scala-lang.org/api/current/scala/collection/immutable/List.html">API文档</a></p></blockquote><h2 id="13-3-Scala-Map-映射"><a href="#13-3-Scala-Map-映射" class="headerlink" title="13.3 Scala Map(映射)"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_133-scala-map%E6%98%A0%E5%B0%84">13.3 Scala Map(映射)</a></h2><p>Map(映射)是一种可迭代的键值对（key/value）结构。</p><p>所有的值都可以通过键来获取。</p><p>Map 中的键都是唯一的。</p><p>Map 也叫哈希表（Hash tables）。</p><p><strong>Map 有两种类型，可变与不可变，区别在于可变对象可以修改它，而不可变对象不可以</strong>。</p><p>默认情况下 Scala 使用不可变 Map。如果你需要使用可变集合，你需要显式的引入 <strong>import scala.collection.mutable.Map</strong> 类</p><p>在 Scala 中 你可以同时使用可变与不可变 Map，不可变的直接使用 Map，可变的使用 mutable.Map。以下实例演示了不可变 Map 的应用：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token comment">// 空哈希表，键为字符串，值为整型</span><span class="token keyword">var</span> A<span class="token operator">:</span>Map<span class="token punctuation">[</span><span class="token builtin">Char</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// Map 键值对演示</span><span class="token keyword">val</span> colors <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"red"</span> <span class="token operator">-&gt;</span> <span class="token string">"#FF0000"</span><span class="token punctuation">,</span> <span class="token string">"azure"</span> <span class="token operator">-&gt;</span> <span class="token string">"#F0FFFF"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>定义 Map 时，需要为键值对定义类型。如果需要添加 key-value 对，可以使用 + 号，如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">A <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token char">'I'</span> <span class="token operator">-&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>A <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token char">'J'</span> <span class="token operator">-&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span>A <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token char">'K'</span> <span class="token operator">-&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>A <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token char">'L'</span> <span class="token operator">-&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-3-1-Map-基本操作"><a href="#13-3-1-Map-基本操作" class="headerlink" title="13.3.1 Map 基本操作"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1331-map-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C">13.3.1 Map 基本操作</a></h3><p>Scala Map 有三个基本操作：</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>keys</td><td>返回 Map 所有的键(key)</td></tr><tr><td>values</td><td>返回 Map 所有的值(value)</td></tr><tr><td>isEmpty</td><td>在 Map 为空时返回true</td></tr></tbody></table><p>示例：</p><p>以下实例演示了以上三个方法的基本应用：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> colors <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"red"</span> <span class="token operator">-&gt;</span> <span class="token string">"#FF0000"</span><span class="token punctuation">,</span>                     <span class="token string">"azure"</span> <span class="token operator">-&gt;</span> <span class="token string">"#F0FFFF"</span><span class="token punctuation">,</span>                     <span class="token string">"peru"</span> <span class="token operator">-&gt;</span> <span class="token string">"#CD853F"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> nums<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"colors 中的键为 : "</span> <span class="token operator">+</span> colors<span class="token punctuation">.</span>keys <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"colors 中的值为 : "</span> <span class="token operator">+</span> colors<span class="token punctuation">.</span>values <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"检测 colors 是否为空 : "</span> <span class="token operator">+</span> colors<span class="token punctuation">.</span>isEmpty <span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"检测 nums 是否为空 : "</span> <span class="token operator">+</span> nums<span class="token punctuation">.</span>isEmpty <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testcolors 中的键为 <span class="token builtin class-name">:</span> Set<span class="token punctuation">(</span>red, azure, peru<span class="token punctuation">)</span>colors 中的值为 <span class="token builtin class-name">:</span> MapLike<span class="token punctuation">(</span><span class="token comment">#FF0000, #F0FFFF, #CD853F)</span>检测 colors 是否为空 <span class="token builtin class-name">:</span> <span class="token boolean">false</span>检测 nums 是否为空 <span class="token builtin class-name">:</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-3-2-Map-合并"><a href="#13-3-2-Map-合并" class="headerlink" title="13.3.2 Map 合并"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1332-map-%E5%90%88%E5%B9%B6">13.3.2 Map 合并</a></h3><p>你可以使用 <strong>++</strong> 运算符或 <strong>Map.++()</strong> 方法来连接两个 Map，Map 合并时会移除重复的 key。以下演示了两个 Map 合并的实例:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> colors1 <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"red"</span> <span class="token operator">-&gt;</span> <span class="token string">"#FF0000"</span><span class="token punctuation">,</span>                      <span class="token string">"azure"</span> <span class="token operator">-&gt;</span> <span class="token string">"#F0FFFF"</span><span class="token punctuation">,</span>                      <span class="token string">"peru"</span> <span class="token operator">-&gt;</span> <span class="token string">"#CD853F"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> colors2 <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"blue"</span> <span class="token operator">-&gt;</span> <span class="token string">"#0033FF"</span><span class="token punctuation">,</span>                      <span class="token string">"yellow"</span> <span class="token operator">-&gt;</span> <span class="token string">"#FFFF00"</span><span class="token punctuation">,</span>                      <span class="token string">"red"</span> <span class="token operator">-&gt;</span> <span class="token string">"#FF0000"</span><span class="token punctuation">)</span>    <span class="token comment">//  ++ 作为运算符</span>    <span class="token keyword">var</span> colors <span class="token operator">=</span> colors1 <span class="token operator">++</span> colors2    println<span class="token punctuation">(</span> <span class="token string">"colors1 ++ colors2 : "</span> <span class="token operator">+</span> colors <span class="token punctuation">)</span>    <span class="token comment">//  ++ 作为方法</span>    colors <span class="token operator">=</span> colors1<span class="token punctuation">.</span>+<span class="token operator">+</span><span class="token punctuation">(</span>colors2<span class="token punctuation">)</span>    println<span class="token punctuation">(</span> <span class="token string">"colors1.++(colors2) : "</span> <span class="token operator">+</span> colors <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testcolors1 ++ colors2 <span class="token builtin class-name">:</span> Map<span class="token punctuation">(</span>blue -<span class="token operator">&gt;</span> <span class="token comment">#0033FF, azure -&gt; #F0FFFF, peru -&gt; #CD853F, yellow -&gt; #FFFF00, red -&gt; #FF0000)</span>colors1.++<span class="token punctuation">(</span>colors2<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> Map<span class="token punctuation">(</span>blue -<span class="token operator">&gt;</span> <span class="token comment">#0033FF, azure -&gt; #F0FFFF, peru -&gt; #CD853F, yellow -&gt; #FFFF00, red -&gt; #FF0000)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-3-3-输出-Map-的-keys-和-values"><a href="#13-3-3-输出-Map-的-keys-和-values" class="headerlink" title="13.3.3 输出 Map 的 keys 和 values"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1333-%E8%BE%93%E5%87%BA-map-%E7%9A%84-keys-%E5%92%8C-values">13.3.3 输出 Map 的 keys 和 values</a></h3><p>以下通过 foreach 循环输出 Map 中的 keys 和 values：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> sites <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"runoob"</span> <span class="token operator">-&gt;</span> <span class="token string">"http://www.runoob.com"</span><span class="token punctuation">,</span>                    <span class="token string">"baidu"</span> <span class="token operator">-&gt;</span> <span class="token string">"http://www.baidu.com"</span><span class="token punctuation">,</span>                    <span class="token string">"taobao"</span> <span class="token operator">-&gt;</span> <span class="token string">"http://www.taobao.com"</span><span class="token punctuation">)</span>    sites<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>foreach<span class="token punctuation">{</span> i <span class="token keyword">=&gt;</span>        print<span class="token punctuation">(</span> <span class="token string">"Key = "</span> <span class="token operator">+</span> i <span class="token punctuation">)</span>      println<span class="token punctuation">(</span><span class="token string">" Value = "</span> <span class="token operator">+</span> sites<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestKey <span class="token operator">=</span> runoob Value <span class="token operator">=</span> http://www.runoob.comKey <span class="token operator">=</span> baidu Value <span class="token operator">=</span> http://www.baidu.comKey <span class="token operator">=</span> taobao Value <span class="token operator">=</span> http://www.taobao.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-3-4-查看-Map-中是否存在指定的-Key"><a href="#13-3-4-查看-Map-中是否存在指定的-Key" class="headerlink" title="13.3.4 查看 Map 中是否存在指定的 Key"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1334-%E6%9F%A5%E7%9C%8B-map-%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%8C%87%E5%AE%9A%E7%9A%84-key">13.3.4 查看 Map 中是否存在指定的 Key</a></h3><p>你可以使用 <strong>Map.contains</strong> 方法来查看 Map 中是否存在指定的 Key。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> sites <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"runoob"</span> <span class="token operator">-&gt;</span> <span class="token string">"http://www.runoob.com"</span><span class="token punctuation">,</span>                    <span class="token string">"baidu"</span> <span class="token operator">-&gt;</span> <span class="token string">"http://www.baidu.com"</span><span class="token punctuation">,</span>                    <span class="token string">"taobao"</span> <span class="token operator">-&gt;</span> <span class="token string">"http://www.taobao.com"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> sites<span class="token punctuation">.</span>contains<span class="token punctuation">(</span> <span class="token string">"runoob"</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"runoob 键存在，对应的值为 :"</span>  <span class="token operator">+</span> sites<span class="token punctuation">(</span><span class="token string">"runoob"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"runoob 键不存在"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> sites<span class="token punctuation">.</span>contains<span class="token punctuation">(</span> <span class="token string">"baidu"</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"baidu 键存在，对应的值为 :"</span>  <span class="token operator">+</span> sites<span class="token punctuation">(</span><span class="token string">"baidu"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"baidu 键不存在"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> sites<span class="token punctuation">.</span>contains<span class="token punctuation">(</span> <span class="token string">"google"</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"google 键存在，对应的值为 :"</span>  <span class="token operator">+</span> sites<span class="token punctuation">(</span><span class="token string">"google"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"google 键不存在"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testrunoob 键存在，对应的值为 :http://www.runoob.combaidu 键存在，对应的值为 :http://www.baidu.comgoogle 键不存在<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-3-5-Scala-Map-方法"><a href="#13-3-5-Scala-Map-方法" class="headerlink" title="13.3.5 Scala Map 方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1335-scala-map-%E6%96%B9%E6%B3%95">13.3.5 Scala Map 方法</a></h3><p>下表列出了 Scala Map 常用的方法：</p><table><thead><tr><th>序号</th><th>方法及描述</th></tr></thead><tbody><tr><td>1</td><td>**def ++(xs: Map[(A, B)]): Map[A, B]**返回一个新的 Map，新的 Map xs 组成</td></tr><tr><td>2</td><td>*_def -(elem1: A, elem2: A, elems: A\_): Map[A, B]**返回一个新的 Map, 移除 key 为 elem1, elem2 或其他 elems。</td></tr><tr><td>3</td><td>**def –(xs: GTO[A]): Map[A, B]**返回一个新的 Map, 移除 xs 对象中对应的 key</td></tr><tr><td>4</td><td>**def get(key: A): Option[B]**返回指定 key 的值</td></tr><tr><td>5</td><td>**def iterator: Iterator[(A, B)]**创建新的迭代器，并输出 key/value 对</td></tr><tr><td>6</td><td><strong>def addString(b: StringBuilder): StringBuilder</strong>将 Map 中的所有元素附加到StringBuilder，可加入分隔符</td></tr><tr><td>7</td><td><strong>def addString(b: StringBuilder, sep: String): StringBuilder</strong>将 Map 中的所有元素附加到StringBuilder，可加入分隔符</td></tr><tr><td>8</td><td><strong>def apply(key: A): B</strong>返回指定键的值，如果不存在返回 Map 的默认方法</td></tr><tr><td>9</td><td><strong>def clear(): Unit</strong>清空 Map</td></tr><tr><td>10</td><td>**def clone(): Map[A, B]**从一个 Map 复制到另一个 Map</td></tr><tr><td>11</td><td><strong>def contains(key: A): Boolean</strong>如果 Map 中存在指定 key，返回 true，否则返回 false。</td></tr><tr><td>12</td><td><strong>def copyToArray(xs: Array[(A, B)]): Unit</strong>复制集合到数组</td></tr><tr><td>13</td><td><strong>def count(p: ((A, B)) =&gt; Boolean): Int</strong>计算满足指定条件的集合元素数量</td></tr><tr><td>14</td><td><strong>def default(key: A): B</strong>定义 Map 的默认值，在 key 不存在时返回。</td></tr><tr><td>15</td><td>**def drop(n: Int): Map[A, B]**返回丢弃前n个元素新集合</td></tr><tr><td>16</td><td>**def dropRight(n: Int): Map[A, B]**返回丢弃最后n个元素新集合</td></tr><tr><td>17</td><td>**def dropWhile(p: ((A, B)) =&gt; Boolean): Map[A, B]**从左向右丢弃元素，直到条件p不成立</td></tr><tr><td>18</td><td>**def empty: Map[A, B]**返回相同类型的空 Map</td></tr><tr><td>19</td><td><strong>def equals(that: Any): Boolean</strong>如果两个 Map 相等(key/value 均相等)，返回true，否则返回false</td></tr><tr><td>20</td><td><strong>def exists(p: ((A, B)) =&gt; Boolean): Boolean</strong>判断集合中指定条件的元素是否存在</td></tr><tr><td>21</td><td>**def filter(p: ((A, B))=&gt; Boolean): Map[A, B]**返回满足指定条件的所有集合</td></tr><tr><td>22</td><td>**def filterKeys(p: (A) =&gt; Boolean): Map[A, B]**返回符合指定条件的不可变 Map</td></tr><tr><td>23</td><td>**def find(p: ((A, B)) =&gt; Boolean): Option[(A, B)]**查找集合中满足指定条件的第一个元素</td></tr><tr><td>24</td><td><strong>def foreach(f: ((A, B)) =&gt; Unit): Unit</strong>将函数应用到集合的所有元素</td></tr><tr><td>25</td><td>**def init: Map[A, B]**返回所有元素，除了最后一个</td></tr><tr><td>26</td><td><strong>def isEmpty: Boolean</strong>检测 Map 是否为空</td></tr><tr><td>27</td><td>**def keys: Iterable[A]**返回所有的key/p&gt;</td></tr><tr><td>28</td><td>**def last: (A, B)**返回最后一个元素</td></tr><tr><td>29</td><td>**def max: (A, B)**查找最大元素</td></tr><tr><td>30</td><td>**def min: (A, B)**查找最小元素</td></tr><tr><td>31</td><td><strong>def mkString: String</strong>集合所有元素作为字符串显示</td></tr><tr><td>32</td><td>**def product: (A, B)**返回集合中数字元素的积。</td></tr><tr><td>33</td><td>**def remove(key: A): Option[B]**移除指定 key</td></tr><tr><td>34</td><td><strong>def retain(p: (A, B) =&gt; Boolean): Map.this.type</strong>如果符合满足条件的返回 true</td></tr><tr><td>35</td><td><strong>def size: Int</strong>返回 Map 元素的个数</td></tr><tr><td>36</td><td>**def sum: (A, B)**返回集合中所有数字元素之和</td></tr><tr><td>37</td><td>**def tail: Map[A, B]**返回一个集合中除了第一元素之外的其他元素</td></tr><tr><td>38</td><td>**def take(n: Int): Map[A, B]**返回前 n 个元素</td></tr><tr><td>39</td><td>**def takeRight(n: Int): Map[A, B]**返回后 n 个元素</td></tr><tr><td>40</td><td>**def takeWhile(p: ((A, B)) =&gt; Boolean): Map[A, B]**返回满足指定条件的元素</td></tr><tr><td>41</td><td>**def toArray: Array[(A, B)]**集合转数组</td></tr><tr><td>42</td><td>**def toBuffer[B &gt;: A]: Buffer[B]**返回缓冲区，包含了 Map 的所有元素</td></tr><tr><td>43</td><td>**def toList: List[A]**返回 List，包含了 Map 的所有元素</td></tr><tr><td>44</td><td>**def toSeq: Seq[A]**返回 Seq，包含了 Map 的所有元素</td></tr><tr><td>45</td><td>**def toSet: Set[A]**返回 Set，包含了 Map 的所有元素</td></tr><tr><td>46</td><td><strong>def toString(): String</strong>返回字符串对象</td></tr></tbody></table><blockquote><p>更多方法可以参考 <a href="http://www.scala-lang.org/api/current/scala/collection/immutable/Map.html">API文档</a></p><p>使用 <strong>++</strong> 或则 <strong>.++()</strong> 方法合并两个 Map。</p><p>需要注意的是: 如果 Map 中存在相同的 key，合并后的 Map 中的 value 会被最右边的 Map 的值所代替。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">var</span> suit1 <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"red"</span><span class="token operator">-&gt;</span><span class="token string">"#FFF"</span><span class="token punctuation">,</span><span class="token string">"blue"</span><span class="token operator">-&gt;</span><span class="token string">"#FED"</span><span class="token punctuation">,</span><span class="token string">"yellow"</span><span class="token operator">-&gt;</span><span class="token string">"#00F"</span><span class="token punctuation">,</span><span class="token string">"green"</span><span class="token operator">-&gt;</span><span class="token string">"#0F0"</span><span class="token punctuation">)</span><span class="token keyword">var</span> suit2 <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"red"</span><span class="token operator">-&gt;</span><span class="token string">"#FF1"</span><span class="token punctuation">,</span><span class="token string">"green"</span><span class="token operator">-&gt;</span><span class="token string">"#1F1"</span><span class="token punctuation">)</span><span class="token keyword">var</span> suit3 <span class="token operator">=</span> suit1<span class="token operator">++</span>suit2println<span class="token punctuation">(</span><span class="token string">"the value of suit1 is:"</span> <span class="token operator">+</span>suit1<span class="token punctuation">)</span>println<span class="token punctuation">(</span><span class="token string">"the value of suit2 is:"</span> <span class="token operator">+</span>suit2<span class="token punctuation">)</span>println<span class="token punctuation">(</span><span class="token string">"the value of after ++ is:"</span> <span class="token operator">+</span>suit3<span class="token punctuation">)</span>println<span class="token punctuation">(</span><span class="token string">"the value of after .++() is:"</span> <span class="token operator">+</span>suit1<span class="token punctuation">.</span>+<span class="token operator">+</span><span class="token punctuation">(</span>suit2<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">the value of suit1 is<span class="token operator">:</span>Map<span class="token punctuation">(</span>red <span class="token operator">-&gt;</span> #FFF<span class="token punctuation">,</span> blue <span class="token operator">-&gt;</span> #FED<span class="token punctuation">,</span> yellow <span class="token operator">-&gt;</span> #<span class="token number">00F</span><span class="token punctuation">,</span> green <span class="token operator">-&gt;</span> #<span class="token number">0F</span><span class="token number">0</span><span class="token punctuation">)</span>the value of suit2 is<span class="token operator">:</span>Map<span class="token punctuation">(</span>red <span class="token operator">-&gt;</span> #FF1<span class="token punctuation">,</span> green <span class="token operator">-&gt;</span> #<span class="token number">1F</span><span class="token number">1</span><span class="token punctuation">)</span>the value of after <span class="token operator">++</span> is<span class="token operator">:</span>Map<span class="token punctuation">(</span>red <span class="token operator">-&gt;</span> #FF1<span class="token punctuation">,</span> blue <span class="token operator">-&gt;</span> #FED<span class="token punctuation">,</span> yellow <span class="token operator">-&gt;</span> #<span class="token number">00F</span><span class="token punctuation">,</span> green <span class="token operator">-&gt;</span> #<span class="token number">1F</span><span class="token number">1</span><span class="token punctuation">)</span>the value of after <span class="token punctuation">.</span>+<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">)</span> is<span class="token operator">:</span>Map<span class="token punctuation">(</span>red <span class="token operator">-&gt;</span> #FF1<span class="token punctuation">,</span> blue <span class="token operator">-&gt;</span> #FED<span class="token punctuation">,</span> yellow <span class="token operator">-&gt;</span> #<span class="token number">00F</span><span class="token punctuation">,</span> green <span class="token operator">-&gt;</span> #<span class="token number">1F</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h2 id="13-4-Scala-元组"><a href="#13-4-Scala-元组" class="headerlink" title="13.4 Scala 元组"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_134-scala-%E5%85%83%E7%BB%84">13.4 Scala 元组</a></h2><p><strong>与列表一样，元组也是不可变的，但与列表不同的是元组可以包含不同类型的元素</strong>。</p><p>元组的值是通过将单个的值包含在圆括号中构成的。例如：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">,</span> <span class="token string">"Fred"</span><span class="token punctuation">)</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以上实例在元组中定义了三个元素，对应的类型分别为[Int, Double, java.lang.String]。</p><p>此外我们也可以使用以下方式来定义：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> t <span class="token operator">=</span> <span class="token keyword">new</span> Tuple3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">,</span> <span class="token string">"Fred"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>元组的实际类型取决于它的元素的类型，比如 (99, “runoob”) 是 Tuple2[Int, String]。 (‘u’, ‘r’, “the”, 1, 4, “me”) 为 Tuple6[Char, Char, String, Int, Int, String]。</p><p><strong>目前 Scala 支持的元组最大长度为 22。对于更大长度你可以使用集合，或者扩展元组</strong>。</p><p>访问元组的元素可以通过数字索引，如下一个元组：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">val</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们可以使用 t._1 访问第一个元素， t._2 访问第二个元素，如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> sum <span class="token operator">=</span> t<span class="token punctuation">.</span>_1 <span class="token operator">+</span> t<span class="token punctuation">.</span>_2 <span class="token operator">+</span> t<span class="token punctuation">.</span>_3 <span class="token operator">+</span> t<span class="token punctuation">.</span>_4    println<span class="token punctuation">(</span> <span class="token string">"元素之和为: "</span>  <span class="token operator">+</span> sum <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test元素之和为: <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="13-4-1-迭代元组"><a href="#13-4-1-迭代元组" class="headerlink" title="13.4.1 迭代元组"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1341-%E8%BF%AD%E4%BB%A3%E5%85%83%E7%BB%84">13.4.1 迭代元组</a></h3><p>你可以使用 <strong>Tuple.productIterator()</strong> 方法来迭代输出元组的所有元素：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>    t<span class="token punctuation">.</span>productIterator<span class="token punctuation">.</span>foreach<span class="token punctuation">{</span> i <span class="token keyword">=&gt;</span>println<span class="token punctuation">(</span><span class="token string">"Value = "</span> <span class="token operator">+</span> i <span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestValue <span class="token operator">=</span> <span class="token number">4</span>Value <span class="token operator">=</span> <span class="token number">3</span>Value <span class="token operator">=</span> <span class="token number">2</span>Value <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-4-2-元组转为字符串"><a href="#13-4-2-元组转为字符串" class="headerlink" title="13.4.2 元组转为字符串"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1342-%E5%85%83%E7%BB%84%E8%BD%AC%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2">13.4.2 元组转为字符串</a></h3><p>你可以使用 <strong>Tuple.toString()</strong> 方法将元组的所有元素组合成一个字符串，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> t <span class="token operator">=</span> <span class="token keyword">new</span> Tuple3<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> Console<span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"连接后的字符串为: "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test连接后的字符串为: <span class="token punctuation">(</span><span class="token number">1</span>,hello,scala.Console<span class="token variable">$@</span>4dd8dc3<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="13-4-3-元素交换"><a href="#13-4-3-元素交换" class="headerlink" title="13.4.3 元素交换"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1343-%E5%85%83%E7%B4%A0%E4%BA%A4%E6%8D%A2">13.4.3 元素交换</a></h3><p>你可以使用 <strong>Tuple.swap</strong> 方法来交换元组的元素。如下实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> t <span class="token operator">=</span> <span class="token keyword">new</span> Tuple2<span class="token punctuation">(</span><span class="token string">"www.google.com"</span><span class="token punctuation">,</span> <span class="token string">"www.runoob.com"</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"交换后的元组: "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span>swap <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test交换后的元组: <span class="token punctuation">(</span>www.runoob.com,www.google.com<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="13-5-Scala-Option-选项"><a href="#13-5-Scala-Option-选项" class="headerlink" title="13.5 Scala Option(选项)"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_135-scala-option%E9%80%89%E9%A1%B9">13.5 Scala Option(选项)</a></h2><p>Scala Option(选项)类型用来表示一个值是可选的（有值或无值)。</p><p><strong>Option[T] 是一个类型为 T 的可选值的容器： 如果值存在， Option[T] 就是一个 Some[T] ，如果不存在， Option[T] 就是对象 None</strong> 。</p><p>接下来我们来看一段代码：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token comment">// 虽然 Scala 可以不定义变量的类型，不过为了清楚些，我还是</span><span class="token comment">// 把他显示的定义上了</span><span class="token keyword">val</span> myMap<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"key1"</span> <span class="token operator">-&gt;</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token keyword">val</span> value1<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> myMap<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">)</span><span class="token keyword">val</span> value2<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> myMap<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"key2"</span><span class="token punctuation">)</span>println<span class="token punctuation">(</span>value1<span class="token punctuation">)</span> <span class="token comment">// Some("value1")</span>println<span class="token punctuation">(</span>value2<span class="token punctuation">)</span> <span class="token comment">// None</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的代码中，myMap 一个是一个 Key 的类型是 String，Value 的类型是 String 的 hash map，但不一样的是他的 get() 返回的是一个叫 Option[String] 的类别。</p><p>Scala 使用 Option[String] 来告诉你：「我会想办法回传一个 String，但也可能没有 String 给你」。</p><p>myMap 里并没有 key2 这笔数据，get() 方法返回 None。</p><p>Option 有两个子类别，一个是 Some，一个是 None，当他回传 Some 的时候，代表这个函式成功地给了你一个 String，而你可以透过 get() 这个函式拿到那个 String，如果他返回的是 None，则代表没有字符串可以给你。</p><p>另一个实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> sites <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"runoob"</span> <span class="token operator">-&gt;</span> <span class="token string">"www.runoob.com"</span><span class="token punctuation">,</span> <span class="token string">"google"</span> <span class="token operator">-&gt;</span> <span class="token string">"www.google.com"</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"sites.get( \"runoob\" ) : "</span> <span class="token operator">+</span>  sites<span class="token punctuation">.</span>get<span class="token punctuation">(</span> <span class="token string">"runoob"</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Some(www.runoob.com)</span>    println<span class="token punctuation">(</span><span class="token string">"sites.get( \"baidu\" ) : "</span> <span class="token operator">+</span>  sites<span class="token punctuation">.</span>get<span class="token punctuation">(</span> <span class="token string">"baidu"</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//  None</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testsites.get<span class="token punctuation">(</span> <span class="token string">"runoob"</span> <span class="token punctuation">)</span> <span class="token builtin class-name">:</span> Some<span class="token punctuation">(</span>www.runoob.com<span class="token punctuation">)</span>sites.get<span class="token punctuation">(</span> <span class="token string">"baidu"</span> <span class="token punctuation">)</span> <span class="token builtin class-name">:</span> None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>你也可以通过模式匹配来输出匹配值。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> sites <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"runoob"</span> <span class="token operator">-&gt;</span> <span class="token string">"www.runoob.com"</span><span class="token punctuation">,</span> <span class="token string">"google"</span> <span class="token operator">-&gt;</span> <span class="token string">"www.google.com"</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"show(sites.get( \"runoob\")) : "</span> <span class="token operator">+</span>              show<span class="token punctuation">(</span>sites<span class="token punctuation">.</span>get<span class="token punctuation">(</span> <span class="token string">"runoob"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"show(sites.get( \"baidu\")) : "</span> <span class="token operator">+</span>              show<span class="token punctuation">(</span>sites<span class="token punctuation">.</span>get<span class="token punctuation">(</span> <span class="token string">"baidu"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> show<span class="token punctuation">(</span>x<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> x <span class="token keyword">match</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> Some<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> s    <span class="token keyword">case</span> None <span class="token keyword">=&gt;</span> <span class="token string">"?"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testshow<span class="token punctuation">(</span>sites.get<span class="token punctuation">(</span> <span class="token string">"runoob"</span><span class="token punctuation">))</span> <span class="token builtin class-name">:</span> www.runoob.comshow<span class="token punctuation">(</span>sites.get<span class="token punctuation">(</span> <span class="token string">"baidu"</span><span class="token punctuation">))</span> <span class="token builtin class-name">:</span> ?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-5-1-getOrElse-方法"><a href="#13-5-1-getOrElse-方法" class="headerlink" title="13.5.1 getOrElse() 方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1351-getorelse-%E6%96%B9%E6%B3%95">13.5.1 getOrElse() 方法</a></h3><p>你可以使用 getOrElse() 方法来获取元组中存在的元素或者使用其默认的值，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> a<span class="token operator">:</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Some<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> b<span class="token operator">:</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> None    println<span class="token punctuation">(</span><span class="token string">"a.getOrElse(0): "</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"b.getOrElse(10): "</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testa.getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>: <span class="token number">5</span>b.getOrElse<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>: <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-5-2-isEmpty-方法"><a href="#13-5-2-isEmpty-方法" class="headerlink" title="13.5.2 isEmpty() 方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1352-isempty-%E6%96%B9%E6%B3%95">13.5.2 isEmpty() 方法</a></h3><p>你可以使用 isEmpty() 方法来检测元组中的元素是否为 None，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> a<span class="token operator">:</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Some<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> b<span class="token operator">:</span>Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> None    println<span class="token punctuation">(</span><span class="token string">"a.isEmpty: "</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>isEmpty <span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"b.isEmpty: "</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>isEmpty <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testa.isEmpty: <span class="token boolean">false</span>b.isEmpty: <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-5-3-Scala-Option-常用方法"><a href="#13-5-3-Scala-Option-常用方法" class="headerlink" title="13.5.3 Scala Option 常用方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1353-scala-option-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95">13.5.3 Scala Option 常用方法</a></h3><p>下表列出了 Scala Option 常用的方法：</p><table><thead><tr><th>序号</th><th>方法及描述</th></tr></thead><tbody><tr><td>1</td><td><strong>def get: A</strong>获取可选值</td></tr><tr><td>2</td><td><strong>def isEmpty: Boolean</strong>检测可选类型值是否为 None，是的话返回 true，否则返回 false</td></tr><tr><td>3</td><td><strong>def productArity: Int</strong>返回元素个数， A(x_1, …, x_k), 返回 k</td></tr><tr><td>4</td><td><strong>def productElement(n: Int): Any</strong>获取指定的可选项，以 0 为起始。即 A(x_1, …, x_k), 返回 x_(n+1) ， 0 &lt; n &lt; k.</td></tr><tr><td>5</td><td><strong>def exists(p: (A) =&gt; Boolean): Boolean</strong>如果可选项中指定条件的元素存在且不为 None 返回 true，否则返回 false。</td></tr><tr><td>6</td><td>**def filter(p: (A) =&gt; Boolean): Option[A]**如果选项包含有值，而且传递给 filter 的条件函数返回 true， filter 会返回 Some 实例。 否则，返回值为 None 。</td></tr><tr><td>7</td><td>**def filterNot(p: (A) =&gt; Boolean): Option[A]**如果选项包含有值，而且传递给 filter 的条件函数返回 false， filter 会返回 Some 实例。 否则，返回值为 None 。</td></tr><tr><td>8</td><td>**def flatMap[B](f: (A) =&gt; Option[B]): Option[B]**如果选项包含有值，则传递给函数 f 处理后返回，否则返回 None</td></tr><tr><td>9</td><td><strong>def foreach[U](f: (A) =&gt; U): Unit</strong>如果选项包含有值，则将每个值传递给函数 f， 否则不处理。</td></tr><tr><td>10</td><td><strong>def getOrElse[B &gt;: A](default: =&gt; B): B</strong>如果选项包含有值，返回选项值，否则返回设定的默认值。</td></tr><tr><td>11</td><td><strong>def isDefined: Boolean</strong>如果可选值是 Some 的实例返回 true，否则返回 false。</td></tr><tr><td>12</td><td>**def iterator: Iterator[A]**如果选项包含有值，迭代出可选值。如果可选值为空则返回空迭代器。</td></tr><tr><td>13</td><td>**def map[B](f: (A) =&gt; B): Option[B]**如果选项包含有值， 返回由函数 f 处理后的 Some，否则返回 None</td></tr><tr><td>14</td><td>**def orElse[B &gt;: A](alternative: =&gt; Option[B]): Option[B]**如果一个 Option 是 None ， orElse 方法会返回传名参数的值，否则，就直接返回这个 Option。</td></tr><tr><td>15</td><td><strong>def orNull</strong>如果选项包含有值返回选项值，否则返回 null。</td></tr></tbody></table><p>Scala Iterator（迭代器）不是一个集合，它是一种用于访问集合的方法。</p><p>迭代器 it 的两个基本操作是 <strong>next</strong> 和 <strong>hasNext</strong>。</p><p>调用 <strong>it.next()</strong> 会返回迭代器的下一个元素，并且更新迭代器的状态。</p><p>调用 <strong>it.hasNext()</strong> 用于检测集合中是否还有元素。</p><p>让迭代器 it 逐个返回所有元素最简单的方法是使用 while 循环：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> it <span class="token operator">=</span> Iterator<span class="token punctuation">(</span><span class="token string">"Baidu"</span><span class="token punctuation">,</span> <span class="token string">"Google"</span><span class="token punctuation">,</span> <span class="token string">"Runoob"</span><span class="token punctuation">,</span> <span class="token string">"Taobao"</span><span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span><span class="token punctuation">{</span>      println<span class="token punctuation">(</span>it<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestBaiduGoogleRunoobTaobao<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="14-1-查找最大与最小元素"><a href="#14-1-查找最大与最小元素" class="headerlink" title="14.1 查找最大与最小元素"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_141-%E6%9F%A5%E6%89%BE%E6%9C%80%E5%A4%A7%E4%B8%8E%E6%9C%80%E5%B0%8F%E5%85%83%E7%B4%A0">14.1 查找最大与最小元素</a></h2><p>你可以使用 <strong>it.min</strong> 和 <strong>it.max</strong> 方法从迭代器中查找最大与最小元素，实例如下:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> ita <span class="token operator">=</span> Iterator<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> itb <span class="token operator">=</span> Iterator<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"最大元素是："</span> <span class="token operator">+</span> ita<span class="token punctuation">.</span>max <span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"最小元素是："</span> <span class="token operator">+</span> itb<span class="token punctuation">.</span>min <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test最大元素是：90最小元素是：2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="14-2-获取迭代器的长度"><a href="#14-2-获取迭代器的长度" class="headerlink" title="14.2 获取迭代器的长度"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_142-%E8%8E%B7%E5%8F%96%E8%BF%AD%E4%BB%A3%E5%99%A8%E7%9A%84%E9%95%BF%E5%BA%A6">14.2 获取迭代器的长度</a></h2><p>你可以使用 <strong>it.size</strong> 或 <strong>it.length</strong> 方法来查看迭代器中的元素个数。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> ita <span class="token operator">=</span> Iterator<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> itb <span class="token operator">=</span> Iterator<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"ita.size 的值: "</span> <span class="token operator">+</span> ita<span class="token punctuation">.</span>size <span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"itb.length 的值: "</span> <span class="token operator">+</span> itb<span class="token punctuation">.</span>length <span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testita.size 的值: <span class="token number">6</span>itb.length 的值: <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="14-3-Scala-Iterator-常用方法"><a href="#14-3-Scala-Iterator-常用方法" class="headerlink" title="14.3 Scala Iterator 常用方法"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_143-scala-iterator-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95">14.3 Scala Iterator 常用方法</a></h2><p>下表列出了 Scala Iterator 常用的方法：</p><table><thead><tr><th>序号</th><th>方法及描述</th></tr></thead><tbody><tr><td>1</td><td><strong>def hasNext: Boolean</strong>如果还有可返回的元素，返回true。</td></tr><tr><td>2</td><td><strong>def next(): A</strong>返回迭代器的下一个元素，并且更新迭代器的状态</td></tr><tr><td>3</td><td>**def ++(that: =&gt; Iterator[A]): Iterator[A]**合并两个迭代器</td></tr><tr><td>4</td><td>**def ++[B &gt;: A](that :=&gt; GenTraversableOnce[B]): Iterator[B]**合并两个迭代器</td></tr><tr><td>5</td><td><strong>def addString(b: StringBuilder): StringBuilder</strong>添加一个字符串到 StringBuilder b</td></tr><tr><td>6</td><td><strong>def addString(b: StringBuilder, sep: String): StringBuilder</strong>添加一个字符串到 StringBuilder b，并指定分隔符</td></tr><tr><td>7</td><td>**def buffered: BufferedIterator[A]**迭代器都转换成 BufferedIterator</td></tr><tr><td>8</td><td><strong>def contains(elem: Any): Boolean</strong>检测迭代器中是否包含指定元素</td></tr><tr><td>9</td><td><strong>def copyToArray(xs: Array[A], start: Int, len: Int): Unit</strong>将迭代器中选定的值传给数组</td></tr><tr><td>10</td><td><strong>def count(p: (A) =&gt; Boolean): Int</strong>返回迭代器元素中满足条件p的元素总数。</td></tr><tr><td>11</td><td>**def drop(n: Int): Iterator[A]**返回丢弃前n个元素新集合</td></tr><tr><td>12</td><td>**def dropWhile(p: (A) =&gt; Boolean): Iterator[A]**从左向右丢弃元素，直到条件p不成立</td></tr><tr><td>13</td><td>**def duplicate: (Iterator[A], Iterator[A])**生成两个能分别返回迭代器所有元素的迭代器。</td></tr><tr><td>14</td><td><strong>def exists(p: (A) =&gt; Boolean): Boolean</strong>返回一个布尔值，指明迭代器元素中是否存在满足p的元素。</td></tr><tr><td>15</td><td>**def filter(p: (A) =&gt; Boolean): Iterator[A]**返回一个新迭代器 ，指向迭代器元素中所有满足条件p的元素。</td></tr><tr><td>16</td><td>**def filterNot(p: (A) =&gt; Boolean): Iterator[A]**返回一个迭代器，指向迭代器元素中不满足条件p的元素。</td></tr><tr><td>17</td><td>**def find(p: (A) =&gt; Boolean): Option[A]**返回第一个满足p的元素或None。注意：如果找到满足条件的元素，迭代器会被置于该元素之后；如果没有找到，会被置于终点。</td></tr><tr><td>18</td><td>**def flatMap[B](f: (A) =&gt; GenTraversableOnce[B]): Iterator[B]**针对迭代器的序列中的每个元素应用函数f，并返回指向结果序列的迭代器。</td></tr><tr><td>19</td><td><strong>def forall(p: (A) =&gt; Boolean): Boolean</strong>返回一个布尔值，指明 it 所指元素是否都满足p。</td></tr><tr><td>20</td><td><strong>def foreach(f: (A) =&gt; Unit): Unit</strong>在迭代器返回的每个元素上执行指定的程序 f</td></tr><tr><td>21</td><td><strong>def hasDefiniteSize: Boolean</strong>如果迭代器的元素个数有限则返回 true（默认等同于 isEmpty）</td></tr><tr><td>22</td><td><strong>def indexOf(elem: B): Int</strong>返回迭代器的元素中index等于x的第一个元素。注意：迭代器会越过这个元素。</td></tr><tr><td>23</td><td><strong>def indexWhere(p: (A) =&gt; Boolean): Int</strong>返回迭代器的元素中下标满足条件p的元素。注意：迭代器会越过这个元素。</td></tr><tr><td>24</td><td><strong>def isEmpty: Boolean</strong>检查it是否为空, 为空返回 true，否则返回false（与hasNext相反）。</td></tr><tr><td>25</td><td><strong>def isTraversableAgain: Boolean</strong>Tests whether this Iterator can be repeatedly traversed.</td></tr><tr><td>26</td><td><strong>def length: Int</strong>返回迭代器元素的数量。</td></tr><tr><td>27</td><td>**def map[B](f: (A) =&gt; B): Iterator[B]**将 it 中的每个元素传入函数 f 后的结果生成新的迭代器。</td></tr><tr><td>28</td><td><strong>def max: A</strong>返回迭代器迭代器元素中最大的元素。</td></tr><tr><td>29</td><td><strong>def min: A</strong>返回迭代器迭代器元素中最小的元素。</td></tr><tr><td>30</td><td><strong>def mkString: String</strong>将迭代器所有元素转换成字符串。</td></tr><tr><td>31</td><td><strong>def mkString(sep: String): String</strong>将迭代器所有元素转换成字符串，并指定分隔符。</td></tr><tr><td>32</td><td><strong>def nonEmpty: Boolean</strong>检查容器中是否包含元素（相当于 hasNext）。</td></tr><tr><td>33</td><td>**def padTo(len: Int, elem: A): Iterator[A]**首先返回迭代器所有元素，追加拷贝 elem 直到长度达到 len。</td></tr><tr><td>34</td><td>**def patch(from: Int, patchElems: Iterator[B], replaced: Int): Iterator[B]**返回一个新迭代器，其中自第 from 个元素开始的 replaced 个元素被迭代器所指元素替换。</td></tr><tr><td>35</td><td><strong>def product: A</strong>返回迭代器所指数值型元素的积。</td></tr><tr><td>36</td><td><strong>def sameElements(that: Iterator[_]): Boolean</strong>判断迭代器和指定的迭代器参数是否依次返回相同元素</td></tr><tr><td>37</td><td>**def seq: Iterator[A]**返回集合的系列视图</td></tr><tr><td>38</td><td><strong>def size: Int</strong>返回迭代器的元素数量</td></tr><tr><td>39</td><td>**def slice(from: Int, until: Int): Iterator[A]**返回一个新的迭代器，指向迭代器所指向的序列中从开始于第 from 个元素、结束于第 until 个元素的片段。</td></tr><tr><td>40</td><td><strong>def sum: A</strong>返回迭代器所指数值型元素的和</td></tr><tr><td>41</td><td>**def take(n: Int): Iterator[A]**返回前 n 个元素的新迭代器。</td></tr><tr><td>42</td><td>**def toArray: Array[A]**将迭代器指向的所有元素归入数组并返回。</td></tr><tr><td>43</td><td>**def toBuffer: Buffer[B]**将迭代器指向的所有元素拷贝至缓冲区 Buffer。</td></tr><tr><td>44</td><td>**def toIterable: Iterable[A]**Returns an Iterable containing all elements of this traversable or iterator. This will not terminate for infinite iterators.</td></tr><tr><td>45</td><td>**def toIterator: Iterator[A]**把迭代器的所有元素归入一个Iterator容器并返回。</td></tr><tr><td>46</td><td>**def toList: List[A]**把迭代器的所有元素归入列表并返回</td></tr><tr><td>47</td><td>**def toMap[T, U]: Map[T, U]**将迭代器的所有键值对归入一个Map并返回。</td></tr><tr><td>48</td><td>**def toSeq: Seq[A]**将代器的所有元素归入一个Seq容器并返回。</td></tr><tr><td>49</td><td><strong>def toString(): String</strong>将迭代器转换为字符串</td></tr><tr><td>50</td><td>**def zip[B](that: Iterator[B]): Iterator[(A, B)**返回一个新迭代器，指向分别由迭代器和指定的迭代器 that 元素一一对应而成的二元组序列</td></tr></tbody></table><blockquote><p>更多方法可以参考 <a href="http://www.scala-lang.org/api/current/index.html#scala.collection.Iterator">API文档</a></p></blockquote><blockquote><p><a href="https://blog.csdn.net/hellojoy/article/details/81183490">Scala——构造函数</a></p></blockquote><p>类是对象的抽象，而对象是类的具体实例。类是抽象的，不占用内存，而对象是具体的，占用存储空间。类是用于创建对象的蓝图，它是一个定义包括在特定类型的对象中的方法和变量的软件模板。</p><p>我们可以使用 new 关键字来创建类的对象，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">class</span> Point<span class="token punctuation">(</span>xc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> yc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> x<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> xc  <span class="token keyword">var</span> y<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> yc  <span class="token keyword">def</span> move<span class="token punctuation">(</span>dx<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dy<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    x <span class="token operator">=</span> x <span class="token operator">+</span> dx    y <span class="token operator">=</span> y <span class="token operator">+</span> dy    println <span class="token punctuation">(</span><span class="token string">"x 的坐标点: "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"y 的坐标点: "</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Scala中的类不声明为public，一个Scala源文件中可以有多个类。</p><p>以上实例的类定义了两个变量 <strong>x</strong> 和 <strong>y</strong> ，一个方法：<strong>move</strong>，方法没有返回值。</p><p><strong>Scala 的类定义可以有参数，称为类参数，如上面的 xc, yc，类参数在整个类中都可以访问</strong>。</p><p>接着我们可以使用 new 来实例化类，并访问类中的方法和变量：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>_<span class="token keyword">class</span> Point<span class="token punctuation">(</span>xc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> yc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> x<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> xc  <span class="token keyword">var</span> y<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> yc  <span class="token keyword">def</span> move<span class="token punctuation">(</span>dx<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dy<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    x <span class="token operator">=</span> x <span class="token operator">+</span> dx    y <span class="token operator">=</span> y <span class="token operator">+</span> dy    println <span class="token punctuation">(</span><span class="token string">"x 的坐标点: "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"y 的坐标点: "</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> pt <span class="token operator">=</span> <span class="token keyword">new</span> Point<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 移到一个新的位置</span>    pt<span class="token punctuation">.</span>move<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testx 的坐标点: <span class="token number">20</span>y 的坐标点: <span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="15-1-Scala-继承"><a href="#15-1-Scala-继承" class="headerlink" title="15.1 Scala 继承"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_151-scala-%E7%BB%A7%E6%89%BF">15.1 Scala 继承</a></h2><p>Scala继承一个基类跟Java很相似, 但我们需要注意以下几点：</p><ul><li>  1、<strong>重写一个非抽象方法必须使用override修饰符</strong>。</li><li>  2、<strong>只有主构造函数才可以往基类的构造函数里写参数</strong>。</li><li>  3、在子类中重写超类的抽象方法时，你不需要使用override关键字。</li></ul><p>接下来让我们来看个实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">class</span> Point<span class="token punctuation">(</span>xc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> yc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> x<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> xc  <span class="token keyword">var</span> y<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> yc  <span class="token keyword">def</span> move<span class="token punctuation">(</span>dx<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dy<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    x <span class="token operator">=</span> x <span class="token operator">+</span> dx    y <span class="token operator">=</span> y <span class="token operator">+</span> dy    println <span class="token punctuation">(</span><span class="token string">"x 的坐标点: "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"y 的坐标点: "</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> Location<span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> xc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token keyword">override</span> <span class="token keyword">val</span> yc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>               <span class="token keyword">val</span> zc <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Point<span class="token punctuation">(</span>xc<span class="token punctuation">,</span> yc<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> z<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> zc  <span class="token keyword">def</span> move<span class="token punctuation">(</span>dx<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dy<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dz<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    x <span class="token operator">=</span> x <span class="token operator">+</span> dx    y <span class="token operator">=</span> y <span class="token operator">+</span> dy    z <span class="token operator">=</span> z <span class="token operator">+</span> dz    println <span class="token punctuation">(</span><span class="token string">"x 的坐标点 : "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"y 的坐标点 : "</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"z 的坐标点 : "</span> <span class="token operator">+</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Scala 使用 extends 关键字来继承一个类。</p><p>实例中 Location 类继承了 Point 类。Point 称为父类(基类)，Location 称为子类。</p><p><strong>override val xc</strong> 为重写了父类的字段。</p><p><strong>继承会继承父类的所有属性和方法，Scala 只允许继承一个父类</strong>。</p><p>实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>_<span class="token keyword">class</span> Point<span class="token punctuation">(</span><span class="token keyword">val</span> xc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token keyword">val</span> yc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> x<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> xc  <span class="token keyword">var</span> y<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> yc  <span class="token keyword">def</span> move<span class="token punctuation">(</span>dx<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dy<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    x <span class="token operator">=</span> x <span class="token operator">+</span> dx    y <span class="token operator">=</span> y <span class="token operator">+</span> dy    println <span class="token punctuation">(</span><span class="token string">"x 的坐标点 : "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"y 的坐标点 : "</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> Location<span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> xc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token keyword">override</span> <span class="token keyword">val</span> yc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>               <span class="token keyword">val</span> zc <span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Point<span class="token punctuation">(</span>xc<span class="token punctuation">,</span> yc<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> z<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> zc  <span class="token keyword">def</span> move<span class="token punctuation">(</span>dx<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dy<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dz<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    x <span class="token operator">=</span> x <span class="token operator">+</span> dx    y <span class="token operator">=</span> y <span class="token operator">+</span> dy    z <span class="token operator">=</span> z <span class="token operator">+</span> dz    println <span class="token punctuation">(</span><span class="token string">"x 的坐标点 : "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"y 的坐标点 : "</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"z 的坐标点 : "</span> <span class="token operator">+</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> loc <span class="token operator">=</span> <span class="token keyword">new</span> Location<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 移到一个新的位置</span>    loc<span class="token punctuation">.</span>move<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testx 的坐标点 <span class="token builtin class-name">:</span> <span class="token number">20</span>y 的坐标点 <span class="token builtin class-name">:</span> <span class="token number">30</span>z 的坐标点 <span class="token builtin class-name">:</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Scala重写一个非抽象方法，必须用override修饰符</strong>。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">class</span> Person <span class="token punctuation">{</span>  <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">""</span>  <span class="token keyword">override</span> <span class="token keyword">def</span> toString <span class="token operator">=</span> getClass<span class="token punctuation">.</span>getName <span class="token operator">+</span> <span class="token string">"[name="</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">}</span><span class="token keyword">class</span> Employee <span class="token keyword">extends</span> Person <span class="token punctuation">{</span>  <span class="token keyword">var</span> salary <span class="token operator">=</span> <span class="token number">0.0</span>  <span class="token keyword">override</span> <span class="token keyword">def</span> toString <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span>toString <span class="token operator">+</span> <span class="token string">"[salary="</span> <span class="token operator">+</span> salary <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">}</span><span class="token keyword">object</span> Test <span class="token keyword">extends</span> App <span class="token punctuation">{</span>  <span class="token keyword">val</span> fred <span class="token operator">=</span> <span class="token keyword">new</span> Employee  fred<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Fred"</span>  fred<span class="token punctuation">.</span>salary <span class="token operator">=</span> <span class="token number">50000</span>  println<span class="token punctuation">(</span>fred<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestEmployee<span class="token punctuation">[</span>name<span class="token operator">=</span>Fred<span class="token punctuation">]</span><span class="token punctuation">[</span>salary<span class="token operator">=</span><span class="token number">50000.0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="15-2-Scala-单例对象"><a href="#15-2-Scala-单例对象" class="headerlink" title="15.2 Scala 单例对象"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_152-scala-%E5%8D%95%E4%BE%8B%E5%AF%B9%E8%B1%A1">15.2 Scala 单例对象</a></h2><p>在 Scala 中，是没有 static 这个东西的，但是它也为我们提供了单例模式的实现方法，那就是使用关键字 object。</p><p><strong>Scala 中使用单例模式时，除了定义的类之外，还要定义一个同名的 object 对象，它和类的区别是，object对象不能带参数</strong>。</p><p>当单例对象与某个类共享同一个名称时，他被称作是这个类的伴生对象：companion object。</p><p>你<strong>必须在同一个源文件里定义类和它的伴生对象。类被称为是这个单例对象的伴生类：companion class</strong>。</p><p><strong>类和它的伴生对象可以互相访问其私有成员</strong>。</p><h3 id="15-2-1-单例对象实例"><a href="#15-2-1-单例对象实例" class="headerlink" title="15.2.1 单例对象实例"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1521-%E5%8D%95%E4%BE%8B%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B">15.2.1 单例对象实例</a></h3><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>_<span class="token keyword">class</span> Point<span class="token punctuation">(</span><span class="token keyword">val</span> xc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token keyword">val</span> yc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> x<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> xc  <span class="token keyword">var</span> y<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> yc  <span class="token keyword">def</span> move<span class="token punctuation">(</span>dx<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> dy<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    x <span class="token operator">=</span> x <span class="token operator">+</span> dx    y <span class="token operator">=</span> y <span class="token operator">+</span> dy  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> point <span class="token operator">=</span> <span class="token keyword">new</span> Point<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>    printPoint    <span class="token keyword">def</span> printPoint<span class="token punctuation">{</span>      println <span class="token punctuation">(</span><span class="token string">"x 的坐标点 : "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>      println <span class="token punctuation">(</span><span class="token string">"y 的坐标点 : "</span> <span class="token operator">+</span> point<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testx 的坐标点 <span class="token builtin class-name">:</span> <span class="token number">10</span>y 的坐标点 <span class="token builtin class-name">:</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="15-2-2-伴生对象实例"><a href="#15-2-2-伴生对象实例" class="headerlink" title="15.2.2 伴生对象实例"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_1522-%E4%BC%B4%E7%94%9F%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B">15.2.2 伴生对象实例</a></h3><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token comment">/* 文件名：Marker.scala * author:菜鸟教程 * url:www.runoob.com */</span><span class="token comment">// 私有构造方法</span><span class="token keyword">class</span> Marker <span class="token keyword">private</span><span class="token punctuation">(</span><span class="token keyword">val</span> color<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  println<span class="token punctuation">(</span><span class="token string">"创建"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span>  <span class="token keyword">override</span> <span class="token keyword">def</span> toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"颜色标记："</span> <span class="token operator">+</span> color<span class="token punctuation">}</span><span class="token comment">// 伴生对象，与类名字相同，可以访问类的私有属性和方法</span><span class="token keyword">object</span> Marker<span class="token punctuation">{</span>  <span class="token keyword">private</span> <span class="token keyword">val</span> markers<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Marker<span class="token punctuation">]</span> <span class="token operator">=</span> Map<span class="token punctuation">(</span>    <span class="token string">"red"</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> Marker<span class="token punctuation">(</span><span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token string">"blue"</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> Marker<span class="token punctuation">(</span><span class="token string">"blue"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token string">"green"</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> Marker<span class="token punctuation">(</span><span class="token string">"green"</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span>  <span class="token keyword">def</span> apply<span class="token punctuation">(</span>color<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>markers<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span> markers<span class="token punctuation">(</span>color<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> getMarker<span class="token punctuation">(</span>color<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>markers<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span> markers<span class="token punctuation">(</span>color<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token keyword">null</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span>Marker<span class="token punctuation">(</span><span class="token string">"red"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// 单例函数调用，省略了.(点)符号  </span>    println<span class="token punctuation">(</span>Marker getMarker <span class="token string">"blue"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Marker.scala $ scala Marker创建颜色标记：red创建颜色标记：blue创建颜色标记：green颜色标记：red颜色标记：blue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Scala Trait(特征) 相当于 Java 的接口，实际上它比接口还功能强大。</p><p><strong>与接口不同的是，它还可以定义属性和方法的实现</strong>。</p><p><strong>一般情况下Scala的类只能够继承单一父类，但是如果是 Trait(特征) 的话就可以继承多个，从结果来看就是实现了多重继承</strong>。</p><p>Trait(特征) 定义的方式与类类似，但它使用的关键字是 <strong>trait</strong>，如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">trait</span> Equal <span class="token punctuation">{</span>  <span class="token keyword">def</span> isEqual<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>  <span class="token keyword">def</span> isNotEqual<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token operator">!</span>isEqual<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>以上Trait(特征)由两个方法组成：<strong>isEqual</strong> 和 <strong>isNotEqual</strong>。isEqual 方法没有定义方法的实现，isNotEqual定义了方法的实现。</p><p><strong>子类继承特征可以实现未被实现的方法。所以其实 Scala Trait(特征)更像 Java 的抽象类。</strong> </p><p>以下演示了特征的完整实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token comment">/* 文件名：Test.scala * author:菜鸟教程 * url:www.runoob.com */</span><span class="token keyword">trait</span> Equal <span class="token punctuation">{</span>  <span class="token keyword">def</span> isEqual<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span>  <span class="token keyword">def</span> isNotEqual<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token operator">!</span>isEqual<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">class</span> Point<span class="token punctuation">(</span>xc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> yc<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Equal <span class="token punctuation">{</span>  <span class="token keyword">var</span> x<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> xc  <span class="token keyword">var</span> y<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> yc  <span class="token keyword">def</span> isEqual<span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span> <span class="token operator">=</span>  obj<span class="token punctuation">.</span>isInstanceOf<span class="token punctuation">[</span>Point<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>  obj<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>Point<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">==</span> x<span class="token punctuation">}</span><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> Point<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> Point<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> Point<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>p1<span class="token punctuation">.</span>isNotEqual<span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>p1<span class="token punctuation">.</span>isNotEqual<span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>p1<span class="token punctuation">.</span>isNotEqual<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test<span class="token boolean">false</span><span class="token boolean">true</span><span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="16-1-特征构造顺序"><a href="#16-1-特征构造顺序" class="headerlink" title="16.1 特征构造顺序"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_161-%E7%89%B9%E5%BE%81%E6%9E%84%E9%80%A0%E9%A1%BA%E5%BA%8F">16.1 特征构造顺序</a></h2><p><strong>特征也可以有构造器，由字段的初始化和其他特征体中的语句构成</strong>。</p><p><strong>这些语句在任何混入该特征的对象在构造时都会被执行</strong>。</p><p>构造器的执行顺序：</p><ul><li>  <strong>调用超类的构造器</strong>；</li><li>  <strong>特征构造器在超类构造器之后、类构造器之前执行</strong>；</li><li>  特征由左到右被构造；</li><li>  每个特征当中，父特征先被构造；</li><li>  <strong>如果多个特征共有一个父特征，父特征不会被重复构造</strong></li><li>  所有特征被构造完毕，子类被构造。</li></ul><p><strong>构造器的顺序是类的线性化的反向</strong>。</p><p>线性化是描述某个类型的所有超类型的一种技术规格。</p><p>Scala 提供了强大的模式匹配机制，应用也非常广泛。</p><p>一个模式匹配包含了一系列备选项，每个都开始于关键字 <strong>case</strong>。每个备选项都包含了一个模式及一到多个表达式。箭头符号 <strong>=&gt;</strong> 隔开了模式和表达式。</p><p>以下是一个简单的整型值模式匹配实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span>matchTest<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> matchTest<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> x <span class="token keyword">match</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token number">1</span> <span class="token keyword">=&gt;</span> <span class="token string">"one"</span>    <span class="token keyword">case</span> <span class="token number">2</span> <span class="token keyword">=&gt;</span> <span class="token string">"two"</span>    <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span> <span class="token string">"many"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testmany<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>match 对应 Java 里的 switch，但是写在选择器表达式之后。即： <strong>选择器 match {备选项}。</strong> </p><p>match 表达式通过以代码编写的先后次序尝试每个模式来完成计算，只要发现有一个匹配的case，剩下的case不会继续匹配。</p><p>接下来我们来看一个不同数据类型的模式匹配：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span>matchTest<span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>matchTest<span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>matchTest<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>matchTest<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> matchTest<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> x <span class="token keyword">match</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token number">1</span> <span class="token keyword">=&gt;</span> <span class="token string">"one"</span>    <span class="token keyword">case</span> <span class="token string">"two"</span> <span class="token keyword">=&gt;</span> <span class="token number">2</span>    <span class="token keyword">case</span> y<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token keyword">=&gt;</span> <span class="token string">"scala.Int"</span>    <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span> <span class="token string">"many"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test<span class="token number">2</span>manyonescala.Int<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实例中第一个 case 对应整型数值 1，第二个 case 对应字符串值 two，第三个 case 对应类型模式，用于判断传入的值是否为整型，<strong>相比使用isInstanceOf来判断类型，使用模式匹配更好</strong>。</p><p>第四个 case 表示默认的全匹配备选项，即没有找到其他匹配时的匹配项，类似 switch 中的 default。</p><h2 id="17-1-使用样例类"><a href="#17-1-使用样例类" class="headerlink" title="17.1 使用样例类"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_171-%E4%BD%BF%E7%94%A8%E6%A0%B7%E4%BE%8B%E7%B1%BB">17.1 使用样例类</a></h2><blockquote><p><a href="https://www.cnblogs.com/gnivor/p/4267347.html">Scala学习笔记–提取器unapply</a></p></blockquote><p><strong>使用了case关键字的类定义就是就是样例类(case classes)，样例类是种特殊的类，经过优化以用于模式匹配</strong>。</p><p>以下是样例类的简单实例:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> alice <span class="token operator">=</span> <span class="token keyword">new</span> Person<span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> bob <span class="token operator">=</span> <span class="token keyword">new</span> Person<span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> charlie <span class="token operator">=</span> <span class="token keyword">new</span> Person<span class="token punctuation">(</span><span class="token string">"Charlie"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>person <span class="token keyword">&lt;-</span> List<span class="token punctuation">(</span>alice<span class="token punctuation">,</span> bob<span class="token punctuation">,</span> charlie<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      person <span class="token keyword">match</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> Person<span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string">"Hi Alice!"</span><span class="token punctuation">)</span>        <span class="token keyword">case</span> Person<span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string">"Hi Bob!"</span><span class="token punctuation">)</span>        <span class="token keyword">case</span> Person<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>        println<span class="token punctuation">(</span><span class="token string">"Age: "</span> <span class="token operator">+</span> age <span class="token operator">+</span> <span class="token string">" year, name: "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"?"</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 样例类</span>  <span class="token keyword">case</span> <span class="token keyword">class</span> Person<span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestHi Alice<span class="token operator">!</span>Hi Bob<span class="token operator">!</span>Age: <span class="token number">32</span> year, name: Charlie?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在声明样例类时，下面的过程自动发生了：</p><ul><li>  <strong>构造器的每个参数都成为val，除非显式被声明为var，但是并不推荐这么做</strong>；</li><li>  <strong>在伴生对象中提供了apply方法，所以可以不使用new关键字就可构建对象</strong>；</li><li>  <strong>提供unapply方法使模式匹配可以工作</strong>；</li><li>  <strong>生成toString、equals、hashCode和copy方法，除非显示给出这些方法的定义</strong>。</li></ul><blockquote><p>还有几种模式匹配:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">case</span> <span class="token number">0</span> <span class="token operator">|</span> <span class="token string">""</span> <span class="token keyword">=&gt;</span> <span class="token boolean">false</span>    <span class="token comment">//在0或空字符串的情况下,返回false</span><span class="token keyword">case</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">6</span> <span class="token operator">|</span> <span class="token number">8</span> <span class="token operator">|</span> <span class="token number">10</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string">"偶数"</span><span class="token punctuation">)</span>     <span class="token comment">//在10及以下的偶数,返回"偶数"</span><span class="token keyword">case</span> x <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span> x <span class="token operator">==</span> <span class="token number">3</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string">"two's company, three's a crowd"</span><span class="token punctuation">)</span>    <span class="token comment">//在模式匹配中使用if</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></blockquote><p>Scala 通过 scala.util.matching 包中的 <strong>Regex</strong> 类来支持正则表达式。以下实例演示了使用正则表达式查找单词 <strong>Scala</strong> :</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matching<span class="token punctuation">.</span></span>Regex<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> pattern <span class="token operator">=</span> <span class="token string">"Scala"</span><span class="token punctuation">.</span>r    <span class="token keyword">val</span> str <span class="token operator">=</span> <span class="token string">"Scala is Scalable and cool"</span>    println<span class="token punctuation">(</span>pattern findFirstIn str<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestSome<span class="token punctuation">(</span>Scala<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>实例中使用 String 类的 r() 方法构造了一个Regex对象。</p><p>然后使用 findFirstIn 方法找到首个匹配项。</p><p>如果需要查看所有的匹配项可以使用 findAllIn 方法。</p><p>你可以使用 mkString( ) 方法来连接正则表达式匹配结果的字符串，并可以使用**管道(|)**来设置不同的模式：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matching<span class="token punctuation">.</span></span>Regex<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> pattern <span class="token operator">=</span> <span class="token keyword">new</span> Regex<span class="token punctuation">(</span><span class="token string">"(S|s)cala"</span><span class="token punctuation">)</span>  <span class="token comment">// 首字母可以是大写 S 或小写 s</span>    <span class="token keyword">val</span> str <span class="token operator">=</span> <span class="token string">"Scala is scalable and cool"</span>    println<span class="token punctuation">(</span><span class="token punctuation">(</span>pattern findAllIn str<span class="token punctuation">)</span><span class="token punctuation">.</span>mkString<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 使用逗号 , 连接返回结果</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestScala,scala<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果你需要将匹配的文本替换为指定的关键词，可以使用 <strong>replaceFirstIn( )</strong> 方法来替换第一个匹配项，使用 <strong>replaceAllIn( )</strong> 方法替换所有匹配项，实例如下:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> pattern <span class="token operator">=</span> <span class="token string">"(S|s)cala"</span><span class="token punctuation">.</span>r    <span class="token keyword">val</span> str <span class="token operator">=</span> <span class="token string">"Scala is scalable and cool"</span>    println<span class="token punctuation">(</span>pattern replaceFirstIn<span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"Java"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestJava is scalable and cool<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="18-1-正则表达式"><a href="#18-1-正则表达式" class="headerlink" title="18.1 正则表达式"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_181-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F">18.1 正则表达式</a></h2><p>Scala 的正则表达式继承了 Java 的语法规则，Java 则大部分使用了 Perl 语言的规则。</p><p>下表我们给出了常用的一些正则表达式规则：</p><table><thead><tr><th>表达式</th><th>匹配规则</th></tr></thead><tbody><tr><td>^</td><td>匹配输入字符串开始的位置。</td></tr><tr><td>$</td><td>匹配输入字符串结尾的位置。</td></tr><tr><td>.</td><td>匹配除”\r\n”之外的任何单个字符。</td></tr><tr><td>[…]</td><td>字符集。匹配包含的任一字符。例如，”[abc]“匹配”plain”中的”a”。</td></tr><tr><td>[^…]</td><td>反向字符集。匹配未包含的任何字符。例如，”[^abc]“匹配”plain”中”p”，”l”，”i”，”n”。</td></tr><tr><td>\A</td><td>匹配输入字符串开始的位置（无多行支持）</td></tr><tr><td>\z</td><td>字符串结尾(类似$，但不受处理多行选项的影响)</td></tr><tr><td>\Z</td><td>字符串结尾或行尾(不受处理多行选项的影响)</td></tr><tr><td>re*</td><td>重复零次或更多次</td></tr><tr><td>re+</td><td>重复一次或更多次</td></tr><tr><td>re?</td><td>重复零次或一次</td></tr><tr><td>re{ n}</td><td>重复n次</td></tr><tr><td>re{ n,}</td><td></td></tr><tr><td>re{ n, m}</td><td>重复n到m次</td></tr><tr><td>a</td><td>b</td></tr><tr><td>(re)</td><td>匹配 re,并捕获文本到自动命名的组里</td></tr><tr><td>(?: re)</td><td>匹配 re,不捕获匹配的文本，也不给此分组分配组号</td></tr><tr><td>(?&gt; re)</td><td>贪婪子表达式</td></tr><tr><td>\w</td><td>匹配字母或数字或下划线或汉字</td></tr><tr><td>\W</td><td>匹配任意不是字母，数字，下划线，汉字的字符</td></tr><tr><td>\s</td><td>匹配任意的空白符,相等于 [\t\n\r\f]</td></tr><tr><td>\S</td><td>匹配任意不是空白符的字符</td></tr><tr><td>\d</td><td>匹配数字，类似 [0-9]</td></tr><tr><td>\D</td><td>匹配任意非数字的字符</td></tr><tr><td>\G</td><td>当前搜索的开头</td></tr><tr><td>\n</td><td>换行符</td></tr><tr><td>\b</td><td>通常是单词分界位置，但如果在字符类里使用代表退格</td></tr><tr><td>\B</td><td>匹配不是单词开头或结束的位置</td></tr><tr><td>\t</td><td>制表符</td></tr><tr><td>\Q</td><td>开始引号：<strong>\Q(a+b)*3\E</strong> 可匹配文本 “(a+b)*3”。</td></tr><tr><td>\E</td><td>结束引号：<strong>\Q(a+b)*3\E</strong> 可匹配文本 “(a+b)*3”。</td></tr></tbody></table><h2 id="18-2-正则表达式实例"><a href="#18-2-正则表达式实例" class="headerlink" title="18.2 正则表达式实例"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_182-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%AE%9E%E4%BE%8B">18.2 正则表达式实例</a></h2><table><thead><tr><th>实例</th><th>描述</th></tr></thead><tbody><tr><td>.</td><td>匹配除”\r\n”之外的任何单个字符。</td></tr><tr><td>[Rr]uby</td><td>匹配 “Ruby” 或 “ruby”</td></tr><tr><td>rub[ye]</td><td>匹配 “ruby” 或 “rube”</td></tr><tr><td>[aeiou]</td><td>匹配小写字母 ：aeiou</td></tr><tr><td>[0-9]</td><td>匹配任何数字，类似 [0123456789]</td></tr><tr><td>[a-z]</td><td>匹配任何 ASCII 小写字母</td></tr><tr><td>[A-Z]</td><td>匹配任何 ASCII 大写字母</td></tr><tr><td>[a-zA-Z0-9]</td><td>匹配数字，大小写字母</td></tr><tr><td>[^aeiou]</td><td>匹配除了 aeiou 其他字符</td></tr><tr><td>[^0-9]</td><td>匹配除了数字的其他字符</td></tr><tr><td>\d</td><td>匹配数字，类似: [0-9]</td></tr><tr><td>\D</td><td>匹配非数字，类似: [^0-9]</td></tr><tr><td>\s</td><td>匹配空格，类似: [ \t\r\n\f]</td></tr><tr><td>\S</td><td>匹配非空格，类似: [^ \t\r\n\f]</td></tr><tr><td>\w</td><td>匹配字母，数字，下划线，类似: [A-Za-z0-9_]</td></tr><tr><td>\W</td><td>匹配非字母，数字，下划线，类似: [^A-Za-z0-9_]</td></tr><tr><td>ruby?</td><td>匹配 “rub” 或 “ruby”: y 是可选的</td></tr><tr><td>ruby*</td><td>匹配 “rub” 加上 0 个或多个的 y。</td></tr><tr><td>ruby+</td><td>匹配 “rub” 加上 1 个或多个的 y。</td></tr><tr><td>\d{3}</td><td>刚好匹配 3 个数字。</td></tr><tr><td>\d{3,}</td><td>匹配 3 个或多个数字。</td></tr><tr><td>\d{3,5}</td><td>匹配 3 个、4 个或 5 个数字。</td></tr><tr><td>\D\d+</td><td>无分组： + 重复 \d</td></tr><tr><td>(\D\d)+/</td><td>分组： + 重复 \D\d 对</td></tr><tr><td>([Rr]uby(, )?)+</td><td>匹配 “Ruby”、”Ruby, ruby, ruby”，等等</td></tr></tbody></table><p>注意上表中的每个字符使用了两个反斜线。这是因为在 Java 和 Scala 中字符串中的反斜线是转义字符。所以如果你要输出 **\**，你需要在字符串中写成 *<em>\\*</em> 来获取一个反斜线。查看以下实例：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matching<span class="token punctuation">.</span></span>Regex<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> pattern <span class="token operator">=</span> <span class="token keyword">new</span> Regex<span class="token punctuation">(</span><span class="token string">"abl[ae]\\d+"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> str <span class="token operator">=</span> <span class="token string">"ablaw is able1 and cool"</span>    println<span class="token punctuation">(</span><span class="token punctuation">(</span>pattern findAllIn str<span class="token punctuation">)</span><span class="token punctuation">.</span>mkString<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Testable1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Scala 的异常处理和其它语言比如 Java 类似。</p><p>Scala 的方法可以通过抛出异常的方法的方式来终止相关代码的运行，不必通过返回值。</p><h2 id="19-1-抛出异常"><a href="#19-1-抛出异常" class="headerlink" title="19.1 抛出异常"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_191-%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8">19.1 抛出异常</a></h2><p>Scala 抛出异常的方法和 Java一样，使用 throw 方法，例如，抛出一个新的参数异常：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">throw</span> <span class="token keyword">new</span> IllegalArgumentException<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="19-2-捕获异常"><a href="#19-2-捕获异常" class="headerlink" title="19.2 捕获异常"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_192-%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8">19.2 捕获异常</a></h2><p>异常捕捉的机制与其他语言中一样，如果有异常发生，catch 字句是按次序捕捉的。因此，在 catch 字句中，越具体的异常越要靠前，越普遍的异常越靠后。 如果抛出的异常不在 catch 字句中，该异常则无法处理，会被升级到调用者处。</p><p>捕捉异常的 catch 子句，语法与其他语言中不太一样。在 Scala 里，借用了模式匹配的思想来做异常的匹配，因此，在 catch 的代码里，是一系列 case 字句，如下例所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileReader<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileNotFoundException<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>      <span class="token keyword">val</span> f <span class="token operator">=</span> <span class="token keyword">new</span> FileReader<span class="token punctuation">(</span><span class="token string">"input.txt"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>      <span class="token keyword">case</span> ex<span class="token operator">:</span> FileNotFoundException <span class="token keyword">=&gt;</span><span class="token punctuation">{</span>        println<span class="token punctuation">(</span><span class="token string">"Missing file exception"</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">case</span> ex<span class="token operator">:</span> IOException <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>        println<span class="token punctuation">(</span><span class="token string">"IO Exception"</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestMissing <span class="token function">file</span> exception<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>catch字句里的内容跟match里的case是完全一样的。由于异常捕捉是按次序，如果最普遍的异常，Throwable，写在最前面，则在它后面的case都捕捉不到，因此需要将它写在最后面。</p><h2 id="19-3-finally-语句"><a href="#19-3-finally-语句" class="headerlink" title="19.3 finally 语句"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_193-finally-%E8%AF%AD%E5%8F%A5">19.3 finally 语句</a></h2><p>finally 语句用于执行不管是正常处理还是有异常发生时都需要执行的步骤，实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileReader<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileNotFoundException<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>      <span class="token keyword">val</span> f <span class="token operator">=</span> <span class="token keyword">new</span> FileReader<span class="token punctuation">(</span><span class="token string">"input.txt"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>      <span class="token keyword">case</span> ex<span class="token operator">:</span> FileNotFoundException <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>        println<span class="token punctuation">(</span><span class="token string">"Missing file exception"</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token keyword">case</span> ex<span class="token operator">:</span> IOException <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>        println<span class="token punctuation">(</span><span class="token string">"IO Exception"</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span><span class="token string">"Exiting finally..."</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestMissing <span class="token function">file</span> exceptionExiting finally<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><a href="https://www.cnblogs.com/gnivor/p/4267347.html">Scala学习笔记–提取器unapply</a></p></blockquote><p>提取器是从传递给它的对象中提取出构造该对象的参数。</p><p>Scala 标准库包含了一些预定义的提取器，我们会大致的了解一下它们。</p><p><strong>Scala 提取器是一个带有unapply方法的对象</strong>。</p><p>unapply方法算是apply方法的反向操作：unapply接受一个对象，然后从对象中提取值，提取的值通常是用来构造该对象的值。</p><p>以下实例演示了邮件地址的提取器对象：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println <span class="token punctuation">(</span><span class="token string">"Apply 方法 : "</span> <span class="token operator">+</span> apply<span class="token punctuation">(</span><span class="token string">"Zara"</span><span class="token punctuation">,</span> <span class="token string">"gmail.com"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"Unapply 方法 : "</span> <span class="token operator">+</span> unapply<span class="token punctuation">(</span><span class="token string">"Zara@gmail.com"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    println <span class="token punctuation">(</span><span class="token string">"Unapply 方法 : "</span> <span class="token operator">+</span> unapply<span class="token punctuation">(</span><span class="token string">"Zara Ali"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 注入方法 (可选)</span>  <span class="token keyword">def</span> apply<span class="token punctuation">(</span>user<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> domain<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    user <span class="token operator">+</span><span class="token string">"@"</span><span class="token operator">+</span> domain  <span class="token punctuation">}</span>  <span class="token comment">// 提取方法（必选）</span>  <span class="token keyword">def</span> unapply<span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> parts <span class="token operator">=</span> str split <span class="token string">"@"</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      Some<span class="token punctuation">(</span>parts<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parts<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>      None    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala TestApply 方法 <span class="token builtin class-name">:</span> Zara@gmail.comUnapply 方法 <span class="token builtin class-name">:</span> Some<span class="token variable"><span class="token punctuation">((</span>Zara<span class="token punctuation">,</span>gmail.com<span class="token punctuation">))</span></span>Unapply 方法 <span class="token builtin class-name">:</span> None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上对象定义了两个方法： <strong>apply</strong> 和 <strong>unapply</strong> 方法。通过 apply 方法我们无需使用 new 操作就可以创建对象。所以你可以通过语句 Test(“Zara”, “gmail.com”) 来构造一个字符串 “<a href="mailto:Zara@gmail.com">Zara@gmail.com</a>“。</p><p>unapply方法算是apply方法的反向操作：unapply接受一个对象，然后从对象中提取值，提取的值通常是用来构造该对象的值。实例中我们使用 Unapply 方法从对象中提取用户名和邮件地址的后缀。</p><p>实例中 unapply 方法在传入的字符串不是邮箱地址时返回 None。代码演示如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala">unapply<span class="token punctuation">(</span><span class="token string">"Zara@gmail.com"</span><span class="token punctuation">)</span> 相等于 Some<span class="token punctuation">(</span><span class="token string">"Zara"</span><span class="token punctuation">,</span> <span class="token string">"gmail.com"</span><span class="token punctuation">)</span>unapply<span class="token punctuation">(</span><span class="token string">"Zara Ali"</span><span class="token punctuation">)</span> 相等于 None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>相当把参数传给unapply方法执行，然后再把结果复制给对应伴生对象中object的形参。</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Square <span class="token punctuation">{</span><span class="token keyword">def</span> unapply<span class="token punctuation">(</span>z<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span> <span class="token operator">=</span> Some<span class="token punctuation">(</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">val</span> number<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> <span class="token number">36.0</span>number <span class="token keyword">match</span> <span class="token punctuation">{</span><span class="token keyword">case</span> Square<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"square root of </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">number</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">n</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string">"nothing matched"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当我们写下这段pattern match的代码时，编译器其实替我们做了好几件事：</p><ol><li> 调用unapply，传入number</li><li> 接收返回值并判断返回值是None，还是Some</li><li> 如果是Some，则将其解开，并将其中的值赋值给n（就是case Square(n)中的n）</li></ol></blockquote><h2 id="20-1-提取器使用模式匹配"><a href="#20-1-提取器使用模式匹配" class="headerlink" title="20.1 提取器使用模式匹配"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_201-%E6%8F%90%E5%8F%96%E5%99%A8%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D">20.1 提取器使用模式匹配</a></h2><p>在我们实例化一个类的时，可以带上0个或者多个的参数，<strong>编译器在实例化的时会调用 apply 方法</strong>。我们可以在类和对象中都定义 apply 方法。</p><p>就像我们之前提到过的，unapply 用于提取我们指定查找的值，它与 apply 的操作相反。 当我们在提取器对象中使用 match 语句是，unapply 将自动执行，如下所示：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> x <span class="token operator">=</span> Test<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    x <span class="token keyword">match</span>    <span class="token punctuation">{</span>      <span class="token keyword">case</span> Test<span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token string">" 是 "</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">" 的两倍！"</span><span class="token punctuation">)</span>      <span class="token comment">//unapply 被调用</span>      <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string">"无法计算"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">def</span> apply<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> x<span class="token operator">*</span><span class="token number">2</span>  <span class="token keyword">def</span> unapply<span class="token punctuation">(</span>z<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>z<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> Some<span class="token punctuation">(</span>z<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">else</span> None<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test<span class="token number">10</span><span class="token number">10</span> 是 <span class="token number">5</span> 的两倍！<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Scala 进行文件写操作，直接用的都是 java中 的 I/O 类 （<strong>java.io.File</strong>)：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>_<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> PrintWriter<span class="token punctuation">(</span><span class="token keyword">new</span> File<span class="token punctuation">(</span><span class="token string">"test.txt"</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>    writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"菜鸟教程"</span><span class="token punctuation">)</span>    writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，会在你的当前目录下生产一个 test.txt 文件，文件内容为”菜鸟教程”:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test$ <span class="token function">cat</span> test.txt 菜鸟教程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="21-1-从屏幕上读取用户输入"><a href="#21-1-从屏幕上读取用户输入" class="headerlink" title="21.1 从屏幕上读取用户输入"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_211-%E4%BB%8E%E5%B1%8F%E5%B9%95%E4%B8%8A%E8%AF%BB%E5%8F%96%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5">21.1 从屏幕上读取用户输入</a></h2><p>有时候我们需要接收用户在屏幕输入的指令来处理程序。实例如下：</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>_<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    print<span class="token punctuation">(</span><span class="token string">"请输入菜鸟教程官网 : "</span> <span class="token punctuation">)</span>    <span class="token keyword">val</span> line <span class="token operator">=</span> StdIn<span class="token punctuation">.</span>readLine<span class="token punctuation">(</span><span class="token punctuation">)</span>    println<span class="token punctuation">(</span><span class="token string">"谢谢，你输入的是: "</span> <span class="token operator">+</span> line<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><em>Scala2.11 后的版本</em> <strong>Console.readLine</strong> <em>已废弃，使用</em> <strong>scala.io.StdIn.readLine()</strong> <em>方法代替。</em></p></blockquote><p>执行以上代码，屏幕上会显示如下信息:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test请输入菜鸟教程官网 <span class="token builtin class-name">:</span> www.runoob.com谢谢，你输入的是: www.runoob.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="21-2-从文件上读取内容"><a href="#21-2-从文件上读取内容" class="headerlink" title="21.2 从文件上读取内容"></a><a href="#/study/Scala/Scala%E8%8F%9C%E9%B8%9F%E6%95%99%E7%A8%8B%E5%AD%A6%E4%B9%A0?id=_212-%E4%BB%8E%E6%96%87%E4%BB%B6%E4%B8%8A%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9">21.2 从文件上读取内容</a></h2><p>从文件读取内容非常简单。我们可以使用 Scala 的 <strong>Source</strong> 类及伴生对象来读取文件。以下实例演示了从 “test.txt”(之前已创建过) 文件中读取内容:</p><pre class="line-numbers language-scala" data-language="scala"><code class="language-scala"><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Source<span class="token keyword">object</span> Test <span class="token punctuation">{</span>  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    println<span class="token punctuation">(</span><span class="token string">"文件内容为:"</span> <span class="token punctuation">)</span>    Source<span class="token punctuation">.</span>fromFile<span class="token punctuation">(</span><span class="token string">"test.txt"</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">{</span>      print    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行以上代码，输出结果为:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ scalac Test.scala $ scala Test文件内容为:菜鸟教程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 编程语言 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bigdata </tag>
            
            <tag> Scala </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2022/03/12/git/"/>
      <url>/2022/03/12/git/</url>
      
        <content type="html"><![CDATA[<p>x</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>可视化图表之Superset</title>
      <link href="/2022/03/11/ke-shi-hua-bao-biao-superset/"/>
      <url>/2022/03/11/ke-shi-hua-bao-biao-superset/</url>
      
        <content type="html"><![CDATA[<h1 id="大数据技术之Superset"><a href="#大数据技术之Superset" class="headerlink" title="大数据技术之Superset"></a>大数据技术之Superset</h1><h1 id="第1章-Superset入门"><a href="#第1章-Superset入门" class="headerlink" title="第1章 Superset入门"></a>第1章 Superset入门</h1><h2 id="1-1-Superset概述"><a href="#1-1-Superset概述" class="headerlink" title="1.1 Superset概述"></a>1.1 Superset概述</h2><p>Apache<br>Superset是一个现代的数据探索和可视化平台。它功能强大且十分易用，可对接各种数据源，包括很多现代的大数据分析引擎，拥有丰富的图表展示形式，并且支持自定义仪表盘。</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/00b9ee09ee40e1302b0bdead1d57b596.png"></p><h2 id="1-2-环境说明"><a href="#1-2-环境说明" class="headerlink" title="1.2 环境说明"></a>1.2 环境说明</h2><p>本课程使用的服务器操作系统为CentOS 7，Superset对接的数据源为MySQL数据库。</p><h1 id="第2章-Superset安装"><a href="#第2章-Superset安装" class="headerlink" title="第2章 Superset安装"></a>第2章 Superset安装</h1><p>Superset官网地址：<a href="http://superset.apache.org/">http://superset.apache.org/</a></p><h2 id="2-1-安装Python环境"><a href="#2-1-安装Python环境" class="headerlink" title="2.1 安装Python环境"></a>2.1 安装Python环境</h2><p>Superset是由Python语言编写的Web应用，要求Python3.7的环境。</p><h3 id="2-1-1-安装Miniconda"><a href="#2-1-1-安装Miniconda" class="headerlink" title="2.1.1 安装Miniconda"></a>2.1.1 安装Miniconda</h3><p>conda是一个开源的包、环境管理器，可以用于在同一个机器上安装不同Python版本的软件包及其依赖，并能够在不同的Python环境之间切换，Anaconda包括Conda、Python以及一大堆安装好的工具包，比如：numpy、pandas等，Miniconda包括Conda、Python。</p><p>此处，我们不需要如此多的工具包，故选择MiniConda。</p><p><strong>1）下载Miniconda（Python3版本）</strong></p><p>下载地址：<a href="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh">https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh</a></p><p><strong>2）安装Miniconda</strong></p><p>（1）执行以下命令进行安装，并按照提示操作，直到安装完成。</p><p><code>[atguigu@hadoop102 lib]$ bash Miniconda3-latest-Linux-x86_64.sh</code></p><p>（2）在安装过程中，出现以下提示时，可以指定安装路径</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/21cfa07f97bad3cc35c659ef3c097c1c.png"></p><p>（3）出现以下字样，即为安装完成</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/11f729cc1dd99c96a88cb4766cecaaa6.png"></p><p><strong>3）加载环境变量配置文件，使之生效</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>atguigu@hadoop102 lib<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>4）取消激活base环境</strong></p><p>Miniconda安装完成后，每次打开终端都会激活其默认的base环境，我们可通过以下命令，禁止激活默认base环境。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>atguigu@hadoop102 lib<span class="token punctuation">]</span>$ conda config --set auto_activate_base <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-1-2-创建Python3-7环境"><a href="#2-1-2-创建Python3-7环境" class="headerlink" title="2.1.2 创建Python3.7环境"></a>2.1.2 创建Python3.7环境</h3><p><strong>1）配置conda国内镜像</strong></p><p>`</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ conda config --add channels<span class="token variable"><span class="token variable">`</span><span class="token variable">`</span></span>https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free<span class="token variable"><span class="token variable">`</span><span class="token variable">`</span></span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ conda config --add channels<span class="token variable"><span class="token variable">`</span><span class="token variable">`</span></span>https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main<span class="token variable"><span class="token variable">`</span><span class="token variable">`</span></span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ conda config --set show_channel_urls yes`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2）创建Python3.7环境</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ conda create --name superset <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.7</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>说明：conda环境管理常用命令</strong></p><p><strong>创建环境：</strong>conda create -n env_name</p><p><strong>查看所有环境：</strong>conda info –envs</p><p><strong>删除一个环境：</strong>conda remove -n env_name –all</p><p><strong>3）激活superset环境</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ conda activate superset<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>激活后效果如下图所示</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/92c18cb491d0a81b6b876e114d83774e.png"></p><p><strong>说明：退出当前环境</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ conda deactivate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>4）执行python命令查看python版本</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/100c6d2217947789ddc8ea045bfc647e.png"></p><h2 id="2-2-Superset部署"><a href="#2-2-Superset部署" class="headerlink" title="2.2 Superset部署"></a>2.2 Superset部署</h2><h3 id="2-2-1-安装依赖"><a href="#2-2-1-安装依赖" class="headerlink" title="2.2.1 安装依赖"></a>2.2.1 安装依赖</h3><p>安装Superset之前，需安装以下所需依赖</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> yum <span class="token function">install</span> -y gcc gcc-c++ libffi-develpython-devel python-pip python-wheel python-setuptools openssl-develcyrus-sasl-devel openldap-devel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-2-2-安装Superset"><a href="#2-2-2-安装Superset" class="headerlink" title="2.2.2 安装Superset"></a>2.2.2 安装Superset</h3><p><strong>1）安装（更新）setuptools和pip</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ pip <span class="token function">install</span> --upgrade setuptools pip -ihttps://pypi.douban.com/simple/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>说明：</strong>pip是python的包管理工具，可以和centos中的yum类比</p><p><strong>2）安装Supetset</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ pip <span class="token function">install</span> apache-superset -ihttps://pypi.douban.com/simple/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>说明：</strong>-i的作用是指定镜像，这里选择国内镜像</p><p>注：如果遇到网络错误导致不能下载，可尝试更换镜像</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ pip <span class="token function">install</span> apache-superset --trusted-hosthttps://repo.huaweicloud.com -ihttps://repo.huaweicloud.com/repository/pypi/simple<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>3）初始化Supetset数据库</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ superset db upgrade<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>4）创建管理员用户</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">FLASK_APP</span><span class="token operator">=</span>superset<span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ superset fab create-admin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>说明：</strong>flask是一个python web框架，Superset使用的就是flask</p><p><strong>5）Superset初始化</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ superset init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-2-3-启动Supterset"><a href="#2-2-3-启动Supterset" class="headerlink" title="2.2.3 启动Supterset"></a>2.2.3 启动Supterset</h3><p><strong>1）安装gunicorn</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ pip <span class="token function">install</span> gunicorn -ihttps://pypi.douban.com/simple/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>说明：</strong>gunicorn是一个Python Web Server，可以和java中的TomCat类比</p><p><strong>2）启动Superset</strong></p><p><strong>（1）确保当前conda环境为superset，及下图所示</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/7eed1f0df3523567cbc7910e7d2285c0.png"></p><p><strong>（2）启动</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ gunicorn --workers <span class="token number">5</span> --timeout <span class="token number">120</span> --bindhadoop102:8787 <span class="token string">"superset.app:create_app()"</span> --daemon<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>说明：</strong></p><p><strong>–workers：指定进程个数</strong></p><p><strong>–timeout：worker进程超时时间，超时会自动重启</strong></p><p><strong>–bind：绑定本机地址，即为Superset访问地址</strong></p><p><strong>–daemon：后台运行</strong></p><p><strong>（3）登录Superset</strong></p><p>访问<a href="http://hadoop102:8787/">http://hadoop102:8787</a>，并使用2.2.2节中第4步创建的管理员账号进行登录。</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/6536ae51a63a05c98ad4bb2da96c0304.png"></p><p><strong>3）停止superset</strong></p><p><strong>停掉</strong>gunicorn进程</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ <span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/superset/ &amp;&amp; !/awk/{print$2}'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span> -9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>退出superset环境</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ conda deactivate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-2-4-superset启停脚本"><a href="#2-2-4-superset启停脚本" class="headerlink" title="2.2.4 superset启停脚本"></a>2.2.4 superset启停脚本</h3><p><strong>1）创建superset.sh文件</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>atguigu@hadoop102 bin<span class="token punctuation">]</span>$ <span class="token function">vim</span> superset.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>内容如下</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token shebang important">#!/bin/bash</span><span class="token function-name function">superset_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token assign-left variable">result</span><span class="token operator">=</span><span class="token punctuation">\</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/gunicorn/ &amp;&amp; !/awk/{print $2}'</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token punctuation">\</span><span class="token variable">`</span></span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$result</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">return</span> <span class="token number">0</span><span class="token keyword">else</span><span class="token builtin class-name">return</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token punctuation">}</span><span class="token function-name function">superset_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token builtin class-name">source</span> ~/.bashrcsuperset_status <span class="token operator">&gt;</span>/dev/null <span class="token number">2</span><span class="token punctuation">\</span><span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>conda activate superset <span class="token punctuation">;</span> gunicorn --workers <span class="token number">5</span> --timeout <span class="token number">120</span> --bindhadoop102:8787 --daemon <span class="token string">'superset.app:create_app()'</span><span class="token keyword">else</span><span class="token builtin class-name">echo</span> <span class="token string">"superset正在运行"</span><span class="token keyword">fi</span><span class="token punctuation">}</span><span class="token function-name function">superset_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>superset_status <span class="token operator">&gt;</span>/dev/null <span class="token number">2</span><span class="token punctuation">\</span><span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">"superset未在运行"</span><span class="token keyword">else</span><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/gunicorn/ &amp;&amp; !/awk/{print $2}'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span> -9<span class="token keyword">fi</span><span class="token punctuation">}</span><span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>start <span class="token punctuation">)</span><span class="token builtin class-name">echo</span> <span class="token string">"启动Superset"</span>superset_start<span class="token punctuation">;</span><span class="token punctuation">;</span>stop <span class="token punctuation">)</span><span class="token builtin class-name">echo</span> <span class="token string">"停止Superset"</span>superset_stop<span class="token punctuation">;</span><span class="token punctuation">;</span>restart <span class="token punctuation">)</span><span class="token builtin class-name">echo</span> <span class="token string">"重启Superset"</span>superset_stopsuperset_start<span class="token punctuation">;</span><span class="token punctuation">;</span>status <span class="token punctuation">)</span>superset_status <span class="token operator">&gt;</span>/dev/null <span class="token number">2</span><span class="token punctuation">\</span><span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">"superset未在运行"</span><span class="token keyword">else</span><span class="token builtin class-name">echo</span> <span class="token string">"superset正在运行"</span><span class="token keyword">fi</span><span class="token keyword">esac</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2）加执行权限</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>atguigu@hadoop102 bin<span class="token punctuation">]</span>$ <span class="token function">chmod</span> +x superset.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>3）测试</strong></p><p><strong>启动superset</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>atguigu@hadoop102 bin<span class="token punctuation">]</span>$ superset.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>停止superset</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>atguigu@hadoop102 bin<span class="token punctuation">]</span>$ superset.sh stop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="第3章-Superset使用"><a href="#第3章-Superset使用" class="headerlink" title="第3章 Superset使用"></a>第3章 Superset使用</h1><h2 id="3-1-对接MySQL数据源"><a href="#3-1-对接MySQL数据源" class="headerlink" title="3.1 对接MySQL数据源"></a>3.1 对接MySQL数据源</h2><h3 id="3-1-1-安装依赖"><a href="#3-1-1-安装依赖" class="headerlink" title="3.1.1 安装依赖"></a>3.1.1 安装依赖</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ conda <span class="token function">install</span> mysqlclient<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>说明：对接不同的数据源，需安装不同的依赖，以下地址为官网说明</strong></p><p><a href="https://superset.apache.org/docs/databases/installing-database-drivers"><strong>https://superset.apache.org/docs/databases/installing-database-drivers</strong></a></p><h3 id="3-1-2-重启Superset"><a href="#3-1-2-重启Superset" class="headerlink" title="3.1.2 重启Superset"></a>3.1.2 重启Superset</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>superset<span class="token punctuation">)</span> <span class="token punctuation">[</span>atguigu@hadoop102 ~<span class="token punctuation">]</span>$ superset.sh restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-1-3-数据源配置"><a href="#3-1-3-数据源配置" class="headerlink" title="3.1.3 数据源配置"></a>3.1.3 数据源配置</h3><p><strong>1）Database配置</strong></p><p><strong>Step1：</strong>点击Data/Databases</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/ed2e0a8bc310f81b004e6fdf2e598c7e.png"></p><p><strong>Step2：</strong>点击<strong>＋DATABASE</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/cfd1ab12fea38f42d7e7d2f8013bb4e8.png"></p><p><strong>Step3：</strong>点击填写Database及SQL Alchemy URI</p><p>注：SQL Alchemy URI编写规范：mysql://用户名:密码@主机名:端口号/数据库名称</p><p>此处填写：</p><p>mysql://root:123456@hadoop102:3306/gmall_report?charset=utf8</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/6e06741add397efe9ef1ba7f43471295.png"></p><p><strong>Step4：</strong>点击Test Connection，出现“Connection looks good!”提示即表示连接成功</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/41f61330a0b2fe5bfba053ef8f6ec4af.png"></p><p><strong>Step5：</strong>点击ADD</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/6df4cc9826f98d13a4d71e0632fc710c.png"></p><p><strong>2）Table配置</strong></p><p><strong>Step1：点击</strong>Data/Datasets</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/9061e51361a8b750abafda61f76e0e68.png"></p><p><strong>Step2：点击</strong>Data/ Datasets</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/f5df3898430000440d1a890c1baedf22.png"></p><p><strong>Step3：配置Table</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/f91d96d302362595c3b04389cc63f47c.png"></p><h2 id="3-2-制作仪表盘"><a href="#3-2-制作仪表盘" class="headerlink" title="3.2 制作仪表盘"></a>3.2 制作仪表盘</h2><h3 id="3-2-1-创建空白仪表盘"><a href="#3-2-1-创建空白仪表盘" class="headerlink" title="3.2.1 创建空白仪表盘"></a>3.2.1 创建空白仪表盘</h3><p><strong>1）点击Dashboards/+DASHBOARDS</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/4706ff2664ab22889a952a2c590eb2a9.png"></p><p><strong>2）命名并保存</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/a2c9d99d4fecd16cb8622779bc306ec9.png"></p><h3 id="3-2-2-创建图表"><a href="#3-2-2-创建图表" class="headerlink" title="3.2.2 创建图表"></a>3.2.2 创建图表</h3><p><strong>1）点击Charts/+CHART</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/52781014d62877d57129190df1e9eb75.png"></p><p><strong>2）选则数据源及图表类型</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/454bfd55d8c5fadcd5fb80ab738f0379.png"></p><p><strong>3）选择何使的图表类型</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/15be5dde28c70fb3dd8b21c6a23b3504.png"></p><p><strong>4）创建图表</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/14f0cfb6a43782037b0ec960f7899aae.png"></p><p><strong>5）按照说明配置图表</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/54577fb83ccb3d4e7c8928a987dd1849.png"></p><p><strong>6）点击“Run Query”</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/ccf7e2bf55783eb63d4d39bacd43eca8.png"></p><p><strong>7）如配置无误，可出现以下图标</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/e299f8a54c3392702460e68d6d05a47d.png"></p><p>8）命名该图表，并保存至仪表盘</p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/b47a47102751453a789c92b846e626dc.png"></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/d2001799b53193e80f4844d1f50a4f9e.png"></p><h3 id="3-2-3-编辑仪表盘"><a href="#3-2-3-编辑仪表盘" class="headerlink" title="3.2.3 编辑仪表盘"></a>3.2.3 编辑仪表盘</h3><p><strong>1）打开仪表盘，点击编辑按钮</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/343693d67dc932661519858e5ea94d4e.png"></p><p><strong>2）调整图表大小以及图表盘布局</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/8decfbfd1ab34ee7d7f058c150330529.png"></p><p><strong>3）点击下图中箭头，可调整仪表盘自动刷新时间</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/674a5b2b560e5db743bccfbbf23e6277.png"></p><h1 id="第4章-Superset实战"><a href="#第4章-Superset实战" class="headerlink" title="第4章 Superset实战"></a>第4章 Superset实战</h1><h2 id="4-1-制作地图"><a href="#4-1-制作地图" class="headerlink" title="4.1 制作地图"></a>4.1 制作地图</h2><p><strong>4.1.1 配置Table</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/391f21beab552e4abd44381b30000abd.png"></p><p><strong>4.1.2 配置Chart</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/2c9af3b1664cf8438a4cba7ca5958d78.png"></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/46ded02587b80ea56a426326526e1251.png"></p><h2 id="4-2-制作饼状图"><a href="#4-2-制作饼状图" class="headerlink" title="4.2 制作饼状图"></a>4.2 制作饼状图</h2><p><strong>4.2.1 配置Table</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/6af5bf2aa9f2804fb10757d7bdfe45de.png"></p><p><strong>4.2.2 配置Chart</strong></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/d2a57f4f4768498dacaee7adcbe06665.png"></p><p><img src="/2022/03/11/ke-shi-hua-bao-biao-superset/677111d4ff218aca2f450f2ed40a33be.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Bigdata </tag>
            
            <tag> Apache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数仓项目</title>
      <link href="/2022/03/05/shu-cang-xiang-mu/"/>
      <url>/2022/03/05/shu-cang-xiang-mu/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Flink学习笔记</title>
      <link href="/2022/03/05/flink-xue-xi-bi-ji/"/>
      <url>/2022/03/05/flink-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://www.bilibili.com/video/BV1qy4y1q728">尚硅谷2021最新Java版Flink</a></p><p>中间会把自己认为较重要的点做做标记（下划线、加粗等）</p></blockquote><ul><li><p>事件驱动（Event-driven）s</p></li><li><p>基于流处理</p><p>一切皆由流组成，离线数据是有界的流；实时数据是一个没有界限的流。（有界流、无界流）</p></li><li><p>分层API</p><ul><li>  越顶层越抽象，表达含义越简明，使用越方便</li><li>  越底层越具体，表达能力越丰富，使用越灵活</li></ul></li></ul><h2 id="1-1-Flink-vs-Spark-Streaming"><a href="#1-1-Flink-vs-Spark-Streaming" class="headerlink" title="1.1 Flink vs Spark Streaming"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_11-flink-vs-spark-streaming">1.1 Flink vs Spark Streaming</a></h2><ul><li>数据模型<ul><li>  Spark采用RDD模型，spark streaming的DStream实际上也就是一组组小批数据RDD的集合</li><li>  flink基本数据模型是数据流，以及事件（Event）序列</li></ul></li><li>运行时架构<ul><li>  spark是批计算，将DAG划分为不同的stage，一个完成后才可以计算下一个</li><li>  flink是标准的流执行模式，一个事件在一个节点处理完后可以直接发往下一个节点处理</li></ul></li></ul><h2 id="2-1-批处理实现WordCount"><a href="#2-1-批处理实现WordCount" class="headerlink" title="2.1 批处理实现WordCount"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_21-%E6%89%B9%E5%A4%84%E7%90%86%E5%AE%9E%E7%8E%B0wordcount">2.1 批处理实现WordCount</a></h2><blockquote><p><em>flink-streaming-scala_2.12 =&gt; org.apache.flink:flink-runtime_2.12:1.12.1 =&gt; com.typesafe.akka:akka-actor_2.12:2.5.21，akka就是用scala实现的。即使这里我们用java语言，还是用到了scala实现的包</em></p></blockquote><p>pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span>         xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>modelVersion<span class="token punctuation">&gt;</span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>example<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span><span class="token class-name">Flink_Tutorial</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">&gt;</span></span>        <span class="token generics"><span class="token punctuation">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token punctuation">&gt;</span></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token punctuation">&gt;</span></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.12</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>flink<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.12</span><span class="token operator">&lt;</span><span class="token operator">/</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>streaming<span class="token operator">-</span>scala_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>clients_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码实现</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">FlatMapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">DataSet</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">ExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/29 10:46 PM * 批处理 wordcount */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCount</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">ExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">ExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从文件中读取数据</span>    <span class="token class-name">String</span> inputPath <span class="token operator">=</span> <span class="token string">"/tmp/Flink_Tutorial/src/main/resources/hello.txt"</span><span class="token punctuation">;</span>    <span class="token class-name">DataSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputDataSet <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 对数据集进行处理，按空格分词展开，转换成(word, 1)二元组进行统计</span>    <span class="token comment">// 按照第一个位置的word分组</span>    <span class="token comment">// 按照第二个位置上的数据求和</span>    <span class="token class-name">DataSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultSet <span class="token operator">=</span> inputDataSet<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyFlatMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultSet<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义类，实现FlatMapFunction接口</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyFlatMapper</span> <span class="token keyword">implements</span> <span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 按空格分词</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 遍历所有word，包成二元组输出</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> str <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">(</span>scala<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>flink<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>world<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>hello<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span>and<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fine<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>how<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>spark<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>you<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span>are<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>thank<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><a href="https://blog.csdn.net/qq_41398614/article/details/107553604">解决 Flink 升级1.11 报错 No ExecutorFactory found to execute the application</a></p></blockquote><h2 id="2-2-流处理实现WordCount"><a href="#2-2-流处理实现WordCount" class="headerlink" title="2.2 流处理实现WordCount"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_22-%E6%B5%81%E5%A4%84%E7%90%86%E5%AE%9E%E7%8E%B0wordcount">2.2 流处理实现WordCount</a></h2><p>在2.1批处理的基础上，新建一个类进行改动。</p><ul><li><p>  批处理=&gt;几组或所有数据到达后才处理；流处理=&gt;有数据来就直接处理，不等数据堆叠到一定数量级</p></li><li><p>  <strong>这里不像批处理有groupBy =&gt; 所有数据统一处理，而是用流处理的keyBy =&gt; 每一个数据都对key进行hash计算，进行类似分区的操作，来一个数据就处理一次，所有中间过程都有输出！</strong></p></li><li><p>  <strong>并行度：开发环境的并行度默认就是计算机的CPU逻辑核数</strong></p></li></ul><p>代码实现</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">wc</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>client<span class="token punctuation">.</span>program<span class="token punctuation">.</span></span><span class="token class-name">StreamContextEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/29 11:13 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamWordCount</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建流处理执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamContextEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 设置并行度，默认值 = 当前计算机的CPU逻辑核数（设置成1即单线程处理）</span>        <span class="token comment">// env.setMaxParallelism(32);</span>              <span class="token comment">// 从文件中读取数据</span>        <span class="token class-name">String</span> inputPath <span class="token operator">=</span> <span class="token string">"/tmp/Flink_Tutorial/src/main/resources/hello.txt"</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 基于数据流进行转换计算</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> inputDataStream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WordCount<span class="token punctuation">.</span>MyFlatMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span>item<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行任务</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><p><em>这里因为是流处理，所以所有中间过程都会被输出，前面的序号就是并行执行任务的线程编号。</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">9</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>world<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">5</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>hello<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">8</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>are<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">10</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>you<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">11</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>how<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">6</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>thank<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">9</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>fine<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">10</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>you<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token number">10</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>you<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token number">15</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>and<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">5</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>hello<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token number">13</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>flink<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>spark<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">5</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>hello<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>scala<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">5</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>hello<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 这里<code>env.execute();</code>之前的代码，可以理解为是在定义任务，只有执行<code>env.execute()</code>后，Flink才把前面的代码片段当作一个任务整体（每个线程根据这个任务操作，并行处理流数据）。</p><h2 id="2-3-流式数据源测试"><a href="#2-3-流式数据源测试" class="headerlink" title="2.3 流式数据源测试"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_23-%E6%B5%81%E5%BC%8F%E6%95%B0%E6%8D%AE%E6%BA%90%E6%B5%8B%E8%AF%95">2.3 流式数据源测试</a></h2><ol><li><p>通过<code>nc -lk &lt;port&gt;</code>打开一个socket服务，用于模拟实时的流数据</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">nc <span class="token operator">-</span>lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>代码修改inputStream的部分</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">wc</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>client<span class="token punctuation">.</span>program<span class="token punctuation">.</span></span><span class="token class-name">StreamContextEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/29 11:13 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamWordCount</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建流处理执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamContextEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 设置并行度，默认值 = 当前计算机的CPU逻辑核数（设置成1即单线程处理）</span>        <span class="token comment">// env.setMaxParallelism(32);</span>        <span class="token comment">// 从文件中读取数据</span><span class="token comment">//        String inputPath = "/tmp/Flink_Tutorial/src/main/resources/hello.txt";</span><span class="token comment">//        DataStream&lt;String&gt; inputDataStream = env.readTextFile(inputPath);</span>        <span class="token comment">// 从socket文本流读取数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 基于数据流进行转换计算</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> inputDataStream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WordCount<span class="token punctuation">.</span>MyFlatMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span>item<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行任务</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在本地开启的socket中输入数据，观察IDEA的console输出。</p><p> 本人测试后发现，同一个字符串，前面输出的编号是一样的，因为key =&gt; hashcode,同一个key的hash值固定，分配给相对应的线程处理。</p></li></ol><h2 id="3-1-Standalone模式"><a href="#3-1-Standalone模式" class="headerlink" title="3.1 Standalone模式"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_31-standalone%E6%A8%A1%E5%BC%8F">3.1 Standalone模式</a></h2><blockquote><p><a href="https://blog.csdn.net/qq_39657909/article/details/105823127">Flink任务调度原理之TaskManager 与Slots</a> &lt;= 下面内容出自该博文</p></blockquote><ol><li> Flink 中每一个 TaskManager 都是一个JVM进程，它可能会在独立的线程上执行一个或多个 subtask</li><li> 为了控制一个 TaskManager 能接收多少个 task， TaskManager 通过 task slot 来进行控制（一个 TaskManager 至少有一个 slot）</li><li> 每个task slot表示TaskManager拥有资源的一个固定大小的子集。假如一个TaskManager有三个slot，那么它会将其管理的内存分成三份给各个slot(注：这里不会涉及CPU的隔离，slot仅仅用来隔离task的受管理内存)</li><li> 可以通过调整task slot的数量去自定义subtask之间的隔离方式。如一个TaskManager一个slot时，那么每个task group运行在独立的JVM中。而<strong>当一个TaskManager多个slot时，多个subtask可以共同享有一个JVM,而在同一个JVM进程中的task将共享TCP连接和心跳消息，也可能共享数据集和数据结构，从而减少每个task的负载</strong>。</li></ol><p><img src="https://img-blog.csdnimg.cn/20200428203404161.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5NjU3OTA5,size_16,color_FFFFFF,t_70#pic_center"></p><p><img src="https://img-blog.csdnimg.cn/20200428205219327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5NjU3OTA5,size_16,color_FFFFFF,t_70#pic_center"></p><ol><li> 默认情况下，Flink 允许子任务共享 slot，即使它们是不同任务的子任务（前提是它们来自同一个job）。 这样的结果是，一个 slot 可以保存作业的整个管道。</li><li> Task Slot 是静态的概念，是指 TaskManager 具有的并发执行能力，可以通过参数taskmanager.numberOfTaskSlots进行配置；而并行度parallelism是动态概念，即TaskManager运行程序时实际使用的并发能力，可以通过参数parallelism.default进行配置。 举例：如果总共有3个TaskManager,每一个TaskManager中分配了3个TaskSlot,也就是每个TaskManager可以接收3个task,这样我们总共可以接收9个TaskSot。但是如果我们设置parallelism.default=1，那么当程序运行时9个TaskSlot将只有1个运行，8个都会处于空闲状态，所以要学会合理设置并行度！具体图解如下： <img src="https://img-blog.csdnimg.cn/20200902165040619.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM5NjU3OTA5,size_16,color_FFFFFF,t_70#pic_center"></li></ol><p><code>conf/flink-conf.yaml</code>配置文件中</p><ul><li>  <code>taskmanager.numberOfTaskSlots</code></li><li>  <code>parallelism.default</code></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"># <span class="token class-name">The</span> number of task slots that each <span class="token class-name">TaskManager</span> <span class="token class-name"><span class="token namespace">offers<span class="token punctuation">.</span></span> Each</span> slot runs one parallel pipeline<span class="token punctuation">.</span>taskmanager<span class="token punctuation">.</span>numberOfTaskSlots<span class="token operator">:</span> <span class="token number">1</span># <span class="token class-name">The</span> parallelism used <span class="token keyword">for</span> programs that did not specify and other parallelism<span class="token punctuation">.</span>parallelism<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注：<strong>Flink存储State用的是堆外内存</strong>，所以web UI里<code>JVM Heap Size</code>和<code>Flink Managed MEM</code>是两个分开的值。</p><h3 id="3-1-1-Web-UI提交job"><a href="#3-1-1-Web-UI提交job" class="headerlink" title="3.1.1 Web UI提交job"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_311-web-ui%E6%8F%90%E4%BA%A4job">3.1.1 Web UI提交job</a></h3><blockquote><p><a href="https://blog.csdn.net/qq_37142346/article/details/91385333">Flink Savepoint简单介绍</a></p></blockquote><p>启动Flink后，可以在<a href="lcoalhost:8081">Web UI</a>的<code>Submit New Job</code>提交jar包，然后指定Job参数。</p><ul><li><p>Entry Class</p><p>程序的入口，指定入口类（类的全限制名）</p></li><li><p>Program Arguments</p><p>程序启动参数，例如<code>--host localhost --port 7777</code></p></li><li><p>Parallelism</p><p>设置Job并行度。</p><p>Ps：并行度优先级（从上到下优先级递减）</p><ul><li>  代码中算子<code>setParallelism()</code></li><li>  <code>ExecutionEnvironment env.setMaxParallelism()</code></li><li>  设置的Job并行度</li><li>  集群conf配置文件中的<code>parallelism.default</code></li></ul><p>ps：<strong>socket等特殊的IO操作，本身不能并行处理，并行度只能是1</strong></p></li><li><p>Savepoint Path</p><p>savepoint是通过checkpoint机制为streaming job创建的一致性快照，比如数据源offset，状态等。</p><p>(savepoint可以理解为手动备份，而checkpoint为自动备份)</p></li></ul><p>ps：提交job要注意分配的slot总数是否足够使用，如果slot总数不够，那么job执行失败。（资源不够调度）</p><p>这里提交前面demo项目的StreamWordCount，在本地socket即<code>nc -lk 7777</code>中输入字符串，查看结果</p><p>输入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">hello world<span class="token punctuation">,</span> and thank you<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>输出：</p><p>可以看出来输出的顺序并不是和输入的字符串严格相同的，因为是多个线程并行处理的。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>world<span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>and<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>thank<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>you<span class="token operator">!</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>hello<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-1-2-命令行提交job"><a href="#3-1-2-命令行提交job" class="headerlink" title="3.1.2 命令行提交job"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_312-%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8F%90%E4%BA%A4job">3.1.2 命令行提交job</a></h3><ol><li><p>查看已提交的所有job</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/flink list      Waiting <span class="token keyword">for</span> response<span class="token punctuation">..</span>.------------------ Running/Restarting Jobs -------------------<span class="token number">30.01</span>.2021 <span class="token number">17</span>:09:45 <span class="token builtin class-name">:</span> 30d9dda946a170484d55e41358973942 <span class="token builtin class-name">:</span> Flink Streaming Job <span class="token punctuation">(</span>RUNNING<span class="token punctuation">)</span>--------------------------------------------------------------No scheduled jobs.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>提交job</p><ul><li>  <code>-c</code>指定入口类</li><li>  <code>-p</code>指定job的并行度</li></ul><p><code>bin/flink run -c &lt;入口类&gt; -p &lt;并行度&gt; &lt;jar包路径&gt; &lt;启动参数&gt;</code></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/flink run -c wc.StreamWordCount -p <span class="token number">3</span> /tmp/Flink_Tutorial-1.0-SNAPSHOT.jar --host localhost --port <span class="token number">7777</span>Job has been submitted with JobID 33a5d1f00688a362837830f0b85fd75e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>取消job</p><p><code>bin/flink cancel &lt;Job的ID&gt;</code></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/flink cancel 30d9dda946a170484d55e41358973942Cancelling job 30d9dda946a170484d55e41358973942.Cancelled job 30d9dda946a170484d55e41358973942.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ol><p><strong>注：Total Task Slots只要不小于Job中Parallelism最大值即可。</strong> </p><p>eg：这里我配置文件设置<code>taskmanager.numberOfTaskSlots: 4</code>，实际Job运行时总Tasks显示9，但是里面具体4个任务步骤分别需求（1，3，3，2）数量的Tasks，4&gt;3，满足最大的Parallelism即可运行成功。</p><h2 id="3-2-yarn模式"><a href="#3-2-yarn模式" class="headerlink" title="3.2 yarn模式"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_32-yarn%E6%A8%A1%E5%BC%8F">3.2 yarn模式</a></h2><blockquote><p><a href="https://blog.csdn.net/suyebiubiu/article/details/111874245">4.6 Flink-流处理框架-Flink On Yarn（Session-cluster+Per-Job-Cluster）</a> &lt;= 下面内容出自此处，主要方便索引图片URL</p></blockquote><pre class="line-numbers language-none"><code class="language-none">以Yarn模式部署Flink任务时，要求Flink是有 Hadoop 支持的版本，Hadoop 环境需要保证版本在 2.2 以上，并且集群中安装有 HDFS 服务。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-2-1-Flink-on-Yarn"><a href="#3-2-1-Flink-on-Yarn" class="headerlink" title="3.2.1 Flink on Yarn"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_321-flink-on-yarn">3.2.1 Flink on Yarn</a></h3><p> Flink提供了两种在yarn上运行的模式，分别为Session-Cluster和Per-Job-Cluster模式。</p><h4 id="1-Sesstion-Cluster模式"><a href="#1-Sesstion-Cluster模式" class="headerlink" title="1. Sesstion Cluster模式"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1-sesstion-cluster%E6%A8%A1%E5%BC%8F">1. Sesstion Cluster模式</a></h4><p> Session-Cluster 模式需要先启动集群，然后再提交作业，接着会向 yarn 申请一块空间后，<strong>资源永远保持不变</strong>。如果资源满了，下一个作业就无法提交，只能等到 yarn 中的其中一个作业执行完成后，释放了资源，下个作业才会正常提交。<strong>所有作业共享 Dispatcher 和 ResourceManager</strong>；<strong>共享资源；适合规模小执行时间短的作业。</strong> </p><p><img src="https://img-blog.csdnimg.cn/20201228202616146.png"></p><p> <strong>在 yarn 中初始化一个 flink 集群，开辟指定的资源，以后提交任务都向这里提交。这个 flink 集群会常驻在 yarn 集群中，除非手工停止。</strong> </p><h4 id="2-Per-Job-Cluster-模式"><a href="#2-Per-Job-Cluster-模式" class="headerlink" title="2. Per Job Cluster 模式"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_2-per-job-cluster-%E6%A8%A1%E5%BC%8F">2. Per Job Cluster 模式</a></h4><p> 一个 Job 会对应一个集群，每提交一个作业会根据自身的情况，都会单独向 yarn 申请资源，直到作业执行完成，一个作业的失败与否并不会影响下一个作业的正常提交和运行。<strong>独享 Dispatcher 和 ResourceManager</strong>，按需接受资源申请；适合规模大长时间运行的作业。</p><p> <strong>每次提交都会创建一个新的 flink 集群，任务之间互相独立，互不影响，方便管理。任务执行完成之后创建的集群也会消失。</strong> </p><p><img src="https://img-blog.csdnimg.cn/20201228202718916.png"></p><h3 id="3-2-2-Session-Cluster"><a href="#3-2-2-Session-Cluster" class="headerlink" title="3.2.2 Session Cluster"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_322-session-cluster">3.2.2 Session Cluster</a></h3><ol><li><p>启动_hadoop_集群（略）</p></li><li><p>启动_yarn-session_</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">./yarn-session.sh -n <span class="token number">2</span> -s <span class="token number">2</span> -jm <span class="token number">1024</span> -tm <span class="token number">1024</span> -nm <span class="token builtin class-name">test</span> -d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其中：</p><ul><li><p>  <code>-n(--container)</code>：TaskManager的数量。</p></li><li><p>  <code>-s(--slots)</code>：每个TaskManager的slot数量，默认一个slot一个core，默认每个taskmanager的slot的个数为1，有时可以多一些taskmanager，做冗余。</p></li><li><p>  <code>-jm</code>：JobManager的内存（单位MB)。</p></li><li><p>  <code>-tm</code>：每个taskmanager的内存（单位MB)。</p></li><li><p>  <code>-nm</code>：yarn 的appName(现在yarn的ui上的名字)。</p></li><li><p>  <code>-d</code>：后台执行。</p></li></ul></li><li><p>执行任务</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">./flink run -c com.atguigu.wc.StreamWordCount FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar --host lcoalhost –port <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>去 yarn 控制台查看任务状态</p><p><img src="https://img-blog.csdnimg.cn/20201228202911116.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1N1eWViaXViaXU=,size_16,color_FFFFFF,t_70"></p></li><li><p>取消 yarn-session</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">yarn</span> application --kill application_1577588252906_0001<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h3 id="3-2-3-Per-Job-Cluster"><a href="#3-2-3-Per-Job-Cluster" class="headerlink" title="3.2.3 Per Job Cluster"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_323-per-job-cluster">3.2.3 Per Job Cluster</a></h3><ol><li><p>启动_hadoop_集群（略）</p></li><li><p>不启动<strong>yarn-session</strong>，直接执行_job_</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">./flink run –m yarn-cluster -c com.atguigu.wc.StreamWordCount FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar --host lcoalhost –port <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h2 id="3-3-Kubernetes部署"><a href="#3-3-Kubernetes部署" class="headerlink" title="3.3 Kubernetes部署"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_33-kubernetes%E9%83%A8%E7%BD%B2">3.3 Kubernetes部署</a></h2><p> 容器化部署时目前业界很流行的一项技术，基于Docker镜像运行能够让用户更加方便地对应用进行管理和运维。容器管理工具中最为流行的就是Kubernetes（k8s），而Flink也在最近的版本中支持了k8s部署模式。</p><ol><li><p> 搭建_Kubernetes_集群（略）</p></li><li><p> 配置各组件的_yaml_文件</p></li></ol><p> 在k8s上构建Flink Session Cluster，需要将Flink集群的组件对应的docker镜像分别在k8s上启动，包括JobManager、TaskManager、JobManagerService三个镜像服务。每个镜像服务都可以从中央镜像仓库中获取。</p><ol start="3"><li><p>启动_Flink Session Cluster_</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">// 启动jobmanager-service 服务kubectl create -f jobmanager-service.yaml// 启动jobmanager-deployment服务kubectl create -f jobmanager-deployment.yaml// 启动taskmanager-deployment服务kubectl create -f taskmanager-deployment.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>访问_Flink UI_页面</p><p>集群启动后，就可以通过JobManagerServicers中配置的WebUI端口，用浏览器输入以下url来访问Flink UI页面了：</p><p><code>http://{JobManagerHost:Port}/api/v1/namespaces/default/services/flink-jobmanager:ui/proxy</code></p></li></ol><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106321149">Flink-运行时架构中的四大组件|任务提交流程|任务调度原理|Slots和并行度中间的关系|数据流|执行图|数据得传输形式|任务链</a></p></blockquote><h2 id="4-1-Flink运行时的组件"><a href="#4-1-Flink运行时的组件" class="headerlink" title="4.1 Flink运行时的组件"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_41-flink%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E7%BB%84%E4%BB%B6">4.1 Flink运行时的组件</a></h2><p> Flink运行时架构主要包括四个不同的组件，它们会在运行流处理应用程序时协同工作：</p><ul><li>  <strong>作业管理器（JobManager）</strong></li><li>  <strong>资源管理器（ResourceManager）</strong></li><li>  <strong>任务管理器（TaskManager）</strong></li><li>  <strong>分发器（Dispatcher）</strong></li></ul><p> 因为Flink是用Java和Scala实现的，所以所有组件都会运行在Java虚拟机上。每个组件的职责如下：</p><h3 id="作业管理器（JobManager）"><a href="#作业管理器（JobManager）" class="headerlink" title="作业管理器（JobManager）"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BD%9C%E4%B8%9A%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88jobmanager%EF%BC%89">作业管理器（JobManager）</a></h3><p> 控制一个应用程序执行的主进程，也就是说，每个应用程序都会被一个不同的JobManager所控制执行。</p><p> JobManager会先接收到要执行的应用程序，这个应用程序会包括：</p><ul><li>  作业图（JobGraph）</li><li>  逻辑数据流图（logical dataflow graph）</li><li>  打包了所有的类、库和其它资源的JAR包。</li></ul><p> JobManager会把JobGraph转换成一个物理层面的数据流图，这个图被叫做“执行图”（ExecutionGraph），包含了所有可以并发执行的任务。</p><p> <strong>JobManager会向资源管理器（ResourceManager）请求执行任务必要的资源，也就是任务管理器（TaskManager）上的插槽（slot）。一旦它获取到了足够的资源，就会将执行图分发到真正运行它们的TaskManager上</strong>。</p><p> 在运行过程中，JobManager会负责所有需要中央协调的操作，比如说检查点（checkpoints）的协调。</p><h3 id="资源管理器（ResourceManager）"><a href="#资源管理器（ResourceManager）" class="headerlink" title="资源管理器（ResourceManager）"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88resourcemanager%EF%BC%89">资源管理器（ResourceManager）</a></h3><p> 主要负责管理任务管理器（TaskManager）的插槽（slot），TaskManger插槽是Flink中定义的处理资源单元。</p><p> Flink为不同的环境和资源管理工具提供了不同资源管理器，比如YARN、Mesos、K8s，以及standalone部署。</p><p> <strong>当JobManager申请插槽资源时，ResourceManager会将有空闲插槽的TaskManager分配给JobManager</strong>。如果ResourceManager没有足够的插槽来满足JobManager的请求，它还可以向资源提供平台发起会话，以提供启动TaskManager进程的容器。</p><p> 另外，<strong>ResourceManager还负责终止空闲的TaskManager，释放计算资源</strong>。</p><h3 id="任务管理器（TaskManager）"><a href="#任务管理器（TaskManager）" class="headerlink" title="任务管理器（TaskManager）"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88taskmanager%EF%BC%89">任务管理器（TaskManager）</a></h3><p> Flink中的工作进程。通常在Flink中会有多个TaskManager运行，每一个TaskManager都包含了一定数量的插槽（slots）。<strong>插槽的数量限制了TaskManager能够执行的任务数量</strong>。</p><p> 启动之后，TaskManager会向资源管理器注册它的插槽；收到资源管理器的指令后，TaskManager就会将一个或者多个插槽提供给JobManager调用。JobManager就可以向插槽分配任务（tasks）来执行了。</p><p> <strong>在执行过程中，一个TaskManager可以跟其它运行同一应用程序的TaskManager交换数据</strong>。</p><h3 id="分发器（Dispatcher）"><a href="#分发器（Dispatcher）" class="headerlink" title="分发器（Dispatcher）"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%88%86%E5%8F%91%E5%99%A8%EF%BC%88dispatcher%EF%BC%89">分发器（Dispatcher）</a></h3><p> 可以跨作业运行，它为应用提交提供了REST接口。</p><p> 当一个应用被提交执行时，分发器就会启动并将应用移交给一个JobManager。由于是REST接口，所以Dispatcher可以作为集群的一个HTTP接入点，这样就能够不受防火墙阻挡。Dispatcher也会启动一个Web UI，用来方便地展示和监控作业执行的信息。</p><p> <em>Dispatcher在架构中可能并不是必需的，这取决于应用提交运行的方式。</em></p><h2 id="4-2-任务提交流程"><a href="#4-2-任务提交流程" class="headerlink" title="4.2 任务提交流程"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_42-%E4%BB%BB%E5%8A%A1%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B">4.2 任务提交流程</a></h2><p> 我们来看看当一个应用提交执行时，Flink的各个组件是如何交互协作的：</p><p><img src="https://img-blog.csdnimg.cn/20200524212126844.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p> <em>ps：上图中7.指TaskManager为JobManager提供slots，8.表示JobManager提交要在slots中执行的任务给TaskManager。</em></p><p> 上图是从一个较为高层级的视角来看应用中各组件的交互协作。</p><p> 如果部署的集群环境不同（例如YARN，Mesos，Kubernetes，standalone等），其中一些步骤可以被省略，或是有些组件会运行在同一个JVM进程中。</p><p> 具体地，如果我们将Flink集群部署到YARN上，那么就会有如下的提交流程：</p><p><img src="https://img-blog.csdnimg.cn/20200524212247873.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ol><li> Flink任务提交后，Client向HDFS上传Flink的Jar包和配置</li><li> 之后客户端向Yarn ResourceManager提交任务，ResourceManager分配Container资源并通知对应的NodeManager启动ApplicationMaster</li><li> ApplicationMaster启动后加载Flink的Jar包和配置构建环境，去启动JobManager，之后<strong>JobManager向Flink自身的RM进行申请资源，自身的RM向Yarn 的ResourceManager申请资源(因为是yarn模式，所有资源归yarn RM管理)启动TaskManager</strong></li><li> Yarn ResourceManager分配Container资源后，由ApplicationMaster通知资源所在节点的NodeManager启动TaskManager</li><li> NodeManager加载Flink的Jar包和配置构建环境并启动TaskManager，TaskManager启动后向JobManager发送心跳包，并等待JobManager向其分配任务。</li></ol><h2 id="4-3-任务调度原理"><a href="#4-3-任务调度原理" class="headerlink" title="4.3 任务调度原理"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_43-%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%8E%9F%E7%90%86">4.3 任务调度原理</a></h2><p><img src="https://img-blog.csdnimg.cn/20200524213145755.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ol><li><p>客户端不是运行时和程序执行的一部分，但它用于准备并发送dataflow(JobGraph)给Master(JobManager)，然后，客户端断开连接或者维持连接以等待接收计算结果。而Job Manager会产生一个执行图(Dataflow Graph)</p></li><li><p>当 Flink 集群启动后，首先会启动一个 JobManger 和一个或多个的 TaskManager。由 Client 提交任务给 JobManager，JobManager 再调度任务到各个 TaskManager 去执行，然后 TaskManager 将心跳和统计信息汇报给 JobManager。TaskManager 之间以流的形式进行数据的传输。上述三者均为独立的 JVM 进程。</p></li><li><p>Client 为提交 Job 的客户端，可以是运行在任何机器上（与 JobManager 环境连通即可）。提交 Job 后，Client 可以结束进程（Streaming的任务），也可以不结束并等待结果返回。</p></li><li><p>JobManager 主要负责调度 Job 并协调 Task 做 checkpoint，职责上很像 Storm 的 Nimbus。从 Client 处接收到 Job 和 JAR 包等资源后，会生成优化后的执行计划，并以 Task 的单元调度到各个 TaskManager 去执行。</p></li><li><p>TaskManager 在启动的时候就设置好了槽位数（Slot），每个 slot 能启动一个 Task，Task 为线程。从 JobManager 处接收需要部署的 Task，部署启动后，与自己的上游建立 Netty 连接，接收数据并处理。</p><p><em>注：如果一个Slot中启动多个线程，那么这几个线程类似CPU调度一样共用同一个slot</em></p></li></ol><h3 id="4-3-1-TaskManger与Slots"><a href="#4-3-1-TaskManger与Slots" class="headerlink" title="4.3.1 TaskManger与Slots"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_431-taskmanger%E4%B8%8Eslots">4.3.1 TaskManger与Slots</a></h3><p>要点：</p><ul><li><p>考虑到Slot分组，所以实际运行Job时所需的Slot总数 = 每个Slot组中的最大并行度。</p><p>eg（1，1，2，1）,其中第一个归为组“red”、第二个归组“blue”、第三个和第四归组“green”，那么运行所需的slot即max（1）+max（1）+max（2，1） = 1+1+2 = 4</p></li></ul><hr><p><img src="https://img-blog.csdnimg.cn/20200524213557113.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  Flink中每一个worker(TaskManager)都是一个<strong>JVM</strong>进程，它可能会在独立的线程上执行一个或多个subtask。</li><li>  为了控制一个worker能接收多少个task，worker通过task slot来进行控制（一个worker至少有一个task slot）。</li></ul><p>**上图这个每个子任务各自占用一个slot，可以在代码中通过算子的<code>.slotSharingGroup("组名")</code>指定算子所在的Slot组名，默认每一个算子的SlotGroup和上一个算子相同，而默认的SlotGroup就是”default”**。</p><p><strong>同一个SlotGroup的算子能共享同一个slot，不同组则必须另外分配独立的Slot。</strong> </p><p><img src="https://img-blog.csdnimg.cn/20200524214555469.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>默认情况下，Flink允许子任务共享slot，即使它们是不同任务的子任务（前提需要来自同一个Job）。这样结果是，<strong>一个slot可以保存作业的整个管道pipeline</strong>。</p><ul><li><p>  <strong>不同任务共享同一个Slot的前提：这几个任务前后顺序不同，如上图中Source和keyBy是两个不同步骤顺序的任务，所以可以在同一个Slot执行</strong>。</p></li><li><p>一个slot可以保存作业的整个管道的好处：</p><ul><li>  如果有某个slot执行完了整个任务流程，那么其他任务就可以不用继续了，这样也省去了跨slot、跨TaskManager的通信损耗（降低了并行度）</li><li>  同时slot能够保存整个管道，使得整个任务执行健壮性更高，因为某些slot执行出异常也能有其他slot补上。</li><li>  有些slot分配到的子任务非CPU密集型，有些则CPU密集型，如果每个slot只完成自己的子任务，将出现某些slot太闲，某些slot过忙的现象。</li></ul></li><li><p>  <em>假设拆分的多个Source子任务放到同一个Slot，那么任务不能并行执行了=&gt;因为多个相同步骤的子任务需要抢占的具体资源相同，比如抢占某个锁，这样就不能并行。</em></p></li></ul></li><li><p>Task Slot是静态的概念，是指TaskManager具有的并发执行能力，可以通过参数<code>taskmanager.numberOfTaskSlots</code>进行配置。</p><p><em>而并行度<strong>parallelism</strong>是动态概念，即<strong>TaskManager</strong>运行程序时实际使用的并发能力，可以通过参数<code>parallelism.default</code>进行配置。</em></p></li></ul><p> 每个task slot表示TaskManager拥有资源的一个固定大小的子集。假如一个TaskManager有三个slot，那么它会将其管理的内存分成三份给各个slot。资源slot化意味着一个subtask将不需要跟来自其他job的subtask竞争被管理的内存，取而代之的是它将拥有一定数量的内存储备。</p><p> <strong>需要注意的是，这里不会涉及到CPU的隔离，slot目前仅仅用来隔离task的受管理的内存</strong>。</p><p> 通过调整task slot的数量，允许用户定义subtask之间如何互相隔离。如果一个TaskManager一个slot，那将意味着每个task group运行在独立的JVM中（该JVM可能是通过一个特定的容器启动的），而一个TaskManager多个slot意味着更多的subtask可以共享同一个JVM。而在同一个JVM进程中的task将共享TCP连接（基于多路复用）和心跳消息。它们也可能共享数据集和数据结构，因此这减少了每个task的负载。</p><h3 id="4-3-2-Slot和并行度"><a href="#4-3-2-Slot和并行度" class="headerlink" title="4.3.2 Slot和并行度"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_432-slot%E5%92%8C%E5%B9%B6%E8%A1%8C%E5%BA%A6">4.3.2 Slot和并行度</a></h3><ol><li> <strong>一个特定算子的 子任务（subtask）的个数被称之为其并行度（parallelism）</strong>，我们可以对单独的每个算子进行设置并行度，也可以直接用env设置全局的并行度，更可以在页面中去指定并行度。</li><li> 最后，由于并行度是实际Task Manager处理task 的能力，而一般情况下，<strong>一个 stream 的并行度，可以认为就是其所有算子中最大的并行度</strong>，则可以得出<strong>在设置Slot时，在所有设置中的最大设置的并行度大小则就是所需要设置的Slot的数量。</strong> （如果Slot分组，则需要为每组Slot并行度最大值的和）</li></ol><p><img src="https://img-blog.csdnimg.cn/20200524215554488.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/2020052421520496.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/20200524215251380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p> 假设一共有3个TaskManager，每一个TaskManager中的分配3个TaskSlot，也就是每个TaskManager可以接收3个task，一共9个TaskSlot，如果我们设置<code>parallelism.default=1</code>，即运行程序默认的并行度为1，9个TaskSlot只用了1个，有8个空闲，因此，设置合适的并行度才能提高效率。</p><p> <em>ps：上图最后一个因为是输出到文件，避免多个Slot（多线程）里的算子都输出到同一个文件互相覆盖等混乱问题，直接设置sink的并行度为1。</em></p><h3 id="4-3-3-程序和数据流（DataFlow）"><a href="#4-3-3-程序和数据流（DataFlow）" class="headerlink" title="4.3.3 程序和数据流（DataFlow）"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_433-%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%95%B0%E6%8D%AE%E6%B5%81%EF%BC%88dataflow%EF%BC%89">4.3.3 程序和数据流（DataFlow）</a></h3><p><img src="https://img-blog.csdnimg.cn/20200524215944234.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>  <strong>所有的Flink程序都是由三部分组成的： Source 、Transformation 和 Sink。</strong> </p></li><li><p>  Source 负责读取数据源，Transformation 利用各种算子进行处理加工，Sink 负责输出</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200524220037630.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>  在运行时，Flink上运行的程序会被映射成“逻辑数据流”（dataflows），它包含了这三部分</p></li><li><p>  每一个dataflow以一个或多个sources开始以一个或多个sinks结束。dataflow类似于任意的有向无环图（DAG）</p></li><li><p>  在大部分情况下，程序中的转换运算（transformations）跟dataflow中的算子（operator）是一一对应的关系</p></li></ul><h3 id="4-3-4-执行图（ExecutionGraph）"><a href="#4-3-4-执行图（ExecutionGraph）" class="headerlink" title="4.3.4 执行图（ExecutionGraph）"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_434-%E6%89%A7%E8%A1%8C%E5%9B%BE%EF%BC%88executiongraph%EF%BC%89">4.3.4 执行图（<strong>ExecutionGraph</strong>）</a></h3><p> 由Flink程序直接映射成的数据流图是StreamGraph，也被称为<strong>逻辑流图</strong>，因为它们表示的是计算逻辑的高级视图。为了执行一个流处理程序，Flink需要将<strong>逻辑流图</strong>转换为<strong>物理数据流图</strong>（也叫<strong>执行图</strong>），详细说明程序的执行方式。</p><ul><li><p>Flink 中的执行图可以分成四层：StreamGraph -&gt; JobGraph -&gt; ExecutionGraph -&gt; 物理执行图。</p><ul><li><p>  <strong>StreamGraph</strong>：是根据用户通过Stream API 编写的代码生成的最初的图。用来表示程序的拓扑结构。</p></li><li><p>  <strong>JobGraph</strong>：StreamGraph经过优化后生成了JobGraph，提交给JobManager 的数据结构。主要的优化为，将多个符合条件的节点chain 在一起作为一个节点，这样可以减少数据在节点之间流动所需要的序列化/反序列化/传输消耗。</p></li><li><p>  <strong>ExecutionGraph</strong>：JobManager 根据JobGraph 生成ExecutionGraph。ExecutionGraph是JobGraph的并行化版本，是调度层最核心的数据结构。</p></li><li><p>  物理执行图：JobManager 根据ExecutionGraph 对Job 进行调度后，在各个TaskManager 上部署Task 后形成的“图”，并不是一个具体的数据结构。</p></li></ul></li></ul><p><img src="https://img-blog.csdnimg.cn/20200524220232635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h3 id="4-3-5-数据传输形式"><a href="#4-3-5-数据传输形式" class="headerlink" title="4.3.5 数据传输形式"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_435-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%BD%A2%E5%BC%8F">4.3.5 数据传输形式</a></h3><ul><li><p>  一个程序中，不同的算子可能具有不同的并行度</p></li><li><p>算子之间传输数据的形式可以是 one-to-one (forwarding) 的模式也可以是redistributing 的模式，具体是哪一种形式，取决于算子的种类</p><ul><li><p>  <strong>One-to-one</strong>：stream维护着分区以及元素的顺序（比如source和map之间）。这意味着map 算子的子任务看到的元素的个数以及顺序跟 source 算子的子任务生产的元素的个数、顺序相同。<strong>map、fliter、flatMap等算子都是one-to-one的对应关系</strong>。</p></li><li><p>  <strong>Redistributing</strong>：stream的分区会发生改变。每一个算子的子任务依据所选择的transformation发送数据到不同的目标任务。例如，keyBy 基于 hashCode 重分区、而 broadcast 和 rebalance 会随机重新分区，这些算子都会引起redistribute过程，而 redistribute 过程就类似于 Spark 中的 shuffle 过程。</p></li></ul></li></ul><h3 id="4-3-6-任务链（OperatorChains）"><a href="#4-3-6-任务链（OperatorChains）" class="headerlink" title="4.3.6 任务链（OperatorChains）"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_436-%E4%BB%BB%E5%8A%A1%E9%93%BE%EF%BC%88operatorchains%EF%BC%89">4.3.6 任务链（OperatorChains）</a></h3><p> Flink 采用了一种称为任务链的优化技术，可以在特定条件下减少本地通信的开销。为了满足任务链的要求，必须将两个或多个算子设为<strong>相同的并行度</strong>，并通过本地转发（local forward）的方式进行连接</p><ul><li><p><strong>相同并行度</strong>的 <strong>one-to-one 操作</strong>，Flink 这样相连的算子链接在一起形成一个 task，原来的算子成为里面的 subtask</p><ul><li>  并行度相同、并且是 one-to-one 操作，两个条件缺一不可</li></ul></li><li><p><em>为什么需要并行度相同，因为若flatMap并行度为1，到了之后的map并行度为2，从flatMap到map的数据涉及到数据由于并行度map为2会往两个slot处理，数据会分散，所产生的元素个数和顺序发生的改变所以有2个单独的task，不能成为任务链</em>*</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200524220815415.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p> <strong>如果前后任务逻辑上可以是OneToOne，且并行度一致，那么就能合并在一个Slot里</strong>（并行度原本是多少就是多少，两者并行度一致）执行。</p><ul><li>  keyBy需要根据Hash值分配给不同slot执行，所以只能Hash，不能OneToOne。</li><li>  逻辑上可OneToOne但是并行度不同，那么就会Rebalance，轮询形式分配给下一个任务的多个slot。</li></ul><hr><ul><li><p>  <strong>代码中如果<code>算子.disableChaining()</code>，能够强制当前算子的子任务不参与任务链的合并，即不和其他Slot资源合并，但是仍然可以保留“Slot共享”的特性</strong>。</p></li><li><p>  <strong>如果<code>StreamExecutionEnvironment env.disableOperatorChaining()</code>则当前执行环境全局设置算子不参与”任务链的合并”。</strong> </p></li><li><p>  <strong>如果<code>算子.startNewChain()</code>表示不管前面任务链合并与否，从当前算子往后重新计算任务链的合并。通常用于前面强制不要任务链合并，而当前往后又需要任务链合并的特殊场景。</strong> </p></li></ul><p><em>ps：如果<code>算子.shuffle()</code>，能够强制算子之后重分区到不同slot执行下一个算子操作，逻辑上也实现了任务不参与任务链合并=&gt;但是仅为“不参与任务链的合并”，这个明显不是最优解操作</em></p><blockquote><p><a href="https://blog.csdn.net/qq_31866793/article/details/102786249">Flink slotSharingGroup disableChain startNewChain 用法案例</a></p></blockquote><h2 id="5-1-Environment"><a href="#5-1-Environment" class="headerlink" title="5.1 Environment"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_51-environment">5.1 Environment</a></h2><p><img src="https://img-blog.csdnimg.cn/20191124113558631.png"></p><h3 id="5-1-1-getExecutionEnvironment"><a href="#5-1-1-getExecutionEnvironment" class="headerlink" title="5.1.1 getExecutionEnvironment"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_511-getexecutionenvironment">5.1.1 getExecutionEnvironment</a></h3><p> 创建一个执行环境，表示当前执行程序的上下文。如果程序是独立调用的，则此方法返回本地执行环境；如果从命令行客户端调用程序以提交到集群，则此方法返回此集群的执行环境，也就是说，getExecutionEnvironment会根据查询运行的方式决定返回什么样的运行环境，是最常用的一种创建执行环境的方式。</p><p><code>ExecutionEnvironment env = ExecutionEnvironment.*getExecutionEnvironment*();</code></p><p><code>StreamExecutionEnvironment env = StreamExecutionEnvironment.*getExecutionEnvironment*();</code></p><p>如果没有设置并行度，会以flink-conf.yaml中的配置为准，默认是1。</p><p><img src="https://img-blog.csdnimg.cn/20191124113636435.png"></p><h3 id="5-1-2-createLocalEnvironment"><a href="#5-1-2-createLocalEnvironment" class="headerlink" title="5.1.2 createLocalEnvironment"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_512-createlocalenvironment">5.1.2 createLocalEnvironment</a></h3><p> 返回本地执行环境，需要在调用时指定默认的并行度。</p><p><code>LocalStreamEnvironment env = StreamExecutionEnvironment.*createLocalEnvironment*(1);</code></p><h3 id="5-1-3-createRemoteEnvironment"><a href="#5-1-3-createRemoteEnvironment" class="headerlink" title="5.1.3 createRemoteEnvironment"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_513-createremoteenvironment">5.1.3 createRemoteEnvironment</a></h3><p> 返回集群执行环境，将Jar提交到远程服务器。需要在调用时指定JobManager的IP和端口号，并指定要在集群中运行的Jar包。</p><p><code>StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironment(1);</code></p><h2 id="5-2-Source"><a href="#5-2-Source" class="headerlink" title="5.2 Source"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_52-source">5.2 Source</a></h2><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106335725">Flink-Environment的三种方式和Source的四种读取方式-从集合中、从kafka中、从文件中、自定义</a></p></blockquote><h3 id="5-2-1-从集合读取数据"><a href="#5-2-1-从集合读取数据" class="headerlink" title="5.2.1 从集合读取数据"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_521-%E4%BB%8E%E9%9B%86%E5%90%88%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE">5.2.1 从集合读取数据</a></h3><p>java代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>source</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/31 5:13 PM * 测试Flink从集合中获取数据 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SourceTest1_Collection</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 设置env并行度1，使得整个任务抢占同一个线程执行</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Source: 从集合Collection中获取数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>                <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                        <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span><span class="token string">"sensor_1"</span><span class="token punctuation">,</span> <span class="token number">1547718199L</span><span class="token punctuation">,</span> <span class="token number">35.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span><span class="token string">"sensor_6"</span><span class="token punctuation">,</span> <span class="token number">1547718201L</span><span class="token punctuation">,</span> <span class="token number">15.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span><span class="token string">"sensor_7"</span><span class="token punctuation">,</span> <span class="token number">1547718202L</span><span class="token punctuation">,</span> <span class="token number">6.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span><span class="token string">"sensor_10"</span><span class="token punctuation">,</span> <span class="token number">1547718205L</span><span class="token punctuation">,</span> <span class="token number">38.1</span><span class="token punctuation">)</span>                <span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> intStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 打印输出</span>        dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"SENSOR"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        intStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"INT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"JobName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">INT<span class="token operator">&gt;</span> <span class="token number">1</span>INT<span class="token operator">&gt;</span> <span class="token number">2</span>SENSOR<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>INT<span class="token operator">&gt;</span> <span class="token number">3</span>SENSOR<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span>INT<span class="token operator">&gt;</span> <span class="token number">4</span>SENSOR<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718202</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">6.7</span><span class="token punctuation">}</span>INT<span class="token operator">&gt;</span> <span class="token number">5</span>SENSOR<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718205</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">38.1</span><span class="token punctuation">}</span>INT<span class="token operator">&gt;</span> <span class="token number">6</span>INT<span class="token operator">&gt;</span> <span class="token number">7</span>INT<span class="token operator">&gt;</span> <span class="token number">8</span>INT<span class="token operator">&gt;</span> <span class="token number">9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-2-2-从文件读取数据"><a href="#5-2-2-从文件读取数据" class="headerlink" title="5.2.2 从文件读取数据"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_522-%E4%BB%8E%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE">5.2.2 从文件读取数据</a></h3><p>java代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>source</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/31 5:26 PM * Flink从文件中获取数据 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SourceTest2_File</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 使得任务抢占同一个线程</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从文件中获取数据输出</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>sensor.txt文件内容</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-2-3-从Kafka读取数据"><a href="#5-2-3-从Kafka读取数据" class="headerlink" title="5.2.3 从Kafka读取数据"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_523-%E4%BB%8Ekafka%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE">5.2.3 从Kafka读取数据</a></h3><ol><li><p>pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span>         xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>modelVersion<span class="token punctuation">&gt;</span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>example<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span><span class="token class-name">Flink_Tutorial</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">&gt;</span></span>        <span class="token generics"><span class="token punctuation">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token punctuation">&gt;</span></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token punctuation">&gt;</span></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.12</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>flink<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.12</span><span class="token operator">&lt;</span><span class="token operator">/</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>streaming<span class="token operator">-</span>scala_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>clients_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>                <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>kafka_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动zookeeper</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/zookeeper-server-start.sh config/zookeeper.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>启动kafka服务</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-server-start.sh config/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>启动kafka生产者</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-console-producer.sh --broker-list localhost:9092  --topic sensor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>编写java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>source</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">SimpleStringSchema</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaConsumer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/31 5:44 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SourceTest3_Kafka</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 设置并行度1</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 下面这些次要参数</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"consumer-group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"auto.offset.reset"</span><span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// flink添加外部数据源</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 打印输出</span>        dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>运行java代码，在Kafka生产者console中输入</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-console-producer.sh --broker-list localhost:9092  --topic sensor<span class="token operator">&gt;</span>sensor_1,1547718199,35.8<span class="token operator">&gt;</span>sensor_6,1547718201,15.4<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>java输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><h3 id="5-2-4-自定义Source"><a href="#5-2-4-自定义Source" class="headerlink" title="5.2.4 自定义Source"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_524-%E8%87%AA%E5%AE%9A%E4%B9%89source">5.2.4 自定义Source</a></h3><p>java代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>source</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">SourceFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/31 6:44 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SourceTest4_UDF</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MySensorSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 实现自定义的SourceFunction</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MySensorSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>        <span class="token comment">// 标示位，控制数据产生</span>        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            <span class="token comment">//定义一个随机数发生器</span>            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 设置10个传感器的初始温度</span>            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> sensorTempMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                sensorTempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sensor_"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">+</span> random<span class="token punctuation">.</span><span class="token function">nextGaussian</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> sensorId <span class="token operator">:</span> sensorTempMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment">// 在当前温度基础上随机波动</span>                    <span class="token class-name">Double</span> newTemp <span class="token operator">=</span> sensorTempMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sensorId<span class="token punctuation">)</span> <span class="token operator">+</span> random<span class="token punctuation">.</span><span class="token function">nextGaussian</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    sensorTempMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sensorId<span class="token punctuation">,</span> newTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>                    ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>sensorId<span class="token punctuation">,</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>newTemp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment">// 控制输出评率</span>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">7</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_9'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">83.80320976056609</span><span class="token punctuation">}</span><span class="token number">15</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">68.77967856820972</span><span class="token punctuation">}</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">45.75304941852771</span><span class="token punctuation">}</span><span class="token number">6</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">71.80036477804133</span><span class="token punctuation">}</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">55.262086521569564</span><span class="token punctuation">}</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_2'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">64.0969570576537</span><span class="token punctuation">}</span><span class="token number">5</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_5'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">51.09761352612651</span><span class="token punctuation">}</span><span class="token number">14</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_3'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759313</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">32.49085393551031</span><span class="token punctuation">}</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_8'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">64.83732456896752</span><span class="token punctuation">}</span><span class="token number">16</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_4'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091759321</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">88.88318538017865</span><span class="token punctuation">}</span><span class="token number">12</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_2'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091761325</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">65.21522804626638</span><span class="token punctuation">}</span><span class="token number">16</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091761325</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">70.49210870668041</span><span class="token punctuation">}</span><span class="token number">15</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_5'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1612091761325</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">50.32349231082738</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-3-Transform"><a href="#5-3-Transform" class="headerlink" title="5.3 Transform"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_53-transform">5.3 Transform</a></h2><p>map、flatMap、filter通常被统一称为<strong>基本转换算子</strong>（<strong>简单转换算子</strong>）。</p><h3 id="5-3-1-基本转换算子-map-flatMap-filter"><a href="#5-3-1-基本转换算子-map-flatMap-filter" class="headerlink" title="5.3.1 基本转换算子(map/flatMap/filter)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_531-%E5%9F%BA%E6%9C%AC%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90mapflatmapfilter">5.3.1 基本转换算子(map/flatMap/filter)</a></h3><blockquote><p><a href="https://zhuanlan.zhihu.com/p/66196174">到处是map、flatMap，啥意思？</a></p></blockquote><p>java代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>transform</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">FilterFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">FlatMapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/31 7:31 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformTest1_Base</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 使得任务抢占同一个线程</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从文件中获取数据输出</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1. map, String =&gt; 字符串长度INT</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> mapStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2. flatMap，按逗号分割字符串</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flatMapStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> field<span class="token operator">:</span>fields<span class="token punctuation">)</span><span class="token punctuation">{</span>                    out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 3. filter,筛选"sensor_1"开头的数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> filterStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"sensor_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 打印输出</span>        mapStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        flatMapStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"flatMap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        filterStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"filter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">map<span class="token operator">&gt;</span> <span class="token number">24</span>flatMap<span class="token operator">&gt;</span> sensor_1flatMap<span class="token operator">&gt;</span> <span class="token number">1547718199</span>flatMap<span class="token operator">&gt;</span> <span class="token number">35.8</span>filter<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>map<span class="token operator">&gt;</span> <span class="token number">24</span>flatMap<span class="token operator">&gt;</span> sensor_6flatMap<span class="token operator">&gt;</span> <span class="token number">1547718201</span>flatMap<span class="token operator">&gt;</span> <span class="token number">15.4</span>map<span class="token operator">&gt;</span> <span class="token number">23</span>flatMap<span class="token operator">&gt;</span> sensor_7flatMap<span class="token operator">&gt;</span> <span class="token number">1547718202</span>flatMap<span class="token operator">&gt;</span> <span class="token number">6.7</span>map<span class="token operator">&gt;</span> <span class="token number">25</span>flatMap<span class="token operator">&gt;</span> sensor_10flatMap<span class="token operator">&gt;</span> <span class="token number">1547718205</span>flatMap<span class="token operator">&gt;</span> <span class="token number">38.1</span>filter<span class="token operator">&gt;</span> sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>map<span class="token operator">&gt;</span> <span class="token number">24</span>flatMap<span class="token operator">&gt;</span> sensor_1flatMap<span class="token operator">&gt;</span> <span class="token number">1547718207</span>flatMap<span class="token operator">&gt;</span> <span class="token number">36.3</span>filter<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>map<span class="token operator">&gt;</span> <span class="token number">24</span>flatMap<span class="token operator">&gt;</span> sensor_1flatMap<span class="token operator">&gt;</span> <span class="token number">1547718209</span>flatMap<span class="token operator">&gt;</span> <span class="token number">32.8</span>filter<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>map<span class="token operator">&gt;</span> <span class="token number">24</span>flatMap<span class="token operator">&gt;</span> sensor_1flatMap<span class="token operator">&gt;</span> <span class="token number">1547718212</span>flatMap<span class="token operator">&gt;</span> <span class="token number">37.1</span>filter<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-3-2-聚合操作算子"><a href="#5-3-2-聚合操作算子" class="headerlink" title="5.3.2 聚合操作算子"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_532-%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C%E7%AE%97%E5%AD%90">5.3.2 聚合操作算子</a></h3><blockquote><p><a href="https://blog.csdn.net/dongkang123456/article/details/108361376">Flink_Trasform算子</a></p></blockquote><ul><li>  DataStream里没有reduce和sum这类聚合操作的方法，因为<strong>Flink设计中，所有数据必须先分组才能做聚合操作</strong>。</li><li>  <strong>先keyBy得到KeyedStream，然后调用其reduce、sum等聚合操作方法。（先分组后聚合）</strong></li></ul><hr><p>常见的聚合操作算子主要有：</p><ul><li><p>  keyBy</p></li><li><p>  滚动聚合算子Rolling Aggregation</p></li><li><p>  reduce</p></li></ul><hr><h4 id="keyBy"><a href="#keyBy" class="headerlink" title="keyBy"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=keyby">keyBy</a></h4><p><img src="https://img-blog.csdnimg.cn/20200902141943335.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><p><strong>DataStream -&gt; KeyedStream</strong>：逻辑地将一个流拆分成不相交的分区，每个分区包含具有相同key的元素，在内部以hash的形式实现的。</p><p>1、KeyBy会重新分区； 2、不同的key有可能分到一起，因为是通过hash原理实现的；</p><h4 id="Rolling-Aggregation"><a href="#Rolling-Aggregation" class="headerlink" title="Rolling Aggregation"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=rolling-aggregation">Rolling Aggregation</a></h4><p>这些算子可以针对KeyedStream的每一个支流做聚合。</p><ul><li>  sum()</li><li>  min()</li><li>  max()</li><li>  minBy()</li><li>  maxBy()</li></ul><hr><p>测试maxBy的java代码一</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>transform</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">KeyedStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/31 9:51 PM * 滚动聚合，测试 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformTest2_RollingAggregation</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建 执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行环境并行度设置1</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        DataStream&lt;SensorReading&gt; sensorStream = dataStream.map(new MapFunction&lt;String, SensorReading&gt;() {</span><span class="token comment">//            @Override</span><span class="token comment">//            public SensorReading map(String value) throws Exception {</span><span class="token comment">//                String[] fields = value.split(",");</span><span class="token comment">//                return new SensorReading(fields[0],new Long(fields[1]),new Double(fields[2]));</span><span class="token comment">//            }</span><span class="token comment">//        });</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> sensorStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 先分组再聚合</span>        <span class="token comment">// 分组</span>        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyedStream <span class="token operator">=</span> sensorStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 滚动聚合，max和maxBy区别在于，maxBy除了用于max比较的字段以外，其他字段也会更新成最新的，而max只有比较的字段更新，其他字段不变</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> keyedStream<span class="token punctuation">.</span><span class="token function">maxBy</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中<code>sensor.txt</code>文件内容如下</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出如下：</p><p><em>由于是滚动更新，每次输出历史最大值，所以下面36.3才会出现两次</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718202</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">6.7</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718205</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">38.1</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718207</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">36.3</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718207</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">36.3</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718212</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">37.1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=reduce">reduce</a></h4><p> <strong>Reduce适用于更加一般化的聚合操作场景</strong>。java中需要实现<code>ReduceFunction</code>函数式接口。</p><hr><p> 在前面Rolling Aggregation的前提下，对需求进行修改。获取同组历史温度最高的传感器信息，同时要求实时更新其时间戳信息。</p><p>java代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>transform</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">KeyedStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>stats<span class="token punctuation">.</span></span><span class="token class-name">Max</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/1/31 10:14 PM * 复杂场景，除了获取最大温度的整个传感器信息以外，还要求时间戳更新成最新的 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformTest3_Reduce</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建 执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行环境并行度设置1</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> sensorStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 先分组再聚合</span>        <span class="token comment">// 分组</span>        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyedStream <span class="token operator">=</span> sensorStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// reduce，自定义规约函数，获取max温度的传感器信息以外，时间戳要求更新成最新的</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> keyedStream<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>                <span class="token punctuation">(</span>curSensor<span class="token punctuation">,</span>newSensor<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>curSensor<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>newSensor<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>curSensor<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newSensor<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>sensor.txt</code>文件内容如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出如下：</p><p><em>和前面“Rolling Aggregation”小节不同的是，倒数第二条数据的时间戳用了当前比较时最新的时间戳。</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718202</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">6.7</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718205</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">38.1</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718207</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">36.3</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718209</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">36.3</span><span class="token punctuation">}</span>result<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718212</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">37.1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-3-3-多流转换算子"><a href="#5-3-3-多流转换算子" class="headerlink" title="5.3.3 多流转换算子"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_533-%E5%A4%9A%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">5.3.3 多流转换算子</a></h3><blockquote><p><a href="https://blog.csdn.net/dongkang123456/article/details/108361376">Flink_Trasform算子</a></p></blockquote><p>多流转换算子一般包括：</p><ul><li><p>  Split和Select （新版已经移除）</p></li><li><p>  Connect和CoMap</p></li><li><p>  Union</p></li></ul><h4 id="Split和Select"><a href="#Split和Select" class="headerlink" title="Split和Select"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=split%E5%92%8Cselect">Split和Select</a></h4><p><strong>注：新版Flink已经不存在Split和Select这两个API了（至少Flink1.12.1没有！）</strong></p><h5 id="Split"><a href="#Split" class="headerlink" title="Split"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=split">Split</a></h5><p><img src="https://img-blog.csdnimg.cn/20200902194203248.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"><br> <strong>DataStream -&gt; SplitStream</strong>：根据某些特征把DataStream拆分成SplitStream;</p><p><strong>SplitStream虽然看起来像是两个Stream，但是其实它是一个特殊的Stream</strong>;</p><h5 id="Select"><a href="#Select" class="headerlink" title="Select"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=select">Select</a></h5><p><img src="https://img-blog.csdnimg.cn/20200902194442828.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"><br> <strong>SplitStream -&gt; DataStream</strong>：从一个SplitStream中获取一个或者多个DataStream;</p><p><strong>我们可以结合split&amp;select将一个DataStream拆分成多个DataStream。</strong> </p><hr><p>测试场景：根据传感器温度高低，划分成两组，high和low（&gt;30归入high）：</p><p><em>这个我发现在Flink当前时间最新版1.12.1已经不是DataStream的方法了，被去除了</em></p><p>这里直接附上教程代码（Flink1.10.1）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>apitest<span class="token punctuation">.</span>transform</span><span class="token punctuation">;</span><span class="token comment">/** * Copyright (c) 2018-2028 尚硅谷 All Rights Reserved * &lt;p&gt; * Project: FlinkTutorial * Package: com.atguigu.apitest.transform * Version: 1.0 * &lt;p&gt; * Created by wushengran on 2020/11/7 16:14 */</span><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple3</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>collector<span class="token punctuation">.</span>selector<span class="token punctuation">.</span></span><span class="token class-name">OutputSelector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">ConnectedStreams</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SplitStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span></span><span class="token class-name">CoMapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span><span class="token comment">/** * @ClassName: TransformTest4_MultipleStreams * @Description: * @Author: wushengran on 2020/11/7 16:14 * @Version: 1.0 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformTest4_MultipleStreams</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从文件读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"D:\\Projects\\BigData\\FlinkTutorial\\src\\main\\resources\\sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 分流，按照温度值30度为界分为两条流</span>    <span class="token class-name">SplitStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> splitStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputSelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"high"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"low"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> highTempStream <span class="token operator">=</span> splitStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"high"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> lowTempStream <span class="token operator">=</span> splitStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"low"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> allTempStream <span class="token operator">=</span> splitStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"high"</span><span class="token punctuation">,</span> <span class="token string">"low"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    highTempStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"high"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    lowTempStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"low"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    allTempStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出结果如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">high<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>all <span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>low <span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span>all <span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Connect和CoMap"><a href="#Connect和CoMap" class="headerlink" title="Connect和CoMap"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=connect%E5%92%8Ccomap">Connect和CoMap</a></h4><h5 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=connect">Connect</a></h5><p><img src="https://img-blog.csdnimg.cn/20200902202832986.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"><br> <strong>DataStream,DataStream -&gt; ConnectedStreams</strong>: 连接两个保持他们类型的数据流，两个数据流被Connect 之后，只是被放在了一个流中，内部依然保持各自的数据和形式不发生任何变化，两个流相互独立。</p><h5 id="CoMap"><a href="#CoMap" class="headerlink" title="CoMap"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=comap">CoMap</a></h5><p><img src="https://img-blog.csdnimg.cn/20200902203333640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"><br> <strong>ConnectedStreams -&gt; DataStream</strong>: 作用于ConnectedStreams 上，功能与map和flatMap一样，对ConnectedStreams 中的<strong>每一个Stream分别进行map和flatMap操作</strong>；</p><hr><p>虽然Flink1.12.1的DataStream有connect和map方法，但是教程基于前面的split和select编写，所以这里直接附上教程的代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>apitest<span class="token punctuation">.</span>transform</span><span class="token punctuation">;</span><span class="token comment">/** * Copyright (c) 2018-2028 尚硅谷 All Rights Reserved * &lt;p&gt; * Project: FlinkTutorial * Package: com.atguigu.apitest.transform * Version: 1.0 * &lt;p&gt; * Created by wushengran on 2020/11/7 16:14 */</span><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple3</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>collector<span class="token punctuation">.</span>selector<span class="token punctuation">.</span></span><span class="token class-name">OutputSelector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">ConnectedStreams</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SplitStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span></span><span class="token class-name">CoMapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span><span class="token comment">/** * @ClassName: TransformTest4_MultipleStreams * @Description: * @Author: wushengran on 2020/11/7 16:14 * @Version: 1.0 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformTest4_MultipleStreams</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从文件读取数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"D:\\Projects\\BigData\\FlinkTutorial\\src\\main\\resources\\sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 转换成SensorReading</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1. 分流，按照温度值30度为界分为两条流</span>        <span class="token class-name">SplitStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> splitStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputSelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"high"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"low"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> highTempStream <span class="token operator">=</span> splitStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"high"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> lowTempStream <span class="token operator">=</span> splitStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"low"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> allTempStream <span class="token operator">=</span> splitStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"high"</span><span class="token punctuation">,</span> <span class="token string">"low"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// highTempStream.print("high");</span>        <span class="token comment">// lowTempStream.print("low");</span>        <span class="token comment">// allTempStream.print("all");</span>        <span class="token comment">// 2. 合流 connect，将高温流转换成二元组类型，与低温流连接合并之后，输出状态信息</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> warningStream <span class="token operator">=</span> highTempStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ConnectedStreams</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> connectedStreams <span class="token operator">=</span> warningStream<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>lowTempStream<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> connectedStreams<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CoMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">map1</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> value<span class="token punctuation">.</span>f1<span class="token punctuation">,</span> <span class="token string">"high temp warning"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">map2</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"normal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">,</span>high temp warning<span class="token punctuation">)</span><span class="token punctuation">(</span>sensor_6<span class="token punctuation">,</span>normal<span class="token punctuation">)</span><span class="token punctuation">(</span>sensor_10<span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">,</span>high temp warning<span class="token punctuation">)</span><span class="token punctuation">(</span>sensor_7<span class="token punctuation">,</span>normal<span class="token punctuation">)</span><span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">36.3</span><span class="token punctuation">,</span>high temp warning<span class="token punctuation">)</span><span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">32.8</span><span class="token punctuation">,</span>high temp warning<span class="token punctuation">)</span><span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">37.1</span><span class="token punctuation">,</span>high temp warning<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Union"><a href="#Union" class="headerlink" title="Union"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=union">Union</a></h4><p><img src="https://img-blog.csdnimg.cn/20200902205220165.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><p><strong>DataStream -&gt; DataStream</strong>：对<strong>两个或者两个以上</strong>的DataStream进行Union操作，产生一个包含多有DataStream元素的新DataStream。</p><p><strong>问题：和Connect的区别？</strong></p><ol><li> Connect 的数据类型可以不同，<strong>Connect 只能合并两个流</strong>；</li><li> <strong>Union可以合并多条流，Union的数据结构必须是一样的</strong>；</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 3. union联合多条流</span><span class="token comment">//        warningStream.union(lowTempStream); 这个不行，因为warningStream类型是DataStream&lt;Tuple2&lt;String, Double&gt;&gt;，而highTempStream是DataStream&lt;SensorReading&gt;</span>        highTempStream<span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>lowTempStream<span class="token punctuation">,</span> allTempStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="5-3-4-算子转换"><a href="#5-3-4-算子转换" class="headerlink" title="5.3.4 算子转换"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_534-%E7%AE%97%E5%AD%90%E8%BD%AC%E6%8D%A2">5.3.4 算子转换</a></h3><blockquote><p><a href="https://blog.csdn.net/a_drjiaoda/article/details/89357916">Flink常用算子Transformation（转换）</a></p></blockquote><p> 在Storm中，我们常常用Bolt的层级关系来表示各个数据的流向关系，组成一个拓扑。</p><p> 在Flink中，<strong>Transformation算子就是将一个或多个DataStream转换为新的DataStream</strong>，可以将多个转换组合成复杂的数据流拓扑。 ​ 如下图所示，DataStream会由不同的Transformation操作，转换、过滤、聚合成其他不同的流，从而完成我们的业务要求。</p><p><img src="https://img-blog.csdnimg.cn/20190417171341810.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FfZHJqaWFvZGE=,size_16,color_FFFFFF,t_70"></p><h2 id="5-4-支持的数据类型"><a href="#5-4-支持的数据类型" class="headerlink" title="5.4 支持的数据类型"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_54-%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">5.4 支持的数据类型</a></h2><p> Flink流应用程序处理的是以数据对象表示的事件流。所以在Flink内部，我们需要能够处理这些对象。它们<strong>需要被序列化和反序列化</strong>，以便通过网络传送它们；或者从状态后端、检查点和保存点读取它们。为了有效地做到这一点，Flink需要明确知道应用程序所处理的数据类型。Flink使用类型信息的概念来表示数据类型，并为每个数据类型生成特定的序列化器、反序列化器和比较器。</p><p> Flink还具有一个类型提取系统，该系统分析函数的输入和返回类型，以自动获取类型信息，从而获得序列化器和反序列化器。但是，在某些情况下，例如lambda函数或泛型类型，需要显式地提供类型信息，才能使应用程序正常工作或提高其性能。</p><p> Flink支持Java和Scala中所有常见数据类型。使用最广泛的类型有以下几种。</p><h3 id="5-4-1-基础数据类型"><a href="#5-4-1-基础数据类型" class="headerlink" title="5.4.1 基础数据类型"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_541-%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">5.4.1 基础数据类型</a></h3><p> Flink支持所有的Java和Scala基础数据类型，Int, Double, Long, String, …</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> numberStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>numberStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="5-4-2-Java和Scala元组-Tuples"><a href="#5-4-2-Java和Scala元组-Tuples" class="headerlink" title="5.4.2 Java和Scala元组(Tuples)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_542-java%E5%92%8Cscala%E5%85%83%E7%BB%84tuples">5.4.2 Java和Scala元组(Tuples)</a></h3><p>java不像Scala天生支持元组Tuple类型，java的元组类型由Flink的包提供，默认提供Tuple0~Tuple25</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> personStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>   <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span><span class="token string">"Adam"</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span><span class="token string">"Sarah"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> personStream<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> p<span class="token punctuation">.</span>f1 <span class="token operator">&gt;</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-4-3-Scala样例类-case-classes"><a href="#5-4-3-Scala样例类-case-classes" class="headerlink" title="5.4.3 Scala样例类(case classes)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_543-scala%E6%A0%B7%E4%BE%8B%E7%B1%BBcase-classes">5.4.3 Scala样例类(case classes)</a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>name<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token class-name">Int</span><span class="token punctuation">)</span>val numbers<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>  <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"李四"</span>，<span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-4-4-Java简单对象-POJO"><a href="#5-4-4-Java简单对象-POJO" class="headerlink" title="5.4.4 Java简单对象(POJO)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_544-java%E7%AE%80%E5%8D%95%E5%AF%B9%E8%B1%A1pojo">5.4.4 Java简单对象(POJO)</a></h3><p>java的POJO这里要求必须提供无参构造函数</p><ul><li>  成员变量要求都是public（或者private但是提供get、set方法）</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span> <span class="token class-name">String</span> name <span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token class-name">DataStream</span> <span class="token class-name">Pe</span> rson <span class="token operator">&gt;</span> persons <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>  <span class="token keyword">new</span> <span class="token class-name">Person</span> <span class="token punctuation">(</span><span class="token string">" Alex"</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">new</span> <span class="token class-name">Person</span> <span class="token punctuation">(</span><span class="token string">" Wendy"</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-4-5-其他-Arrays-Lists-Maps-Enums-等等"><a href="#5-4-5-其他-Arrays-Lists-Maps-Enums-等等" class="headerlink" title="5.4.5 其他(Arrays, Lists, Maps, Enums,等等)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_545-%E5%85%B6%E4%BB%96arrays-lists-maps-enums%E7%AD%89%E7%AD%89">5.4.5 其他(Arrays, Lists, Maps, Enums,等等)</a></h3><p>Flink对Java和Scala中的一些特殊目的的类型也都是支持的，比如Java的ArrayList，HashMap，Enum等等。</p><h2 id="5-5-实现UDF函数——更细粒度的控制流"><a href="#5-5-实现UDF函数——更细粒度的控制流" class="headerlink" title="5.5 实现UDF函数——更细粒度的控制流"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_55-%E5%AE%9E%E7%8E%B0udf%E5%87%BD%E6%95%B0%E6%9B%B4%E7%BB%86%E7%B2%92%E5%BA%A6%E7%9A%84%E6%8E%A7%E5%88%B6%E6%B5%81">5.5 实现UDF函数——更细粒度的控制流</a></h2><h3 id="5-5-1-函数类-Function-Classes"><a href="#5-5-1-函数类-Function-Classes" class="headerlink" title="5.5.1 函数类(Function Classes)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_551-%E5%87%BD%E6%95%B0%E7%B1%BBfunction-classes">5.5.1 函数类(Function Classes)</a></h3><p> Flink暴露了所有UDF函数的接口(实现方式为接口或者抽象类)。例如MapFunction, FilterFunction, ProcessFunction等等。</p><p> 下面例子实现了FilterFunction接口：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flinkTweets <span class="token operator">=</span> tweets<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FlinkFilter</span> <span class="token keyword">implements</span> <span class="token class-name">FilterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>   <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"flink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 还可以将函数实现成匿名类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flinkTweets <span class="token operator">=</span> tweets<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>  <span class="token keyword">new</span> <span class="token class-name">FilterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"flink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 我们filter的字符串”flink”还可以当作参数传进去。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tweets <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"INPUT_FILE "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flinkTweets <span class="token operator">=</span> tweets<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeyWordFilter</span><span class="token punctuation">(</span><span class="token string">"flink"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">KeyWordFilter</span> <span class="token keyword">implements</span> <span class="token class-name">FilterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>   <span class="token keyword">private</span> <span class="token class-name">String</span> keyWord<span class="token punctuation">;</span>   <span class="token class-name">KeyWordFilter</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyWord<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>keyWord <span class="token operator">=</span> keyWord<span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>keyWord<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-5-2-匿名函数-Lambda-Functions"><a href="#5-5-2-匿名函数-Lambda-Functions" class="headerlink" title="5.5.2 匿名函数(Lambda Functions)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_552-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0lambda-functions">5.5.2 匿名函数(Lambda Functions)</a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tweets <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"INPUT_FILE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flinkTweets <span class="token operator">=</span> tweets<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span> tweet <span class="token operator">-&gt;</span> tweet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"flink"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="5-5-3-富函数-Rich-Functions"><a href="#5-5-3-富函数-Rich-Functions" class="headerlink" title="5.5.3 富函数(Rich Functions)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_553-%E5%AF%8C%E5%87%BD%E6%95%B0rich-functions">5.5.3 富函数(Rich Functions)</a></h3><p> “富函数”是DataStream API提供的一个函数类的接口，所有Flink函数类都有其Rich版本。</p><p> <strong>它与常规函数的不同在于，可以获取运行环境的上下文，并拥有一些生命周期方法，所以可以实现更复杂的功能</strong>。</p><ul><li><p>  RichMapFunction</p></li><li><p>  RichFlatMapFunction</p></li><li><p>  RichFilterFunction</p></li><li><p>  …</p></li></ul><p> Rich Function有一个<strong>生命周期</strong>的概念。典型的生命周期方法有：</p><ul><li><p>  <strong><code>open()</code>方法是rich function的初始化方法，当一个算子例如map或者filter被调用之前<code>open()</code>会被调用。</strong> </p></li><li><p>  <strong><code>close()</code>方法是生命周期中的最后一个调用的方法，做一些清理工作。</strong> </p></li><li><p>  <strong><code>getRuntimeContext()</code>方法提供了函数的RuntimeContext的一些信息，例如函数执行的并行度，任务的名字，以及state状态</strong></p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyMapFunction</span> <span class="token keyword">extends</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>   <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"my map open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 以下可以做一些初始化工作，例如建立一个和HDFS的连接 </span>  <span class="token punctuation">}</span>   <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"my map close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 以下做一些清理工作，例如断开和HDFS的连接 </span>  <span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>测试代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>transform</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">RichMapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 12:21 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformTest5_RichFunction</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 转换成SensorReading类型</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">MyMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 传统的Function不能获取上下文信息，只能处理当前数据，不能和其他数据交互</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyMapper0</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 实现自定义富函数类（RichMapFunction是一个抽象类）</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyMapper</span> <span class="token keyword">extends</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token comment">//            RichFunction可以获取State状态</span><span class="token comment">//            getRuntimeContext().getState();</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            <span class="token comment">// 初始化工作，一般是定义状态，或者建立数据库连接</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            <span class="token comment">// 一般是关闭连接和清空状态的收尾操作</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出如下：</p><p>由于设置了执行环境env的并行度为4，所以有4个slot执行自定义的RichFunction，输出4次open和close</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">open</span><span class="token keyword">open</span><span class="token keyword">open</span><span class="token keyword">open</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_6<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>close<span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>close<span class="token number">3</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>close<span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_7<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_10<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>close<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-6-数据重分区操作"><a href="#5-6-数据重分区操作" class="headerlink" title="5.6 数据重分区操作"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_56-%E6%95%B0%E6%8D%AE%E9%87%8D%E5%88%86%E5%8C%BA%E6%93%8D%E4%BD%9C">5.6 数据重分区操作</a></h2><p>重分区操作，在DataStream类中可以看到很多<code>Partitioner</code>字眼的类。</p><p><strong>其中<code>partitionCustom(...)</code>方法用于自定义重分区</strong>。</p><p>java代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>transform</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 12:38 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformTest6_Partition</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度 = 4</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从文件读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// SingleOutputStreamOperator多并行度默认就rebalance,轮询方式分配</span>    dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. shuffle (并非批处理中的获取一批后才打乱，这里每次获取到直接打乱且分区)</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> shuffleStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    shuffleStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"shuffle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. keyBy (Hash，然后取模)</span>    dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"keyBy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. global (直接发送给第一个分区，少数特殊情况才用)</span>    dataStream<span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">input<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>input<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span>input<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718207</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">36.3</span><span class="token punctuation">}</span>input<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718209</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">32.8</span><span class="token punctuation">}</span>shuffle<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>input<span class="token operator">:</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718202</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">6.7</span><span class="token punctuation">}</span>input<span class="token operator">:</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718205</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">38.1</span><span class="token punctuation">}</span>shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>shuffle<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>global<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>keyBy<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>global<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span>keyBy<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span>keyBy<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718207</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">36.3</span><span class="token punctuation">}</span>keyBy<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718209</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">32.8</span><span class="token punctuation">}</span>global<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718207</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">36.3</span><span class="token punctuation">}</span>shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>global<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718209</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">32.8</span><span class="token punctuation">}</span>shuffle<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>input<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718212</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">37.1</span><span class="token punctuation">}</span>global<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718202</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">6.7</span><span class="token punctuation">}</span>keyBy<span class="token operator">:</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718202</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">6.7</span><span class="token punctuation">}</span>keyBy<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718205</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">38.1</span><span class="token punctuation">}</span>global<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718205</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">38.1</span><span class="token punctuation">}</span>shuffle<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span>keyBy<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718212</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">37.1</span><span class="token punctuation">}</span>global<span class="token operator">:</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718212</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">37.1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-7-Sink"><a href="#5-7-Sink" class="headerlink" title="5.7 Sink"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_57-sink">5.7 Sink</a></h2><blockquote><p><a href="https://blog.csdn.net/lixinkuan328/article/details/104116894">Flink之流处理API之Sink</a></p></blockquote><p> Flink没有类似于spark中foreach方法，让用户进行迭代的操作。虽有对外的输出操作都要利用Sink完成。最后通过类似如下方式完成整个任务最终输出操作。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">stream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MySink</span><span class="token punctuation">(</span>xxxx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> 官方提供了一部分的框架的sink。除此以外，需要用户自定义实现sink。</p><p><img src="https://img-blog.csdnimg.cn/20200130221249884.png"></p><h3 id="5-7-1-Kafka"><a href="#5-7-1-Kafka" class="headerlink" title="5.7.1 Kafka"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_571-kafka">5.7.1 Kafka</a></h3><ol><li><p>pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span>         xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>modelVersion<span class="token punctuation">&gt;</span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>example<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span><span class="token class-name">Flink_Tutorial</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">&gt;</span></span>        <span class="token generics"><span class="token punctuation">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token punctuation">&gt;</span></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token punctuation">&gt;</span></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.12</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>flink<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.12</span><span class="token operator">&lt;</span><span class="token operator">/</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>streaming<span class="token operator">-</span>scala_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>clients_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>                <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>kafka_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>编写java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>sink</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">SimpleStringSchema</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaConsumer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaProducer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 1:11 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SinkTest1_Kafka</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>        <span class="token comment">// 创建执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 并行度设置为1</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"consumer-group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"auto.offset.reset"</span><span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从Kafka中读取数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 序列化从Kafka中读取的数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 将数据写入Kafka</span>        dataStream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"localhost:9092"</span><span class="token punctuation">,</span> <span class="token string">"sinktest"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动zookeeper</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/zookeeper-server-start.sh config/zookeeper.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>启动kafka服务</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-server-start.sh config/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>新建kafka生产者console</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-console-producer.sh --broker-list localhost:9092  --topic sensor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>新建kafka消费者console</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic sinktest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>运行Flink程序，在kafka生产者console输入数据，查看kafka消费者console的输出结果</p><p>输入(kafka生产者console)</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token operator">&gt;</span>sensor_1,1547718199,35.8<span class="token operator">&gt;</span>sensor_6,1547718201,15.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>输出(kafka消费者console)</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">SensorReading<span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token string">'sensor_1'</span>, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1547718199</span>, <span class="token assign-left variable">temperature</span><span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>SensorReading<span class="token punctuation">{</span>id<span class="token operator">=</span><span class="token string">'sensor_6'</span>, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1547718201</span>, <span class="token assign-left variable">temperature</span><span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><p>这里Flink的作用相当于pipeline了。</p><h3 id="5-7-2-Redis"><a href="#5-7-2-Redis" class="headerlink" title="5.7.2 Redis"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_572-redis">5.7.2 Redis</a></h3><blockquote><p><a href="https://mvnrepository.com/search?q=flink-connector-redis">flink-connector-redis</a></p><p>查询Flink连接器，最简单的就是查询关键字<code>flink-connector-</code></p></blockquote><p>这里将Redis当作sink的输出对象。</p><ol><li><p>pom依赖</p><p>这个可谓相当老的依赖了，2017年的。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bahir<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>redis_2<span class="token punctuation">.</span><span class="token number">11</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>编写java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>sink</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>redis<span class="token punctuation">.</span></span><span class="token class-name">RedisSink</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>common<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">FlinkJedisPoolConfig</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>common<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">RedisCommand</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>common<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">RedisCommandDescription</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>common<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">RedisMapper</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 1:47 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SinkTest2_Redis</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从文件读取数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 转换成SensorReading类型</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 定义jedis连接配置(我这里连接的是docker的redis)</span>        <span class="token class-name">FlinkJedisPoolConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlinkJedisPoolConfig<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setDatabase</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataStream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyRedisMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 自定义RedisMapper</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyRedisMapper</span> <span class="token keyword">implements</span> <span class="token class-name">RedisMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>        <span class="token comment">// 定义保存数据到redis的命令，存成Hash表，hset sensor_temp id temperature</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">RedisCommandDescription</span> <span class="token function">getCommandDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RedisCommandDescription</span><span class="token punctuation">(</span><span class="token class-name">RedisCommand</span><span class="token punctuation">.</span>HSET<span class="token punctuation">,</span> <span class="token string">"sensor_temp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getKeyFromData</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getValueFromData</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动redis服务（我这里是docker里的）</p></li><li><p>启动Flink程序</p></li><li><p>查看Redis里的数据</p><p><em>因为最新数据覆盖前面的，所以最后redis里呈现的是最新的数据。</em></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>hgetall sensor_temp<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"sensor_1"</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"37.1"</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"sensor_6"</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"15.4"</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"sensor_7"</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"6.7"</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">"sensor_10"</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">"38.1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="5-7-3-Elasticsearch"><a href="#5-7-3-Elasticsearch" class="headerlink" title="5.7.3 Elasticsearch"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_573-elasticsearch">5.7.3 Elasticsearch</a></h3><blockquote><p><a href="https://blog.csdn.net/weixin_42066446/article/details/113243977">Flink 1.12.1 ElasticSearch连接 Sink</a></p></blockquote><ol><li><p>pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>elasticsearch7_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.12</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>编写java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>sink</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">RuntimeContext</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span></span><span class="token class-name">ElasticsearchSinkFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span></span><span class="token class-name">RequestIndexer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>elasticsearch7<span class="token punctuation">.</span></span><span class="token class-name">ElasticsearchSink</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHost</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexRequest</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Requests</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 2:13 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SinkTest3_Es</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从文件读取数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 转换成SensorReading类型</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 定义es的连接配置</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpHost</span><span class="token punctuation">&gt;</span></span> httpHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        httpHosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataStream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchSink<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>httpHosts<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyEsSinkFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 实现自定义的ES写入操作</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyEsSinkFunction</span> <span class="token keyword">implements</span> <span class="token class-name">ElasticsearchSinkFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> element<span class="token punctuation">,</span> <span class="token class-name">RuntimeContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RequestIndexer</span> indexer<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 定义写入的数据source</span>            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            dataSource<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            dataSource<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"temp"</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            dataSource<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 创建请求，作为向es发起的写入命令(ES7统一type就是_doc，不再允许指定type)</span>            <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token class-name">Requests</span><span class="token punctuation">.</span><span class="token function">indexRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 用index发送请求</span>            indexer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动ElasticSearch（我这里是docker启动的</p></li><li><p>运行Flink程序，查看ElasticSearch是否新增数据</p><pre class="line-numbers language-json" data-language="json"><code class="language-json">$ curl <span class="token string">"localhost:9200/sensor/_search?pretty"</span><span class="token punctuation">{</span>  <span class="token property">"took"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"value"</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>      <span class="token property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"max_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>    <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"sensor"</span><span class="token punctuation">,</span>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"jciyWXcBiXrGJa12kSQt"</span><span class="token punctuation">,</span>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token property">"temp"</span> <span class="token operator">:</span> <span class="token string">"35.8"</span><span class="token punctuation">,</span>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token string">"sensor_1"</span><span class="token punctuation">,</span>          <span class="token property">"ts"</span> <span class="token operator">:</span> <span class="token string">"1547718199"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"sensor"</span><span class="token punctuation">,</span>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"jsiyWXcBiXrGJa12kSQu"</span><span class="token punctuation">,</span>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token property">"temp"</span> <span class="token operator">:</span> <span class="token string">"15.4"</span><span class="token punctuation">,</span>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token string">"sensor_6"</span><span class="token punctuation">,</span>          <span class="token property">"ts"</span> <span class="token operator">:</span> <span class="token string">"1547718201"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"sensor"</span><span class="token punctuation">,</span>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"j8iyWXcBiXrGJa12kSQu"</span><span class="token punctuation">,</span>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token property">"temp"</span> <span class="token operator">:</span> <span class="token string">"6.7"</span><span class="token punctuation">,</span>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token string">"sensor_7"</span><span class="token punctuation">,</span>          <span class="token property">"ts"</span> <span class="token operator">:</span> <span class="token string">"1547718202"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"sensor"</span><span class="token punctuation">,</span>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"kMiyWXcBiXrGJa12kSQu"</span><span class="token punctuation">,</span>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token property">"temp"</span> <span class="token operator">:</span> <span class="token string">"38.1"</span><span class="token punctuation">,</span>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token string">"sensor_10"</span><span class="token punctuation">,</span>          <span class="token property">"ts"</span> <span class="token operator">:</span> <span class="token string">"1547718205"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"sensor"</span><span class="token punctuation">,</span>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"kciyWXcBiXrGJa12kSQu"</span><span class="token punctuation">,</span>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token property">"temp"</span> <span class="token operator">:</span> <span class="token string">"36.3"</span><span class="token punctuation">,</span>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token string">"sensor_1"</span><span class="token punctuation">,</span>          <span class="token property">"ts"</span> <span class="token operator">:</span> <span class="token string">"1547718207"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"sensor"</span><span class="token punctuation">,</span>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"ksiyWXcBiXrGJa12kSQu"</span><span class="token punctuation">,</span>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token property">"temp"</span> <span class="token operator">:</span> <span class="token string">"32.8"</span><span class="token punctuation">,</span>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token string">"sensor_1"</span><span class="token punctuation">,</span>          <span class="token property">"ts"</span> <span class="token operator">:</span> <span class="token string">"1547718209"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"sensor"</span><span class="token punctuation">,</span>        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"k8iyWXcBiXrGJa12kSQu"</span><span class="token punctuation">,</span>        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token property">"temp"</span> <span class="token operator">:</span> <span class="token string">"37.1"</span><span class="token punctuation">,</span>          <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token string">"sensor_1"</span><span class="token punctuation">,</span>          <span class="token property">"ts"</span> <span class="token operator">:</span> <span class="token string">"1547718212"</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="5-7-4-JDBC自定义sink"><a href="#5-7-4-JDBC自定义sink" class="headerlink" title="5.7.4 JDBC自定义sink"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_574-jdbc%E8%87%AA%E5%AE%9A%E4%B9%89sink">5.7.4 JDBC自定义sink</a></h3><blockquote><p><a href="https://www.cnblogs.com/ywjfx/p/14263718.html">Flink之Mysql数据CDC</a></p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/jdbc.html">JDBC Connector</a> &lt;= 官方目前没有专门针对MySQL的，我们自己实现就好了</p></blockquote><p>这里测试的是连接MySQL。</p><ol><li><p>pom依赖（我本地docker里的mysql是8.0.19版本的）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>mysql<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">8.0</span><span class="token number">.19</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动mysql服务（我本地是docker启动的）</p></li><li><p>新建数据库</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token identifier"><span class="token punctuation">`</span>flink_test<span class="token punctuation">`</span></span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>新建schema</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>sensor_temp<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>temp<span class="token punctuation">`</span></span> <span class="token keyword">double</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>编写java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>sink</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">SourceTest4_UDF</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span><span class="token class-name">RichSinkFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DriverManager</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 2:48 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SinkTest4_Jdbc</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 设置并行度 = 1</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从文件读取数据</span><span class="token comment">//        DataStream&lt;String&gt; inputStream = env.readTextFile("/tmp/Flink_Tutorial/src/main/resources/sensor.txt");</span><span class="token comment">//</span><span class="token comment">//        // 转换成SensorReading类型</span><span class="token comment">//        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; {</span><span class="token comment">//            String[] fields = line.split(",");</span><span class="token comment">//            return new SensorReading(fields[0], new Long(fields[1]), new Double(fields[2]));</span><span class="token comment">//        });</span>        <span class="token comment">// 使用之前编写的随机变动温度的SourceFunction来生成数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SourceTest4_UDF<span class="token punctuation">.</span>MySensorSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataStream<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyJdbcSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 实现自定义的SinkFunction</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyJdbcSink</span> <span class="token keyword">extends</span> <span class="token class-name">RichSinkFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>        <span class="token comment">// 声明连接和预编译语句</span>        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">PreparedStatement</span> insertStmt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">PreparedStatement</span> updateStmt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/flink_test?useUnicode=true&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=UTF-8&amp;useSSL=false"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token string">"example"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            insertStmt <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">"insert into sensor_temp (id, temp) values (?, ?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            updateStmt <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">"update sensor_temp set temp = ? where id = ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 每来一条数据，调用连接，执行sql</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            <span class="token comment">// 直接执行更新语句，如果没有更新那么就插入</span>            updateStmt<span class="token punctuation">.</span><span class="token function">setDouble</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            updateStmt<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            updateStmt<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>updateStmt<span class="token punctuation">.</span><span class="token function">getUpdateCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                insertStmt<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                insertStmt<span class="token punctuation">.</span><span class="token function">setDouble</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                insertStmt<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            insertStmt<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            updateStmt<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>运行Flink程序，查看MySQL数据（可以看到MySQL里的数据一直在变动）</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysql<span class="token operator">&gt;</span> SELECT * FROM sensor_temp<span class="token punctuation">;</span>+-----------+--------------------+<span class="token operator">|</span> <span class="token function">id</span>        <span class="token operator">|</span> temp               <span class="token operator">|</span>+-----------+--------------------+<span class="token operator">|</span> sensor_3  <span class="token operator">|</span> <span class="token number">20.489172407885917</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_10 <span class="token operator">|</span>  <span class="token number">73.01289164711463</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_4  <span class="token operator">|</span> <span class="token number">43.402500895809744</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_1  <span class="token operator">|</span>  <span class="token number">6.894772325662007</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_2  <span class="token operator">|</span> <span class="token number">101.79309911751122</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_7  <span class="token operator">|</span> <span class="token number">63.070612021580324</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_8  <span class="token operator">|</span>  <span class="token number">63.82606628090501</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_5  <span class="token operator">|</span>  <span class="token number">57.67115738487047</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_6  <span class="token operator">|</span>  <span class="token number">50.84442627975055</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_9  <span class="token operator">|</span>  <span class="token number">52.58400793021675</span> <span class="token operator">|</span>+-----------+--------------------+<span class="token number">10</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">&gt;</span> SELECT * FROM sensor_temp<span class="token punctuation">;</span>+-----------+--------------------+<span class="token operator">|</span> <span class="token function">id</span>        <span class="token operator">|</span> temp               <span class="token operator">|</span>+-----------+--------------------+<span class="token operator">|</span> sensor_3  <span class="token operator">|</span> <span class="token number">19.498209543035923</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_10 <span class="token operator">|</span>  <span class="token number">71.92981963197121</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_4  <span class="token operator">|</span> <span class="token number">43.566017489470426</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_1  <span class="token operator">|</span>  <span class="token number">6.378208186786803</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_2  <span class="token operator">|</span> <span class="token number">101.71010087830145</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_7  <span class="token operator">|</span>  <span class="token number">62.11402602179431</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_8  <span class="token operator">|</span>  <span class="token number">64.33196455020062</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_5  <span class="token operator">|</span>  <span class="token number">56.39071692662006</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_6  <span class="token operator">|</span> <span class="token number">48.952784757264894</span> <span class="token operator">|</span><span class="token operator">|</span> sensor_9  <span class="token operator">|</span> <span class="token number">52.078086096436685</span> <span class="token operator">|</span>+-----------+--------------------+<span class="token number">10</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="5-8-Joining"><a href="#5-8-Joining" class="headerlink" title="5.8 Joining"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_58-joining">5.8 Joining</a></h2><blockquote><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/operators/joining.html">Joining</a></p></blockquote><h3 id="5-8-1-Window-Join"><a href="#5-8-1-Window-Join" class="headerlink" title="5.8.1 Window Join"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_581-window-join">5.8.1 Window Join</a></h3><p> A window join joins the elements of two streams that share a common key and lie in the same window. These windows can be defined by using a <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/operators/windows.html#window-assigners">window assigner</a> and are evaluated on elements from both of the streams.</p><p> The elements from both sides are then passed to a user-defined <code>JoinFunction</code> or <code>FlatJoinFunction</code> where the user can emit results that meet the join criteria.</p><p> The general usage can be summarized as follows:</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">stream.join<span class="token punctuation">(</span>otherStream<span class="token punctuation">)</span>    .where<span class="token punctuation">(</span><span class="token operator">&lt;</span>KeySelector<span class="token operator">&gt;</span><span class="token punctuation">)</span>    .equalTo<span class="token punctuation">(</span><span class="token operator">&lt;</span>KeySelector<span class="token operator">&gt;</span><span class="token punctuation">)</span>    .window<span class="token punctuation">(</span><span class="token operator">&lt;</span>WindowAssigner<span class="token operator">&gt;</span><span class="token punctuation">)</span>    .apply<span class="token punctuation">(</span><span class="token operator">&lt;</span>JoinFunction<span class="token operator">&gt;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Tumbling-Window-Join"><a href="#Tumbling-Window-Join" class="headerlink" title="Tumbling Window Join"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=tumbling-window-join">Tumbling Window Join</a></h4><p> When performing a tumbling window join, all elements with a common key and a common tumbling window are joined as pairwise combinations and passed on to a <code>JoinFunction</code> or <code>FlatJoinFunction</code>. Because this behaves like an inner join, elements of one stream that do not have elements from another stream in their tumbling window are not emitted!</p><p><img src="https://ci.apache.org/projects/flink/flink-docs-release-1.12/fig/tumbling-window-join.svg"></p><p> As illustrated in the figure, we define a tumbling window with the size of 2 milliseconds, which results in windows of the form <code>[0,1], [2,3], ...</code>. The image shows the pairwise combinations of all elements in each window which will be passed on to the <code>JoinFunction</code>. Note that in the tumbling window <code>[6,7]</code> nothing is emitted because no elements exist in the green stream to be joined with the orange elements ⑥ and ⑦.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeySelector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> orangeStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> greenStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>orangeStream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>greenStream<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span>apply <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JoinFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> first<span class="token punctuation">,</span> <span class="token class-name">Integer</span> second<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> first <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> second<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Sliding-Window-Join"><a href="#Sliding-Window-Join" class="headerlink" title="Sliding Window Join"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=sliding-window-join">Sliding Window Join</a></h4><p> When performing a sliding window join, all elements with a common key and common sliding window are joined as pairwise combinations and passed on to the <code>JoinFunction</code> or <code>FlatJoinFunction</code>. Elements of one stream that do not have elements from the other stream in the current sliding window are not emitted! Note that some elements might be joined in one sliding window but not in another!</p><p><img src="https://ci.apache.org/projects/flink/flink-docs-release-1.12/fig/sliding-window-join.svg"></p><p> In this example we are using sliding windows with a size of two milliseconds and slide them by one millisecond, resulting in the sliding windows <code>[-1, 0],[0,1],[1,2],[2,3], …</code>. The joined elements below the x-axis are the ones that are passed to the <code>JoinFunction</code> for each sliding window. Here you can also see how for example the orange ② is joined with the green ③ in the window <code>[2,3]</code>, but is not joined with anything in the window <code>[1,2]</code>.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeySelector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> orangeStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> greenStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>orangeStream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>greenStream<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">/* size */</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">/* slide */</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span>apply <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JoinFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> first<span class="token punctuation">,</span> <span class="token class-name">Integer</span> second<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> first <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> second<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Session-Window-Join"><a href="#Session-Window-Join" class="headerlink" title="Session Window Join"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=session-window-join">Session Window Join</a></h4><p> When performing a session window join, all elements with the same key that when <em>“combined”</em> fulfill the session criteria are joined in pairwise combinations and passed on to the <code>JoinFunction</code> or <code>FlatJoinFunction</code>. Again this performs an inner join, so if there is a session window that only contains elements from one stream, no output will be emitted!</p><p><img src="https://ci.apache.org/projects/flink/flink-docs-release-1.12/fig/session-window-join.svg"></p><p> Here we define a session window join where each session is divided by a gap of at least 1ms. There are three sessions, and in the first two sessions the joined elements from both streams are passed to the <code>JoinFunction</code>. In the third session there are no elements in the green stream, so ⑧ and ⑨ are not joined!</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeySelector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">EventTimeSessionWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> orangeStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> greenStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>orangeStream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>greenStream<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">EventTimeSessionWindows</span><span class="token punctuation">.</span><span class="token function">withGap</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span>apply <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JoinFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> first<span class="token punctuation">,</span> <span class="token class-name">Integer</span> second<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> first <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> second<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-8-2-Interval-Join"><a href="#5-8-2-Interval-Join" class="headerlink" title="5.8.2 Interval Join"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_582-interval-join">5.8.2 Interval Join</a></h3><p>The interval join joins elements of two streams (we’ll call them A &amp; B for now) with a common key and where elements of stream B have timestamps that lie in a relative time interval to timestamps of elements in stream A.</p><p>This can also be expressed more formally as <code>b.timestamp ∈ [a.timestamp + lowerBound; a.timestamp + upperBound]</code> or <code>a.timestamp + lowerBound &lt;= b.timestamp &lt;= a.timestamp + upperBound</code></p><p>where a and b are elements of A and B that share a common key. Both the lower and upper bound can be either negative or positive as long as as the lower bound is always smaller or equal to the upper bound. The interval join currently only performs inner joins.</p><p>When a pair of elements are passed to the <code>ProcessJoinFunction</code>, they will be assigned with the larger timestamp (which can be accessed via the <code>ProcessJoinFunction.Context</code>) of the two elements.</p><p><strong>Note</strong> The interval join currently only supports event time.</p><p><img src="https://ci.apache.org/projects/flink/flink-docs-release-1.12/fig/interval-join.svg"></p><p>In the example above, we join two streams ‘orange’ and ‘green’ with a lower bound of -2 milliseconds and an upper bound of +1 millisecond. Be default, these boundaries are inclusive, but <code>.lowerBoundExclusive()</code> and <code>.upperBoundExclusive</code> can be applied to change the behaviour.</p><p>Using the more formal notation again this will translate to</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">orangeElem<span class="token punctuation">.</span>ts <span class="token operator">+</span> lowerBound <span class="token operator">&lt;=</span> greenElem<span class="token punctuation">.</span>ts <span class="token operator">&lt;=</span> orangeElem<span class="token punctuation">.</span>ts <span class="token operator">+</span> upperBound<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>as indicated by the triangles.</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeySelector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span></span><span class="token class-name">ProcessJoinFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> orangeStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> greenStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>orangeStream    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">intervalJoin</span><span class="token punctuation">(</span>greenStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span>process <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessJoinFunction</span><span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> left<span class="token punctuation">,</span> <span class="token class-name">Integer</span> right<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token punctuation">{</span>            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>first <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> second<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-1-Window"><a href="#6-1-Window" class="headerlink" title="6.1 Window"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_61-window">6.1 Window</a></h2><blockquote><p><a href="https://blog.csdn.net/dongkang123456/article/details/108374799">Flink_Window</a></p></blockquote><h3 id="6-1-1-概述"><a href="#6-1-1-概述" class="headerlink" title="6.1.1 概述"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_611-%E6%A6%82%E8%BF%B0">6.1.1 概述</a></h3><p><img src="https://img-blog.csdnimg.cn/20200903082944202.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><p> streaming流式计算是一种被设计用于处理无限数据集的数据处理引擎，而无限数据集是指一种不断增长的本质上无限的数据集，而<strong>window是一种切割无限数据为有限块进行处理的手段</strong>。</p><p> <strong>Window是无限数据流处理的核心，Window将一个无限的stream拆分成有限大小的”buckets”桶，我们可以在这些桶上做计算操作</strong>。</p><p><em>举例子：假设按照时间段划分桶，接收到的数据马上能判断放到哪个桶，且多个桶的数据能并行被处理。（迟到的数据也可判断是原本属于哪个桶的）</em></p><h3 id="6-1-2-Window类型"><a href="#6-1-2-Window类型" class="headerlink" title="6.1.2 Window类型"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_612-window%E7%B1%BB%E5%9E%8B">6.1.2 Window类型</a></h3><ul><li>时间窗口（Time Window）<ul><li>  滚动时间窗口</li><li>  滑动时间窗口</li><li>  会话窗口</li></ul></li><li>计数窗口（Count Window）<ul><li>  滚动计数窗口</li><li>  滑动计数窗口</li></ul></li></ul><p><strong>TimeWindow：按照时间生成Window</strong></p><p><strong>CountWindow：按照指定的数据条数生成一个Window，与时间无关</strong></p><hr><h4 id="滚动窗口-Tumbling-Windows"><a href="#滚动窗口-Tumbling-Windows" class="headerlink" title="滚动窗口(Tumbling Windows)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3tumbling-windows">滚动窗口(Tumbling Windows)</a></h4><p><img src="https://img-blog.csdnimg.cn/20200903083725483.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><ul><li><p>  依据<strong>固定的窗口长度</strong>对数据进行切分</p></li><li><p>  时间对齐，窗口长度固定，没有重叠</p></li></ul><h4 id="滑动窗口-Sliding-Windows"><a href="#滑动窗口-Sliding-Windows" class="headerlink" title="滑动窗口(Sliding Windows)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3sliding-windows">滑动窗口(Sliding Windows)</a></h4><p><img src="https://img-blog.csdnimg.cn/20200903084127244.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><ul><li><p>  可以按照固定的长度向后滑动固定的距离</p></li><li><p>  滑动窗口由<strong>固定的窗口长度</strong>和<strong>滑动间隔</strong>组成</p></li><li><p>  可以有重叠(是否重叠和滑动距离有关系)</p></li><li><p>  滑动窗口是固定窗口的更广义的一种形式，滚动窗口可以看做是滑动窗口的一种特殊情况（即窗口大小和滑动间隔相等）</p></li></ul><h4 id="会话窗口-Session-Windows"><a href="#会话窗口-Session-Windows" class="headerlink" title="会话窗口(Session Windows)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3session-windows">会话窗口(Session Windows)</a></h4><p><img src="https://img-blog.csdnimg.cn/20200903085034747.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><ul><li>  由一系列事件组合一个指定时间长度的timeout间隙组成，也就是一段时间没有接收到新数据就会生成新的窗口</li><li>  特点：时间无对齐</li></ul><h2 id="6-2-Window-API"><a href="#6-2-Window-API" class="headerlink" title="6.2 Window API"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_62-window-api">6.2 Window API</a></h2><h3 id="6-2-1-概述"><a href="#6-2-1-概述" class="headerlink" title="6.2.1 概述"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_621-%E6%A6%82%E8%BF%B0">6.2.1 概述</a></h3><ul><li><p>窗口分配器——<code>window()</code>方法</p></li><li><p>我们可以用<code>.window()</code>来定义一个窗口，然后基于这个window去做一些聚合或者其他处理操作。</p><p><strong>注意<code>window()</code>方法必须在keyBy之后才能使用</strong>。</p></li><li><p>Flink提供了更加简单的<code>.timeWindow()</code>和<code>.countWindow()</code>方法，用于定义时间窗口和计数窗口。</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> minTempPerWindowStream <span class="token operator">=</span>   datastream  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">minBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="窗口分配器-window-assigner"><a href="#窗口分配器-window-assigner" class="headerlink" title="窗口分配器(window assigner)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E7%AA%97%E5%8F%A3%E5%88%86%E9%85%8D%E5%99%A8window-assigner">窗口分配器(window assigner)</a></h4><ul><li>  <code>window()</code>方法接收的输入参数是一个WindowAssigner</li><li>  WindowAssigner负责将每条输入的数据分发到正确的window中</li><li>Flink提供了通用的WindowAssigner<ul><li>  滚动窗口（tumbling window）</li><li>  滑动窗口（sliding window）</li><li>  会话窗口（session window）</li><li>  <strong>全局窗口（global window）</strong></li></ul></li></ul><h4 id="创建不同类型的窗口"><a href="#创建不同类型的窗口" class="headerlink" title="创建不同类型的窗口"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%88%9B%E5%BB%BA%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%AA%97%E5%8F%A3">创建不同类型的窗口</a></h4><ul><li><p>滚动时间窗口（tumbling time window）</p><p><code>.timeWindow(Time.seconds(15))</code></p></li><li><p>滑动时间窗口（sliding time window）</p><p><code>.timeWindow(Time.seconds(15),Time.seconds(5))</code></p></li><li><p>会话窗口（session window）</p><p><code>.window(EventTimeSessionWindows.withGap(Time.minutes(10)))</code></p></li><li><p>滚动计数窗口（tumbling count window）</p><p><code>.countWindow(5)</code></p></li><li><p>滑动计数窗口（sliding count window）</p><p><code>.countWindow(10,2)</code></p></li></ul><p><em>DataStream的<code>windowAll()</code>类似分区的global操作，这个操作是non-parallel的(并行度强行为1)，所有的数据都会被传递到同一个算子operator上，官方建议如果非必要就不要用这个API</em></p><h3 id="6-2-2-TimeWindow"><a href="#6-2-2-TimeWindow" class="headerlink" title="6.2.2 TimeWindow"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_622-timewindow">6.2.2 TimeWindow</a></h3><p> TimeWindow将指定时间范围内的所有数据组成一个window，一次对一个window里面的所有数据进行计算。</p><h4 id="滚动窗口"><a href="#滚动窗口" class="headerlink" title="滚动窗口"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3">滚动窗口</a></h4><p> Flink默认的时间窗口根据ProcessingTime进行窗口的划分，将Flink获取到的数据根据进入Flink的时间划分到不同的窗口中。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> minTempPerWindowStream <span class="token operator">=</span> dataStream   <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token annotation punctuation">@Override</span>     <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">minBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 时间间隔可以通过<code>Time.milliseconds(x)</code>，<code>Time.seconds(x)</code>，<code>Time.minutes(x)</code>等其中的一个来指定。</p><h4 id="滑动窗口"><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3">滑动窗口</a></h4><p> 滑动窗口和滚动窗口的函数名是完全一致的，只是在传参数时需要传入两个参数，一个是window_size，一个是sliding_size。</p><p> 下面代码中的sliding_size设置为了5s，也就是说，每5s就计算输出结果一次，每一次计算的window范围是15s内的所有元素。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> minTempPerWindowStream <span class="token operator">=</span> dataStream   <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">minBy</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p> 时间间隔可以通过<code>Time.milliseconds(x)</code>，<code>Time.seconds(x)</code>，<code>Time.minutes(x)</code>等其中的一个来指定。</p><h3 id="6-2-3-CountWindow"><a href="#6-2-3-CountWindow" class="headerlink" title="6.2.3 CountWindow"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_623-countwindow">6.2.3 CountWindow</a></h3><p> CountWindow根据窗口中相同key元素的数量来触发执行，执行时只计算元素数量达到窗口大小的key对应的结果。</p><p> <strong>注意：CountWindow的window_size指的是相同Key的元素的个数，不是输入的所有元素的总数。</strong> </p><h4 id="滚动窗口-1"><a href="#滚动窗口-1" class="headerlink" title="滚动窗口"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3-1">滚动窗口</a></h4><p> 默认的CountWindow是一个滚动窗口，只需要指定窗口大小即可，<strong>当元素数量达到窗口大小时，就会触发窗口的执行</strong>。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> minTempPerWindowStream <span class="token operator">=</span> dataStream   <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">countWindow</span><span class="token punctuation">(</span> <span class="token number">5</span> <span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">minBy</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="滑动窗口-1"><a href="#滑动窗口-1" class="headerlink" title="滑动窗口"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3-1">滑动窗口</a></h4><p> 滑动窗口和滚动窗口的函数名是完全一致的，只是在传参数时需要传入两个参数，一个是window_size，一个是sliding_size。</p><p> 下面代码中的sliding_size设置为了2，也就是说，每收到两个相同key的数据就计算一次，每一次计算的window范围是10个元素。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> minTempPerWindowStream <span class="token operator">=</span> dataStream   <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">countWindow</span><span class="token punctuation">(</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span>   <span class="token punctuation">.</span><span class="token function">minBy</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-2-4-window-function"><a href="#6-2-4-window-function" class="headerlink" title="6.2.4 window function"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_624-window-function">6.2.4 window function</a></h3><p>window function 定义了要对窗口中收集的数据做的计算操作，主要可以分为两类：</p><ul><li>  增量聚合函数（incremental aggregation functions）</li><li>  全窗口函数（full window functions）</li></ul><h4 id="增量聚合函数"><a href="#增量聚合函数" class="headerlink" title="增量聚合函数"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%A2%9E%E9%87%8F%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0">增量聚合函数</a></h4><ul><li>  <strong>每条数据到来就进行计算</strong>，保持一个简单的状态。（来一条处理一条，但是不输出，到窗口临界位置才输出）</li><li>  典型的增量聚合函数有ReduceFunction, AggregateFunction。</li></ul><h4 id="全窗口函数"><a href="#全窗口函数" class="headerlink" title="全窗口函数"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%85%A8%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0">全窗口函数</a></h4><ul><li>  <strong>先把窗口所有数据收集起来，等到计算的时候会遍历所有数据</strong>。（来一个放一个，窗口临界位置才遍历且计算、输出）</li><li>  ProcessWindowFunction，WindowFunction。</li></ul><h3 id="6-2-5-其它可选API"><a href="#6-2-5-其它可选API" class="headerlink" title="6.2.5 其它可选API"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_625-%E5%85%B6%E5%AE%83%E5%8F%AF%E9%80%89api">6.2.5 其它可选API</a></h3><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106359443">Flink-Window概述 | Window类型 | TimeWindow、CountWindow、SessionWindow、WindowFunction</a></p></blockquote><ul><li><p><code>.trigger()</code> ——触发器</p><p>定义window 什么时候关闭，触发计算并输出结果</p></li><li><p><code>.evitor()</code> ——移除器</p><p>定义移除某些数据的逻辑</p></li><li><p><code>.allowedLateness()</code> ——允许处理迟到的数据</p></li><li><p><code>.sideOutputLateData()</code> ——将迟到的数据放入侧输出流</p></li><li><p><code>.getSideOutput()</code> ——获取侧输出流</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200526181340668.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h3 id="6-2-6-代码测试"><a href="#6-2-6-代码测试" class="headerlink" title="6.2.6 代码测试"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_626-%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95">6.2.6 代码测试</a></h3><blockquote><p><a href="https://www.cnblogs.com/yangshibiao/p/14133628.html">Flink之Window的使用（2）：时间窗口</a></p></blockquote><ol><li><p>测试滚动时间窗口的<strong>增量聚合函数</strong></p><p>增量聚合函数，特点即每次数据过来都处理，但是<strong>到了窗口临界才输出结果</strong>。</p><ul><li><p>编写java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>window</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 7:14 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest1_TimeWindow</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 并行度设置1，方便看结果</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//        // 从文件读取数据</span>    <span class="token comment">//        DataStream&lt;String&gt; dataStream = env.readTextFile("/tmp/Flink_Tutorial/src/main/resources/sensor.txt");</span>    <span class="token comment">// 从socket文本流获取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 开窗测试</span>    <span class="token comment">// 1. 增量聚合函数 (这里简单统计每个key组里传感器信息的总数)</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>      <span class="token comment">//                .countWindow(10, 2);</span>      <span class="token comment">//                .window(EventTimeSessionWindows.withGap(Time.minutes(1)));</span>      <span class="token comment">//                .window(TumblingProcessingTimeWindows.of(Time.seconds(15)))</span>      <span class="token comment">//                .timeWindow(Time.seconds(15)) // 已经不建议使用@Deprecated</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 新建的累加器</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 每个数据在上次的基础上累加</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">,</span> <span class="token class-name">Integer</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 返回结果值</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 分区合并结果(TimeWindow一般用不到，SessionWindow可能需要考虑合并)</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> a<span class="token punctuation">,</span> <span class="token class-name">Integer</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>本地开启socket服务</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nc</span> -lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>启动Flink程序，在socket窗口输入数据</p><ul><li><p>输入(下面用“换行”区分每个15s内的输入，实际输入时无换行)</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出（下面用“换行”区分每个15s内的输出，实际输出无换行）</p><p><em>因为代码实现每15s一个window，所以”sensor_1”中间一组才累计2，最初一次不累计，最后一次也是另外的window，重新从1计数。</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> <span class="token number">1</span>result<span class="token operator">&gt;</span> <span class="token number">1</span>result<span class="token operator">&gt;</span> <span class="token number">1</span>result<span class="token operator">&gt;</span> <span class="token number">1</span>result<span class="token operator">&gt;</span> <span class="token number">2</span>result<span class="token operator">&gt;</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul></li><li><p>测试滚动时间窗口的<strong>全窗口函数</strong></p><p>全窗口函数，特点即数据过来先不处理，等到窗口临界再遍历、计算、输出结果。</p><ul><li><p>编写java测试代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>window</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">IteratorUtils</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple3</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 7:14 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest1_TimeWindow</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建执行环境</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 并行度设置1，方便看结果</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        // 从文件读取数据</span><span class="token comment">//        DataStream&lt;String&gt; dataStream = env.readTextFile("/tmp/Flink_Tutorial/src/main/resources/sensor.txt");</span>        <span class="token comment">// 从socket文本流获取数据</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 转换成SensorReading类型</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2. 全窗口函数 （WindowFunction和ProcessWindowFunction，后者更全面）</span>        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultStream2 <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//                .process(new ProcessWindowFunction&lt;SensorReading, Object, Tuple, TimeWindow&gt;() {</span><span class="token comment">//                })</span>                <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                        <span class="token class-name">String</span> id <span class="token operator">=</span> s<span class="token punctuation">;</span>                        <span class="token keyword">long</span> windowEnd <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token class-name">IteratorUtils</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> windowEnd<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        resultStream2<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动本地socket</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nc</span> -lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>在本地socket输入，查看Flink输出结果</p><ul><li><p>输入（以“空行”表示每个15s时间窗口内的输入，实际没有“空行”）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出（以“空行”表示每个15s时间窗口内的输入，实际没有“空行”）</p><p><em>这里每个window都是分开计算的，所以第一个window里的sensor_1和第二个window里的sensor_1并没有累计。</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result2<span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">1612190820000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>result2<span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_6<span class="token punctuation">,</span><span class="token number">1612190820000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>result2<span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_7<span class="token punctuation">,</span><span class="token number">1612190835000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>result2<span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">1612190835000</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>result2<span class="token operator">&gt;</span> <span class="token punctuation">(</span>sensor_10<span class="token punctuation">,</span><span class="token number">1612190835000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul></li><li><p>测试滑动计数窗口的<strong>增量聚合函数</strong></p><p>滑动窗口，当窗口不足设置的大小时，会先按照步长输出。</p><p>eg：窗口大小10，步长2，那么前5次输出时，窗口内的元素个数分别是（2，4，6，8，10），再往后就是10个为一个窗口了。</p><ul><li><p>编写java代码：</p><p>这里获取每个窗口里的温度平均值</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>window</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/1 11:03 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest2_CountWindow</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 并行度设置1，方便看结果</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从socket文本流获取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">countWindow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyAvgFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyAvgFunc</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// 温度累加求和，当前统计的温度个数+1</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>accumulator<span class="token punctuation">.</span>f0 <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accumulator<span class="token punctuation">.</span>f1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Double</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">.</span>f0 <span class="token operator">/</span> accumulator<span class="token punctuation">.</span>f1<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> a<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>f0 <span class="token operator">+</span> b<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> a<span class="token punctuation">.</span>f1 <span class="token operator">+</span> b<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动socket服务</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nc</span> -lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>本地socket输入，Flink控制台查看输出结果</p><ul><li><p>输入</p><p>这里为了方便，就只输入同一个keyBy组的数据<code>sensor_1</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">2</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">4</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">5</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">6</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">7</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">9</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">10</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">11</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">12</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">13</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">14</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><p>输入时，会发现，每次到达一个窗口步长（这里为2），就会计算得出一次结果。</p><p>第一次计算前2个数的平均值</p><p>第二次计算前4个数的平均值</p><p>第三次计算前6个数的平均值</p><p>第四次计算前8个数的平均值</p><p>第五次计算前10个数的平均值</p><p><strong>第六次计算前最近10个数的平均值</strong></p><p><strong>第七次计算前最近10个数的平均值</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> <span class="token number">1.5</span>result<span class="token operator">&gt;</span> <span class="token number">2.5</span>result<span class="token operator">&gt;</span> <span class="token number">3.5</span>result<span class="token operator">&gt;</span> <span class="token number">4.5</span>result<span class="token operator">&gt;</span> <span class="token number">5.5</span>result<span class="token operator">&gt;</span> <span class="token number">7.5</span>result<span class="token operator">&gt;</span> <span class="token number">9.5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul></li><li><p>其他可选API代码片段</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 3. 其他可选API</span><span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> outputTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> sumStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//                .trigger() // 触发器，一般不使用 </span>  <span class="token comment">//                .evictor() // 移除器，一般不使用</span>  <span class="token punctuation">.</span><span class="token function">allowedLateness</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 允许1分钟内的迟到数据&lt;=比如数据产生时间在窗口范围内，但是要处理的时候已经超过窗口时间了</span>  <span class="token punctuation">.</span><span class="token function">sideOutputLateData</span><span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span> <span class="token comment">// 侧输出流，迟到超过1分钟的数据，收集于此</span>  <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 侧输出流 对 温度信息 求和。</span><span class="token comment">// 之后可以再用别的程序，把侧输出流的信息和前面窗口的信息聚合。（可以把侧输出流理解为用来批处理来补救处理超时数据）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><blockquote><p><a href="https://blog.csdn.net/dongkang123456/article/details/108374799">Flink_Window</a></p></blockquote><h2 id="7-1-Flink中的时间语义"><a href="#7-1-Flink中的时间语义" class="headerlink" title="7.1 Flink中的时间语义"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_71-flink%E4%B8%AD%E7%9A%84%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89">7.1 Flink中的时间语义</a></h2><p><img src="https://img-blog.csdnimg.cn/20200903145920356.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><ul><li><p>  <strong>Event Time：事件创建时间；</strong></p></li><li><p>  Ingestion Time：数据进入Flink的时间；</p></li><li><p>  Processing Time：执行操作算子的本地系统时间，与机器相关；</p></li></ul><p> <em>Event Time是事件创建的时间。它通常由事件中的时间戳描述，例如采集的日志数据中，每一条日志都会记录自己的生成时间，Flink通过时间戳分配器访问事件时间戳。</em></p><hr><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106363815">Flink-时间语义与Wartmark及EventTime在Window中的使用</a></p></blockquote><p><img src="https://img-blog.csdnimg.cn/20200526200231905.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  不同的时间语义有不同的应用场合</li><li>  <strong>我们往往更关心事件事件（Event Time）</strong></li></ul><p><img src="https://img-blog.csdnimg.cn/20200526200432798.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p> 这里假设玩游戏，两分钟内如果过5关就有奖励。用户坐地铁玩游戏，进入隧道前已经过3关，在隧道中又过了2关。但是信号不好，后两关通关的信息，等到出隧道的时候（8:23:20）才正式到达服务器。</p><p> 如果为了用户体验，那么应该按照Event Time处理信息，保证用户获得游戏奖励。</p><ul><li><p>Event Time可以从日志数据的时间戳（timestamp）中提取</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token number">2017</span>-11-02 <span class="token number">18</span>:27:15.624 INFO Fail over to <span class="token function">rm</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h2 id="7-2-EventTime的引入"><a href="#7-2-EventTime的引入" class="headerlink" title="7.2 EventTime的引入"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_72-eventtime%E7%9A%84%E5%BC%95%E5%85%A5">7.2 EventTime的引入</a></h2><p> <strong>在Flink的流式处理中，绝大部分的业务都会使用eventTime</strong>，一般只在eventTime无法使用时，才会被迫使用ProcessingTime或者IngestionTime。</p><p> <em>（虽然默认环境里使用的就是ProcessingTime，使用EventTime需要另外设置）</em></p><p> 如果要使用EventTime，那么需要引入EventTime的时间属性，引入方式如下所示：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从调用时刻开始给env创建的每一个stream追加时间特征</span>env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>注：具体的时间，还需要从数据中提取时间戳。</strong> </p><h2 id="7-3-Watermark"><a href="#7-3-Watermark" class="headerlink" title="7.3 Watermark"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_73-watermark">7.3 Watermark</a></h2><blockquote><p><a href="https://blog.csdn.net/lmalds/article/details/52704170">Flink流计算编程–watermark（水位线）简介</a> &lt;= 不错的文章，建议阅读</p></blockquote><h3 id="7-3-1-概念"><a href="#7-3-1-概念" class="headerlink" title="7.3.1 概念"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_731-%E6%A6%82%E5%BF%B5">7.3.1 概念</a></h3><ul><li><strong>Flink对于迟到数据有三层保障</strong>，先来后到的保障顺序是：<ul><li>  WaterMark =&gt; 约等于放宽窗口标准</li><li>  allowedLateness =&gt; 允许迟到（ProcessingTime超时，但是EventTime没超时）</li><li>  sideOutputLateData =&gt; 超过迟到时间，另外捕获，之后可以自己批处理合并先前的数据</li></ul></li></ul><hr><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106363815">Flink-时间语义与Wartmark及EventTime在Window中的使用</a></p></blockquote><p> 我们知道，流处理从事件产生，到流经source，再到operator，中间是有一个过程和时间的，虽然大部分情况下，流到operator的数据都是按照事件产生的时间顺序来的，但是也不排除由于网络、分布式等原因，导致乱序的产生，所谓乱序，就是指Flink接收到的事件的先后顺序不是严格按照事件的Event Time顺序排列的。</p><p><img src="https://img-blog.csdnimg.cn/20200526201305372.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p> 那么此时出现一个问题，一旦出现乱序，如果只根据eventTime决定window的运行，我们不能明确数据是否全部到位，但又不能无限期的等下去，此时必须要有个机制来保证一个特定的时间后，必须触发window去进行计算了，这个特别的机制，就是Watermark。</p><p><img src="https://img-blog.csdnimg.cn/20200526201418333.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>当Flink以<strong>Event Time模式</strong>处理数据流时，它会根据<strong>数据里的时间戳</strong>来处理基于时间的算子。</p><p>（比如5s一个窗口，那么理想情况下，遇到时间戳是5s的数据时，就认为[0,5s)时间段的桶bucket就可以关闭了。）</p></li><li><p>实际由于网络、分布式传输处理等原因，会导致乱序数据的产生</p></li><li><p>乱序数据会导致窗口计算不准确</p><p>（如果按照前面说法，获取到5s时间戳的数据，但是2s，3s乱序数据还没到，理论上不应该关闭桶）</p></li></ul><hr><ul><li><p>怎样避免乱序数据带来的计算不正确？</p></li><li><p>遇到一个时间戳达到了窗口关闭时间，不应该立即触发窗口计算，而是等待一段时间，等迟到的数据来了再关闭窗口</p></li></ul><ol><li><p>Watermark是一种衡量Event Time进展的机制，可以设定延迟触发</p></li><li><p>Watermark是用于处理乱序事件的，而正确的处理乱序事件，通常用Watermark机制结合window来实现</p></li><li><p>数据流中的Watermark用于表示”timestamp小于Watermark的数据，都已经到达了“，因此，window的执行也是由Watermark触发的。</p></li><li><p>Watermark可以理解成一个延迟触发机制，我们可以设置Watermark的延时时长t，每次系统会校验已经到达的数据中最大的maxEventTime，然后认定eventTime小于maxEventTime - t的所有数据都已经到达，<strong>如果有窗口的停止时间等于maxEventTime – t，那么这个窗口被触发执行。</strong> </p><p><code>Watermark = maxEventTime-延迟时间t</code></p></li><li><p>watermark 用来让程序自己平衡延迟和结果正确性</p></li></ol><p><em>watermark可以理解为把原本的窗口标准稍微放宽了一点。（比如原本5s，设置延迟时间=2s，那么实际等到7s的数据到达时，才认为是[0,5）的桶需要关闭了）</em></p><p>有序流的Watermarker如下图所示：（延迟时间设置为0s）</p><p><em>此时以5s一个窗口，那么EventTime=5s的元素到达时，关闭第一个窗口，下图即W(5)，W(10)同理。</em></p><p><img src="https://img-blog.csdnimg.cn/20200526201731274.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p>乱序流的Watermarker如下图所示：（延迟时间设置为2s）</p><p><em>乱序流，所以可能出现EventTime前后顺序不一致的情况，这里延迟时间设置2s，第一个窗口则为<code>5s+2s</code>，当EventTime=7s的数据到达时，关闭第一个窗口。第二个窗口则是<code>5*2+2=12s</code>，当12s这个EventTime的数据到达时，关闭第二个窗口。</em></p><p><img src="https://img-blog.csdnimg.cn/2020052620175060.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p> 当Flink接收到数据时，会按照一定的规则去生成Watermark，这条Watermark就等于当前所有到达数据中的maxEventTime-延迟时长，也就是说，<strong>Watermark是基于数据携带的时间戳生成的</strong>，一旦Watermark比当前未触发的窗口的停止时间要晚，那么就会触发相应窗口的执行。</p><p> <strong>由于event time是由数据携带的，因此，如果运行过程中无法获取新的数据，那么没有被触发的窗口将永远都不被触发</strong>。</p><p> 上图中，我们设置的允许最大延迟到达时间为2s，所以时间戳为7s的事件对应的Watermark是5s，时间戳为12s的事件的Watermark是10s，如果我们的窗口1是<code>1s~5s</code>，窗口2是<code>6s~10s</code>，那么时间戳为7s的事件到达时的Watermarker恰好触发窗口1，时间戳为12s的事件到达时的Watermark恰好触发窗口2。</p><p> <strong>Watermark 就是触发前一窗口的“关窗时间”，一旦触发关门那么以当前时刻为准在窗口范围内的所有所有数据都会收入窗中。</strong> </p><p> <strong>只要没有达到水位那么不管现实中的时间推进了多久都不会触发关窗。</strong> </p><h3 id="7-3-2-Watermark的特点"><a href="#7-3-2-Watermark的特点" class="headerlink" title="7.3.2 Watermark的特点"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_732-watermark%E7%9A%84%E7%89%B9%E7%82%B9">7.3.2 Watermark的特点</a></h3><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106363815">Flink-时间语义与Wartmark及EventTime在Window中的使用</a></p></blockquote><p><img src="https://img-blog.csdnimg.cn/20200526204111817.png"></p><ul><li><p>  watermark 是一条特殊的数据记录</p></li><li><p>  <strong>watermark 必须单调递增</strong>，以确保任务的事件时间时钟在向前推进，而不是在后退</p></li><li><p>  watermark 与数据的时间戳相关</p></li></ul><h3 id="7-3-3-Watermark的传递"><a href="#7-3-3-Watermark的传递" class="headerlink" title="7.3.3 Watermark的传递"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_733-watermark%E7%9A%84%E4%BC%A0%E9%80%92">7.3.3 Watermark的传递</a></h3><p><img src="https://img-blog.csdnimg.cn/20200526204125805.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ol><li> 图一，当前Task有四个上游Task给自己传输WaterMark信息，通过比较，只取当前最小值作为自己的本地Event-time clock，上图中，当前Task[0,2)的桶就可关闭了，因为所有上游中2s最小，能保证2s的WaterMark是准确的（所有上游Watermark都已经&gt;=2s)。这时候将Watermark=2广播到当前Task的下游。</li><li> 图二，上游的Watermark持续变动，此时Watermark=3成为新的最小值，更新本地Task的event-time clock，同时将最新的Watermark=3广播到下游</li><li> 图三，上游的Watermark虽然更新了，但是当前最小值还是3，所以不更新event-time clock，也不需要广播到下游</li><li> 图四，和图二同理，更新本地event-time clock，同时向下游广播最新的Watermark=4</li></ol><h3 id="7-3-4-Watermark的引入"><a href="#7-3-4-Watermark的引入" class="headerlink" title="7.3.4 Watermark的引入"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_734-watermark%E7%9A%84%E5%BC%95%E5%85%A5">7.3.4 Watermark的引入</a></h3><p> watermark的引入很简单，对于乱序数据，最常见的引用方式如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">dataStream<span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token class-name">SensorReading</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> **Event Time的使用一定要指定数据源中的时间戳。否则程序无法知道事件的事件时间是什么(数据源里的数据没有时间戳的话，就只能使用Processing Time了)**。</p><p> 我们看到上面的例子中创建了一个看起来有点复杂的类，这个类实现的其实就是分配时间戳的接口。Flink暴露了TimestampAssigner接口供我们实现，使我们可以自定义如何从事件数据中抽取时间戳。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置事件时间语义 env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SensorSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyAssigner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>MyAssigner有两种类型</p><ul><li><p>  AssignerWithPeriodicWatermarks</p></li><li><p>  AssignerWithPunctuatedWatermarks</p></li></ul><p>以上两个接口都继承自TimestampAssigner。</p><h4 id="TimestampAssigner"><a href="#TimestampAssigner" class="headerlink" title="TimestampAssigner"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=timestampassigner">TimestampAssigner</a></h4><h5 id="AssignerWithPeriodicWatermarks"><a href="#AssignerWithPeriodicWatermarks" class="headerlink" title="AssignerWithPeriodicWatermarks"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=assignerwithperiodicwatermarks">AssignerWithPeriodicWatermarks</a></h5><ul><li><p>  周期性的生成 watermark：系统会周期性的将 watermark 插入到流中</p></li><li><p>  默认周期是200毫秒，可以使用 <code>ExecutionConfig.setAutoWatermarkInterval()</code> 方法进行设置</p></li><li><p>  <strong>升序和前面乱序的处理 BoundedOutOfOrderness ，都是基于周期性 watermark 的</strong>。</p></li></ul><h5 id="AssignerWithPunctuatedWatermarks"><a href="#AssignerWithPunctuatedWatermarks" class="headerlink" title="AssignerWithPunctuatedWatermarks"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=assignerwithpunctuatedwatermarks">AssignerWithPunctuatedWatermarks</a></h5><ul><li>  没有时间周期规律，可打断的生成 watermark（即可实现每次获取数据都更新watermark）</li></ul><h3 id="7-3-5-Watermark的设定"><a href="#7-3-5-Watermark的设定" class="headerlink" title="7.3.5 Watermark的设定"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_735-watermark%E7%9A%84%E8%AE%BE%E5%AE%9A">7.3.5 Watermark的设定</a></h3><ul><li>  在Flink中，Watermark由应用程序开发人员生成，这通常需要对相应的领域有一定的了解</li><li>  如果Watermark设置的延迟太久，收到结果的速度可能就会很慢，解决办法是在水位线到达之前输出一个近似结果</li><li>  如果Watermark到达得太早，则可能收到错误结果，不过Flink处理迟到数据的机制可以解决这个问题</li></ul><p> <em>一般大数据场景都是考虑高并发情况，所以一般使用周期性生成Watermark的方式，避免频繁地生成Watermark。</em></p><hr><p><strong>注：一般认为Watermark的设置代码，在里Source步骤越近的地方越合适。</strong> </p><h3 id="7-3-6-测试代码"><a href="#7-3-6-测试代码" class="headerlink" title="7.3.6 测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_736-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81">7.3.6 测试代码</a></h3><p>测试Watermark和迟到数据</p><p>java代码（旧版Flink），新版的代码我暂时不打算折腾，之后用上再说吧。</p><p><strong>这里设置的Watermark的延时时间是2s，实际一般设置和window大小一致。</strong> </p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest3_EventTimeWindow</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Flink1.12.X 已经默认就是使用EventTime了，所以不需要这行代码</span>    <span class="token comment">//        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span>    env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoWatermarkInterval</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// socket文本流</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型，分配时间戳和watermark</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment">//              </span>      <span class="token comment">//                // 旧版 (新版官方推荐用assignTimestampsAndWatermarks(WatermarkStrategy) )</span>      <span class="token comment">// 升序数据设置事件时间和watermark</span>      <span class="token comment">//.assignTimestampsAndWatermarks(new AscendingTimestampExtractor&lt;SensorReading&gt;() {</span>      <span class="token comment">//  @Override</span>      <span class="token comment">//  public long extractAscendingTimestamp(SensorReading element) {</span>      <span class="token comment">//    return element.getTimestamp() * 1000L;</span>      <span class="token comment">//  }</span>      <span class="token comment">//})</span>            <span class="token comment">// 旧版 (新版官方推荐用assignTimestampsAndWatermarks(WatermarkStrategy) )</span>      <span class="token comment">// 乱序数据设置时间戳和watermark</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> outputTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 基于事件时间的开窗聚合，统计15秒内温度的最小值</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> minTempStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">allowedLateness</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">sideOutputLateData</span><span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">minBy</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    minTempStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"minTemp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    minTempStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="并行任务Watermark传递测试"><a href="#并行任务Watermark传递测试" class="headerlink" title="并行任务Watermark传递测试"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%B9%B6%E8%A1%8C%E4%BB%BB%E5%8A%A1watermark%E4%BC%A0%E9%80%92%E6%B5%8B%E8%AF%95">并行任务Watermark传递测试</a></h4><p>在前面代码的基础上，修改执行环境并行度为4，进行测试</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest3_EventTimeWindow</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoWatermarkInterval</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// socket文本流</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型，分配时间戳和watermark</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token comment">// 乱序数据设置时间戳和watermark</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> outputTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 基于事件时间的开窗聚合，统计15秒内温度的最小值</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> minTempStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">allowedLateness</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">sideOutputLateData</span><span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">minBy</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    minTempStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"minTemp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    minTempStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动本地socket，输入数据，查看结果</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nc</span> -lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>输入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718211</span><span class="token punctuation">,</span><span class="token number">34</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">31.9</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">31.9</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">31.9</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">31.9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出</p><p><em>注意：上面输入全部输入后，才突然有下面4条输出！</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">minTemp<span class="token operator">:</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718205</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">38.1</span><span class="token punctuation">}</span>minTemp<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>minTemp<span class="token operator">:</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718202</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">6.7</span><span class="token punctuation">}</span>minTemp<span class="token operator">:</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="分析"><a href="#分析" class="headerlink" title="分析"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%88%86%E6%9E%90">分析</a></h5><ol><li><p><strong>计算窗口起始位置Start和结束位置End</strong></p><p>从<code>TumblingProcessingTimeWindows</code>类里的<code>assignWindows</code>方法，我们可以得知窗口的起点计算方法如下： $$ 窗口起点start = timestamp - (timestamp -offset+WindowSize) % WindowSize $$ 由于我们没有设置offset，所以这里<code>start=第一个数据的时间戳1547718199-(1547718199-0+15)%15=1547718195</code></p><p>计算得到窗口初始位置为<code>Start = 1547718195</code>，那么这个窗口理论上本应该在1547718195+15的位置关闭，也就是<code>End=1547718210</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token function">assignWindows</span><span class="token punctuation">(</span>  <span class="token class-name">Object</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">WindowAssignerContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getCurrentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>staggerOffset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    staggerOffset <span class="token operator">=</span>      windowStagger<span class="token punctuation">.</span><span class="token function">getStaggerOffset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurrentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">long</span> start <span class="token operator">=</span>    <span class="token class-name">TimeWindow</span><span class="token punctuation">.</span><span class="token function">getWindowStartWithOffset</span><span class="token punctuation">(</span>    now<span class="token punctuation">,</span> <span class="token punctuation">(</span>globalOffset <span class="token operator">+</span> staggerOffset<span class="token punctuation">)</span> <span class="token operator">%</span> size<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 跟踪 getWindowStartWithOffset 方法得到TimeWindow的方法</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getWindowStartWithOffset</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> windowSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> timestamp <span class="token operator">-</span> <span class="token punctuation">(</span>timestamp <span class="token operator">-</span> offset <span class="token operator">+</span> windowSize<span class="token punctuation">)</span> <span class="token operator">%</span> windowSize<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>计算修正后的Window输出结果的时间</strong></p><p>测试代码中Watermark设置的<code>maxOutOfOrderness</code>最大乱序程度是2s，所以实际获取到End+2s的时间戳数据时（达到Watermark），才认为Window需要输出计算的结果（不关闭，因为设置了允许迟到1min）</p><p><strong>所以实际应该是1547718212的数据到来时才触发Window输出计算结果。</strong> </p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// BoundedOutOfOrdernessTimestampExtractor.java</span><span class="token keyword">public</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">(</span><span class="token class-name">Time</span> maxOutOfOrderness<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>maxOutOfOrderness<span class="token punctuation">.</span><span class="token function">toMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>      <span class="token string">"Tried to set the maximum allowed "</span>      <span class="token operator">+</span> <span class="token string">"lateness to "</span>      <span class="token operator">+</span> maxOutOfOrderness      <span class="token operator">+</span> <span class="token string">". This parameter cannot be negative."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>maxOutOfOrderness <span class="token operator">=</span> maxOutOfOrderness<span class="token punctuation">.</span><span class="token function">toMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>currentMaxTimestamp <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MIN_VALUE <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxOutOfOrderness<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Watermark</span> <span class="token function">getCurrentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// this guarantees that the watermark never goes backwards.</span>  <span class="token keyword">long</span> potentialWM <span class="token operator">=</span> currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>potentialWM <span class="token operator">&gt;=</span> lastEmittedWatermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>    lastEmittedWatermark <span class="token operator">=</span> potentialWM<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>lastEmittedWatermark<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>为什么上面输入中，最后连续四条相同输入，才触发Window输出结果？</p><ul><li><p><strong>Watermark会向子任务广播</strong></p><ul><li>  我们在map才设置Watermark，map根据Rebalance轮询方式分配数据。所以前4个输入分别到4个slot中，4个slot计算得出的Watermark不同（分别是1547718199-2，1547718201-2，1547718202-2，1547718205-2）</li></ul></li><li><p><strong>Watermark传递时，会选择当前接收到的最小一个作为自己的Watermark</strong></p><ul><li>  前4次输入中，有些map子任务还没有接收到数据，所以其下游的keyBy后的slot里watermark就是<code>Long.MIN_VALUE</code>（因为4个上游的Watermark广播最小值就是默认的<code>Long.MIN_VALUE</code>）</li><li>  并行度4，在最后4个相同的输入，使得Rebalance到4个map子任务的数据的<code>currentMaxTimestamp</code>都是1547718212，经过<code>getCurrentWatermark()</code>的计算（<code>currentMaxTimestamp-maxOutOfOrderness</code>），4个子任务都计算得到watermark=1547718210，4个map子任务向4个keyBy子任务广播<code>watermark=1547718210</code>，使得keyBy子任务们获取到4个上游的Watermark最小值就是1547718210，然后4个KeyBy子任务都更新自己的Watermark为1547718210。</li></ul></li><li><p>  <strong>根据Watermark的定义，我们认为&gt;=Watermark的数据都已经到达。由于此时watermark &gt;= 窗口End，所以Window输出计算结果（4个子任务，4个结果）。</strong> </p></li></ul></li></ol><h3 id="7-3-7-窗口起始点和偏移量"><a href="#7-3-7-窗口起始点和偏移量" class="headerlink" title="7.3.7 窗口起始点和偏移量"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_737-%E7%AA%97%E5%8F%A3%E8%B5%B7%E5%A7%8B%E7%82%B9%E5%92%8C%E5%81%8F%E7%A7%BB%E9%87%8F">7.3.7 窗口起始点和偏移量</a></h3><blockquote><p><a href="https://juejin.cn/post/6844904110941011976">flink-Window Assingers(窗口分配器)中offset偏移量</a></p></blockquote><p> 时间偏移一个很大的用处是用来调准非0时区的窗口，例如:在中国你需要指定一个8小时的时间偏移。</p><blockquote><p><a href="https://blog.csdn.net/dongkang123456/article/details/108430338">Flink_Flink中的状态</a></p><p><a href="https://zhuanlan.zhihu.com/p/104171679">Flink状态管理详解：Keyed State和Operator List State深度解析</a> &lt;= 不错的文章，建议阅读</p></blockquote><ul><li>  算子状态（Operator State）</li><li>  键控状态（Keyed State）</li><li>  状态后端（State Backends）</li></ul><h2 id="8-1-状态概述"><a href="#8-1-状态概述" class="headerlink" title="8.1 状态概述"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_81-%E7%8A%B6%E6%80%81%E6%A6%82%E8%BF%B0">8.1 状态概述</a></h2><p><img src="https://img-blog.csdnimg.cn/20200906125916475.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><ul><li>  由一个任务维护，并且用来计算某个结果的所有数据，都属于这个任务的状态</li><li>  可以认为任务状态就是一个本地变量，可以被任务的业务逻辑访问</li><li>  <strong>Flink 会进行状态管理，包括状态一致性、故障处理以及高效存储和访问，以便于开发人员可以专注于应用程序的逻辑</strong></li></ul><hr><ul><li>  <strong>在Flink中，状态始终与特定算子相关联</strong></li><li>  为了使运行时的Flink了解算子的状态，算子需要预先注册其状态</li></ul><p><strong>总的来说，有两种类型的状态：</strong> </p><ul><li><strong>算子状态（Operator State）</strong><ul><li>  算子状态的作用范围限定为<strong>算子任务</strong>（也就是不能跨任务访问）</li></ul></li><li><strong>键控状态（Keyed State）</strong><ul><li>  根据输入数据流中定义的键（key）来维护和访问</li></ul></li></ul><h2 id="8-2-算子状态-Operator-State"><a href="#8-2-算子状态-Operator-State" class="headerlink" title="8.2 算子状态 Operator State"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_82-%E7%AE%97%E5%AD%90%E7%8A%B6%E6%80%81-operator-state">8.2 算子状态 Operator State</a></h2><p><img src="https://img-blog.csdnimg.cn/20200906173949148.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><ul><li><p>  算子状态的作用范围限定为算子任务，同一并行任务所处理的所有数据都可以访问到相同的状态。</p></li><li><p>  状态对于<strong>同一任务</strong>而言是共享的。（<strong>不能跨slot</strong>）</p></li><li><p>  状态算子不能由相同或不同算子的另一个任务访问。</p></li></ul><h3 id="算子状态数据结构"><a href="#算子状态数据结构" class="headerlink" title="算子状态数据结构"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E7%AE%97%E5%AD%90%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">算子状态数据结构</a></h3><ul><li><p>列表状态(List state)</p><ul><li>  将状态表示为一组数据的列表</li></ul></li><li><p>联合列表状态(Union list state)</p><ul><li>  也将状态表示未数据的列表。它与常规列表状态的区别在于，在发生故障时，或者从保存点(savepoint)启动应用程序时如何恢复</li></ul></li><li><p>广播状态(Broadcast state)</p><ul><li>  如果一个算子有多项任务，而它的每项任务状态又都相同，那么这种特殊情况最适合应用广播状态</li></ul></li></ul><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81">测试代码</a></h3><p>实际一般用算子状态比较少，一般还是键控状态用得多一点。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>state</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>checkpoint<span class="token punctuation">.</span></span><span class="token class-name">ListCheckpointed</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/2 4:05 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateTest1_OperatorState</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// socket文本流</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 定义一个有状态的map操作，统计当前分区数据个数</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyCountMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义MapFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyCountMapper</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ListCheckpointed</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义一个本地变量，作为算子状态</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      count<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> count<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">snapshotState</span><span class="token punctuation">(</span><span class="token keyword">long</span> checkpointId<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">restoreState</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> state<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> num <span class="token operator">:</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>        count <span class="token operator">+=</span> num<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输入(本地开启socket后输入)</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">1</span><span class="token number">2</span><span class="token number">3</span><span class="token number">4</span><span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="8-3-键控状态-Keyed-State"><a href="#8-3-键控状态-Keyed-State" class="headerlink" title="8.3 键控状态 Keyed State"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_83-%E9%94%AE%E6%8E%A7%E7%8A%B6%E6%80%81-keyed-state">8.3 键控状态 Keyed State</a></h2><blockquote><p><a href="https://blog.csdn.net/dongkang123456/article/details/108430338">Flink_Flink中的状态</a></p></blockquote><p><img src="https://img-blog.csdnimg.cn/20200906182710217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><ul><li><p>  键控状态是根据输入数据流中定义的键（key）来维护和访问的。</p></li><li><p>  <strong>Flink 为每个key维护一个状态实例，并将具有相同键的所有数据，都分区到同一个算子任务中，这个任务会维护和处理这个key对应的状态。</strong> </p></li><li><p>  <strong>当任务处理一条数据时，他会自动将状态的访问范围限定为当前数据的key</strong>。</p></li></ul><h3 id="键控状态数据结构"><a href="#键控状态数据结构" class="headerlink" title="键控状态数据结构"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E9%94%AE%E6%8E%A7%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">键控状态数据结构</a></h3><ul><li><p>值状态(value state)</p><ul><li>  将状态表示为单个的值</li></ul></li><li><p>列表状态(List state)</p><ul><li>  将状态表示为一组数据的列表</li></ul></li><li><p>映射状态(Map state)</p><ul><li>  将状态表示为一组key-value对</li></ul></li><li><p><strong>聚合状态(Reducing state &amp; Aggregating State)</strong></p><ul><li>  将状态表示为一个用于聚合操作的列表</li></ul></li></ul><h3 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-1">测试代码</a></h3><p><img src="https://img-blog.csdnimg.cn/20200906183806458.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RvbmdrYW5nMTIzNDU2,size_16,color_FFFFFF,t_70#pic_center"></p><p><em>注：声明一个键控状态，一般在算子的open()中声明，因为运行时才能获取上下文信息</em></p><ul><li><p>java测试代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>state</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">RichMapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/2 5:41 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateTest2_KeyedState</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度 = 1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从本地socket读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 使用自定义map方法，里面使用 我们自定义的Keyed State</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> dataStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义map富函数，测试 键控状态</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyMapper</span> <span class="token keyword">extends</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>    <span class="token comment">//        Exception in thread "main" java.lang.IllegalStateException: The runtime context has not been initialized.</span>    <span class="token comment">//        ValueState&lt;Integer&gt; valueState = getRuntimeContext().getState(new ValueStateDescriptor&lt;Integer&gt;("my-int", Integer.class));</span>    <span class="token keyword">private</span> <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> valueState<span class="token punctuation">;</span>    <span class="token comment">// 其它类型状态的声明</span>    <span class="token keyword">private</span> <span class="token class-name">ListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> myListState<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">MapState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> myMapState<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">ReducingState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> myReducingState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      valueState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"my-int"</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      myListState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getListState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"my-list"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      myMapState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"my-map"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//            myReducingState = getRuntimeContext().getReducingState(new ReducingStateDescriptor&lt;SensorReading&gt;())</span>    <span class="token punctuation">}</span>    <span class="token comment">// 这里就简单的统计每个 传感器的 信息数量</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 其它状态API调用</span>      <span class="token comment">// list state</span>      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token operator">:</span> myListState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      myListState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// map state</span>      myMapState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      myMapState<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token number">12.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      myMapState<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// reducing state</span>      <span class="token comment">//            myReducingState.add(value);</span>      myMapState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Integer</span> count <span class="token operator">=</span> valueState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 第一次获取是null，需要判断</span>      count <span class="token operator">=</span> count<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">?</span><span class="token number">0</span><span class="token operator">:</span>count<span class="token punctuation">;</span>      <span class="token operator">++</span>count<span class="token punctuation">;</span>      valueState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> count<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="场景测试"><a href="#场景测试" class="headerlink" title="场景测试"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%9C%BA%E6%99%AF%E6%B5%8B%E8%AF%95">场景测试</a></h3><p>假设做一个温度报警，如果一个传感器前后温差超过10度就报警。这里使用键控状态Keyed State + flatMap来实现</p><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>state</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">RichFlatMapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple3</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/2 6:37 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateTest3_KeyedStateApplicationCase</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度 = 1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从socket获取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换为SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyFlatMapper</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 如果 传感器温度 前后差距超过指定温度(这里指定10.0),就报警</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyFlatMapper</span> <span class="token keyword">extends</span> <span class="token class-name">RichFlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 报警的温差阈值</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Double</span> threshold<span class="token punctuation">;</span>    <span class="token comment">// 记录上一次的温度</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> lastTemperature<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">MyFlatMapper</span><span class="token punctuation">(</span><span class="token class-name">Double</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> threshold<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 从运行时上下文中获取keyedState</span>      lastTemperature <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"last-temp"</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 手动释放资源</span>      lastTemperature<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">Double</span> lastTemp <span class="token operator">=</span> lastTemperature<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Double</span> curTemp <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 如果不为空，判断是否温差超过阈值，超过则报警</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTemp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>curTemp <span class="token operator">-</span> lastTemp<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lastTemp<span class="token punctuation">,</span> curTemp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token comment">// 更新保存的"上一次温度"</span>      lastTemperature<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>curTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动socket</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nc</span> -lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>输入数据，查看结果</p><ul><li><p>输入</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">32.4</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">42.4</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">52.6</span>   sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">22.5</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">9.9</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">19.9</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><p><em>中间没有输出（sensor_7,9.9,19.9)，应该是double浮点数计算精度问题，不管它</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">(</span>sensor_1<span class="token punctuation">,</span><span class="token number">32.4</span><span class="token punctuation">,</span><span class="token number">42.4</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sensor_10<span class="token punctuation">,</span><span class="token number">52.6</span><span class="token punctuation">,</span><span class="token number">22.5</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sensor_7<span class="token punctuation">,</span><span class="token number">19.9</span><span class="token punctuation">,</span><span class="token number">30.0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><h2 id="8-4-状态后端-State-Backends"><a href="#8-4-状态后端-State-Backends" class="headerlink" title="8.4 状态后端 State Backends"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_84-%E7%8A%B6%E6%80%81%E5%90%8E%E7%AB%AF-state-backends">8.4 状态后端 State Backends</a></h2><blockquote><p><a href="https://blog.csdn.net/dongkang123456/article/details/108430338">Flink_Flink中的状态</a></p></blockquote><h3 id="8-4-1-概述"><a href="#8-4-1-概述" class="headerlink" title="8.4.1 概述"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_841-%E6%A6%82%E8%BF%B0">8.4.1 概述</a></h3><ul><li><p>  每传入一条数据，有状态的算子任务都会读取和更新状态。</p></li><li><p>  由于有效的状态访问对于处理数据的低延迟至关重要，因此每个并行任务都会在本地维护其状态，以确保快速的状态访问。</p></li><li><p>  状态的存储、访问以及维护，由一个可插入的组件决定，这个组件就叫做<strong>状态后端( state backend)</strong></p></li><li><p>  <strong>状态后端主要负责两件事：本地状态管理，以及将检查点(checkPoint)状态写入远程存储</strong></p></li></ul><h3 id="8-4-2-选择一个状态后端"><a href="#8-4-2-选择一个状态后端" class="headerlink" title="8.4.2 选择一个状态后端"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_842-%E9%80%89%E6%8B%A9%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E5%90%8E%E7%AB%AF">8.4.2 选择一个状态后端</a></h3><ul><li>MemoryStateBackend<ul><li>  内存级的状态后端，会将键控状态作为内存中的对象进行管理，将它们存储在TaskManager的JVM堆上，而将checkpoint存储在JobManager的内存中</li><li>  特点：快速、低延迟，但不稳定</li></ul></li><li>FsStateBackend（默认）<ul><li>  将checkpoint存到远程的持久化文件系统（FileSystem）上，而对于本地状态，跟MemoryStateBackend一样，也会存在TaskManager的JVM堆上</li><li>  同时拥有内存级的本地访问速度，和更好的容错保证</li></ul></li><li>RocksDBStateBackend<ul><li>  将所有状态序列化后，存入本地的RocksDB中存储</li></ul></li></ul><h3 id="8-4-3-配置文件"><a href="#8-4-3-配置文件" class="headerlink" title="8.4.3 配置文件"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_843-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">8.4.3 配置文件</a></h3><p><code>flink-conf.yaml</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">#<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span># <span class="token class-name">Fault</span> tolerance and checkpointing#<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span># <span class="token class-name">The</span> backend that will be used <span class="token keyword">to</span> <span class="token namespace">store</span> operator state checkpoints <span class="token keyword">if</span># checkpointing is enabled<span class="token punctuation">.</span>## <span class="token class-name">Supported</span> backends are 'jobmanager<span class="token char">', '</span>filesystem<span class="token char">', '</span>rocksdb'<span class="token punctuation">,</span> or the# <span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">-</span>of<span class="token operator">-</span>factory<span class="token operator">&gt;</span><span class="token punctuation">.</span>## state<span class="token punctuation">.</span>backend<span class="token operator">:</span> filesystem上面这个就是默认的checkpoint存在filesystem# <span class="token class-name">Directory</span> <span class="token keyword">for</span> checkpoints filesystem<span class="token punctuation">,</span> when using any of the <span class="token keyword">default</span> bundled# state backends<span class="token punctuation">.</span>## state<span class="token punctuation">.</span>checkpoints<span class="token punctuation">.</span>dir<span class="token operator">:</span> hdfs<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>namenode<span class="token operator">-</span>host<span class="token operator">:</span>port<span class="token operator">/</span>flink<span class="token operator">-</span>checkpoints# <span class="token class-name">Default</span> target directory <span class="token keyword">for</span> savepoints<span class="token punctuation">,</span> optional<span class="token punctuation">.</span>## state<span class="token punctuation">.</span>savepoints<span class="token punctuation">.</span>dir<span class="token operator">:</span> hdfs<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>namenode<span class="token operator">-</span>host<span class="token operator">:</span>port<span class="token operator">/</span>flink<span class="token operator">-</span>savepoints# <span class="token class-name">Flag</span> <span class="token keyword">to</span> <span class="token namespace">enable</span><span class="token operator">/</span>disable incremental checkpoints <span class="token keyword">for</span> backends that# support incremental checkpoints <span class="token punctuation">(</span>like the <span class="token class-name">RocksDB</span> state backend<span class="token punctuation">)</span><span class="token punctuation">.</span> ## state<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>incremental<span class="token operator">:</span> <span class="token boolean">false</span># <span class="token class-name">The</span> failover strategy<span class="token punctuation">,</span> i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> how the job computation recovers from task failures<span class="token punctuation">.</span># <span class="token class-name">Only</span> restart tasks that may have been affected by the task failure<span class="token punctuation">,</span> which typically includes# downstream tasks and potentially upstream tasks <span class="token keyword">if</span> their produced data is no longer available <span class="token keyword">for</span> consumption<span class="token punctuation">.</span>jobmanager<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>failover<span class="token operator">-</span>strategy<span class="token operator">:</span> region上面这个region指，多个并行度的任务要是有个挂掉了，只重启那个任务所属的region（可能含有多个子任务），而不需要重启整个<span class="token class-name">Flink</span>程序<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-4-4-样例代码"><a href="#8-4-4-样例代码" class="headerlink" title="8.4.4 样例代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_844-%E6%A0%B7%E4%BE%8B%E4%BB%A3%E7%A0%81">8.4.4 样例代码</a></h3><ul><li><p>其中使用RocksDBStateBackend需要另外加入pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>statebackend<span class="token operator">-</span>rocksdb_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>state</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>restartstrategy<span class="token punctuation">.</span></span><span class="token class-name">RestartStrategies</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">RocksDBStateBackend</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>state<span class="token punctuation">.</span>filesystem<span class="token punctuation">.</span></span><span class="token class-name">FsStateBackend</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">MemoryStateBackend</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/2 11:35 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateTest4_FaultTolerance</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1. 状态后端配置</span>        env<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MemoryStateBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FsStateBackend</span><span class="token punctuation">(</span><span class="token string">"checkpointDataUri"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 这个需要另外导入依赖</span>        env<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RocksDBStateBackend</span><span class="token punctuation">(</span><span class="token string">"checkpointDataUri"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// socket文本流</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 转换成SensorReading类型</span>        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p> 我们之前学习的<strong>转换算子</strong>是无法访问事件的时间戳信息和水位线信息的。而这在一些应用场景下，极为重要。例如MapFunction这样的map转换算子就无法访问时间戳或者当前事件的事件时间。</p><p> 基于此，DataStream API提供了一系列的Low-Level转换算子。可以<strong>访问时间戳</strong>、<strong>watermark</strong>以及<strong>注册定时事件</strong>。还可以输出<strong>特定的一些事件</strong>，例如超时事件等。Process Function用来构建事件驱动的应用以及实现自定义的业务逻辑(使用之前的window函数和转换算子无法实现)。例如，FlinkSQL就是使用Process Function实现的。</p><p>Flink提供了8个Process Function：</p><ul><li>  ProcessFunction</li><li>  KeyedProcessFunction</li><li>  CoProcessFunction</li><li>  ProcessJoinFunction</li><li>  BroadcastProcessFunction</li><li>  KeyedBroadcastProcessFunction</li><li>  ProcessWindowFunction</li><li>  ProcessAllWindowFunction</li></ul><h2 id="9-1-KeyedProcessFunction"><a href="#9-1-KeyedProcessFunction" class="headerlink" title="9.1 KeyedProcessFunction"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_91-keyedprocessfunction">9.1 KeyedProcessFunction</a></h2><p> 这个是相对比较常用的ProcessFunction，根据名字就可以知道是用在keyedStream上的。</p><p> KeyedProcessFunction用来操作KeyedStream。KeyedProcessFunction会处理流的每一个元素，输出为0个、1个或者多个元素。所有的Process Function都继承自RichFunction接口，所以都有<code>open()</code>、<code>close()</code>和<code>getRuntimeContext()</code>等方法。而<code>KeyedProcessFunction&lt;K, I, O&gt;</code>还额外提供了两个方法:</p><ul><li>  <code>processElement(I value, Context ctx, Collector&lt;O&gt; out)</code>，流中的每一个元素都会调用这个方法，调用结果将会放在Collector数据类型中输出。Context可以访问元素的时间戳，元素的 key ，以及TimerService 时间服务。 Context 还可以将结果输出到别的流(side outputs)。</li><li>  <code>onTimer(long timestamp, OnTimerContext ctx, Collector&lt;O&gt; out)</code>，是一个回调函数。当之前注册的定时器触发时调用。参数timestamp 为定时器所设定的触发的时间戳。Collector 为输出结果的集合。OnTimerContext和processElement的Context 参数一样，提供了上下文的一些信息，例如定时器触发的时间信息(事件时间或者处理时间)。</li></ul><h3 id="测试代码-2"><a href="#测试代码-2" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-2">测试代码</a></h3><p>设置一个获取数据后第5s给出提示信息的定时器。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">processfunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 12:30 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProcessTest1_KeyedProcessFunction</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// socket文本流</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 测试KeyedProcessFunction，先分组然后自定义处理</span>    dataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">MyProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的处理函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyProcess</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">,</span> <span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> tsTimerState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      tsTimerState <span class="token operator">=</span>  <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"ts-timer"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// context</span>      <span class="token comment">// Timestamp of the element currently being processed or timestamp of a firing timer.</span>      ctx<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// Get key of the element being processed.</span>      ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//            ctx.output();</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 在5处理时间的5秒延迟后触发</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerProcessingTimeTimer</span><span class="token punctuation">(</span> ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      tsTimerState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//            ctx.timerService().registerEventTimeTimer((value.getTimestamp() + 10) * 1000L);</span>      <span class="token comment">// 删除指定时间触发的定时器</span>      <span class="token comment">//            ctx.timerService().deleteProcessingTimeTimer(tsTimerState.value());</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timestamp <span class="token operator">+</span> <span class="token string">" 定时器触发"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//            ctx.output();</span>      ctx<span class="token punctuation">.</span><span class="token function">timeDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      tsTimerState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动本地socket</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nc</span> -lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>输入</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sensor_1,1547718207,36.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>输出</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token number">8</span><span class="token number">1612283803911</span> 定时器触发<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="9-2-TimerService和定时器-Timers"><a href="#9-2-TimerService和定时器-Timers" class="headerlink" title="9.2 TimerService和定时器(Timers)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_92-timerservice%E5%92%8C%E5%AE%9A%E6%97%B6%E5%99%A8timers">9.2 TimerService和定时器(Timers)</a></h2><p> Context 和OnTimerContext 所持有的TimerService 对象拥有以下方法：</p><ul><li><p>  <code>long currentProcessingTime()</code> 返回当前处理时间</p></li><li><p>  <code>long currentWatermark()</code> 返回当前watermark 的时间戳</p></li><li><p>  <code>void registerProcessingTimeTimer( long timestamp)</code> 会注册当前key的processing time的定时器。当processing time 到达定时时间时，触发timer。</p></li><li><p>  <strong><code>void registerEventTimeTimer(long timestamp)</code> 会注册当前key 的event time 定时器。当Watermark水位线大于等于定时器注册的时间时，触发定时器执行回调函数。</strong> </p></li><li><p>  <code>void deleteProcessingTimeTimer(long timestamp)</code> 删除之前注册处理时间定时器。如果没有这个时间戳的定时器，则不执行。</p></li><li><p>  <code>void deleteEventTimeTimer(long timestamp)</code> 删除之前注册的事件时间定时器，如果没有此时间戳的定时器，则不执行。</p></li><li><p><em>当定时器timer 触发时，会执行回调函数onTimer()。注意定时器timer 只能在keyed streams 上面使用。</em>* </p></li></ul><h3 id="测试代码-3"><a href="#测试代码-3" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-3">测试代码</a></h3><p>下面举个例子说明KeyedProcessFunction 如何操作KeyedStream。</p><p>需求：监控温度传感器的温度值，如果温度值在10 秒钟之内(processing time)连续上升，则报警。</p><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">processfunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 1:02 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProcessTest2_ApplicationCase</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从socket中获取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换数据为SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> sensorReadingStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 如果存在连续10s内温度持续上升的情况，则报警</span>    sensorReadingStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TempConsIncreWarning</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 如果存在连续10s内温度持续上升的情况，则报警</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TempConsIncreWarning</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token class-name">TempConsIncreWarning</span><span class="token punctuation">(</span><span class="token class-name">Long</span> interval<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>interval <span class="token operator">=</span> interval<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 报警的时间间隔(如果在interval时间内温度持续上升，则报警)</span>    <span class="token keyword">private</span> <span class="token class-name">Long</span> interval<span class="token punctuation">;</span>    <span class="token comment">// 上一个温度值</span>    <span class="token keyword">private</span> <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> lastTemperature<span class="token punctuation">;</span>    <span class="token comment">// 最近一次定时器的触发时间(报警时间)</span>    <span class="token keyword">private</span> <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> recentTimerTimeStamp<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      lastTemperature <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"lastTemperature"</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      recentTimerTimeStamp <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"recentTimerTimeStamp"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      lastTemperature<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      recentTimerTimeStamp<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 当前温度值</span>      <span class="token keyword">double</span> curTemp <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 上一次温度(没有则设置为当前温度)</span>      <span class="token keyword">double</span> lastTemp <span class="token operator">=</span> lastTemperature<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> lastTemperature<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> curTemp<span class="token punctuation">;</span>      <span class="token comment">// 计时器状态值(时间戳)</span>      <span class="token class-name">Long</span> timerTimestamp <span class="token operator">=</span> recentTimerTimeStamp<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 如果 当前温度 &gt; 上次温度 并且 没有设置报警计时器，则设置</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>curTemp <span class="token operator">&gt;</span> lastTemp <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span> <span class="token operator">==</span> timerTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> warningTimestamp <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> interval<span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerProcessingTimeTimer</span><span class="token punctuation">(</span>warningTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>        recentTimerTimeStamp<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>warningTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 如果 当前温度 &lt; 上次温度，且 设置了报警计时器，则清空计时器</span>      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curTemp <span class="token operator">&lt;=</span> lastTemp <span class="token operator">&amp;&amp;</span> timerTimestamp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteProcessingTimeTimer</span><span class="token punctuation">(</span>timerTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>        recentTimerTimeStamp<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 更新保存的温度值</span>      lastTemperature<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>curTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 定时器任务</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 触发报警，并且清除 定时器状态值</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token string">"传感器"</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"温度值连续"</span> <span class="token operator">+</span> interval <span class="token operator">+</span> <span class="token string">"ms上升"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      recentTimerTimeStamp<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动本地socket，之后输入数据</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nc</span> -lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>输入</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">34.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">34.2</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.1</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">39</span>  sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">18</span>  sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">9.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">传感器sensor_1温度值连续<span class="token number">10000</span>ms上升传感器sensor_10温度值连续<span class="token number">10000</span>ms上升传感器sensor_6温度值连续<span class="token number">10000</span>ms上升传感器sensor_7温度值连续<span class="token number">10000</span>ms上升<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><h2 id="9-3-侧输出流（SideOutput）"><a href="#9-3-侧输出流（SideOutput）" class="headerlink" title="9.3 侧输出流（SideOutput）"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_93-%E4%BE%A7%E8%BE%93%E5%87%BA%E6%B5%81%EF%BC%88sideoutput%EF%BC%89">9.3 侧输出流（SideOutput）</a></h2><ul><li>  <strong>一个数据可以被多个window包含，只有其不被任何window包含的时候(包含该数据的所有window都关闭之后)，才会被丢到侧输出流。</strong> </li><li>  <strong>简言之，如果一个数据被丢到侧输出流，那么所有包含该数据的window都由于已经超过了”允许的迟到时间”而关闭了，进而新来的迟到数据只能被丢到侧输出流！</strong></li></ul><hr><ul><li><p>  大部分的DataStream API 的算子的输出是单一输出，也就是某种数据类型的流。除了split 算子，可以将一条流分成多条流，这些流的数据类型也都相同。</p></li><li><p>  <strong>processfunction 的side outputs 功能可以产生多条流，并且这些流的数据类型可以不一样。</strong> </p></li><li><p>  一个side output 可以定义为OutputTag[X]对象，X 是输出流的数据类型。</p></li><li><p>  processfunction 可以通过Context 对象发射一个事件到一个或者多个side outputs。</p></li></ul><h3 id="测试代码-4"><a href="#测试代码-4" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-4">测试代码</a></h3><p>场景：温度&gt;=30放入高温流输出，反之放入低温流输出</p><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">processfunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">ProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">OutputTag</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 2:07 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProcessTest3_SideOuptCase</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度 = 1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从本地socket读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 定义一个OutputTag，用来表示侧输出流低温流</span>    <span class="token comment">// An OutputTag must always be an anonymous inner class</span>    <span class="token comment">// so that Flink can derive a TypeInformation for the generic type parameter.</span>    <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> lowTempTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"lowTemp"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 测试ProcessFunction，自定义侧输出流实现分流操作</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> highTempStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">,</span> <span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">// 判断温度，大于30度，高温流输出到主流；小于低温流输出到侧输出流</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>lowTempTag<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    highTempStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"high-temp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    highTempStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>lowTempTag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"low-temp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>本地启动socket</p><ul><li><p>输入</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">high<span class="token operator">-</span>temp<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_1'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718199</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">35.8</span><span class="token punctuation">}</span>low<span class="token operator">-</span>temp<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718201</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">15.4</span><span class="token punctuation">}</span>low<span class="token operator">-</span>temp<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718202</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">6.7</span><span class="token punctuation">}</span>high<span class="token operator">-</span>temp<span class="token operator">&gt;</span> <span class="token class-name">SensorReading</span><span class="token punctuation">{</span>id<span class="token operator">=</span>'sensor_10'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1547718205</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">38.1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><h2 id="9-4-CoProcessFunction"><a href="#9-4-CoProcessFunction" class="headerlink" title="9.4 CoProcessFunction"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_94-coprocessfunction">9.4 CoProcessFunction</a></h2><ul><li><p>  对于两条输入流，DataStream API 提供了CoProcessFunction 这样的low-level操作。CoProcessFunction 提供了操作每一个输入流的方法: <code>processElement1()</code>和<code>processElement2()</code>。</p></li><li><p>  <strong>类似于ProcessFunction，这两种方法都通过Context 对象来调用</strong>。这个Context对象可以访问事件数据，定时器时间戳，TimerService，以及side outputs。</p></li><li><p>  <strong>CoProcessFunction 也提供了onTimer()回调函数</strong>。</p></li></ul><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106433621">Flink-容错机制 | 一致性检查点 | 检查点到恢复状态过程 | Flink检查点算法(Chandy-Lamport) | 算法操作解析 | 保存点简介</a></p></blockquote><h2 id="10-1-一致性检查点-checkpoint"><a href="#10-1-一致性检查点-checkpoint" class="headerlink" title="10.1 一致性检查点(checkpoint)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_101-%E4%B8%80%E8%87%B4%E6%80%A7%E6%A3%80%E6%9F%A5%E7%82%B9checkpoint">10.1 一致性检查点(checkpoint)</a></h2><p><img src="https://img-blog.csdnimg.cn/2020052922013278.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>Flink 故障恢复机制的核心，就是应用状态的一致性检查点</p></li><li><p>有状态流应用的一致检查点，其实就是<strong>所有任务的状态</strong>，在某个时间点的一份拷贝（一份快照）；<strong>这个时间点，应该是所有任务都恰好处理完一个相同的输入数据的时候</strong></p><p><em>(5这个数据虽然进了奇数流但是偶数流也应该做快照，因为属于同一个相同数据，只是没有被他处理)</em></p><p><em>（这里根据奇偶性分流，偶数流求偶数和，奇数流求奇数和，5这里明显已经被sum_odd（1+3+5）处理了，且sum_even不需要处理该数据，因为前面已经判断该数据不需要到sum_even流，相当于所有任务都已经处理完source的数据5了。）</em></p></li><li><p>在JobManager中也有个Chechpoint的指针，指向了仓库的状态快照的一个拓扑图，为以后的数据故障恢复做准备</p></li></ul><h2 id="10-2-从检查点恢复状态"><a href="#10-2-从检查点恢复状态" class="headerlink" title="10.2 从检查点恢复状态"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_102-%E4%BB%8E%E6%A3%80%E6%9F%A5%E7%82%B9%E6%81%A2%E5%A4%8D%E7%8A%B6%E6%80%81">10.2 从检查点恢复状态</a></h2><p><img src="https://img-blog.csdnimg.cn/20200529220326395.png"></p><ul><li><p>在执行流应用程序期间，Flink 会定期保存状态的一致检查点</p></li><li><p>如果发生故障， Flink 将会使用最近的检查点来一致恢复应用程序的状态，并重新启动处理流程</p><p>（<strong>如图中所示，7这个数据被source读到了，准备传给奇数流时，奇数流宕机了，数据传输发生中断</strong>）</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200529220452315.png"></p><ul><li><p>遇到故障之后，第一步就是重启应用</p><p>(<strong>重启后，起初流都是空的</strong>)</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200529220546658.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>第二步是从 checkpoint 中读取状态，将状态重置</p><p><em>(<strong>读取在远程仓库</strong>(Storage，这里的仓库指状态后端保存数据指定的三种方式之一)<strong>保存的状态</strong>)</em></p></li><li><p>从检查点重新启动应用程序后，其内部状态与检查点完成时的状态完全相同</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200529220850257.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>第三步：开始消费并处理检查点到发生故障之间的所有数据</p></li><li><p><strong>这种检查点的保存和恢复机制可以为应用程序状态提供“精确一次”（exactly-once）的一致性，因为所有算子都会保存检查点并恢复其所有状态，这样一来所有的输入流就都会被重置到检查点完成时的位置</strong></p><p><em>（这里要求source源也能记录状态，回退到读取数据7的状态，kafka有相应的偏移指针能完成该操作）</em></p></li></ul><h2 id="10-3-Flink检查点算法"><a href="#10-3-Flink检查点算法" class="headerlink" title="10.3 Flink检查点算法"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_103-flink%E6%A3%80%E6%9F%A5%E7%82%B9%E7%AE%97%E6%B3%95">10.3 Flink检查点算法</a></h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%A6%82%E8%BF%B0">概述</a></h3><p><strong>checkpoint和Watermark一样，都会以广播的形式告诉所有下游。</strong> </p><hr><ul><li><p>一种简单的想法</p><p>暂停应用，保存状态到检查点，再重新恢复应用（当然Flink 不是采用这种简单粗暴的方式）</p></li><li><p>Flink的改进实现</p><ul><li>  基于Chandy-Lamport算法的分布式快照</li><li>  将检查点的保存和数据处理分离开，不暂停整个应用</li></ul><p>（就是每个任务单独拍摄自己的快照到内存，之后再到jobManager整合）</p></li></ul><hr><ul><li><p>检查点分界线（Checkpoint Barrier）</p><ul><li>  Flink的检查点算法用到了一种称为分界线（barrier）的特殊数据形式，用来把一条流上数据按照不同的检查点分开</li><li>  <strong>分界线之前到来的数据导致的状态更改，都会被包含在当前分界线所属的检查点中；而基于分界线之后的数据导致的所有更改，就会被包含在之后的检查点中</strong></li></ul></li></ul><h3 id="具体讲解"><a href="#具体讲解" class="headerlink" title="具体讲解"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%85%B7%E4%BD%93%E8%AE%B2%E8%A7%A3">具体讲解</a></h3><p><img src="https://img-blog.csdnimg.cn/20200529224034243.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>  现在是一个有两个输入流的应用程序，用并行的两个 Source 任务来读取</p></li><li><p>  两条自然数数据流，蓝色数据流已经输出完<code>蓝3</code>了，黄色数据流输出完<code>黄4</code>了</p></li><li><p>  在Souce端 Source1 接收到了数据<code>蓝3</code> 正在往下游发向一个数据<code>蓝2 和 蓝3</code>； Source2 接受到了数据<code>黄4</code>，且往下游发送数据<code>黄4</code></p></li><li><p>  偶数流已经处理完<code>黄2</code> 所以后面显示为2， 奇数流处理完<code>蓝1 和 黄1 黄3</code> 所以为5，并分别往下游发送每次聚合后的结果给Sink</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200529224517502.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p><strong>JobManager 会向每个 source 任务发送一条带有新检查点 ID 的消息</strong>，通过这种方式来启动检查点</p><p><em>（这个带有新检查点ID的东西为<strong>barrier</strong>，由图中三角型表示，数值2只是ID）</em></p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200529224705177.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  数据源将它们的状态写入检查点，并发出一个检查点barrier</li><li>  状态后端在状态存入检查点之后，会返回通知给source任务，source任务就会向JobManager确认检查点完成</li></ul><p> <em>上图，在Source端接受到barrier后，将自己此身的3 和 4 的数据的状态写入检查点，且向JobManager发送checkpoint成功的消息，然后向下游分别发出一个检查点 barrier</em></p><p> <em>可以看出在Source接受barrier时，数据流也在不断的处理，不会进行中断</em></p><p> <em>此时的偶数流已经处理完<code>蓝2</code>变成了4，但是还没处理到<code>黄4</code>，只是下游sink发送了一个数据4，而奇数流已经处理完<code>蓝3</code>变成了8（黄1+蓝1+黄3+蓝3），并向下游sink发送了8</em></p><p> <em>此时检查点barrier都还未到Sum_odd奇数流和Sum_even偶数流</em></p><p><img src="https://img-blog.csdnimg.cn/20200529225235834.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  <strong>分界线对齐：barrier向下游传递，sum任务会等待所有输入分区的barrier到达</strong></li><li>  <strong>对于barrier已经达到的分区，继续到达的数据会被缓存</strong></li><li>  <strong>而barrier尚未到达的分区，数据会被正常处理</strong></li></ul><p> <em>此时蓝色流的barrier先一步抵达了偶数流，黄色的barrier还未到，但是因为数据的不中断一直处理，此时的先到的蓝色的barrier会将此时的偶数流的数据4进行缓存处理，流接着处理接下来的数据等待着黄色的barrier的到来，而黄色barrier之前的数据将会对缓存的数据相加</em></p><p> <em>这次处理的总结：<strong>分界线对齐</strong>：<strong>barrier 向下游传递，sum 任务会等待所有输入分区的 barrier 到达，对于barrier已经到达的分区，继续到达的数据会被缓存。而barrier尚未到达的分区，数据会被正常处理</strong></em></p><p><img src="https://img-blog.csdnimg.cn/20200529225656902.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  <strong>当收到所有输入分区的 barrier 时，任务就将其状态保存到状态后端的检查点中，然后将 barrier 继续向下游转发</strong></li></ul><p> <em>当蓝色的barrier和黄色的barrier(所有分区的)都到达后，进行状态保存到远程仓库，<strong>然后对JobManager发送消息，说自己的检查点保存完毕了</strong></em></p><p> <em>此时的偶数流和奇数流都为8</em></p><p><img src="https://img-blog.csdnimg.cn/20200529230413317.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  向下游转发检查点 barrier 后，任务继续正常的数据处理</li></ul><p><img src="https://img-blog.csdnimg.cn/2020052923042436.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  <strong>Sink 任务向 JobManager 确认状态保存到 checkpoint 完毕</strong></li><li>  <strong>当所有任务都确认已成功将状态保存到检查点时，检查点就真正完成了</strong></li></ul><h2 id="10-4-保存点-Savepoints"><a href="#10-4-保存点-Savepoints" class="headerlink" title="10.4 保存点(Savepoints)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_104-%E4%BF%9D%E5%AD%98%E7%82%B9savepoints">10.4 保存点(Savepoints)</a></h2><p><strong>CheckPoint为自动保存，SavePoint为手动保存</strong></p><ul><li>  Flink还提供了可以自定义的镜像保存功能，就是保存点（save points）</li><li>  原则上，创建保存点使用的算法与检查点完全相同，因此保存点可以认为就是具有一些额外元数据的检查点</li><li>  Flink不会自动创建保存点，因此用户（或者外部调度程序）必须明确地触发创建操作</li><li>  保存点是一个强大的功能。除了故障恢复外，保存点可以用于：有计划的手动备份、更新应用程序、版本迁移、暂停和重启程序，等等</li></ul><h2 id="10-5-检查点和重启策略配置"><a href="#10-5-检查点和重启策略配置" class="headerlink" title="10.5 检查点和重启策略配置"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_105-%E6%A3%80%E6%9F%A5%E7%82%B9%E5%92%8C%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5%E9%85%8D%E7%BD%AE">10.5 检查点和重启策略配置</a></h2><ul><li><p>java样例代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>state</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>restartstrategy<span class="token punctuation">.</span></span><span class="token class-name">RestartStrategies</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">RocksDBStateBackend</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>state<span class="token punctuation">.</span>filesystem<span class="token punctuation">.</span></span><span class="token class-name">FsStateBackend</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">MemoryStateBackend</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/2 11:35 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateTest4_FaultTolerance</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 状态后端配置</span>    env<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MemoryStateBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FsStateBackend</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 这个需要另外导入依赖</span>    env<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RocksDBStateBackend</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 检查点配置 (每300ms让jobManager进行一次checkpoint检查)</span>    env<span class="token punctuation">.</span><span class="token function">enableCheckpointing</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 高级选项</span>    env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCheckpointingMode</span><span class="token punctuation">(</span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Checkpoint的处理超时时间</span>    env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCheckpointTimeout</span><span class="token punctuation">(</span><span class="token number">60000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 最大允许同时处理几个Checkpoint(比如上一个处理到一半，这里又收到一个待处理的Checkpoint事件)</span>    env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxConcurrentCheckpoints</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 与上面setMaxConcurrentCheckpoints(2) 冲突，这个时间间隔是 当前checkpoint的处理完成时间与接收最新一个checkpoint之间的时间间隔</span>    env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMinPauseBetweenCheckpoints</span><span class="token punctuation">(</span><span class="token number">100L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 如果同时开启了savepoint且有更新的备份，是否倾向于使用更老的自动备份checkpoint来恢复，默认false</span>    env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPreferCheckpointForRecovery</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 最多能容忍几次checkpoint处理失败（默认0，即checkpoint处理失败，就当作程序执行异常）</span>    env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTolerableCheckpointFailureNumber</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 重启策略配置</span>    <span class="token comment">// 固定延迟重启(最多尝试3次，每次间隔10s)</span>    env<span class="token punctuation">.</span><span class="token function">setRestartStrategy</span><span class="token punctuation">(</span><span class="token class-name">RestartStrategies</span><span class="token punctuation">.</span><span class="token function">fixedDelayRestart</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 失败率重启(在10分钟内最多尝试3次，每次至少间隔1分钟)</span>    env<span class="token punctuation">.</span><span class="token function">setRestartStrategy</span><span class="token punctuation">(</span><span class="token class-name">RestartStrategies</span><span class="token punctuation">.</span><span class="token function">failureRateRestart</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// socket文本流</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 转换成SensorReading类型</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="10-6-状态一致性"><a href="#10-6-状态一致性" class="headerlink" title="10.6 状态一致性"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_106-%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7">10.6 状态一致性</a></h2><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106445029">Flink-状态一致性 | 状态一致性分类 | 端到端状态一致性 | 幂等写入 | 事务写入 | WAL | 2PC</a></p></blockquote><h3 id="10-6-1-概述"><a href="#10-6-1-概述" class="headerlink" title="10.6.1 概述"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1061-%E6%A6%82%E8%BF%B0">10.6.1 概述</a></h3><p><img src="https://img-blog.csdnimg.cn/20200530181851687.png"></p><ul><li><p>  有状态的流处理，内部每个算子任务都可以有自己的状态</p></li><li><p>  对于流处理器内部来说，所谓的状态一致性，其实就是我们所说的计算结果要保证准确。</p></li><li><p>  一条数据不应该丢失，也不应该重复计算</p></li><li><p>  在遇到故障时可以恢复状态，恢复以后的重新计算，结果应该也是完全正确的。</p></li></ul><h3 id="10-6-2-分类"><a href="#10-6-2-分类" class="headerlink" title="10.6.2 分类"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1062-%E5%88%86%E7%B1%BB">10.6.2 分类</a></h3><p> <strong>Flink的一个重大价值在于，它既保证了exactly-once，也具有低延迟和高吞吐的处理能力。</strong> </p><ol><li><p>AT-MOST-ONCE（最多一次） 当任务故障时，最简单的做法是什么都不干，既不恢复丢失的状态，也不重播丢失的数据。At-most-once 语义的含义是最多处理一次事件。</p><p><em>这其实是没有正确性保障的委婉说法——故障发生之后，计算结果可能丢失。类似的比如网络协议的udp。</em></p></li><li><p>AT-LEAST-ONCE（至少一次） 在大多数的真实应用场景，我们希望不丢失事件。这种类型的保障称为 at-least-once，意思是所有的事件都得到了处理，而一些事件还可能被处理多次。</p><p><em>这表示计数结果可能大于正确值，但绝不会小于正确值。也就是说，计数程序在发生故障后可能多算，但是绝不会少算。</em></p></li><li><p>EXACTLY-ONCE（精确一次） <strong>恰好处理一次是最严格的保证，也是最难实现的。恰好处理一次语义不仅仅意味着没有事件丢失，还意味着针对每一个数据，内部状态仅仅更新一次。</strong> </p><p><em>这指的是系统保证在发生故障后得到的计数结果与正确值一致。</em></p></li></ol><h3 id="10-6-3-一致性检查点-Checkpoints"><a href="#10-6-3-一致性检查点-Checkpoints" class="headerlink" title="10.6.3 一致性检查点(Checkpoints)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1063-%E4%B8%80%E8%87%B4%E6%80%A7%E6%A3%80%E6%9F%A5%E7%82%B9checkpoints">10.6.3 一致性检查点(Checkpoints)</a></h3><ul><li>  Flink使用了一种轻量级快照机制——检查点（checkpoint）来保证exactly-once语义</li><li>  有状态流应用的一致检查点，其实就是：所有任务的状态，在某个时间点的一份备份（一份快照）。而这个时间点，应该是所有任务都恰好处理完一个相同的输入数据的时间。</li><li>  应用状态的一致检查点，是Flink故障恢复机制的核心</li></ul><h4 id="端到端-end-to-end-状态一致性"><a href="#端到端-end-to-end-状态一致性" class="headerlink" title="端到端(end-to-end)状态一致性"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E7%AB%AF%E5%88%B0%E7%AB%AFend-to-end%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7">端到端(end-to-end)状态一致性</a></h4><ul><li><p>  目前我们看到的一致性保证都是由流处理器实现的，也就是说都是在Flink流处理器内部保证的；而在真实应用中，流处理应用除了流处理器以外还包含了数据源（例如Kafka）和输出到持久化系统</p></li><li><p>  端到端的一致性保证，意味着结果的正确性贯穿了整个流处理应用的始终；每一个组件都保证了它自己的一致性</p></li><li><p>  <strong>整个端到端的一致性级别取决于所有组件中一致性最弱的组件</strong></p></li></ul><h4 id="端到端-exactly-once"><a href="#端到端-exactly-once" class="headerlink" title="端到端 exactly-once"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E7%AB%AF%E5%88%B0%E7%AB%AF-exactly-once">端到端 exactly-once</a></h4><ul><li>  内部保证——checkpoint</li><li>  source端——可重设数据的读取位置</li><li>sink端——从故障恢复时，数据不会重复写入外部系统<ul><li>  幂等写入</li><li>  事务写入</li></ul></li></ul><h5 id="幂等写入"><a href="#幂等写入" class="headerlink" title="幂等写入"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%B9%82%E7%AD%89%E5%86%99%E5%85%A5">幂等写入</a></h5><ul><li><p>所谓幂等操作，是说一个操作，可以重复执行很多次，但只导致一次结果更改，也就是说，后面再重复执行就不起作用了。</p><p><em>（中间可能会存在不正确的情况，只能保证最后结果正确。比如5=&gt;10=&gt;15=&gt;5=&gt;10=&gt;15，虽然最后是恢复到了15，但是中间有个恢复的过程，如果这个过程能够被读取，就会出问题。）</em></p></li></ul><p><img src="https://img-blog.csdnimg.cn/2020053019091138.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h5 id="事务写入"><a href="#事务写入" class="headerlink" title="事务写入"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BA%8B%E5%8A%A1%E5%86%99%E5%85%A5">事务写入</a></h5><ul><li><p>事务（Transaction）</p><ul><li>  应用程序中一系列严密的操作，所有操作必须成功完成，否则在每个操作中所作的所有更改都会被撤销</li><li>  具有原子性：一个事务中的一系列的操作要么全部成功，要么一个都不做</li></ul></li><li><p>实现思想</p><p><strong>构建的事务对应着checkpoint，等到checkpoint真正完成的时候，才把所有对应的结果写入sink系统中</strong>。</p></li><li><p>实现方式</p><ul><li>  预习日志</li><li>  两阶段提交</li></ul></li></ul><h6 id="预写日志-Write-Ahead-Log，WAL"><a href="#预写日志-Write-Ahead-Log，WAL" class="headerlink" title="预写日志(Write-Ahead-Log，WAL)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E9%A2%84%E5%86%99%E6%97%A5%E5%BF%97write-ahead-log%EF%BC%8Cwal">预写日志(Write-Ahead-Log，WAL)</a></h6><ul><li>  把结果数据先当成状态保存，然后在收到checkpoint完成的通知时，一次性写入sink系统</li><li>  简单易于实现，由于数据提前在状态后端中做了缓存，所以无论什么sink系统，都能用这种方式一批搞定</li><li>  DataStream API提供了一个模版类：GenericWriteAheadSink，来实现这种事务性sink</li></ul><h6 id="两阶段提交-Two-Phase-Commit，2PC"><a href="#两阶段提交-Two-Phase-Commit，2PC" class="headerlink" title="两阶段提交(Two-Phase-Commit，2PC)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4two-phase-commit%EF%BC%8C2pc">两阶段提交(Two-Phase-Commit，2PC)</a></h6><ul><li>  对于每个checkpoint，sink任务会启动一个事务，并将接下来所有接收到的数据添加到事务里</li><li>  然后将这些数据写入外部sink系统，但不提交它们——这时只是”预提交”</li><li>  <strong>这种方式真正实现了exactly-once，它需要一个提供事务支持的外部sink系统</strong>。Flink提供了TwoPhaseCommitSinkFunction接口</li></ul><h4 id="不同Source和Sink的一致性保证"><a href="#不同Source和Sink的一致性保证" class="headerlink" title="不同Source和Sink的一致性保证"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%B8%8D%E5%90%8Csource%E5%92%8Csink%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E4%BF%9D%E8%AF%81">不同Source和Sink的一致性保证</a></h4><p><img src="https://img-blog.csdnimg.cn/20200530194322578.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h2 id="10-7-Flink-Kafka-端到端状态一致性的保证"><a href="#10-7-Flink-Kafka-端到端状态一致性的保证" class="headerlink" title="10.7 Flink+Kafka 端到端状态一致性的保证"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_107-flinkkafka-%E7%AB%AF%E5%88%B0%E7%AB%AF%E7%8A%B6%E6%80%81%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E4%BF%9D%E8%AF%81">10.7 Flink+Kafka 端到端状态一致性的保证</a></h2><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106445029">Flink-状态一致性 | 状态一致性分类 | 端到端状态一致性 | 幂等写入 | 事务写入 | WAL | 2PC</a></p></blockquote><ul><li>  内部——利用checkpoint机制，把状态存盘，发生故障的时候可以恢复，保证内部的状态一致性</li><li>  source——kafka consumer作为source，可以将偏移量保存下来，如果后续任务出现了故障，恢复的时候可以由连接器重制偏移量，重新消费数据，保证一致性</li><li>  sink——kafka producer作为sink，采用两阶段提交sink，需要实现一个TwoPhaseCommitSinkFunction</li></ul><h3 id="Exactly-once-两阶段提交"><a href="#Exactly-once-两阶段提交" class="headerlink" title="Exactly-once 两阶段提交"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=exactly-once-%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4">Exactly-once 两阶段提交</a></h3><p><img src="https://img-blog.csdnimg.cn/20200530194434435.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  JobManager 协调各个 TaskManager 进行 checkpoint 存储</li><li>  checkpoint保存在 StateBackend中，默认StateBackend是内存级的，也可以改为文件级的进行持久化保存</li></ul><p><img src="https://img-blog.csdnimg.cn/20200530194627287.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  当 checkpoint 启动时，JobManager 会将检查点分界线（barrier）注入数据流</li><li>  barrier会在算子间传递下去</li></ul><p><img src="https://img-blog.csdnimg.cn/20200530194657186.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  每个算子会对当前的状态做个快照，保存到状态后端</li><li>  checkpoint 机制可以保证内部的状态一致性</li></ul><p><img src="https://img-blog.csdnimg.cn/20200530194835593.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>每个内部的 transform 任务遇到 barrier 时，都会把状态存到 checkpoint 里</p></li><li><p>sink 任务首先把数据写入外部 kafka，<strong>这些数据都属于预提交的事务</strong>；<strong>遇到 barrier 时，把状态保存到状态后端，并开启新的预提交事务</strong></p><p><em>(barrier之前的数据还是在之前的事务中没关闭事务，遇到barrier后的数据另外新开启一个事务)</em></p></li></ul><p><img src="https://img-blog.csdnimg.cn/2020053019485194.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  当所有算子任务的快照完成，也就是这次的 checkpoint 完成时，JobManager 会向所有任务发通知，确认这次 checkpoint 完成</li><li>  sink 任务收到确认通知，正式提交之前的事务，kafka 中未确认数据改为“已确认”</li></ul><h3 id="Exactly-once-两阶段提交步骤总结"><a href="#Exactly-once-两阶段提交步骤总结" class="headerlink" title="Exactly-once 两阶段提交步骤总结"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=exactly-once-%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E6%AD%A5%E9%AA%A4%E6%80%BB%E7%BB%93">Exactly-once 两阶段提交步骤总结</a></h3><ol><li> 第一条数据来了之后，开启一个 kafka 的事务（transaction），正常写入 kafka 分区日志但标记为未提交，这就是“预提交”</li><li> jobmanager 触发 checkpoint 操作，barrier 从 source 开始向下传递，遇到 barrier 的算子将状态存入状态后端，并通知 jobmanager</li><li> sink 连接器收到 barrier，保存当前状态，存入 checkpoint，通知 jobmanager，并开启下一阶段的事务，用于提交下个检查点的数据</li><li> jobmanager 收到所有任务的通知，发出确认信息，表示 checkpoint 完成</li><li> sink 任务收到 jobmanager 的确认信息，正式提交这段时间的数据</li><li> 外部kafka关闭事务，提交的数据可以正常消费了。</li></ol><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106457648">Flink-Table API 和 Flink SQL简介 | 新老版本Flink批流处理对比 | 读取文件和Kafka消费数据 | API 和 SQL查询表</a></p><p><a href="https://blog.csdn.net/weixin_41956627/article/details/110050094">flink-Table&amp;sql-碰到的几个问题记录</a></p></blockquote><h2 id="11-1-概述"><a href="#11-1-概述" class="headerlink" title="11.1 概述"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_111-%E6%A6%82%E8%BF%B0">11.1 概述</a></h2><ul><li>  Flink 对批处理和流处理，提供了统一的上层 API</li><li>  Table API 是一套内嵌在 Java 和 Scala 语言中的查询API，它允许以非常直观的方式组合来自一些关系运算符的查询</li><li>  Flink 的 SQL 支持基于实现了 SQL 标准的 Apache Calcite</li></ul><p><img src="https://img-blog.csdnimg.cn/20200531165328668.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h3 id="使用样例"><a href="#使用样例" class="headerlink" title="使用样例"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BD%BF%E7%94%A8%E6%A0%B7%E4%BE%8B">使用样例</a></h3><ul><li><p>导入pom依赖，1.11.X之后，推荐使用blink版本</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>table<span class="token operator">-</span>planner<span class="token operator">-</span>blink_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>java样例代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 5:47 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest1_Example</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 转换成POJO</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 创建表环境</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 基于流创建一张表</span>    <span class="token class-name">Table</span> dataTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 调用table API进行转换操作</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> dataTable<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, temperature"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"id = 'sensor_1'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 6. 执行SQL</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> dataTable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select id, temperature from sensor where id = 'sensor_1'"</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> resultSqlTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultSqlTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Txt文件</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出结果</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">35.8</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">35.8</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">36.3</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">36.3</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">32.8</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">32.8</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">37.1</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="11-2-基本程序结构"><a href="#11-2-基本程序结构" class="headerlink" title="11.2 基本程序结构"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_112-%E5%9F%BA%E6%9C%AC%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84">11.2 基本程序结构</a></h2><ul><li><p>Table API和SQL的程序结构，与流式处理的程序结构十分类似</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 创建表的执行环境</span><span class="token comment">// 创建一张表，用于读取数据</span>tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 注册一张表，用于把计算结果输出</span>tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"outputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 通过 Table API 查询算子，得到一张结果表</span><span class="token class-name">Table</span> result <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 通过SQL查询语句，得到一张结果表</span><span class="token class-name">Table</span> sqlResult <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT ... FROM inputTable ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将结果表写入输出表中</span>result<span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"outputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="11-3-Table-API批处理和流处理"><a href="#11-3-Table-API批处理和流处理" class="headerlink" title="11.3 Table API批处理和流处理"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_113-table-api%E6%89%B9%E5%A4%84%E7%90%86%E5%92%8C%E6%B5%81%E5%A4%84%E7%90%86">11.3 Table API批处理和流处理</a></h2><p>新版本blink，真正把批处理、流处理都以DataStream实现。</p><h3 id="创建环境-样例代码"><a href="#创建环境-样例代码" class="headerlink" title="创建环境-样例代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%88%9B%E5%BB%BA%E7%8E%AF%E5%A2%83-%E6%A0%B7%E4%BE%8B%E4%BB%A3%E7%A0%81">创建环境-样例代码</a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">ExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">EnvironmentSettings</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">BatchTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span><span class="token class-name">TableEnvironmentImpl</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 3:56 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest2_CommonApi</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1.1 基于老版本planner的流处理</span>    <span class="token class-name">EnvironmentSettings</span> oldStreamSettings <span class="token operator">=</span> <span class="token class-name">EnvironmentSettings</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">useOldPlanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">inStreamingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> oldStreamTableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>oldStreamSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1.2 基于老版本planner的批处理</span>    <span class="token class-name">ExecutionEnvironment</span> batchEnv <span class="token operator">=</span> <span class="token class-name">ExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">BatchTableEnvironment</span> oldBatchTableEnv <span class="token operator">=</span> <span class="token class-name">BatchTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>batchEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1.3 基于Blink的流处理</span>    <span class="token class-name">EnvironmentSettings</span> blinkStreamSettings <span class="token operator">=</span> <span class="token class-name">EnvironmentSettings</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">useBlinkPlanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">inStreamingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> blinkStreamTableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>blinkStreamSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1.4 基于Blink的批处理</span>    <span class="token class-name">EnvironmentSettings</span> blinkBatchSettings <span class="token operator">=</span> <span class="token class-name">EnvironmentSettings</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">useBlinkPlanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">inBatchMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">TableEnvironment</span> blinkBatchTableEnv <span class="token operator">=</span> <span class="token class-name">TableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>blinkBatchSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11-3-1-表-Table"><a href="#11-3-1-表-Table" class="headerlink" title="11.3.1 表(Table)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1131-%E8%A1%A8table">11.3.1 表(Table)</a></h3><ul><li>  TableEnvironment可以注册目录Catalog，并可以基于Catalog注册表</li><li>  <strong>表(Table)是由一个”标示符”(identifier)来指定的，由3部分组成：Catalog名、数据库(database)名和对象名</strong></li><li>  表可以是常规的，也可以是虚拟的(视图，View)</li><li>  常规表(Table)一般可以用来描述外部数据，比如文件、数据库表或消息队列的数据，也可以直接从DataStream转换而来</li><li>  视图(View)可以从现有的表中创建，通常是table API或者SQL查询的一个结果集</li></ul><h3 id="11-3-2-创建表"><a href="#11-3-2-创建表" class="headerlink" title="11.3.2 创建表"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1132-%E5%88%9B%E5%BB%BA%E8%A1%A8">11.3.2 创建表</a></h3><ul><li><p>TableEnvironment可以调用<code>connect()</code>方法，连接外部系统，并调用<code>.createTemporaryTable()</code>方法，在Catalog中注册表</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">tableEnv  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>    <span class="token comment">//    定义表的数据来源，和外部系统建立连接</span>  <span class="token punctuation">.</span><span class="token function">withFormat</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>    <span class="token comment">//    定义数据格式化方法</span>  <span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>    <span class="token comment">//    定义表结构</span>  <span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"MyTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//    创建临时表</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="11-3-3-创建TableEnvironment"><a href="#11-3-3-创建TableEnvironment" class="headerlink" title="11.3.3 创建TableEnvironment"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1133-%E5%88%9B%E5%BB%BAtableenvironment">11.3.3 创建TableEnvironment</a></h3><ul><li><p>创建表的执行环境，需要将flink流处理的执行环境传入</p><p><code>StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</code></p></li><li><p>TableEnvironment是flink中集成Table API和SQL的核心概念，所有对表的操作都基于TableEnvironment</p><ul><li>  注册Catalog</li><li>  在Catalog中注册表</li><li>  执行SQL查询</li><li>  注册用户自定义函数（UDF）</li></ul></li></ul><h4 id="测试代码-5"><a href="#测试代码-5" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-5">测试代码</a></h4><ul><li><p>pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>table<span class="token operator">-</span>planner<span class="token operator">-</span>blink_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>csv<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Csv</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">FileSystem</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 3:56 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest2_CommonApi</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 表的创建：连接外部系统，读取数据</span>    <span class="token comment">// 2.1 读取文件</span>    <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 定义到文件系统的连接</span>      <span class="token punctuation">.</span><span class="token function">withFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 定义以csv格式进行数据格式化</span>      <span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">BIGINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"temp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">DOUBLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token punctuation">)</span> <span class="token comment">// 定义表结构</span>      <span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建临时表</span>    <span class="token class-name">Table</span> inputTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    inputTable<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>inputTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输入文件</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">root <span class="token operator">|</span><span class="token operator">--</span> id<span class="token operator">:</span> STRING <span class="token operator">|</span><span class="token operator">--</span> timestamp<span class="token operator">:</span> BIGINT <span class="token operator">|</span><span class="token operator">--</span> temp<span class="token operator">:</span> <span class="token class-name">DOUBLE</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="11-3-4-表的查询"><a href="#11-3-4-表的查询" class="headerlink" title="11.3.4 表的查询"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1134-%E8%A1%A8%E7%9A%84%E6%9F%A5%E8%AF%A2">11.3.4 表的查询</a></h3><ul><li><p>Table API是集成在Scala和Java语言内的查询API</p></li><li><p>Table API基于代表”表”的Table类，并提供一整套操作处理的方法API；这些方法会返回一个新的Table对象，表示对输入表应用转换操作的结果</p></li><li><p>有些关系型转换操作，可以由多个方法调用组成，构成链式调用结构</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Table</span> resultTable <span class="token operator">=</span> sensorTable  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"temperature"</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token string">"id = 'sensor_1'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="从文件获取数据"><a href="#从文件获取数据" class="headerlink" title="从文件获取数据"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%8E%E6%96%87%E4%BB%B6%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE">从文件获取数据</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Csv</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">FileSystem</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 3:56 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest2_CommonApi</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 表的创建：连接外部系统，读取数据</span>    <span class="token comment">// 2.1 读取文件</span>    <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">BIGINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"temp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">DOUBLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> inputTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//        inputTable.printSchema();</span>    <span class="token comment">//        tableEnv.toAppendStream(inputTable, Row.class).print();</span>    <span class="token comment">// 3. 查询转换</span>    <span class="token comment">// 3.1 Table API</span>    <span class="token comment">// 简单转换</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> inputTable<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, temp"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token string">"id === 'sensor_6'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 聚合统计</span>    <span class="token class-name">Table</span> aggTable <span class="token operator">=</span> inputTable<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, id.count as count, temp.avg as avgTemp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.2 SQL</span>    tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, temp from inputTable where id = 'senosr_6'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> sqlAggTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, count(id) as cnt, avg(temp) as avgTemp from inputTable group by id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 打印输出</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toRetractStream</span><span class="token punctuation">(</span>aggTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toRetractStream</span><span class="token punctuation">(</span>sqlAggTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"sqlagg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出结果</p><p><em>里面的false表示上一条保存的记录被删除，true则是新加入的数据</em></p><p><em>所以Flink的Table API在更新数据时，实际是先删除原本的数据，再添加新数据。</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> sensor_6<span class="token punctuation">,</span><span class="token number">15.4</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_6<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_7<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_10<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_6<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_7<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_10<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>sqlagg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">35.5</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>agg<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">35.5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="数据写入到文件"><a href="#数据写入到文件" class="headerlink" title="数据写入到文件"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E5%88%B0%E6%96%87%E4%BB%B6">数据写入到文件</a></h4><blockquote><p><a href="https://blog.csdn.net/qq_26502245/article/details/107376528">flink Sql 1.11 executeSql报No operators defined in streaming topology. Cannot generate StreamGraph.</a></p></blockquote><p> 写入到文件有局限，只能是批处理，且只能是追加写，不能是更新式的随机写。</p><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Csv</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">FileSystem</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 5:53 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest3_FileOutput</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 表的创建：连接外部系统，读取数据</span>    <span class="token comment">// 读取文件</span>    <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">BIGINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"temp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">DOUBLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> inputTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//        inputTable.printSchema();</span>    <span class="token comment">//        tableEnv.toAppendStream(inputTable, Row.class).print();</span>    <span class="token comment">// 3. 查询转换</span>    <span class="token comment">// 3.1 Table API</span>    <span class="token comment">// 简单转换</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> inputTable<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, temp"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token string">"id === 'sensor_6'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 聚合统计</span>    <span class="token class-name">Table</span> aggTable <span class="token operator">=</span> inputTable<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, id.count as count, temp.avg as avgTemp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.2 SQL</span>    tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, temp from inputTable where id = 'senosr_6'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> sqlAggTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, count(id) as cnt, avg(temp) as avgTemp from inputTable group by id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 输出到文件</span>    <span class="token comment">// 连接外部文件注册输出表</span>    <span class="token class-name">String</span> outputPath <span class="token operator">=</span> <span class="token string">"/tmp/Flink_Tutorial/src/main/resources/out.txt"</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token comment">//                        配合 aggTable.insertInto("outputTable"); 才使用下面这条</span>                  <span class="token comment">//                        .field("cnt", DataTypes.BIGINT())</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">DOUBLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"outputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultTable<span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"outputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 这条会报错(文件系统输出，不支持随机写，只支持附加写)</span>    <span class="token comment">// Exception in thread "main" org.apache.flink.table.api.TableException:</span>    <span class="token comment">// AppendStreamTableSink doesn't support consuming update changes which is produced by</span>    <span class="token comment">// node GroupAggregate(groupBy=[id], select=[id, COUNT(id) AS EXPR$0, AVG(temp) AS EXPR$1])</span>    <span class="token comment">//        aggTable.insertInto("outputTable");</span>    <span class="token comment">// 旧版可以用下面这条</span>    <span class="token comment">//        env.execute();</span>    <span class="token comment">// 新版需要用这条，上面那条会报错，报错如下</span>    <span class="token comment">// Exception in thread "main" java.lang.IllegalStateException:</span>    <span class="token comment">// No operators defined in streaming topology. Cannot execute.</span>    tableEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出结果（输出到out.txt文件）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_6<span class="token punctuation">,</span><span class="token number">15.4</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>这个程序只能运行一次，再运行一次报错</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Exception</span> in thread <span class="token string">"main"</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>JobExecutionException</span><span class="token operator">:</span> <span class="token class-name">Job</span> execution failed<span class="token punctuation">.</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>jobmaster<span class="token punctuation">.</span></span>JobResult</span><span class="token punctuation">.</span><span class="token function">toJobExecutionResult</span><span class="token punctuation">(</span><span class="token class-name">JobResult</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">144</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>minicluster<span class="token punctuation">.</span></span>MiniClusterJobClient</span><span class="token punctuation">.</span>lambda$getJobExecutionResult$<span class="token function">2</span><span class="token punctuation">(</span><span class="token class-name">MiniClusterJobClient</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">117</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>CompletableFuture</span><span class="token punctuation">.</span><span class="token function">uniApply</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">616</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>CompletableFuture</span>$<span class="token class-name">UniApply</span><span class="token punctuation">.</span><span class="token function">tryFire</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">591</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>CompletableFuture</span><span class="token punctuation">.</span><span class="token function">postComplete</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">488</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>CompletableFuture</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1975</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>akka<span class="token punctuation">.</span></span>AkkaInvocationHandler</span><span class="token punctuation">.</span>lambda$invokeRpc$<span class="token function">0</span><span class="token punctuation">(</span><span class="token class-name">AkkaInvocationHandler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">238</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>CompletableFuture</span><span class="token punctuation">.</span><span class="token function">uniWhenComplete</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">774</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>CompletableFuture</span>$<span class="token class-name">UniWhenComplete</span><span class="token punctuation">.</span><span class="token function">tryFire</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">750</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>CompletableFuture</span><span class="token punctuation">.</span><span class="token function">postComplete</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">488</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>CompletableFuture</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1975</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>FutureUtils</span>$<span class="token number">1.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token class-name">FutureUtils</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1046</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>OnComplete</span><span class="token punctuation">.</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">264</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>OnComplete</span><span class="token punctuation">.</span><span class="token function">internal</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">261</span><span class="token punctuation">)</span>    at akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>japi$<span class="token class-name">CallbackBridge</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">191</span><span class="token punctuation">)</span>    at akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>japi$<span class="token class-name">CallbackBridge</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">188</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>CallbackRunnable</span><span class="token punctuation">.</span>run$$$<span class="token function">capture</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>CallbackRunnable</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>Executors</span>$<span class="token class-name">DirectExecutionContext</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Executors</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">73</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>CallbackRunnable</span><span class="token punctuation">.</span><span class="token function">executeWithValue</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">68</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>Promise</span>$<span class="token class-name">DefaultPromise</span><span class="token punctuation">.</span>$anonfun$tryComplete$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">284</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>Promise</span>$<span class="token class-name">DefaultPromise</span><span class="token punctuation">.</span>$anonfun$tryComplete$<span class="token number">1</span>$<span class="token function">adapted</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">284</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>Promise</span>$<span class="token class-name">DefaultPromise</span><span class="token punctuation">.</span><span class="token function">tryComplete</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">284</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span>PromiseActorRef</span><span class="token punctuation">.</span>$<span class="token function">bang</span><span class="token punctuation">(</span><span class="token class-name">AskSupport</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">573</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span>PipeToSupport</span>$<span class="token class-name">PipeableFuture</span>$$anonfun$pipeTo$<span class="token number">1.</span><span class="token function">applyOrElse</span><span class="token punctuation">(</span><span class="token class-name">PipeToSupport</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span>PipeToSupport</span>$<span class="token class-name">PipeableFuture</span>$$anonfun$pipeTo$<span class="token number">1.</span><span class="token function">applyOrElse</span><span class="token punctuation">(</span><span class="token class-name">PipeToSupport</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>Future</span><span class="token punctuation">.</span>$anonfun$andThen$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">532</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>Promise</span><span class="token punctuation">.</span>liftedTree1$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>Promise</span><span class="token punctuation">.</span>$anonfun$transform$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>CallbackRunnable</span><span class="token punctuation">.</span>run$$$<span class="token function">capture</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>CallbackRunnable</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Promise</span><span class="token punctuation">.</span>scala<span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>BatchingExecutor</span>$<span class="token class-name">AbstractBatch</span><span class="token punctuation">.</span><span class="token function">processBatch</span><span class="token punctuation">(</span><span class="token class-name">BatchingExecutor</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>BatchingExecutor</span>$<span class="token class-name">BlockableBatch</span><span class="token punctuation">.</span>$anonfun$run$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">BatchingExecutor</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">91</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>java8<span class="token punctuation">.</span></span>JFunction0</span>$mcV$sp<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">JFunction0</span>$mcV$sp<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>BlockContext</span>$<span class="token punctuation">.</span><span class="token function">withBlockContext</span><span class="token punctuation">(</span><span class="token class-name">BlockContext</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">81</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>BatchingExecutor</span>$<span class="token class-name">BlockableBatch</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">BatchingExecutor</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">91</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>TaskInvocation</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">AbstractDispatcher</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">40</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>ForkJoinExecutorConfigurator</span>$<span class="token class-name">AkkaForkJoinTask</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinExecutorConfigurator</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">44</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>forkjoin<span class="token punctuation">.</span></span>ForkJoinTask</span><span class="token punctuation">.</span><span class="token function">doExec</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">260</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>forkjoin<span class="token punctuation">.</span></span>ForkJoinPool</span>$<span class="token class-name">WorkQueue</span><span class="token punctuation">.</span><span class="token function">runTask</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1339</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>forkjoin<span class="token punctuation">.</span></span>ForkJoinPool</span><span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1979</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>forkjoin<span class="token punctuation">.</span></span>ForkJoinWorkerThread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span>JobException</span><span class="token operator">:</span> <span class="token class-name">Recovery</span> is suppressed by <span class="token class-name">NoRestartBackoffTimeStrategy</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>executiongraph<span class="token punctuation">.</span>failover<span class="token punctuation">.</span>flip1<span class="token punctuation">.</span></span>ExecutionFailureHandler</span><span class="token punctuation">.</span><span class="token function">handleFailure</span><span class="token punctuation">(</span><span class="token class-name">ExecutionFailureHandler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">118</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>executiongraph<span class="token punctuation">.</span>failover<span class="token punctuation">.</span>flip1<span class="token punctuation">.</span></span>ExecutionFailureHandler</span><span class="token punctuation">.</span><span class="token function">getFailureHandlingResult</span><span class="token punctuation">(</span><span class="token class-name">ExecutionFailureHandler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span></span>DefaultScheduler</span><span class="token punctuation">.</span><span class="token function">handleTaskFailure</span><span class="token punctuation">(</span><span class="token class-name">DefaultScheduler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">233</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span></span>DefaultScheduler</span><span class="token punctuation">.</span><span class="token function">maybeHandleTaskFailure</span><span class="token punctuation">(</span><span class="token class-name">DefaultScheduler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">224</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span></span>DefaultScheduler</span><span class="token punctuation">.</span><span class="token function">updateTaskExecutionStateInternal</span><span class="token punctuation">(</span><span class="token class-name">DefaultScheduler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">215</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span></span>SchedulerBase</span><span class="token punctuation">.</span><span class="token function">updateTaskExecutionState</span><span class="token punctuation">(</span><span class="token class-name">SchedulerBase</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">665</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span></span>SchedulerNG</span><span class="token punctuation">.</span><span class="token function">updateTaskExecutionState</span><span class="token punctuation">(</span><span class="token class-name">SchedulerNG</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">89</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>jobmaster<span class="token punctuation">.</span></span>JobMaster</span><span class="token punctuation">.</span><span class="token function">updateTaskExecutionState</span><span class="token punctuation">(</span><span class="token class-name">JobMaster</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">447</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">NativeMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>akka<span class="token punctuation">.</span></span>AkkaRpcActor</span><span class="token punctuation">.</span><span class="token function">handleRpcInvocation</span><span class="token punctuation">(</span><span class="token class-name">AkkaRpcActor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">306</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>akka<span class="token punctuation">.</span></span>AkkaRpcActor</span><span class="token punctuation">.</span><span class="token function">handleRpcMessage</span><span class="token punctuation">(</span><span class="token class-name">AkkaRpcActor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">213</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>akka<span class="token punctuation">.</span></span>FencedAkkaRpcActor</span><span class="token punctuation">.</span><span class="token function">handleRpcMessage</span><span class="token punctuation">(</span><span class="token class-name">FencedAkkaRpcActor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">77</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>akka<span class="token punctuation">.</span></span>AkkaRpcActor</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">AkkaRpcActor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">159</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>japi<span class="token punctuation">.</span>pf<span class="token punctuation">.</span></span>UnitCaseStatement</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">CaseStatements</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>japi<span class="token punctuation">.</span>pf<span class="token punctuation">.</span></span>UnitCaseStatement</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">CaseStatements</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>PartialFunction</span><span class="token punctuation">.</span><span class="token function">applyOrElse</span><span class="token punctuation">(</span><span class="token class-name">PartialFunction</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>PartialFunction</span><span class="token punctuation">.</span>applyOrElse$<span class="token punctuation">(</span><span class="token class-name">PartialFunction</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">122</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>japi<span class="token punctuation">.</span>pf<span class="token punctuation">.</span></span>UnitCaseStatement</span><span class="token punctuation">.</span><span class="token function">applyOrElse</span><span class="token punctuation">(</span><span class="token class-name">CaseStatements</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>PartialFunction</span>$<span class="token class-name">OrElse</span><span class="token punctuation">.</span><span class="token function">applyOrElse</span><span class="token punctuation">(</span><span class="token class-name">PartialFunction</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">171</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>PartialFunction</span>$<span class="token class-name">OrElse</span><span class="token punctuation">.</span><span class="token function">applyOrElse</span><span class="token punctuation">(</span><span class="token class-name">PartialFunction</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">172</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span></span>PartialFunction</span>$<span class="token class-name">OrElse</span><span class="token punctuation">.</span><span class="token function">applyOrElse</span><span class="token punctuation">(</span><span class="token class-name">PartialFunction</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">172</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>actor<span class="token punctuation">.</span></span>Actor</span><span class="token punctuation">.</span><span class="token function">aroundReceive</span><span class="token punctuation">(</span><span class="token class-name">Actor</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">517</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>actor<span class="token punctuation">.</span></span>Actor</span><span class="token punctuation">.</span>aroundReceive$<span class="token punctuation">(</span><span class="token class-name">Actor</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">515</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>actor<span class="token punctuation">.</span></span>AbstractActor</span><span class="token punctuation">.</span><span class="token function">aroundReceive</span><span class="token punctuation">(</span><span class="token class-name">AbstractActor</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">225</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>actor<span class="token punctuation">.</span></span>ActorCell</span><span class="token punctuation">.</span><span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">ActorCell</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">592</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>actor<span class="token punctuation">.</span></span>ActorCell</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">ActorCell</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">561</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>Mailbox</span><span class="token punctuation">.</span><span class="token function">processMailbox</span><span class="token punctuation">(</span><span class="token class-name">Mailbox</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">258</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>Mailbox</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Mailbox</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">225</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">akka<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span></span>Mailbox</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token class-name">Mailbox</span><span class="token punctuation">.</span>scala<span class="token operator">:</span><span class="token number">235</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">4</span> more<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException</span><span class="token operator">:</span> <span class="token class-name">File</span> or directory <span class="token operator">/</span><span class="token class-name">Users</span><span class="token operator">/</span>ashiamd<span class="token operator">/</span>mydocs<span class="token operator">/</span>docs<span class="token operator">/</span>study<span class="token operator">/</span>javadocument<span class="token operator">/</span>javadocument<span class="token operator">/</span><span class="token class-name">IDEA_project</span><span class="token operator">/</span><span class="token class-name">Flink_Tutorial</span><span class="token operator">/</span>src<span class="token operator">/</span>main<span class="token operator">/</span>resources<span class="token operator">/</span>out<span class="token punctuation">.</span>txt already <span class="token class-name"><span class="token namespace">exists<span class="token punctuation">.</span></span> Existing</span> files and directories are not overwritten in NO_OVERWRITE <span class="token class-name"><span class="token namespace">mode<span class="token punctuation">.</span></span> Use</span> OVERWRITE mode <span class="token keyword">to</span> <span class="token namespace">overwrite</span> existing files and directories<span class="token punctuation">.</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>core<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>FileSystem</span><span class="token punctuation">.</span><span class="token function">initOutPathLocalFS</span><span class="token punctuation">(</span><span class="token class-name">FileSystem</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">874</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>core<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>SafetyNetWrapperFileSystem</span><span class="token punctuation">.</span><span class="token function">initOutPathLocalFS</span><span class="token punctuation">(</span><span class="token class-name">SafetyNetWrapperFileSystem</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">142</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileOutputFormat</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">FileOutputFormat</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">234</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>TextOutputFormat</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">TextOutputFormat</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">92</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span>OutputFormatSinkFunction</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">OutputFormatSinkFunction</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">65</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>FunctionUtils</span><span class="token punctuation">.</span><span class="token function">openFunction</span><span class="token punctuation">(</span><span class="token class-name">FunctionUtils</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">34</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>operators<span class="token punctuation">.</span></span>AbstractUdfStreamOperator</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">AbstractUdfStreamOperator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">102</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>operators<span class="token punctuation">.</span></span>StreamSink</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">StreamSink</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">46</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>OperatorChain</span><span class="token punctuation">.</span><span class="token function">initializeStateAndOpenOperators</span><span class="token punctuation">(</span><span class="token class-name">OperatorChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">426</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span>lambda$beforeInvoke$<span class="token function">2</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">535</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTaskActionExecutor</span>$<span class="token number">1.</span><span class="token function">runThrowing</span><span class="token punctuation">(</span><span class="token class-name">StreamTaskActionExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span><span class="token function">beforeInvoke</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">525</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">565</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskmanager<span class="token punctuation">.</span></span>Task</span><span class="token punctuation">.</span><span class="token function">doRun</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">755</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>taskmanager<span class="token punctuation">.</span></span>Task</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">570</span><span class="token punctuation">)</span>    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>    <span class="token class-name">Suppressed</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NullPointerException</span>        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span>ContinuousFileReaderOperator</span><span class="token punctuation">.</span>lambda$cleanUp$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">ContinuousFileReaderOperator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">499</span><span class="token punctuation">)</span>        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span>ContinuousFileReaderOperator</span><span class="token punctuation">.</span><span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token class-name">ContinuousFileReaderOperator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">512</span><span class="token punctuation">)</span>        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span>ContinuousFileReaderOperator</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token class-name">ContinuousFileReaderOperator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">441</span><span class="token punctuation">)</span>        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span><span class="token function">disposeAllOperators</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">783</span><span class="token punctuation">)</span>        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span><span class="token function">runAndSuppressThrowable</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">762</span><span class="token punctuation">)</span>        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span><span class="token function">cleanUpInvoke</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">681</span><span class="token punctuation">)</span>        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>StreamTask</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">StreamTask</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">585</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">3</span> more<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="读写Kafka"><a href="#读写Kafka" class="headerlink" title="读写Kafka"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E8%AF%BB%E5%86%99kafka">读写Kafka</a></h4><p>Kafka作为消息队列，和文件系统类似的，只能往里追加数据，不能修改数据。</p><ul><li><p>测试代码</p><p><em>（我用的新版Flink和新版kafka连接器，所以version指定”universal”）</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Csv</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Kafka</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/3 6:33 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest4_KafkaPipeLine</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 连接Kafka，读取数据</span>    tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Kafka</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">"universal"</span><span class="token punctuation">)</span>                     <span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">)</span>                     <span class="token punctuation">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">"zookeeper.connect"</span><span class="token punctuation">,</span> <span class="token string">"localhost:2181"</span><span class="token punctuation">)</span>                     <span class="token punctuation">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span>                    <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">BIGINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"temp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">DOUBLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 查询转换</span>    <span class="token comment">// 简单转换</span>    <span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"inputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> sensorTable<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, temp"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token string">"id === 'sensor_6'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 聚合统计</span>    <span class="token class-name">Table</span> aggTable <span class="token operator">=</span> sensorTable<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, id.count as count, temp.avg as avgTemp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 建立kafka连接，输出到不同的topic下</span>    tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Kafka</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">"universal"</span><span class="token punctuation">)</span>                     <span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token string">"sinktest"</span><span class="token punctuation">)</span>                     <span class="token punctuation">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">"zookeeper.connect"</span><span class="token punctuation">,</span> <span class="token string">"localhost:2181"</span><span class="token punctuation">)</span>                     <span class="token punctuation">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span>                    <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token comment">//                        .field("timestamp", DataTypes.BIGINT())</span>                  <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"temp"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">DOUBLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"outputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultTable<span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"outputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动kafka目录里自带的zookeeper</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/zookeeper-server-start.sh config/zookeeper.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>启动kafka服务</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-server-start.sh config/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>新建kafka生产者和消费者</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-console-producer.sh --broker-list localhost:9092  --topic sensor$ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic sinktest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>启动Flink程序，在kafka生产者console中输入数据，查看输出</p><ul><li><p>输入（kafka-console-producer）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&gt;</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token operator">&gt;</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span><span class="token operator">&gt;</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span><span class="token operator">&gt;</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span><span class="token operator">&gt;</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">34.5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出（kafka-console-consumer）</p><p>代码中，只筛选id为<code>sensor_6</code>的，所以输出没有问题</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_6<span class="token punctuation">,</span><span class="token number">15.4</span>           sensor_6<span class="token punctuation">,</span><span class="token number">34.5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><h3 id="11-3-5-更新模式"><a href="#11-3-5-更新模式" class="headerlink" title="11.3.5 更新模式"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1135-%E6%9B%B4%E6%96%B0%E6%A8%A1%E5%BC%8F">11.3.5 更新模式</a></h3><ul><li>  对于流式查询，需要声明如何在表和外部连接器之间执行转换</li><li>  与外部系统交换的消息类型，由更新模式（Uadate Mode）指定</li><li>追加（Append）模式<ul><li>  表只做插入操作，和外部连接器只交换插入（Insert）消息</li></ul></li><li>撤回（Retract）模式<ul><li>  表和外部连接器交换添加（Add）和撤回（Retract）消息</li><li>  插入操作（Insert）编码为Add消息；删除（Delete）编码为Retract消息；<strong>更新（Update）编码为上一条的Retract和下一条的Add消息</strong></li></ul></li><li>更新插入（Upsert）模式<ul><li>  更新和插入都被编码为Upsert消息；删除编码为Delete消息</li></ul></li></ul><h3 id="11-3-6-输出到ES"><a href="#11-3-6-输出到ES" class="headerlink" title="11.3.6 输出到ES"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1136-%E8%BE%93%E5%87%BA%E5%88%B0es">11.3.6 输出到ES</a></h3><ul><li><p>可以创建Table来描述ES中的数据，作为输出的TableSink</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">tableEnv<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>  <span class="token keyword">new</span> <span class="token class-name">Elasticsearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">"6"</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token number">9200</span><span class="token punctuation">,</span><span class="token string">"http"</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">documentType</span><span class="token punctuation">(</span><span class="token string">"temp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">inUpsertMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">withFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">BIGINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>             <span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">createTemporaryTable</span><span class="token punctuation">(</span><span class="token string">"esOutputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>aggResultTable<span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"esOutputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="11-3-7-输出到MySQL"><a href="#11-3-7-输出到MySQL" class="headerlink" title="11.3.7 输出到MySQL"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1137-%E8%BE%93%E5%87%BA%E5%88%B0mysql">11.3.7 输出到MySQL</a></h3><ul><li><p>需要的pom依赖</p><p>Flink专门为Table API的jdbc连接提供了flink-jdbc连接器，需要先引入依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>jdbc_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.10</span><span class="token number">.3</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">&gt;</span></span>provided<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>可以创建Table来描述MySql中的数据，作为输入和输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> sinkDDL <span class="token operator">=</span>   <span class="token string">"create table jdbcOutputTable ("</span> <span class="token operator">+</span>  <span class="token string">" id varchar(20) not null, "</span> <span class="token operator">+</span>  <span class="token string">" cnt bigint not null "</span> <span class="token operator">+</span>  <span class="token string">") with ("</span> <span class="token operator">+</span>  <span class="token string">" 'connector.type' = 'jdbc', "</span> <span class="token operator">+</span>  <span class="token string">" 'connector.url' = 'jdbc:mysql://localhost:3306/test', "</span> <span class="token operator">+</span>  <span class="token string">" 'connector.table' = 'sensor_count', "</span> <span class="token operator">+</span>  <span class="token string">" 'connector.driver' = 'com.mysql.jdbc.Driver', "</span> <span class="token operator">+</span>  <span class="token string">" 'connector.username' = 'root', "</span> <span class="token operator">+</span>  <span class="token string">" 'connector.password' = '123456' )"</span><span class="token punctuation">;</span>tableEnv<span class="token punctuation">.</span><span class="token function">sqlUpdate</span><span class="token punctuation">(</span>sinkDDL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 执行DDL创建表</span>aggResultSqlTable<span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"jdbcOutputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="11-4-表和流的转换"><a href="#11-4-表和流的转换" class="headerlink" title="11.4 表和流的转换"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_114-%E8%A1%A8%E5%92%8C%E6%B5%81%E7%9A%84%E8%BD%AC%E6%8D%A2">11.4 表和流的转换</a></h2><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106479537">Flink- 将表转换成DataStream | 查看执行计划 | 流处理和关系代数的区别 | 动态表 | 流式持续查询的过程 | 将流转换成动态表 | 持续查询 | 将动态表转换成 DS</a></p></blockquote><h3 id="11-4-1-将Table转换成DataStream"><a href="#11-4-1-将Table转换成DataStream" class="headerlink" title="11.4.1 将Table转换成DataStream"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1141-%E5%B0%86table%E8%BD%AC%E6%8D%A2%E6%88%90datastream">11.4.1 将Table转换成DataStream</a></h3><ul><li><p>表可以转换为 DataStream 或 DataSet ，这样自定义流处理或批处理程序就可以继续在 Table API 或 SQL 查询的结果上运行了</p></li><li><p>将表转换为 DataStream 或 DataSet 时，需要指定生成的数据类型，即要将表的每一行转换成的数据类型</p></li><li><p>表作为流式查询的结果，是动态更新的</p></li><li><p>转换有两种转换模式：追加（Appende）模式和撤回（Retract）模式</p></li><li><p>追加模式</p><ul><li>  用于表只会被插入（Insert）操作更改的场景</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span><span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>撤回模式</p><ul><li><p>用于任何场景。有些类似于更新模式中Retract模式，它只有Insert和Delete两类操作。</p></li><li><p><strong>得到的数据会增加一个Boolean类型的标识位（返回的第一个字段），用它来表示到底是新增的数据（Insert），还是被删除的数据（Delete）</strong>。</p><p><em>(更新数据，会先删除旧数据，再插入新数据)</em></p></li></ul></li></ul><h3 id="11-4-2-将DataStream转换成表"><a href="#11-4-2-将DataStream转换成表" class="headerlink" title="11.4.2 将DataStream转换成表"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1142-%E5%B0%86datastream%E8%BD%AC%E6%8D%A2%E6%88%90%E8%A1%A8">11.4.2 将DataStream转换成表</a></h3><ul><li><p>对于一个DataStream，可以直接转换成Table，进而方便地调用Table API做转换操作</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>默认转换后的Table schema和DataStream中的字段定义一一对应，也可以单独指定出来</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span>                                           <span class="token string">"id, timestamp as ts, temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="11-4-3-创建临时视图-Temporary-View"><a href="#11-4-3-创建临时视图-Temporary-View" class="headerlink" title="11.4.3 创建临时视图(Temporary View)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1143-%E5%88%9B%E5%BB%BA%E4%B8%B4%E6%97%B6%E8%A7%86%E5%9B%BEtemporary-view">11.4.3 创建临时视图(Temporary View)</a></h3><ul><li><p>基于DataStream创建临时视图</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensorView"</span><span class="token punctuation">,</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensorView"</span><span class="token punctuation">,</span>                            dataStream<span class="token punctuation">,</span> <span class="token string">"id, timestamp as ts, temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>基于Table创建临时视图</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensorView"</span><span class="token punctuation">,</span> sensorTable<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h2 id="11-5-查看执行计划"><a href="#11-5-查看执行计划" class="headerlink" title="11.5 查看执行计划"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_115-%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92">11.5 查看执行计划</a></h2><ul><li><p>Table API 提供了一种机制来解释计算表的逻辑和优化查询计划</p></li><li><p>查看执行计划，可以通过<code>TableEnvironment.explain(table)</code>方法或<code>TableEnvironment.explain()</code>方法完成，返回一个字符串，描述三个计划</p><ul><li>  优化的逻辑查询计划</li><li>  优化后的逻辑查询计划</li><li>  实际执行计划</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> explaination <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>explaination<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h2 id="11-6-流处理和关系代数的区别"><a href="#11-6-流处理和关系代数的区别" class="headerlink" title="11.6 流处理和关系代数的区别"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_116-%E6%B5%81%E5%A4%84%E7%90%86%E5%92%8C%E5%85%B3%E7%B3%BB%E4%BB%A3%E6%95%B0%E7%9A%84%E5%8C%BA%E5%88%AB">11.6 流处理和关系代数的区别</a></h2><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106479537">Flink- 将表转换成DataStream | 查看执行计划 | 流处理和关系代数的区别 | 动态表 | 流式持续查询的过程 | 将流转换成动态表 | 持续查询 | 将动态表转换成 DS</a></p></blockquote><p> Table API和SQL，本质上还是基于关系型表的操作方式；而关系型表、关系代数，以及SQL本身，一般是有界的，更适合批处理的场景。这就导致在进行流处理的过程中，理解会稍微复杂一些，需要引入一些特殊概念。</p><p> 可以看到，其实<strong>关系代数（主要就是指关系型数据库中的表）和SQL，主要就是针对批处理的，这和流处理有天生的隔阂。</strong> </p><table><thead><tr><th></th><th>关系代数(表)/SQL</th><th>流处理</th></tr></thead><tbody><tr><td>处理的数据对象</td><td>字段元组的有界集合</td><td>字段元组的无限序列</td></tr><tr><td>查询（Query）对数据的访问</td><td>可以访问到完整的数据输入</td><td>无法访问所有数据，必须持续”等待”流式输入</td></tr><tr><td>查询终止条件</td><td>生成固定大小的结果集后终止</td><td>永不停止，根据持续收到的数据不断更新查询结果</td></tr></tbody></table><h3 id="11-6-1-动态表-Dynamic-Tables"><a href="#11-6-1-动态表-Dynamic-Tables" class="headerlink" title="11.6.1 动态表(Dynamic Tables)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1161-%E5%8A%A8%E6%80%81%E8%A1%A8dynamic-tables">11.6.1 动态表(Dynamic Tables)</a></h3><p> 我们可以<strong>随着新数据的到来，不停地在之前的基础上更新结果</strong>。这样得到的表，在Flink Table API概念里，就叫做“动态表”（Dynamic Tables）。</p><ul><li>  动态表是 Flink 对流数据的 Table API 和 SQL 支持的核心概念</li><li>  与表示批处理数据的静态表不同，动态表是随时间变化的</li><li>持续查询(Continuous Query)<ul><li>  动态表可以像静态的批处理表一样进行查询，查询一个动态表会产生<strong>持续查询（Continuous Query）</strong></li><li>  <strong>连续查询永远不会终止，并会生成另一个动态表</strong></li><li>  查询（Query）会不断更新其动态结果表，以反映其动态输入表上的更改。</li></ul></li></ul><h3 id="11-6-2-动态表和持续查询"><a href="#11-6-2-动态表和持续查询" class="headerlink" title="11.6.2 动态表和持续查询"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1162-%E5%8A%A8%E6%80%81%E8%A1%A8%E5%92%8C%E6%8C%81%E7%BB%AD%E6%9F%A5%E8%AF%A2">11.6.2 动态表和持续查询</a></h3><p><img src="https://img-blog.csdnimg.cn/20200601190927869.png"></p><p>流式表查询的处理过程：</p><ol><li><p> 流被转换为动态表</p></li><li><p> 对动态表计算连续查询，生成新的动态表</p></li><li><p> 生成的动态表被转换回流</p></li></ol><h3 id="11-6-3-将流转换成动态表"><a href="#11-6-3-将流转换成动态表" class="headerlink" title="11.6.3 将流转换成动态表"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1163-%E5%B0%86%E6%B5%81%E8%BD%AC%E6%8D%A2%E6%88%90%E5%8A%A8%E6%80%81%E8%A1%A8">11.6.3 将流转换成动态表</a></h3><ul><li>  为了处理带有关系查询的流，必须先将其转换为表</li><li>  从概念上讲，流的每个数据记录，都被解释为对结果表的插入（Insert）修改操作</li></ul><p><em>本质上，我们其实是从一个、只有插入操作的changelog（更新日志）流，来构建一个表</em></p><p><em>来一条数据插入一条数据</em></p><p><img src="https://img-blog.csdnimg.cn/20200601191016684.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h3 id="11-6-4-持续查询"><a href="#11-6-4-持续查询" class="headerlink" title="11.6.4 持续查询"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1164-%E6%8C%81%E7%BB%AD%E6%9F%A5%E8%AF%A2">11.6.4 持续查询</a></h3><ul><li><p>持续查询，会在动态表上做计算处理，并作为结果生成新的动态表。</p><p><em>与批处理查询不同，连续查询从不终止，并根据输入表上的更新更新其结果表。</em></p><p><em>在任何时间点，连续查询的结果在语义上，等同于在输入表的快照上，以批处理模式执行的同一查询的结果。</em></p></li></ul><p> 下图为一个点击事件流的持续查询，是一个分组聚合做count统计的查询。</p><p><img src="https://img-blog.csdnimg.cn/20200601191112183.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h3 id="11-6-4-将动态表转换成-DataStream"><a href="#11-6-4-将动态表转换成-DataStream" class="headerlink" title="11.6.4 将动态表转换成 DataStream"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1164-%E5%B0%86%E5%8A%A8%E6%80%81%E8%A1%A8%E8%BD%AC%E6%8D%A2%E6%88%90-datastream">11.6.4 将动态表转换成 DataStream</a></h3><ul><li><p>与常规的数据库表一样，动态表可以通过插入（Insert）、更新（Update）和删除（Delete）更改，进行持续的修改</p></li><li><p><strong>将动态表转换为流或将其写入外部系统时，需要对这些更改进行编码</strong></p></li></ul><hr><ul><li><p>仅追加（Append-only）流</p><ul><li>  仅通过插入（Insert）更改来修改的动态表，可以直接转换为仅追加流</li></ul></li><li><p>撤回（Retract）流</p><ul><li><p>撤回流是包含两类消息的流：添加（Add）消息和撤回（Retract）消息</p><p><em>动态表通过将INSERT 编码为add消息、DELETE 编码为retract消息、UPDATE编码为被更改行（前一行）的retract消息和更新后行（新行）的add消息，转换为retract流。</em></p></li></ul></li><li><p>Upsert（更新插入流）</p><ul><li><p>Upsert流也包含两种类型的消息：Upsert消息和删除（Delete）消息</p><p><em>通过将INSERT和UPDATE更改编码为upsert消息，将DELETE更改编码为DELETE消息，就可以将具有唯一键（Unique Key）的动态表转换为流。</em></p></li></ul></li></ul><h3 id="11-6-5-将动态表转换成DataStream"><a href="#11-6-5-将动态表转换成DataStream" class="headerlink" title="11.6.5 将动态表转换成DataStream"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1165-%E5%B0%86%E5%8A%A8%E6%80%81%E8%A1%A8%E8%BD%AC%E6%8D%A2%E6%88%90datastream">11.6.5 将动态表转换成DataStream</a></h3><p><img src="https://img-blog.csdnimg.cn/20200601191549610.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h2 id="12-1-概述"><a href="#12-1-概述" class="headerlink" title="12.1 概述"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_121-%E6%A6%82%E8%BF%B0">12.1 概述</a></h2><ul><li>  基于时间的操作（比如 Table API 和 SQL 中窗口操作），需要定义相关的时间语义和时间数据来源的信息</li><li>  Table 可以提供一个逻辑上的时间字段，用于在表处理程序中，指示时间和访问相应的时间戳</li><li>  <strong>时间属性，可以是每个表schema的一部分。一旦定义了时间属性，它就可以作为一个字段引用，并且可以在基于时间的操作中使用</strong></li><li>  时间属性的行为类似于常规时间戳，可以访问，并且进行计算</li></ul><h2 id="12-2-定义处理时间-Processing-Time"><a href="#12-2-定义处理时间-Processing-Time" class="headerlink" title="12.2 定义处理时间(Processing Time)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_122-%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4processing-time">12.2 定义处理时间(Processing Time)</a></h2><ul><li>  处理时间语义下，允许表处理程序根据机器的本地时间生成结果。它是时间的最简单概念。它既不需要提取时间戳，也不需要生成 watermark</li></ul><h3 id="由DataStream转换成表时指定"><a href="#由DataStream转换成表时指定" class="headerlink" title="由DataStream转换成表时指定"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E7%94%B1datastream%E8%BD%AC%E6%8D%A2%E6%88%90%E8%A1%A8%E6%97%B6%E6%8C%87%E5%AE%9A">由DataStream转换成表时指定</a></h3><ul><li><p>在定义 Table Schema 期间，可以使用<code>.proctime</code>，指定字段名定义处理时间字段</p></li><li><p><strong>这个proctime属性只能通过附加逻辑字段，来扩展物理schema。因此，只能在schema定义的末尾定义它</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span>                                           <span class="token string">"id, temperature, pt.proctime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="定义Table-Schema时指定"><a href="#定义Table-Schema时指定" class="headerlink" title="定义Table Schema时指定"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%AE%9A%E4%B9%89table-schema%E6%97%B6%E6%8C%87%E5%AE%9A">定义Table Schema时指定</a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">BIGINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">DOUBLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"pt"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">proctime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建表的DDL中定义"><a href="#创建表的DDL中定义" class="headerlink" title="创建表的DDL中定义"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%88%9B%E5%BB%BA%E8%A1%A8%E7%9A%84ddl%E4%B8%AD%E5%AE%9A%E4%B9%89">创建表的DDL中定义</a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> sinkDDL <span class="token operator">=</span>   <span class="token string">"create table dataTable ("</span> <span class="token operator">+</span>  <span class="token string">" id varchar(20) not null, "</span> <span class="token operator">+</span>  <span class="token string">" ts bigint, "</span> <span class="token operator">+</span>  <span class="token string">" temperature double, "</span> <span class="token operator">+</span>  <span class="token string">" pt AS PROCTIME() "</span> <span class="token operator">+</span>  <span class="token string">" ) with ("</span> <span class="token operator">+</span>  <span class="token string">" 'connector.type' = 'filesystem', "</span> <span class="token operator">+</span>  <span class="token string">" 'connector.path' = '/sensor.txt', "</span> <span class="token operator">+</span>  <span class="token string">" 'format.type' = 'csv')"</span><span class="token punctuation">;</span>tableEnv<span class="token punctuation">.</span><span class="token function">sqlUpdate</span><span class="token punctuation">(</span>sinkDDL<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试代码-6"><a href="#测试代码-6" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-6">测试代码</a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TimeCharacteristic</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Over</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Tumble</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 12:47 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest5_TimeAndWindow</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 读入文件数据，得到DataStream</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 将流转换成表，定义时间特性</span>    <span class="token class-name">Table</span> dataTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> <span class="token string">"id, timestamp as ts, temperature as temp, pt.proctime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dataTable<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>dataTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">root <span class="token operator">|</span><span class="token operator">--</span> id<span class="token operator">:</span> STRING <span class="token operator">|</span><span class="token operator">--</span> ts<span class="token operator">:</span> BIGINT <span class="token operator">|</span><span class="token operator">--</span> temp<span class="token operator">:</span> DOUBLE <span class="token operator">|</span><span class="token operator">--</span> pt<span class="token operator">:</span> <span class="token function">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span>PROCTIME<span class="token operator">*</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">,</span><span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span>T16<span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">58.048</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">,</span><span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span>T16<span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">58.048</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">,</span><span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span>T16<span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">58.050</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">,</span><span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span>T16<span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">58.050</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span><span class="token punctuation">,</span><span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span>T16<span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">58.051</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span><span class="token punctuation">,</span><span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span>T16<span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">58.051</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span class="token punctuation">,</span><span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span>T16<span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">58.051</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="12-3-定义事件事件-Event-Time"><a href="#12-3-定义事件事件-Event-Time" class="headerlink" title="12.3 定义事件事件(Event Time)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_123-%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6%E4%BA%8B%E4%BB%B6event-time">12.3 定义事件事件(Event Time)</a></h2><ul><li>  事件时间语义，允许表处理程序根据每个记录中包含的时间生成结果。这样即使在有乱序事件或者延迟事件时，也可以获得正确的结果。</li><li>  <strong>为了处理无序事件，并区分流中的准时和迟到事件；Flink需要从事件数据中，提取时间戳，并用来推送事件时间的进展</strong></li><li>定义事件事件，同样有三种方法：<ul><li>  由DataStream转换成表时指定</li><li>  定义Table Schema时指定</li><li>  在创建表的DDL中定义</li></ul></li></ul><h3 id="由DataStream转换成表时指定-1"><a href="#由DataStream转换成表时指定-1" class="headerlink" title="由DataStream转换成表时指定"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E7%94%B1datastream%E8%BD%AC%E6%8D%A2%E6%88%90%E8%A1%A8%E6%97%B6%E6%8C%87%E5%AE%9A-1">由DataStream转换成表时指定</a></h3><ul><li><p>由DataStream转换成表时指定（推荐）</p></li><li><p>在DataStream转换成Table，使用<code>.rowtime</code>可以定义事件事件属性</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 将DataStream转换为Table，并指定时间字段</span><span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span>                                           <span class="token string">"id, timestamp.rowtime, temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 或者，直接追加时间字段</span><span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span>                                          <span class="token string">"id, temperature, timestamp, rt.rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="定义Table-Schema时指定java"><a href="#定义Table-Schema时指定java" class="headerlink" title="定义Table Schema时指定java"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%AE%9A%E4%B9%89table-schema%E6%97%B6%E6%8C%87%E5%AE%9A-1">定义Table Schema时指定<strong>java</strong></a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">withSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">BIGINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">rowtime</span><span class="token punctuation">(</span>              <span class="token keyword">new</span> <span class="token class-name">Rowtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token punctuation">.</span><span class="token function">timestampsFromField</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span> <span class="token comment">// 从字段中提取时间戳</span>              <span class="token punctuation">.</span><span class="token function">watermarksPeriodicBounded</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// watermark延迟1秒</span>            <span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">DOUBLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建表的DDL中定义-1"><a href="#创建表的DDL中定义-1" class="headerlink" title="创建表的DDL中定义"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E5%88%9B%E5%BB%BA%E8%A1%A8%E7%9A%84ddl%E4%B8%AD%E5%AE%9A%E4%B9%89-1">创建表的DDL中定义</a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> sinkDDL <span class="token operator">=</span>   <span class="token string">"create table dataTable ("</span> <span class="token operator">+</span>  <span class="token string">" id varchar(20) not null, "</span> <span class="token operator">+</span>  <span class="token string">" ts bigint, "</span> <span class="token operator">+</span>  <span class="token string">" temperature double, "</span> <span class="token operator">+</span>  <span class="token string">" rt AS TO_TIMESTAMP( FROM_UNIXTIME(ts) ), "</span> <span class="token operator">+</span>  <span class="token string">" watermark for rt as rt - interval '1' second"</span>  <span class="token string">" ) with ("</span> <span class="token operator">+</span>  <span class="token string">" 'connector.type' = 'filesystem', "</span> <span class="token operator">+</span>  <span class="token string">" 'connector.path' = '/sensor.txt', "</span> <span class="token operator">+</span>  <span class="token string">" 'format.type' = 'csv')"</span><span class="token punctuation">;</span>tableEnv<span class="token punctuation">.</span><span class="token function">sqlUpdate</span><span class="token punctuation">(</span>sinkDDL<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试代码-7"><a href="#测试代码-7" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-7">测试代码</a></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TimeCharacteristic</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Over</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Tumble</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 12:47 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest5_TimeAndWindow</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 读入文件数据，得到DataStream</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 将流转换成表，定义时间特性</span>    <span class="token comment">//        Table dataTable = tableEnv.fromDataStream(dataStream, "id, timestamp as ts, temperature as temp, pt.proctime");</span>    <span class="token class-name">Table</span> dataTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> <span class="token string">"id, timestamp as ts, temperature as temp, rt.rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dataTable<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>dataTable<span class="token punctuation">,</span><span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出如下：</p><p><em>注：这里最后一列rt里显示的是EventTime，而不是Processing Time</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">root <span class="token operator">|</span><span class="token operator">--</span> id<span class="token operator">:</span> STRING <span class="token operator">|</span><span class="token operator">--</span> ts<span class="token operator">:</span> BIGINT <span class="token operator">|</span><span class="token operator">--</span> temp<span class="token operator">:</span> DOUBLE <span class="token operator">|</span><span class="token operator">--</span> rt<span class="token operator">:</span> <span class="token function">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span>ROWTIME<span class="token operator">*</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">19</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">21</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">22</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">25</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">36.3</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">27</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">32.8</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">29</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">37.1</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="12-4-窗口"><a href="#12-4-窗口" class="headerlink" title="12.4 窗口"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_124-%E7%AA%97%E5%8F%A3">12.4 窗口</a></h2><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106482095">Flink-分组窗口 | Over Windows | SQL 中的 Group Windows | SQL 中的 Over Windows</a></p></blockquote><ul><li>  时间语义，要配合窗口操作才能发挥作用。</li><li>在Table API和SQL中，主要有两种窗口<ul><li>Group Windows（分组窗口）<ul><li>  <strong>根据时间戳或行计数间隔，将行聚合到有限的组（Group）中，并对每个组的数据执行一次聚合函数</strong></li></ul></li><li>Over Windows<ul><li>  针对每个输入行，计算相邻行范围内的聚合</li></ul></li></ul></li></ul><h3 id="12-4-1-Group-Windows"><a href="#12-4-1-Group-Windows" class="headerlink" title="12.4.1 Group Windows"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1241-group-windows">12.4.1 Group Windows</a></h3><ul><li><p>Group Windows 是使用 window（w:GroupWindow）子句定义的，并且<strong>必须由as子句指定一个别名</strong>。</p></li><li><p>为了按窗口对表进行分组，窗口的别名必须在 group by 子句中，像常规的分组字段一样引用</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Table</span> table <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token operator">:</span><span class="token class-name">GroupWindow</span><span class="token punctuation">]</span> as <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token comment">// 定义窗口，别名为w</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"w, a"</span><span class="token punctuation">)</span> <span class="token comment">// 按照字段 a和窗口 w分组</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"a,b.sum"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 聚合</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Table API 提供了一组具有特定语义的预定义 Window 类，这些类会被转换为底层 DataStream 或 DataSet 的窗口操作</p></li><li><p>分组窗口分为三种：</p><ul><li>  滚动窗口</li><li>  滑动窗口</li><li>  会话窗口</li></ul></li></ul><h4 id="滚动窗口-Tumbling-windows"><a href="#滚动窗口-Tumbling-windows" class="headerlink" title="滚动窗口(Tumbling windows)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3tumbling-windows-1">滚动窗口(Tumbling windows)</a></h4><ul><li>  滚动窗口（Tumbling windows）要用Tumble类来定义</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Tumbling Event-time Window（事件时间字段rowtime）</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Tumble</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token string">"10.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// Tumbling Processing-time Window（处理时间字段proctime）</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Tumble</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token string">"10.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"proctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// Tumbling Row-count Window (类似于计数窗口，按处理时间排序，10行一组)</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Tumble</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token string">"10.rows"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"proctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>  over：定义窗口长度</li><li>  on：用来分组（按时间间隔）或者排序（按行数）的时间字段</li><li>  as：别名，必须出现在后面的groupBy中</li></ul><h4 id="滑动窗口-Sliding-windows"><a href="#滑动窗口-Sliding-windows" class="headerlink" title="滑动窗口(Sliding windows)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3sliding-windows-1">滑动窗口(Sliding windows)</a></h4><ul><li>  滑动窗口（Sliding windows）要用Slide类来定义</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Sliding Event-time Window</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Slide</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token string">"10.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token string">"5.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// Sliding Processing-time window </span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Slide</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token string">"10.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token string">"5.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"proctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// Sliding Row-count window</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Slide</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token string">"10.rows"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token string">"5.rows"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"proctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>  over：定义窗口长度</li><li>  every：定义滑动步长</li><li>  on：用来分组（按时间间隔）或者排序（按行数）的时间字段</li><li>  as：别名，必须出现在后面的groupBy中</li></ul><h4 id="会话窗口-Session-windows"><a href="#会话窗口-Session-windows" class="headerlink" title="会话窗口(Session windows)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3session-windows-1">会话窗口(Session windows)</a></h4><ul><li>  会话窗口（Session windows）要用Session类来定义</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Session Event-time Window</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Session</span><span class="token punctuation">.</span><span class="token function">withGap</span><span class="token punctuation">(</span><span class="token string">"10.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// Session Processing-time Window </span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Session</span><span class="token punctuation">.</span><span class="token function">withGap</span><span class="token punctuation">(</span><span class="token string">"10.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"proctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>  withGap：会话时间间隔</li><li>  on：用来分组（按时间间隔）或者排序（按行数）的时间字段</li><li>  as：别名，必须出现在后面的groupBy中</li></ul><h3 id="12-4-2-SQL中的Group-Windows"><a href="#12-4-2-SQL中的Group-Windows" class="headerlink" title="12.4.2 SQL中的Group Windows"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1242-sql%E4%B8%AD%E7%9A%84group-windows">12.4.2 SQL中的Group Windows</a></h3><p>Group Windows定义在SQL查询的Group By子句中</p><ul><li>TUMBLE(time_attr, interval)<ul><li>  定义一个滚动窗口，每一个参数是时间字段，第二个参数是窗口长度</li></ul></li><li>HOP(time_attr，interval，interval)<ul><li>  定义一个滑动窗口，第一个参数是时间字段，<strong>第二个参数是窗口滑动步长，第三个是窗口长度</strong></li></ul></li><li>SESSION(time_attr，interval)<ul><li>  定义一个绘画窗口，第一个参数是时间字段，第二个参数是窗口间隔</li></ul></li></ul><h4 id="测试代码-8"><a href="#测试代码-8" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-8">测试代码</a></h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TimeCharacteristic</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Over</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Tumble</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 12:47 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest5_TimeAndWindow</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 读入文件数据，得到DataStream</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 将流转换成表，定义时间特性</span>    <span class="token comment">//        Table dataTable = tableEnv.fromDataStream(dataStream, "id, timestamp as ts, temperature as temp, pt.proctime");</span>    <span class="token class-name">Table</span> dataTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> <span class="token string">"id, timestamp as ts, temperature as temp, rt.rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//        dataTable.printSchema();</span>    <span class="token comment">//</span>    <span class="token comment">//        tableEnv.toAppendStream(dataTable,Row.class).print();</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> dataTable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 窗口操作</span>    <span class="token comment">// 5.1 Group Window</span>    <span class="token comment">// table API</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> dataTable<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Tumble</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token string">"10.seconds"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"rt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"tw"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"id, tw"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, id.count, temp.avg, tw.end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// SQL</span>    <span class="token class-name">Table</span> resultSqlTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, count(id) as cnt, avg(temp) as avgTemp, tumble_end(rt, interval '10' second) "</span> <span class="token operator">+</span>                                             <span class="token string">"from sensor group by id, tumble(rt, interval '10' second)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dataTable<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toRetractStream</span><span class="token punctuation">(</span>resultSqlTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">root <span class="token operator">|</span><span class="token operator">--</span> id<span class="token operator">:</span> STRING <span class="token operator">|</span><span class="token operator">--</span> ts<span class="token operator">:</span> BIGINT <span class="token operator">|</span><span class="token operator">--</span> temp<span class="token operator">:</span> DOUBLE <span class="token operator">|</span><span class="token operator">--</span> rt<span class="token operator">:</span> <span class="token function">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span>ROWTIME<span class="token operator">*</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">20</span>result<span class="token operator">&gt;</span> sensor_6<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">34.55</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span>result<span class="token operator">&gt;</span> sensor_10<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span>result<span class="token operator">&gt;</span> sensor_7<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">37.1</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">40</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_6<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">34.55</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_10<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_7<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">37.1</span><span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">40</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="12-4-3-Over-Windows"><a href="#12-4-3-Over-Windows" class="headerlink" title="12.4.3 Over Windows"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1243-over-windows">12.4.3 Over Windows</a></h3><blockquote><p><a href="https://blog.csdn.net/liuyuehui110/article/details/42736667">SQL中over的用法</a></p><p><a href="https://www.cnblogs.com/xiayang/articles/1886372.html">sql over的作用及用法</a></p></blockquote><ul><li><p><strong>Over window 聚合是标准 SQL 中已有的（over 子句），可以在查询的 SELECT 子句中定义</strong></p></li><li><p>Over window 聚合，会<strong>针对每个输入行</strong>，计算相邻行范围内的聚合</p></li><li><p>Over windows 使用 window（w:overwindows*）子句定义，并在 select（）方法中通过<strong>别名</strong>来引用</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Table</span> table <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token operator">:</span> <span class="token class-name">OverWindow</span><span class="token punctuation">]</span> as <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"a, b.sum over w, c.min over w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>Table API 提供了 Over 类，来配置 Over 窗口的属性</p></li></ul><h4 id="无界Over-Windows"><a href="#无界Over-Windows" class="headerlink" title="无界Over Windows"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%97%A0%E7%95%8Cover-windows">无界Over Windows</a></h4><ul><li>  可以在事件时间或处理时间，以及指定为时间间隔、或行计数的范围内，定义 Over windows</li><li>  无界的 over window 是使用常量指定的</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 无界的事件时间over window (时间字段 "rowtime")</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span>UNBOUNDED_RANGE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//无界的处理时间over window (时间字段"proctime")</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"proctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span>UNBOUNDED_RANGE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 无界的事件时间Row-count over window (时间字段 "rowtime")</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span>UNBOUNDED_ROW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//无界的处理时间Row-count over window (时间字段 "rowtime")</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"proctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span>UNBOUNDED_ROW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em>partitionBy是可选项</em></p><h4 id="有界Over-Windows"><a href="#有界Over-Windows" class="headerlink" title="有界Over Windows"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%9C%89%E7%95%8Cover-windows">有界Over Windows</a></h4><ul><li>  有界的over window是用间隔的大小指定的</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 有界的事件时间over window (时间字段 "rowtime"，之前1分钟)</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span><span class="token string">"1.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 有界的处理时间over window (时间字段 "rowtime"，之前1分钟)</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"porctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span><span class="token string">"1.minutes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 有界的事件时间Row-count over window (时间字段 "rowtime"，之前10行)</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span><span class="token string">"10.rows"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 有界的处理时间Row-count over window (时间字段 "rowtime"，之前10行)</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"proctime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span><span class="token string">"10.rows"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="12-4-4-SQL中的Over-Windows"><a href="#12-4-4-SQL中的Over-Windows" class="headerlink" title="12.4.4 SQL中的Over Windows"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1244-sql%E4%B8%AD%E7%9A%84over-windows">12.4.4 SQL中的Over Windows</a></h3><ul><li>  用 Over 做窗口聚合时，所有聚合必须在同一窗口上定义，也就是说必须是相同的分区、排序和范围</li><li>  目前仅支持在当前行范围之前的窗口</li><li>  ORDER BY 必须在单一的时间属性上指定</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> OVER <span class="token punctuation">(</span>  PARTITION BY user  ORDER BY proctime  ROWS BETWEEN <span class="token number">2</span> PRECEDING AND <span class="token class-name">CURRENT</span> ROW<span class="token punctuation">)</span>FROM <span class="token class-name">Orders</span><span class="token comment">// 也可以做多个聚合</span><span class="token class-name">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token class-name">OVER</span> w<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> OVER wFROM <span class="token class-name">Orders</span>WINDOW w AS <span class="token punctuation">(</span>  PARTITION BY user  ORDER BY proctime  ROWS BETWEEN <span class="token number">2</span> PRECEDING AND <span class="token class-name">CURRENT</span> ROW<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="测试代码-9"><a href="#测试代码-9" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-9">测试代码</a></h4><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TimeCharacteristic</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Over</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Tumble</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 12:47 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableTest5_TimeAndWindow</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 读入文件数据，得到DataStream</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">SensorReading</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 将流转换成表，定义时间特性</span>    <span class="token comment">//        Table dataTable = tableEnv.fromDataStream(dataStream, "id, timestamp as ts, temperature as temp, pt.proctime");</span>    <span class="token class-name">Table</span> dataTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> <span class="token string">"id, timestamp as ts, temperature as temp, rt.rowtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//        dataTable.printSchema();</span>    <span class="token comment">//</span>    <span class="token comment">//        tableEnv.toAppendStream(dataTable,Row.class).print();</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> dataTable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 窗口操作</span>    <span class="token comment">// 5.1 Group Window</span>    <span class="token comment">// table API</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> dataTable<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Tumble</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token string">"10.seconds"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"rt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"tw"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"id, tw"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, id.count, temp.avg, tw.end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// SQL</span>    <span class="token class-name">Table</span> resultSqlTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, count(id) as cnt, avg(temp) as avgTemp, tumble_end(rt, interval '10' second) "</span> <span class="token operator">+</span>                                             <span class="token string">"from sensor group by id, tumble(rt, interval '10' second)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5.2 Over Window</span>    <span class="token comment">// table API</span>    <span class="token class-name">Table</span> overResult <span class="token operator">=</span> dataTable<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Over</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"rt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preceding</span><span class="token punctuation">(</span><span class="token string">"2.rows"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"ow"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, rt, id.count over ow, temp.avg over ow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// SQL</span>    <span class="token class-name">Table</span> overSqlResult <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, rt, count(id) over ow, avg(temp) over ow "</span> <span class="token operator">+</span>                                            <span class="token string">" from sensor "</span> <span class="token operator">+</span>                                            <span class="token string">" window ow as (partition by id order by rt rows between 2 preceding and current row)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//        dataTable.printSchema();</span>    <span class="token comment">//        tableEnv.toAppendStream(resultTable, Row.class).print("result");</span>    <span class="token comment">//        tableEnv.toRetractStream(resultSqlTable, Row.class).print("sql");</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>overResult<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toRetractStream</span><span class="token punctuation">(</span>overSqlResult<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出:</p><p><em>因为<code>partition by id order by rt rows between 2 preceding and current row</code>，所以最后2次关于<code>sensor_1</code>的输出的<code>count(id)</code>都是3,但是计算出来的平均值不一样。（前者计算倒数3条sensor_1的数据，后者计算最后最新的3条sensor_1数据的平均值）</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">35.8</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> sensor_6<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15.4</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_6<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> sensor_7<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6.7</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_7<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> sensor_10<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">38.1</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_10<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">36.05</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">34.96666666666666</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">35.4</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">17</span>T09<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">35.4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106482550">Flink-函数 | 用户自定义函数（UDF）标量函数 | 表函数 | 聚合函数 | 表聚合函数</a></p></blockquote><p><img src="https://img-blog.csdnimg.cn/20200601214323293.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/2020060121433777.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h2 id="13-1-用户自定义函数-UDF"><a href="#13-1-用户自定义函数-UDF" class="headerlink" title="13.1 用户自定义函数(UDF)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_131-%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0udf">13.1 用户自定义函数(UDF)</a></h2><ul><li><p>用户定义函数（User-defined Functions，UDF）是一个重要的特性，它们显著地扩展了查询的表达能力</p><p><em>一些系统内置函数无法解决的需求，我们可以用UDF来自定义实现</em></p></li><li><p><strong>在大多数情况下，用户定义的函数必须先注册，然后才能在查询中使用</strong></p></li><li><p>函数通过调用 <code>registerFunction()</code> 方法在 TableEnvironment 中注册。当用户定义的函数被注册时，它被插入到 TableEnvironment 的函数目录中，这样Table API 或 SQL 解析器就可以识别并正确地解释它</p></li></ul><h3 id="13-1-1-标量函数-Scalar-Functions"><a href="#13-1-1-标量函数-Scalar-Functions" class="headerlink" title="13.1.1 标量函数(Scalar Functions)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1311-%E6%A0%87%E9%87%8F%E5%87%BD%E6%95%B0scalar-functions">13.1.1 标量函数(Scalar Functions)</a></h3><p><strong>Scalar Funcion类似于map，一对一</strong></p><p><strong>Table Function类似flatMap，一对多</strong></p><hr><ul><li><p>用户定义的标量函数，可以将0、1或多个标量值，映射到新的标量值</p></li><li><p>为了定义标量函数，必须在 org.apache.flink.table.functions 中扩展基类Scalar Function，并实现（一个或多个）求值（eval）方法</p></li><li><p><strong>标量函数的行为由求值方法决定，求值方法必须public公开声明并命名为 eval</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HashCode</span> <span class="token keyword">extends</span> <span class="token class-name">ScalarFunction</span> <span class="token punctuation">{</span>  <span class="token keyword">private</span> <span class="token keyword">int</span> factor <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token class-name">HashCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> factor<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>factor <span class="token operator">=</span> factor<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> id<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">13</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="测试代码-10"><a href="#测试代码-10" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-10">测试代码</a></h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi<span class="token punctuation">.</span>udf</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">ScalarFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 3:28 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdfTest1_ScalarFunction</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 并行度设置为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建Table执行环境</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 转换成POJO</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 将流转换为表</span>    <span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> <span class="token string">"id,timestamp as ts,temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 自定义标量函数，实现求id的hash值</span>    <span class="token class-name">HashCode</span> hashCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashCode</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注册UDF</span>    tableEnv<span class="token punctuation">.</span><span class="token function">registerFunction</span><span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">,</span> hashCode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.1 table API</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> sensorTable<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, ts, hashCode(id)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.2 SQL</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> sensorTable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> resultSqlTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, ts, hashCode(id) from sensor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 打印输出</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultSqlTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HashCode</span> <span class="token keyword">extends</span> <span class="token class-name">ScalarFunction</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> factor <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">HashCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> factor<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>factor <span class="token operator">=</span> factor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> id<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">13</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出结果</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373508</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373508</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373443</span>sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373443</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373430</span>sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373430</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">1826225652</span>sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">1826225652</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373508</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373508</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373508</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373508</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373508</span>sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">772373508</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-2-表函数-Table-Fcuntions"><a href="#13-1-2-表函数-Table-Fcuntions" class="headerlink" title="13.1.2 表函数(Table Fcuntions)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1312-%E8%A1%A8%E5%87%BD%E6%95%B0table-fcuntions">13.1.2 表函数(Table Fcuntions)</a></h3><p><strong>Scalar Funcion类似于map，一对一</strong></p><p><strong>Table Function类似flatMap，一对多</strong></p><hr><ul><li><p>用户定义的表函数，也可以将0、1或多个标量值作为输入参数；<strong>与标量函数不同的是，它可以返回任意数量的行作为输出，而不是单个值</strong></p></li><li><p>为了定义一个表函数，必须扩展 org.apache.flink.table.functions 中的基类 TableFunction 并实现（一个或多个）求值方法</p></li><li><p><strong>表函数的行为由其求值方法决定，求值方法必须是 public 的，并命名为 eval</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Split</span> <span class="token keyword">extends</span> <span class="token class-name">TableFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>  <span class="token comment">// 定义属性，分隔符</span>  <span class="token keyword">private</span> <span class="token class-name">String</span> separator <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token class-name">Split</span><span class="token punctuation">(</span><span class="token class-name">String</span> separator<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>separator <span class="token operator">=</span> separator<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>separator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="测试代码-11"><a href="#测试代码-11" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-11">测试代码</a></h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi<span class="token punctuation">.</span>udf</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">TableFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 3:58 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdfTest2_TableFunction</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 并行度设置为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 创建Table执行环境</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 转换成POJO</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 将流转换为表</span>    <span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> <span class="token string">"id,timestamp as ts,temperature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 自定义表函数，实现将id拆分，并输出（word, length）</span>    <span class="token class-name">Split</span> split <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 需要在环境中注册UDF</span>    tableEnv<span class="token punctuation">.</span><span class="token function">registerFunction</span><span class="token punctuation">(</span><span class="token string">"split"</span><span class="token punctuation">,</span> split<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.1 table API</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> sensorTable      <span class="token punctuation">.</span><span class="token function">joinLateral</span><span class="token punctuation">(</span><span class="token string">"split(id) as (word, length)"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, ts, word, length"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.2 SQL</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> sensorTable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> resultSqlTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, ts, word, length "</span> <span class="token operator">+</span>                                             <span class="token string">" from sensor, lateral table(split(id)) as splitid(word, length)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 打印输出</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>resultSqlTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义 Table Function</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Split</span> <span class="token keyword">extends</span> <span class="token class-name">TableFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义属性，分隔符</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> separator <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Split</span><span class="token punctuation">(</span><span class="token class-name">String</span> separator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>separator <span class="token operator">=</span> separator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>separator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出结果</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718199</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>result<span class="token operator">&gt;</span> sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>result<span class="token operator">&gt;</span> sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span>sql<span class="token operator">&gt;</span> sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>sql<span class="token operator">&gt;</span> sensor_6<span class="token punctuation">,</span><span class="token number">1547718201</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span>result<span class="token operator">&gt;</span> sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>result<span class="token operator">&gt;</span> sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">1</span>sql<span class="token operator">&gt;</span> sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>sql<span class="token operator">&gt;</span> sensor_7<span class="token punctuation">,</span><span class="token number">1547718202</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">1</span>result<span class="token operator">&gt;</span> sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>result<span class="token operator">&gt;</span> sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span>sql<span class="token operator">&gt;</span> sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>sql<span class="token operator">&gt;</span> sensor_10<span class="token punctuation">,</span><span class="token number">1547718205</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718207</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718209</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>result<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span>sensor<span class="token punctuation">,</span><span class="token number">6</span>sql<span class="token operator">&gt;</span> sensor_1<span class="token punctuation">,</span><span class="token number">1547718212</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-3-聚合函数-Aggregate-Functions"><a href="#13-1-3-聚合函数-Aggregate-Functions" class="headerlink" title="13.1.3 聚合函数(Aggregate Functions)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1313-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0aggregate-functions">13.1.3 聚合函数(Aggregate Functions)</a></h3><p><strong>聚合，多对一，类似前面的窗口聚合</strong></p><hr><ul><li>  用户自定义聚合函数（User-Defined Aggregate Functions，UDAGGs）可以把一个表中的数据，聚合成一个标量值</li><li>  用户定义的聚合函数，是通过继承 AggregateFunction 抽象类实现的</li></ul><p><img src="https://img-blog.csdnimg.cn/20200601221643915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>AggregationFunction要求必须实现的方法<ul><li>  <code>createAccumulator()</code></li><li>  <code>accumulate()</code></li><li>  <code>getValue()</code></li></ul></li><li>AggregateFunction 的工作原理如下：<ul><li>  首先，它需要一个累加器（Accumulator），用来保存聚合中间结果的数据结构；可以通过调用 <code>createAccumulator()</code> 方法创建空累加器</li><li>  随后，对每个输入行调用函数的 <code>accumulate()</code> 方法来更新累加器</li><li>  处理完所有行后，将调用函数的 <code>getValue()</code> 方法来计算并返回最终结果</li></ul></li></ul><h4 id="测试代码-12"><a href="#测试代码-12" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-12">测试代码</a></h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">apitest<span class="token punctuation">.</span>tableapi<span class="token punctuation">.</span>udf</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">apitest<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 4:24 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UdfTest3_AggregateFunction</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/Flink_Tutorial/src/main/resources/sensor.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 转换成POJO</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SensorReading</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SensorReading</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 将流转换成表</span>    <span class="token class-name">Table</span> sensorTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> <span class="token string">"id, timestamp as ts, temperature as temp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 自定义聚合函数，求当前传感器的平均温度值</span>    <span class="token comment">// 4.1 table API</span>    <span class="token class-name">AvgTemp</span> avgTemp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AvgTemp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 需要在环境中注册UDF</span>    tableEnv<span class="token punctuation">.</span><span class="token function">registerFunction</span><span class="token punctuation">(</span><span class="token string">"avgTemp"</span><span class="token punctuation">,</span> avgTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> sensorTable      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token string">"avgTemp(temp) as avgtemp"</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id, avgtemp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.2 SQL</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> sensorTable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> resultSqlTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select id, avgTemp(temp) "</span> <span class="token operator">+</span>                                             <span class="token string">" from sensor group by id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 打印输出</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toRetractStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toRetractStream</span><span class="token punctuation">(</span>resultSqlTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的AggregateFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AvgTemp</span> <span class="token keyword">extends</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Double</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">.</span>f0 <span class="token operator">/</span> accumulator<span class="token punctuation">.</span>f1<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 必须实现一个accumulate方法，来数据之后更新状态</span>    <span class="token comment">// 这里方法名必须是这个，且必须public。</span>    <span class="token comment">// 累加器参数，必须得是第一个参数；随后的才是我们自己传的入参</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accumulate</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> accumulator<span class="token punctuation">,</span> <span class="token class-name">Double</span> temp<span class="token punctuation">)</span> <span class="token punctuation">{</span>      accumulator<span class="token punctuation">.</span>f0 <span class="token operator">+=</span> temp<span class="token punctuation">;</span>      accumulator<span class="token punctuation">.</span>f1 <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出结果：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_6<span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_7<span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_10<span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_6<span class="token punctuation">,</span><span class="token number">15.4</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_7<span class="token punctuation">,</span><span class="token number">6.7</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_10<span class="token punctuation">,</span><span class="token number">38.1</span><span class="token punctuation">)</span>result<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">35.5</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">35.8</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">36.05</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">34.96666666666666</span><span class="token punctuation">)</span>sql<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>sensor_1<span class="token punctuation">,</span><span class="token number">35.5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="13-1-4-表聚合函数"><a href="#13-1-4-表聚合函数" class="headerlink" title="13.1.4 表聚合函数"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1314-%E8%A1%A8%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0">13.1.4 表聚合函数</a></h3><ul><li>  用户定义的表聚合函数（User-Defined Table Aggregate Functions，UDTAGGs），可以把一个表中数据，聚合为具有多行和多列的结果表</li><li>  用户定义表聚合函数，是通过继承 TableAggregateFunction 抽象类来实现的</li></ul><p><img src="https://img-blog.csdnimg.cn/20200601223517314.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>AggregationFunction 要求必须实现的方法：<ul><li>  <code>createAccumulator()</code></li><li>  <code>accumulate()</code></li><li>  <code>emitValue()</code></li></ul></li><li>TableAggregateFunction 的工作原理如下：<ul><li>  首先，它同样需要一个累加器（Accumulator），它是保存聚合中间结果的数据结构。通过调用 <code>createAccumulator()</code> 方法可以创建空累加器。</li><li>  随后，对每个输入行调用函数的 <code>accumulate()</code> 方法来更新累加器。</li><li>  处理完所有行后，将调用函数的 <code>emitValue()</code> 方法来计算并返回最终结果。</li></ul></li></ul><h4 id="测试代码-13"><a href="#测试代码-13" class="headerlink" title="测试代码"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81-13">测试代码</a></h4><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106482550">Flink-函数 | 用户自定义函数（UDF）标量函数 | 表函数 | 聚合函数 | 表聚合函数</a></p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span><span class="token class-name">SensorReading</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TimeCharacteristic</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">TableAggregateFunction</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span>object <span class="token class-name">TableAggregateFunctionTest</span> <span class="token punctuation">{</span>  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment">// 开启事件时间语义</span>    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span>    <span class="token comment">// 创建表环境</span>    val tableEnv<span class="token operator">:</span> <span class="token class-name">StreamTableEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span>    val inputDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"D:\\MyWork\\WorkSpaceIDEA\\flink-tutorial\\src\\main\\resources\\SensorReading.txt"</span><span class="token punctuation">)</span>    val dataDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">SensorReading</span><span class="token punctuation">]</span> <span class="token operator">=</span> inputDStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>      data <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>        val dataArray<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>        <span class="token class-name">SensorReading</span><span class="token punctuation">(</span><span class="token function">dataArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dataArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">dataArray</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">)</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">[</span><span class="token class-name">SensorReading</span><span class="token punctuation">]</span>                                   <span class="token punctuation">(</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>                                     override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token class-name">SensorReading</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>timestamp <span class="token operator">*</span> <span class="token number">1000L</span>                                   <span class="token punctuation">}</span> <span class="token punctuation">)</span>    <span class="token comment">// 用proctime定义处理时间</span>    val dataTable<span class="token operator">:</span> <span class="token class-name">Table</span> <span class="token operator">=</span> tableEnv    <span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataDStream<span class="token punctuation">,</span> <span class="token char">'id, '</span>temperature<span class="token punctuation">,</span> 'timestamp<span class="token punctuation">.</span>rowtime as 'ts<span class="token punctuation">)</span>    <span class="token comment">// 使用自定义的hash函数，求id的哈希值</span>    val myAggTabTemp <span class="token operator">=</span> <span class="token class-name">MyAggTabTemp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 查询 Table API 方式</span>    val resultTable<span class="token operator">:</span> <span class="token class-name">Table</span> <span class="token operator">=</span> dataTable    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>'id<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">flatAggregate</span><span class="token punctuation">(</span> <span class="token function">myAggTabTemp</span><span class="token punctuation">(</span>'temperature<span class="token punctuation">)</span> as <span class="token punctuation">(</span><span class="token char">'temp, '</span>rank<span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token char">'id, '</span>temp<span class="token punctuation">,</span> 'rank<span class="token punctuation">)</span>    <span class="token comment">// SQL调用方式，首先要注册表</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"dataTable"</span><span class="token punctuation">,</span> dataTable<span class="token punctuation">)</span>    <span class="token comment">// 注册函数</span>    tableEnv<span class="token punctuation">.</span><span class="token function">registerFunction</span><span class="token punctuation">(</span><span class="token string">"myAggTabTemp"</span><span class="token punctuation">,</span> myAggTabTemp<span class="token punctuation">)</span>    <span class="token comment">/*    val resultSqlTable: Table = tableEnv.sqlQuery(      """        |select id, temp, `rank`        |from dataTable, lateral table(myAggTabTemp(temperature)) as aggtab(temp, `rank`)        |group by id        |""".stripMargin)*/</span>    <span class="token comment">// 测试输出</span>    resultTable<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span> <span class="token class-name">Row</span> <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span> <span class="token string">"scalar"</span> <span class="token punctuation">)</span>    <span class="token comment">//resultSqlTable.toAppendStream[ Row ].print( "scalar_sql" )</span>    <span class="token comment">// 查看表结构</span>    dataTable<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">" table ProcessingTime test job"</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// 自定义状态类</span><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">AggTabTempAcc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> highestTemp<span class="token operator">:</span> <span class="token class-name">Double</span> <span class="token operator">=</span> <span class="token class-name">Double<span class="token punctuation">.</span>MinValue</span>  <span class="token keyword">var</span> secondHighestTemp<span class="token operator">:</span> <span class="token class-name">Double</span> <span class="token operator">=</span> <span class="token class-name">Double<span class="token punctuation">.</span>MinValue</span><span class="token punctuation">}</span><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">MyAggTabTemp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> <span class="token class-name">TableAggregateFunction</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">AggTabTempAcc</span><span class="token punctuation">]</span><span class="token punctuation">{</span>  <span class="token comment">// 初始化状态</span>  override def <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">AggTabTempAcc</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AggTabTempAcc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 每来一个数据后，聚合计算的操作</span>  def <span class="token function">accumulate</span><span class="token punctuation">(</span> acc<span class="token operator">:</span> <span class="token class-name">AggTabTempAcc</span><span class="token punctuation">,</span> temp<span class="token operator">:</span> <span class="token class-name">Double</span> <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span><span class="token punctuation">{</span>    <span class="token comment">// 将当前温度值，跟状态中的最高温和第二高温比较，如果大的话就替换</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> temp <span class="token operator">&gt;</span> acc<span class="token punctuation">.</span>highestTemp <span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token comment">// 如果比最高温还高，就排第一，其它温度依次后移</span>      acc<span class="token punctuation">.</span>secondHighestTemp <span class="token operator">=</span> acc<span class="token punctuation">.</span>highestTemp      acc<span class="token punctuation">.</span>highestTemp <span class="token operator">=</span> temp    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> temp <span class="token operator">&gt;</span> acc<span class="token punctuation">.</span>secondHighestTemp <span class="token punctuation">)</span><span class="token punctuation">{</span>      acc<span class="token punctuation">.</span>secondHighestTemp <span class="token operator">=</span> temp    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现一个输出数据的方法，写入结果表中</span>  def <span class="token function">emitValue</span><span class="token punctuation">(</span> acc<span class="token operator">:</span> <span class="token class-name">AggTabTempAcc</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span><span class="token punctuation">{</span>    out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span>highestTemp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span>secondHighestTemp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><a href="https://blog.csdn.net/qq_40180229/article/details/106502286">Flink电商项目第一天-电商用户行为分析及完整图步骤解析-热门商品统计TopN的实现</a></p></blockquote><ul><li>  批处理和流处理</li><li>  电商用户行为分析</li><li>  数据源解析</li><li>  项目模块划分</li></ul><h2 id="14-1-批处理和流处理"><a href="#14-1-批处理和流处理" class="headerlink" title="14.1 批处理和流处理"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_141-%E6%89%B9%E5%A4%84%E7%90%86%E5%92%8C%E6%B5%81%E5%A4%84%E7%90%86">14.1 批处理和流处理</a></h2><h3 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%89%B9%E5%A4%84%E7%90%86">批处理</a></h3><p>批处理主要操作大容量静态数据集，并在计算过程完成后返回结果。</p><p>可以认为，处理的是用一个固定时间间隔分组的数据点集合。</p><p>批处理模式中使用的数据集通常符合下列特征：</p><ul><li>  <strong>有界：批处理数据集代表数据的有限集合</strong></li><li>  <strong>持久：数据通常始终存储在某种类型的持久存储位置中</strong></li><li>  <strong>大量：批处理操作通常是处理极为海量数据集的唯一方法</strong></li></ul><h3 id="流处理"><a href="#流处理" class="headerlink" title="流处理"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%B5%81%E5%A4%84%E7%90%86">流处理</a></h3><p>流处理可以对随时进入系统的数据进行计算。</p><p>流处理方式无需针对整个数据集执行操作，而是对通过系统传输的每个数据项执行操作。</p><p>流处理中的数据集是“无边界”的，这就产生了几个重要的影响：</p><ul><li><p>  可以处理几乎无限量的数据，但<strong>同一时间只能处理一条数据，不同记录间只维持最少量的状态</strong></p></li><li><p>  处理工作是基于事件的，除非明确停止否则没有“尽头”</p></li><li><p>  处理结果立刻可用，并会随着新数据的抵达继续更新。</p></li></ul><h2 id="14-2-电商用户行为分析"><a href="#14-2-电商用户行为分析" class="headerlink" title="14.2 电商用户行为分析"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_142-%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90">14.2 电商用户行为分析</a></h2><p><img src="https://img-blog.csdnimg.cn/20200602182834724.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>统计分析<ul><li>  点击、浏览</li><li>  热门商品、近期热门商品、分类热门商品，流量统计</li></ul></li><li>偏好统计<ul><li>  收藏、喜欢、评分、打标签</li><li>  用户画像，推荐列表（结合特征工程和机器学习算法）</li></ul></li><li>风险控制<ul><li>  下订单、支付、登录</li><li>  刷单监控，订单失效监控，恶意登录（短时间内频繁登录失败）监控</li></ul></li></ul><h3 id="项目模块设计"><a href="#项目模块设计" class="headerlink" title="项目模块设计"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E9%A1%B9%E7%9B%AE%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1">项目模块设计</a></h3><p><img src="https://img-blog.csdnimg.cn/20200602183018421.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/20200602183121950.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h3 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%95%B0%E6%8D%AE%E6%BA%90">数据源</a></h3><p><img src="https://img-blog.csdnimg.cn/20200602183227549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h3 id="数据源-数据结构"><a href="#数据源-数据结构" class="headerlink" title="数据源-数据结构"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%95%B0%E6%8D%AE%E6%BA%90-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">数据源-数据结构</a></h3><p><strong>UserBehavior</strong></p><p><img src="https://img-blog.csdnimg.cn/20200602183249723.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p><strong>ApacheLogEvent</strong></p><p><img src="https://img-blog.csdnimg.cn/20200602183323920.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h2 id="14-3-项目模块"><a href="#14-3-项目模块" class="headerlink" title="14.3 项目模块"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_143-%E9%A1%B9%E7%9B%AE%E6%A8%A1%E5%9D%97">14.3 项目模块</a></h2><p><img src="https://img-blog.csdnimg.cn/20200602183434342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h3 id="14-3-1-热门实时商品统计"><a href="#14-3-1-热门实时商品统计" class="headerlink" title="14.3.1 热门实时商品统计"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1431-%E7%83%AD%E9%97%A8%E5%AE%9E%E6%97%B6%E5%95%86%E5%93%81%E7%BB%9F%E8%AE%A1">14.3.1 热门实时商品统计</a></h3><p><img src="https://img-blog.csdnimg.cn/20200602183513841.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/20200602183537531.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  按照商品id进行分区</li></ul><p><img src="https://img-blog.csdnimg.cn/20200602183613384.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  设置窗口时间</li></ul><p><img src="https://img-blog.csdnimg.cn/20200602183637249.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  时间窗口（timeWindow）区间为左闭右开</li><li>  同一份数据会被分发到不同的窗口</li></ul><p><img src="https://img-blog.csdnimg.cn/20200602183733756.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  窗口聚合</li></ul><p><img src="https://img-blog.csdnimg.cn/20200602183749122.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p>窗口聚合策略——没出现一条记录就加一</p></li><li><p>实现AggregateFunction接口</p><p><code>interface AggregateFunction&lt;IN, ACC, OUT&gt;</code></p></li><li><p>定义输出结构——<code>ItemViewCount(itemId,windowEnd,count)</code></p></li><li><p>实现WindowFunction接口</p><ul><li><p><code>interface WindowFunction&lt;IN,OUT,KEY,W extends Window&gt;</code></p><ul><li>  IN：输入为累加器的类型，Long</li><li>  OUT：窗口累加以后输出的类型为<code>ItemViewCount(itemId: Long,windowEnd: Long,count: Long)</code>，windowEnd为窗口的结束时间，也是窗口的唯一标识</li><li>  KEY：Tuple泛型，在这里是itemId，窗口根据itemId聚合</li><li>  W：聚合的窗口，<code>w.getEnd</code>就能拿到窗口的结束时间</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> tuple<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span>                 <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>  <span class="token class-name">Long</span> itemId <span class="token operator">=</span> tuple<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Long</span> windowEnd <span class="token operator">-</span> window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Long</span> count <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ItemViewCount</span><span class="token punctuation">(</span>itemId<span class="token punctuation">,</span> windowEnd<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>窗口聚合示例</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200602183856808.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  <strong>进行统计整理 —— keyBy(“windowEnd”)</strong></li></ul><p><img src="https://img-blog.csdnimg.cn/2020060218391775.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li>  状态编程</li></ul><p><img src="https://img-blog.csdnimg.cn/20200602183935754.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><ul><li><p><strong>最终排序输出——keyedProcessFunction</strong></p><ul><li>  针对有状态流的底层API</li><li>  KeyedProcessFunction会对分区后的每一条子流进行处理</li><li>  以windowEnd作为key，保证分流以后每一条流的数据都在一个时间窗口内</li><li>  从ListState中读取当前流的状态，存储数据进行排序输出</li></ul><hr><ul><li>  用ProcessFunction定义KeyedStream的处理逻辑</li><li>分区之后，每个KeyedStream都有其自己的生命周期<ul><li>  open：初始化，在这里可以获取当前流的状态</li><li>  processElement：处理流中每一个元素时调用</li><li>  onTimer：定时调用，注册定时器Timer并触发之后的回调操作</li></ul></li></ul></li></ul><p><img src="https://img-blog.csdnimg.cn/20200602184003237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMTgwMjI5,size_16,color_FFFFFF,t_70"></p><h4 id="POJO"><a href="#POJO" class="headerlink" title="POJO"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=pojo">POJO</a></h4><p>需要生成get/set、无参/有参构造函数、toString</p><ul><li><p>ItemViewCount</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> itemId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> windowEnd<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>UserBehavior</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> uerId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> itemId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Integer</span> categoryId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> behavior<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码1-文件"><a href="#代码1-文件" class="headerlink" title="代码1-文件"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%811-%E6%96%87%E4%BB%B6">代码1-文件</a></h4><ul><li><p>父pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span>         xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>modelVersion<span class="token punctuation">&gt;</span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>example<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span><span class="token class-name">UserBehaviorAnalysis</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>packaging<span class="token punctuation">&gt;</span></span>pom<span class="token operator">&lt;</span><span class="token operator">/</span>packaging<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>modules<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">module</span><span class="token punctuation">&gt;</span></span><span class="token class-name">HotItemsAnalysis</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">module</span><span class="token operator">&gt;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>modules<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token punctuation">&gt;</span></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>source<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token punctuation">&gt;</span></span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>maven<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>target<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.12</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>flink<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.12</span><span class="token operator">&lt;</span><span class="token operator">/</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>kafka<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.7</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>kafka<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>mysql<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">8.0</span><span class="token number">.19</span><span class="token operator">&lt;</span><span class="token operator">/</span>mysql<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>      <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>      <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>streaming<span class="token operator">-</span>java_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>      <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>clients_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>      <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>kafka_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>kafka<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>      <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>kafka_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>      <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>build<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>plugins<span class="token punctuation">&gt;</span></span>      <span class="token generics"><span class="token punctuation">&lt;</span>plugin<span class="token punctuation">&gt;</span></span>        <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>maven<span class="token operator">-</span>compiler<span class="token operator">-</span>plugin<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>        <span class="token generics"><span class="token punctuation">&lt;</span>configuration<span class="token punctuation">&gt;</span></span>          <span class="token generics"><span class="token punctuation">&lt;</span>source<span class="token punctuation">&gt;</span></span><span class="token number">1.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>source<span class="token operator">&gt;</span>          <span class="token generics"><span class="token punctuation">&lt;</span>target<span class="token punctuation">&gt;</span></span><span class="token number">1.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>target<span class="token operator">&gt;</span>          <span class="token generics"><span class="token punctuation">&lt;</span>encoding<span class="token punctuation">&gt;</span></span>UTF<span class="token operator">-</span><span class="token number">8</span><span class="token operator">&lt;</span><span class="token operator">/</span>encoding<span class="token operator">&gt;</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>      <span class="token operator">&lt;</span><span class="token operator">/</span>plugin<span class="token operator">&gt;</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>plugins<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>build<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">ItemViewCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">UserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">Lists</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingProcessingTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 6:07 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotItems</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 从csv文件中获取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/UserBehaviorAnalysis/HotItemsAnalysis/src/main/resources/UserBehavior.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO,分配时间戳和watermark</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> userBehaviorDataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserBehavior</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 分组开窗聚合，得到每个窗口内各个商品的count值</span>    <span class="token comment">//        DataStream&lt;ItemViewCount&gt; windowAggStream = userBehaviorDataStream</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemViewCount</span><span class="token punctuation">&gt;</span></span> windowAggStream <span class="token operator">=</span> userBehaviorDataStream      <span class="token comment">// 过滤只保留pv行为</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>userBehavior <span class="token operator">-&gt;</span> <span class="token string">"pv"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userBehavior<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// 按照商品ID分组</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span><span class="token operator">::</span><span class="token function">getItemId</span><span class="token punctuation">)</span>      <span class="token comment">// 滑动窗口</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ItemCountAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WindowItemCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 收集同一窗口的所有商品的count数据，排序输出top n</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> windowAggStream      <span class="token comment">// 按照窗口分组</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">ItemViewCount</span><span class="token operator">::</span><span class="token function">getWindowEnd</span><span class="token punctuation">)</span>      <span class="token comment">// 用自定义处理函数排序取前5</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopNHotItems</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"hot items analysis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义增量聚合函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ItemCountAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义全窗口函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WindowItemCountResult</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ItemViewCount</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Long</span> itemId<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">Long</span> windowEnd <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Long</span> count <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ItemViewCount</span><span class="token punctuation">(</span>itemId<span class="token punctuation">,</span> windowEnd<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义KeyedProcessFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TopNHotItems</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ItemViewCount</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义属性， TopN的大小</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> topSize<span class="token punctuation">;</span>    <span class="token comment">// 定义状态列表，保存当前窗口内所有输出的ItemViewCount</span>    <span class="token class-name">ListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemViewCount</span><span class="token punctuation">&gt;</span></span> itemViewCountListState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      itemViewCountListState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getListState</span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemViewCount</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"item-view-count-list"</span><span class="token punctuation">,</span> <span class="token class-name">ItemViewCount</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//        @Override</span>    <span class="token comment">//        public void close() throws Exception {</span>    <span class="token comment">//            itemViewCountListState.clear();</span>    <span class="token comment">//        }</span>    <span class="token keyword">public</span> <span class="token class-name">TopNHotItems</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> topSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>topSize <span class="token operator">=</span> topSize<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">ItemViewCount</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 每来一条数据，存入List中，并注册定时器</span>      itemViewCountListState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 模拟等待，所以这里时间设的比较短(1ms)</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getWindowEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 定时器触发，当前已收集到所有数据，排序输出</span>      <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemViewCount</span><span class="token punctuation">&gt;</span></span> itemViewCounts <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>itemViewCountListState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 从多到少(越热门越前面)</span>      itemViewCounts<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token operator">-</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">StringBuilder</span> resultBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"============================"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"窗口结束时间："</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 遍历列表，取top n输出</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>topSize<span class="token punctuation">,</span> itemViewCounts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ItemViewCount</span> currentItemViewCount <span class="token operator">=</span> itemViewCounts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"NO "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" 商品ID = "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>currentItemViewCount<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" 热门度 = "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>currentItemViewCount<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"==============================="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 控制输出频率</span>      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>resultBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输入文件如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">543462</span><span class="token punctuation">,</span><span class="token number">1715</span><span class="token punctuation">,</span><span class="token number">1464116</span><span class="token punctuation">,</span>pv<span class="token punctuation">,</span><span class="token number">1511658000</span><span class="token number">662867</span><span class="token punctuation">,</span><span class="token number">2244074</span><span class="token punctuation">,</span><span class="token number">1575622</span><span class="token punctuation">,</span>pv<span class="token punctuation">,</span><span class="token number">1511658000</span><span class="token number">561558</span><span class="token punctuation">,</span><span class="token number">3611281</span><span class="token punctuation">,</span><span class="token number">965809</span><span class="token punctuation">,</span>pv<span class="token punctuation">,</span><span class="token number">1511658000</span><span class="token number">894923</span><span class="token punctuation">,</span><span class="token number">3076029</span><span class="token punctuation">,</span><span class="token number">1879194</span><span class="token punctuation">,</span>pv<span class="token punctuation">,</span><span class="token number">1511658000</span><span class="token number">834377</span><span class="token punctuation">,</span><span class="token number">4541270</span><span class="token punctuation">,</span><span class="token number">3738615</span><span class="token punctuation">,</span>pv<span class="token punctuation">,</span><span class="token number">1511658000</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">00.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">2338453</span> 热门度 <span class="token operator">=</span> <span class="token number">30</span>NO <span class="token number">2</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">812879</span> 热门度 <span class="token operator">=</span> <span class="token number">18</span>NO <span class="token number">3</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">2563440</span> 热门度 <span class="token operator">=</span> <span class="token number">14</span>NO <span class="token number">4</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">138964</span> 热门度 <span class="token operator">=</span> <span class="token number">12</span>NO <span class="token number">5</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">3244134</span> 热门度 <span class="token operator">=</span> <span class="token number">12</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">00.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">2338453</span> 热门度 <span class="token operator">=</span> <span class="token number">33</span>NO <span class="token number">2</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">812879</span> 热门度 <span class="token operator">=</span> <span class="token number">18</span>NO <span class="token number">3</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">3244134</span> 热门度 <span class="token operator">=</span> <span class="token number">13</span>NO <span class="token number">4</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">2563440</span> 热门度 <span class="token operator">=</span> <span class="token number">13</span>NO <span class="token number">5</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">2364679</span> 热门度 <span class="token operator">=</span> <span class="token number">13</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">00.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">2338453</span> 热门度 <span class="token operator">=</span> <span class="token number">32</span>NO <span class="token number">2</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">812879</span> 热门度 <span class="token operator">=</span> <span class="token number">18</span>NO <span class="token number">3</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">3244134</span> 热门度 <span class="token operator">=</span> <span class="token number">15</span>NO <span class="token number">4</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">4649427</span> 热门度 <span class="token operator">=</span> <span class="token number">13</span>NO <span class="token number">5</span><span class="token operator">:</span> 商品ID <span class="token operator">=</span> <span class="token number">2364679</span> 热门度 <span class="token operator">=</span> <span class="token number">12</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码2-kafka"><a href="#代码2-kafka" class="headerlink" title="代码2-kafka"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%812-kafka">代码2-kafka</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 仅修改 获取数据源的部分</span><span class="token comment">// 2. 从csv文件中获取数据</span><span class="token comment">//        DataStream&lt;String&gt; inputStream = env.readTextFile("/tmp/UserBehaviorAnalysis/HotItemsAnalysis/src/main/resources/UserBehavior.csv");</span><span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"consumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 下面是一些次要参数</span>properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"auto.offset.reset"</span><span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 2. 从kafka消费数据</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"hotitems"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动本地kafka里自带的zookeeper</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/zookeeper-server-start.sh config/zookeeper.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>启动kafka</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-server-start.sh config/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>启动kafka生产者console</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-console-producer.sh --broker-list localhost:9092  --topic hotitems<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>运行Flink程序，输入数据（kafka-console-producer）</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bin/kafka-console-producer.sh --broker-list localhost:9092  --topic hotitems<span class="token operator">&gt;</span><span class="token number">543462,1715</span>,1464116,pv,1511658000<span class="token operator">&gt;</span><span class="token number">662867,2244074</span>,1575622,pv,1511658060<span class="token operator">&gt;</span><span class="token number">561558,3611281</span>,965809,pv,1511658120<span class="token operator">&gt;</span><span class="token number">894923,1715</span>,1879194,pv,1511658180<span class="token operator">&gt;</span><span class="token number">834377,2244074</span>,3738615,pv,1511658240<span class="token operator">&gt;</span><span class="token number">625915,3611281</span>,570735,pv,1511658300<span class="token operator">&gt;</span><span class="token number">625915,3611281</span>,570735,pv,1511658301<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：2017-11-26 09:05:00.0NO <span class="token number">1</span>: 商品ID <span class="token operator">=</span> <span class="token number">1715</span> 热门度 <span class="token operator">=</span> <span class="token number">2</span>NO <span class="token number">2</span>: 商品ID <span class="token operator">=</span> <span class="token number">2244074</span> 热门度 <span class="token operator">=</span> <span class="token number">2</span>NO <span class="token number">3</span>: 商品ID <span class="token operator">=</span> <span class="token number">3611281</span> 热门度 <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码3-kafka批量数据测试"><a href="#代码3-kafka批量数据测试" class="headerlink" title="代码3-kafka批量数据测试"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%813-kafka%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE%E6%B5%8B%E8%AF%95">代码3-kafka批量数据测试</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedReader</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedWriter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileReader</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/4 11:53 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerUtil</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token function">writeToKafka</span><span class="token punctuation">(</span><span class="token string">"hotitems"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writeToKafka</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>    <span class="token comment">// Kafka配置</span>    <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 定义一个Kafka Producer</span>    <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 用缓冲方式来读取文本</span>    <span class="token class-name">BufferedReader</span> bufferedReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token string">"/tmp/UserBehaviorAnalysis/HotItemsAnalysis/src/main/resources/UserBehavior.csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> line<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> bufferedReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>line <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 用producer发送数据</span>      kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>producerRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动zookeeper</p></li><li><p>启动kafka服务</p></li><li><p>运行该java程序，之后就可以直接启动HotItems程序，读取本地已有的kafka数据了</p></li></ul><h4 id="代码4-Flink-SQL实现"><a href="#代码4-Flink-SQL实现" class="headerlink" title="代码4-Flink-SQL实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%814-flink-sql%E5%AE%9E%E7%8E%B0">代码4-Flink-SQL实现</a></h4><ul><li><p>java代码</p><p><strong>下面用最新的Expression写法实现&lt;=新版本推荐的写法</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">UserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">EnvironmentSettings</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Slide</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Expressions</span><span class="token punctuation">.</span>$<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Expressions</span><span class="token punctuation">.</span>lit<span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 12:18 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotItemsWithSql</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 从csv文件中获取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">"/tmp/UserBehaviorAnalysis/HotItemsAnalysis/src/main/resources/UserBehavior.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO,分配时间戳和watermark</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> userBehaviorDataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserBehavior</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 创建表执行环境,使用blink版本</span>    <span class="token class-name">EnvironmentSettings</span> settings <span class="token operator">=</span> <span class="token class-name">EnvironmentSettings</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">useBlinkPlanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">inStreamingMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5. 将流转换成表</span>    <span class="token class-name">Table</span> dataTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>userBehaviorDataStream<span class="token punctuation">,</span>                                              $<span class="token punctuation">(</span><span class="token string">"itemId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                              $<span class="token punctuation">(</span><span class="token string">"behavior"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                              $<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rowtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">)</span>                                             <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 6. 分组开窗</span>    <span class="token comment">// Table API</span>    <span class="token class-name">Table</span> windowAggTable <span class="token operator">=</span> dataTable      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token string">"behavior"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqual</span><span class="token punctuation">(</span><span class="token string">"pv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">Slide</span><span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span><span class="token function">lit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token function">lit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token string">"itemId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token string">"itemId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"windowEnd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"itemId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"cnt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 7. 利用开创函数，对count值进行排序，并获取Row number，得到Top N</span>    <span class="token comment">// SQL</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> aggStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toAppendStream</span><span class="token punctuation">(</span>windowAggTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"agg"</span><span class="token punctuation">,</span> aggStream<span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"itemId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"windowEnd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"cnt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select * from "</span> <span class="token operator">+</span>                                          <span class="token string">"  ( select *, ROW_NUMBER() over (partition by windowEnd order by cnt desc) as row_num "</span> <span class="token operator">+</span>                                          <span class="token string">"  from agg) "</span> <span class="token operator">+</span>                                          <span class="token string">" where row_num &lt;= 5 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 纯SQL实现</span>    tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"data_table"</span><span class="token punctuation">,</span> userBehaviorDataStream<span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"itemId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"behavior"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rowtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Table</span> resultSqlTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"select * from "</span> <span class="token operator">+</span>                                             <span class="token string">"  ( select *, ROW_NUMBER() over (partition by windowEnd order by cnt desc) as row_num "</span> <span class="token operator">+</span>                                             <span class="token string">"  from ( "</span> <span class="token operator">+</span>                                             <span class="token string">"    select itemId, count(itemId) as cnt, HOP_END(ts, interval '5' minute, interval '1' hour) as windowEnd "</span> <span class="token operator">+</span>                                             <span class="token string">"    from data_table "</span> <span class="token operator">+</span>                                             <span class="token string">"    where behavior = 'pv' "</span> <span class="token operator">+</span>                                             <span class="token string">"    group by itemId, HOP(ts, interval '5' minute, interval '1' hour)"</span> <span class="token operator">+</span>                                             <span class="token string">"    )"</span> <span class="token operator">+</span>                                             <span class="token string">"  ) "</span> <span class="token operator">+</span>                                             <span class="token string">" where row_num &lt;= 5 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//   tableEnv.toRetractStream(resultTable, Row.class).print();</span>    tableEnv<span class="token punctuation">.</span><span class="token function">toRetractStream</span><span class="token punctuation">(</span>resultSqlTable<span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"hot items with sql job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">2288408</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">279675</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">291932</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">3715112</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">3244931</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">710777</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">3715112</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">724262</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">710777</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">1303734</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">724262</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">4622270</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">1303734</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">1303734</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span>T03<span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="14-3-2-实时流量统计——热门页面"><a href="#14-3-2-实时流量统计——热门页面" class="headerlink" title="14.3.2 实时流量统计——热门页面"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1432-%E5%AE%9E%E6%97%B6%E6%B5%81%E9%87%8F%E7%BB%9F%E8%AE%A1%E7%83%AD%E9%97%A8%E9%A1%B5%E9%9D%A2">14.3.2 实时流量统计——热门页面</a></h3><ul><li>基本需求<ul><li>  从web服务器的日志中，统计实时的热门访问页面</li><li>  统计每分钟的ip访问量，取出访问量最大的5个地址，每5秒更新一次</li></ul></li><li>解决思路1<ul><li>  将apache服务器日志中的时间，转换为时间戳，作为Event Time</li><li>  构建滑动窗口，窗口长度为1分钟，滑动距离为5秒</li></ul></li></ul><h4 id="POJO-1"><a href="#POJO-1" class="headerlink" title="POJO"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=pojo-1">POJO</a></h4><ul><li><p>ApacheLogEvent</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> userId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> method<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>PageViewCount</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> windowEnd<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码1-文件-1"><a href="#代码1-文件-1" class="headerlink" title="代码1-文件"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%811-%E6%96%87%E4%BB%B6-1">代码1-文件</a></h4><ul><li><p>Java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">PageViewCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">Lists</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 1:27 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotPages</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取文件，转换成POJO</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">HotPages</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/apache.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SimpleDateFormat</span> simpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"dd/MM/yyyy:HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 分组开窗聚合</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> windowAggStream <span class="token operator">=</span> dataStream      <span class="token comment">// 过滤get请求</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token string">"GET"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> regex <span class="token operator">=</span> <span class="token string">"^((?!\\.(css|js|png|ico)$).)*$"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment">// 按照url分组</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span><span class="token operator">::</span><span class="token function">getUrl</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageCountAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PageCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 收集同一窗口count数据，排序输出</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> windowAggStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">PageViewCount</span><span class="token operator">::</span><span class="token function">getWindowEnd</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopNHotPages</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"hot pages job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义预聚合函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PageCountAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的窗口函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PageCountResult</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的处理函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TopNHotPages</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> topSize<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">TopNHotPages</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> topSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>topSize <span class="token operator">=</span> topSize<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 定义状态，保存当前所有PageViewCount到list中</span>    <span class="token class-name">ListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> pageViewCountListState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      pageViewCountListState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getListState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"page-count-list"</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">PageViewCount</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      pageViewCountListState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getWindowEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> pageViewCounts <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>pageViewCountListState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      pageViewCounts<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token operator">-</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 格式化成String输出</span>      <span class="token class-name">StringBuilder</span> resultBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"============================"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"窗口结束时间："</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 遍历列表，取top n输出</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>topSize<span class="token punctuation">,</span> pageViewCounts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">PageViewCount</span> pageViewCount <span class="token operator">=</span> pageViewCounts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"NO "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" 页面URL = "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pageViewCount<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" 浏览量 = "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pageViewCount<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"==============================="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 控制输出频率</span>      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>resultBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出结果</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">25.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>tags<span class="token operator">/</span>puppet<span class="token operator">?</span>flav<span class="token operator">=</span>rss20 浏览量 <span class="token operator">=</span> <span class="token number">2</span>NO <span class="token number">2</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>geekery<span class="token operator">/</span>eventdb<span class="token operator">-</span>ideas<span class="token punctuation">.</span>html 浏览量 <span class="token operator">=</span> <span class="token number">1</span>NO <span class="token number">3</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>geekery<span class="token operator">/</span>installing<span class="token operator">-</span>windows<span class="token operator">-</span><span class="token number">8</span><span class="token operator">-</span>consumer<span class="token operator">-</span>preview<span class="token punctuation">.</span>html 浏览量 <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">30.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>tags<span class="token operator">/</span>puppet<span class="token operator">?</span>flav<span class="token operator">=</span>rss20 浏览量 <span class="token operator">=</span> <span class="token number">2</span>NO <span class="token number">2</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>geekery<span class="token operator">/</span>eventdb<span class="token operator">-</span>ideas<span class="token punctuation">.</span>html 浏览量 <span class="token operator">=</span> <span class="token number">1</span>NO <span class="token number">3</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>geekery<span class="token operator">/</span>installing<span class="token operator">-</span>windows<span class="token operator">-</span><span class="token number">8</span><span class="token operator">-</span>consumer<span class="token operator">-</span>preview<span class="token punctuation">.</span>html 浏览量 <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">35.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>tags<span class="token operator">/</span>puppet<span class="token operator">?</span>flav<span class="token operator">=</span>rss20 浏览量 <span class="token operator">=</span> <span class="token number">2</span>NO <span class="token number">2</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>tags<span class="token operator">/</span>firefox<span class="token operator">?</span>flav<span class="token operator">=</span>rss20 浏览量 <span class="token operator">=</span> <span class="token number">2</span>NO <span class="token number">3</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>blog<span class="token operator">/</span>geekery<span class="token operator">/</span>eventdb<span class="token operator">-</span>ideas<span class="token punctuation">.</span>html 浏览量 <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码2-乱序数据测试"><a href="#代码2-乱序数据测试" class="headerlink" title="代码2-乱序数据测试"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%812-%E4%B9%B1%E5%BA%8F%E6%95%B0%E6%8D%AE%E6%B5%8B%E8%AF%95">代码2-乱序数据测试</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">PageViewCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">Lists</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">OutputTag</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 1:27 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotPages</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取文件，转换成POJO</span>    <span class="token comment">//        URL resource = HotPages.class.getResource("/apache.log");</span>    <span class="token comment">//        DataStream&lt;String&gt; inputStream = env.readTextFile(resource.getPath());</span>    <span class="token comment">// 方便测试，使用本地Socket输入数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SimpleDateFormat</span> simpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"dd/MM/yyyy:HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 定义一个侧输出流标签</span>    <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span> lateTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 分组开窗聚合</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> windowAggStream <span class="token operator">=</span> dataStream      <span class="token comment">// 过滤get请求</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token string">"GET"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> regex <span class="token operator">=</span> <span class="token string">"^((?!\\.(css|js|png|ico)$).)*$"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment">// 按照url分组</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span><span class="token operator">::</span><span class="token function">getUrl</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">allowedLateness</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">sideOutputLateData</span><span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageCountAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PageCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    windowAggStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    windowAggStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 收集同一窗口count数据，排序输出</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> windowAggStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">PageViewCount</span><span class="token operator">::</span><span class="token function">getWindowEnd</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopNHotPages</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"hot pages job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义预聚合函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PageCountAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的窗口函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PageCountResult</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的处理函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TopNHotPages</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> topSize<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">TopNHotPages</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> topSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>topSize <span class="token operator">=</span> topSize<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 定义状态，保存当前所有PageViewCount到list中</span>    <span class="token class-name">ListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> pageViewCountListState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      pageViewCountListState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getListState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"page-count-list"</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">PageViewCount</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      pageViewCountListState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getWindowEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> pageViewCounts <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>pageViewCountListState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      pageViewCounts<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token operator">-</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 格式化成String输出</span>      <span class="token class-name">StringBuilder</span> resultBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"============================"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"窗口结束时间："</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 遍历列表，取top n输出</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>topSize<span class="token punctuation">,</span> pageViewCounts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">PageViewCount</span> pageViewCount <span class="token operator">=</span> pageViewCounts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"NO "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" 页面URL = "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pageViewCount<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" 浏览量 = "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pageViewCount<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"==============================="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 控制输出频率</span>      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>resultBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      pageViewCountListState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动本地socket</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nc</span> -lk <span class="token number">7777</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>在本地socket输入数据，查看输出</p><ul><li><p>输入</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">49</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">50</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">51</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">52</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">55</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">56</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">56</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>present<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">57</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>present<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">01</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">02</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>pre<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">46</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">02</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>pre<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">03</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>pre<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><p><em>由于<code>onTimer</code>简单粗暴直接<code>pageViewCountListState.clear();</code>导致前面几次排名信息中丢失第一名以外的数据 =&gt; 下面代码3-乱序数据代码改进 中解决问题</em></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829549000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829550000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829551000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829552000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829555000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829556000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829556000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>present'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829557000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>present'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829561000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token char">'/'</span><span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829562000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token char">'/pre'</span><span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829546000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829562000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token char">'/pre'</span><span class="token punctuation">}</span>agg<span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1431829550000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span>agg<span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1431829555000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">}</span>agg<span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1431829560000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">}</span>agg<span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span>'<span class="token operator">/</span>present'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1431829560000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">50.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>presentations<span class="token operator">/</span> 浏览量 <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">55.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>presentations<span class="token operator">/</span> 浏览量 <span class="token operator">=</span> <span class="token number">5</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>presentations<span class="token operator">/</span> 浏览量 <span class="token operator">=</span> <span class="token number">7</span>NO <span class="token number">2</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>present 浏览量 <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><h4 id="代码3-乱序数据-代码改进"><a href="#代码3-乱序数据-代码改进" class="headerlink" title="代码3-乱序数据-代码改进"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%813-%E4%B9%B1%E5%BA%8F%E6%95%B0%E6%8D%AE-%E4%BB%A3%E7%A0%81%E6%94%B9%E8%BF%9B">代码3-乱序数据-代码改进</a></h4><p><strong>一个数据只有不属于任何窗口了，才会被丢进侧输出流！</strong></p><hr><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">PageViewCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">Lists</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">MapState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">MapStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">OutputTag</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 1:27 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotPages</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取文件，转换成POJO</span>    <span class="token comment">//        URL resource = HotPages.class.getResource("/apache.log");</span>    <span class="token comment">//        DataStream&lt;String&gt; inputStream = env.readTextFile(resource.getPath());</span>    <span class="token comment">// 方便测试，使用本地Socket输入数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SimpleDateFormat</span> simpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"dd/MM/yyyy:HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 定义一个侧输出流标签</span>    <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span> lateTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 分组开窗聚合</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> windowAggStream <span class="token operator">=</span> dataStream      <span class="token comment">// 过滤get请求</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token string">"GET"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> regex <span class="token operator">=</span> <span class="token string">"^((?!\\.(css|js|png|ico)$).)*$"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment">// 按照url分组</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span><span class="token operator">::</span><span class="token function">getUrl</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">allowedLateness</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">sideOutputLateData</span><span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageCountAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PageCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    windowAggStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    windowAggStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 收集同一窗口count数据，排序输出</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> windowAggStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">PageViewCount</span><span class="token operator">::</span><span class="token function">getWindowEnd</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopNHotPages</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"hot pages job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义预聚合函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PageCountAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApacheLogEvent</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ApacheLogEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的窗口函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PageCountResult</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的处理函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TopNHotPages</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> topSize<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">TopNHotPages</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> topSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>topSize <span class="token operator">=</span> topSize<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 定义状态，保存当前所有PageViewCount到Map中</span>    <span class="token comment">//        ListState&lt;PageViewCount&gt; pageViewCountListState;</span>    <span class="token class-name">MapState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> pageViewCountMapState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">//            pageViewCountListState = getRuntimeContext().getListState(new ListStateDescriptor&lt;PageViewCount&gt;("page-count-list", PageViewCount.class));</span>      pageViewCountMapState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"page-count-map"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">PageViewCount</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">//            pageViewCountListState.add(value);</span>      pageViewCountMapState<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getWindowEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 注册一个1分钟之后的定时器，用来清空状态</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getWindowEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 先判断是否到了窗口关闭清理时间，如果是，直接清空状态返回</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">==</span> ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        pageViewCountMapState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">//            ArrayList&lt;PageViewCount&gt; pageViewCounts = Lists.newArrayList(pageViewCountListState.get().iterator());</span>      <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pageViewCounts <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>pageViewCountMapState<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      pageViewCounts<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token operator">-</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 格式化成String输出</span>      <span class="token class-name">StringBuilder</span> resultBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"============================"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"窗口结束时间："</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 遍历列表，取top n输出</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>topSize<span class="token punctuation">,</span> pageViewCounts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//                PageViewCount pageViewCount = pageViewCounts.get(i);</span>        <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> pageViewCount <span class="token operator">=</span> pageViewCounts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"NO "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" 页面URL = "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pageViewCount<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" 浏览量 = "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pageViewCount<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      resultBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"==============================="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 控制输出频率</span>      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>resultBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//            pageViewCountListState.clear();</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输入</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">49</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">50</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">51</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">52</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">55</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">56</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">56</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>present<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">57</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>present<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">01</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">02</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>pre<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">46</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>presentations<span class="token operator">/</span><span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token number">17</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">2015</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">03</span> <span class="token operator">+</span><span class="token number">0000</span> GET <span class="token operator">/</span>pre<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829549000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829550000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829551000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829552000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829555000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829556000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829556000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>present'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829557000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>present'<span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829561000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token char">'/'</span><span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829562000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token char">'/pre'</span><span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829546000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">}</span>agg<span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1431829550000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span>agg<span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1431829555000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">}</span>agg<span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span>'<span class="token operator">/</span>presentations<span class="token operator">/</span>'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1431829560000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">}</span>agg<span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span>'<span class="token operator">/</span>present'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1431829560000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span>data<span class="token operator">&gt;</span> <span class="token class-name">ApacheLogEvent</span><span class="token punctuation">{</span>ip<span class="token operator">=</span>'<span class="token number">83.149</span><span class="token number">.9</span><span class="token number">.216</span>'<span class="token punctuation">,</span> userId<span class="token operator">=</span><span class="token char">'-'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1431829563000</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token char">'GET'</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token char">'/pre'</span><span class="token punctuation">}</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">50.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>presentations<span class="token operator">/</span> 浏览量 <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">55.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>presentations<span class="token operator">/</span> 浏览量 <span class="token operator">=</span> <span class="token number">5</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>窗口结束时间：<span class="token number">2015</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00.0</span>NO <span class="token number">1</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>presentations<span class="token operator">/</span> 浏览量 <span class="token operator">=</span> <span class="token number">7</span>NO <span class="token number">2</span><span class="token operator">:</span> 页面URL <span class="token operator">=</span> <span class="token operator">/</span>present 浏览量 <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="14-3-3-实时流量统计——PV和UV"><a href="#14-3-3-实时流量统计——PV和UV" class="headerlink" title="14.3.3 实时流量统计——PV和UV"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1433-%E5%AE%9E%E6%97%B6%E6%B5%81%E9%87%8F%E7%BB%9F%E8%AE%A1pv%E5%92%8Cuv">14.3.3 实时流量统计——PV和UV</a></h3><ul><li>基本需求<ul><li>  从埋点日志中，统计实时的PV和UV</li><li>  统计每小时的访问量（PV），并且对用户进行去重（UV）</li></ul></li><li>解决思路<ul><li>  统计埋点日志中的pv行为，利用Set数据结构进行去重</li><li>  <strong>对于超大规模的数据，可以考虑用布隆过滤器进行去重</strong></li></ul></li></ul><h4 id="代码1-PV统计-基本实现"><a href="#代码1-PV统计-基本实现" class="headerlink" title="代码1-PV统计-基本实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%811-pv%E7%BB%9F%E8%AE%A1-%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0">代码1-PV统计-基本实现</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">UserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 3:11 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageView</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 从csv文件中获取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">PageView</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/UserBehavior.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO,分配时间戳和watermark</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> userBehaviorDataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserBehavior</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 分组开窗聚合，得到每个窗口内各个商品的count值</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pvResultStream <span class="token operator">=</span> userBehaviorDataStream      <span class="token comment">// 过滤只保留pv行为</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>userBehavior <span class="token operator">-&gt;</span> <span class="token string">"pv"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userBehavior<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"pv"</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment">// 按照商品ID分组</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>      <span class="token comment">// 1小时滚动窗口</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pvResultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"pv count job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">41890</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">48022</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">47298</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">44499</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">48649</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">50838</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">52296</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">52552</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">48292</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码2-PV统计-并行和数据倾斜优化"><a href="#代码2-PV统计-并行和数据倾斜优化" class="headerlink" title="代码2 PV统计-并行和数据倾斜优化"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%812-pv%E7%BB%9F%E8%AE%A1-%E5%B9%B6%E8%A1%8C%E5%92%8C%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E4%BC%98%E5%8C%96">代码2 PV统计-并行和数据倾斜优化</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">PageViewCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">UserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 3:11 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageView</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为4</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 从csv文件中获取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">PageView</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/UserBehavior.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO,分配时间戳和watermark</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> userBehaviorDataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserBehavior</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 分组开窗聚合，得到每个窗口内各个商品的count值</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pvResultStream0 <span class="token operator">=</span> userBehaviorDataStream      <span class="token comment">// 过滤只保留pv行为</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>userBehavior <span class="token operator">-&gt;</span> <span class="token string">"pv"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userBehavior<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"pv"</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment">// 按照商品ID分组</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>      <span class="token comment">// 1小时滚动窗口</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//  并行任务改进，设计随机key，解决数据倾斜问题</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> pvStream <span class="token operator">=</span> userBehaviorDataStream<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token string">"pv"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>          <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PvCountAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PvCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将各分区数据汇总起来</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> pvResultStream <span class="token operator">=</span> pvStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">PageViewCount</span><span class="token operator">::</span><span class="token function">getWindowEnd</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TotalPvCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//                .sum("count");</span>    pvResultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"pv count job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义预聚合函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PvCountAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义窗口</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PvCountResult</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">(</span>integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义处理函数，把相同窗口分组统计的count值叠加</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TotalPvCount</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义状态，保存当前的总count值</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> totalCountState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      totalCountState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"total-count"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">PageViewCount</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">Long</span> totalCount <span class="token operator">=</span> totalCountState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> totalCount<span class="token punctuation">)</span><span class="token punctuation">{</span>        totalCount <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>        totalCountState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>totalCount<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      totalCountState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> totalCount <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>      ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getWindowEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 定时器触发，所有分组count值都到齐，直接输出当前的总count数量</span>      <span class="token class-name">Long</span> totalCount <span class="token operator">=</span> totalCountState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">(</span><span class="token string">"pv"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> totalCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 清空状态</span>      totalCountState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511661600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">41890</span><span class="token punctuation">}</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511679600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">50838</span><span class="token punctuation">}</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511676000000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">48649</span><span class="token punctuation">}</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511668800000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">47298</span><span class="token punctuation">}</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511686800000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">52552</span><span class="token punctuation">}</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511672400000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">44499</span><span class="token punctuation">}</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511665200000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">48022</span><span class="token punctuation">}</span><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511683200000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">52296</span><span class="token punctuation">}</span><span class="token number">2</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511690400000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">48292</span><span class="token punctuation">}</span><span class="token number">3</span><span class="token operator">&gt;</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'pv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511694000000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码3-UV统计-Set去重"><a href="#代码3-UV统计-Set去重" class="headerlink" title="代码3-UV统计-Set去重"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%813-uv%E7%BB%9F%E8%AE%A1-set%E5%8E%BB%E9%87%8D">代码3-UV统计-Set去重</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">PageViewCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">UserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">AllWindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashSet</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 3:51 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UniqueVisitor</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 从csv文件中获取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">UniqueVisitor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/UserBehavior.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO,分配时间戳和watermark</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserBehavior</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 开窗统计uv值</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> uvStream <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token string">"pv"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">timeWindowAll</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UvCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uvStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"uv count job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义全窗口函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UvCountResult</span> <span class="token keyword">implements</span> <span class="token class-name">AllWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> values<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 定义一个Set结构，保存窗口中的所有userId，自动去重</span>      <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> uidSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> ub <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>        uidSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ub<span class="token punctuation">.</span><span class="token function">getUerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">(</span><span class="token string">"uv"</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> uidSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511661600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">28196</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511665200000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">32160</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511668800000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">32233</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511672400000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">30615</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511676000000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">32747</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511679600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">33898</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511683200000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">34631</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511686800000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">34746</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511690400000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">32356</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511694000000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码4-UV统计-布隆过滤器"><a href="#代码4-UV统计-布隆过滤器" class="headerlink" title="代码4-UV统计-布隆过滤器"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%814-uv%E7%BB%9F%E8%AE%A1-%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8">代码4-UV统计-布隆过滤器</a></h4><ul><li><p>pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>  <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>redis<span class="token punctuation">.</span>clients<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jedis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.5</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">PageViewCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">UserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">ProcessAllWindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>triggers<span class="token punctuation">.</span></span><span class="token class-name">Trigger</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>triggers<span class="token punctuation">.</span></span><span class="token class-name">TriggerResult</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Jedis</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 4:03 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UvWithBloomFilter</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. 创建执行环境</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置并行度为1</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 从csv文件中获取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">UniqueVisitor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/UserBehavior.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 转换成POJO,分配时间戳和watermark</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserBehavior</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 开窗统计uv值</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> uvStream <span class="token operator">=</span> dataStream      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token string">"pv"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">timeWindowAll</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UvCountResultWithBloomFliter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uvStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"uv count with bloom filter job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义触发器</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyTrigger</span> <span class="token keyword">extends</span> <span class="token class-name">Trigger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onElement</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 每一条数据来到，直接触发窗口计算，并且直接清空窗口</span>      <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>FIRE_AND_PURGE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onProcessingTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">TriggerResult</span> <span class="token function">onEventTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token class-name">TriggerResult</span><span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">TriggerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 自定义一个布隆过滤器</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyBloomFilter</span> <span class="token punctuation">{</span>    <span class="token comment">// 定义位图的大小，一般需要定义为2的整次幂</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> cap<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">MyBloomFilter</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> cap<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>cap <span class="token operator">=</span> cap<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 实现一个hash函数</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Integer</span> seed<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token class-name">Long</span> result <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        result <span class="token operator">=</span> result <span class="token operator">*</span> seed <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> result <span class="token operator">&amp;</span> <span class="token punctuation">(</span>cap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的处理函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UvCountResultWithBloomFliter</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessAllWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义jedis连接和布隆过滤器</span>    <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>    <span class="token class-name">MyBloomFilter</span> myBloomFilter<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      myBloomFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyBloomFilter</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 要处理1亿个数据，用64MB大小的位图</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> elements<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageViewCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 将位图和窗口count值全部存入redis，用windowEnd作为key</span>      <span class="token class-name">Long</span> windowEnd <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">String</span> bitmapKey <span class="token operator">=</span> windowEnd<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 把count值存成一张hash表</span>      <span class="token class-name">String</span> countHashName <span class="token operator">=</span> <span class="token string">"uv_count"</span><span class="token punctuation">;</span>      <span class="token class-name">String</span> countKey <span class="token operator">=</span> windowEnd<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 1. 取当前的userId</span>      <span class="token class-name">Long</span> userId <span class="token operator">=</span> elements<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 2. 计算位图中的offset</span>      <span class="token class-name">Long</span> offset <span class="token operator">=</span> myBloomFilter<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 3. 用redis的getbit命令，判断对应位置的值</span>      <span class="token class-name">Boolean</span> isExist <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">getbit</span><span class="token punctuation">(</span>bitmapKey<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isExist<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 如果不存在，对应位图位置置1</span>        jedis<span class="token punctuation">.</span><span class="token function">setbit</span><span class="token punctuation">(</span>bitmapKey<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 更新redis中保存的count值</span>        <span class="token class-name">Long</span> uvCount <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token comment">// 初始count值</span>        <span class="token class-name">String</span> uvCountString <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span>countHashName<span class="token punctuation">,</span> countKey<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>uvCountString <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uvCountString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          uvCount <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>uvCountString<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span>countHashName<span class="token punctuation">,</span> countKey<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>uvCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageViewCount</span><span class="token punctuation">(</span><span class="token string">"uv"</span><span class="token punctuation">,</span> windowEnd<span class="token punctuation">,</span> uvCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511661600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">7469</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511661600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">7470</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511661600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">7471</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511661600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">7472</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511661600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">7473</span><span class="token punctuation">}</span><span class="token class-name">PageViewCount</span><span class="token punctuation">{</span>url<span class="token operator">=</span><span class="token char">'uv'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span><span class="token number">1511661600000</span><span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">7474</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="14-3-4-市场营销分析——APP市场推广统计"><a href="#14-3-4-市场营销分析——APP市场推广统计" class="headerlink" title="14.3.4 市场营销分析——APP市场推广统计"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1434-%E5%B8%82%E5%9C%BA%E8%90%A5%E9%94%80%E5%88%86%E6%9E%90app%E5%B8%82%E5%9C%BA%E6%8E%A8%E5%B9%BF%E7%BB%9F%E8%AE%A1">14.3.4 市场营销分析——APP市场推广统计</a></h3><ul><li>基本需求<ul><li>  从埋点日志中，统计APP市场推广的数据指标</li><li>  按照不同的推广渠道，分别统计数据</li></ul></li><li>解决思路<ul><li>  通过过滤日志中的用户行为，按照不同的渠道进行统计</li><li>  可以用process function处理，得到自定义的输出数据信息</li></ul></li></ul><h4 id="POJO-2"><a href="#POJO-2" class="headerlink" title="POJO"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=pojo-2">POJO</a></h4><ul><li><p>MarketingUserBehavior</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> behavior<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> channel<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ChannelPromotionCount</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">String</span> channel<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> behavior<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> windowEnd<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> count<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码1-自定义测试数据源"><a href="#代码1-自定义测试数据源" class="headerlink" title="代码1-自定义测试数据源"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%811-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E6%BA%90">代码1-自定义测试数据源</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">SourceFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 5:32 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppMarketingByChannel</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从自定义数据源中读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimulatedMarketingUserBehaviorSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的模拟市场用户行为数据源</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SimulatedMarketingUserBehaviorSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 控制是否正常运行的标识位</span>    <span class="token class-name">Boolean</span> running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment">// 定义用户行为和渠道的范围</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> behaviorList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"CLICK"</span><span class="token punctuation">,</span> <span class="token string">"DOWNLOAD"</span><span class="token punctuation">,</span> <span class="token string">"INSTALL"</span><span class="token punctuation">,</span> <span class="token string">"UNINSTALL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> channelList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"app store"</span><span class="token punctuation">,</span> <span class="token string">"wechat"</span><span class="token punctuation">,</span> <span class="token string">"weibo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 随机生成所有字段</span>        <span class="token class-name">Long</span> id <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> behavior <span class="token operator">=</span> behaviorList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>behaviorList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> channel <span class="token operator">=</span> channelList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>channelList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 发出数据</span>        ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> behavior<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码2-具体实现"><a href="#代码2-具体实现" class="headerlink" title="代码2-具体实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%812-%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0">代码2-具体实现</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeySelector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">SourceFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">ProcessWindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 5:32 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppMarketingByChannel</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从自定义数据源中读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimulatedMarketingUserBehaviorSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">MarketingUserBehavior</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 分渠道开窗统计</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> dataStream      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token operator">!</span><span class="token string">"UNINSTALL"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token class-name">MarketingUserBehavior</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment">// 定义滑窗</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MarketingCountAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MarketingCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"app marketing by channel job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的模拟市场用户行为数据源</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SimulatedMarketingUserBehaviorSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 控制是否正常运行的标识位</span>    <span class="token class-name">Boolean</span> running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment">// 定义用户行为和渠道的范围</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> behaviorList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"CLICK"</span><span class="token punctuation">,</span> <span class="token string">"DOWNLOAD"</span><span class="token punctuation">,</span> <span class="token string">"INSTALL"</span><span class="token punctuation">,</span> <span class="token string">"UNINSTALL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> channelList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"app store"</span><span class="token punctuation">,</span> <span class="token string">"wechat"</span><span class="token punctuation">,</span> <span class="token string">"weibo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 随机生成所有字段</span>        <span class="token class-name">Long</span> id <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> behavior <span class="token operator">=</span> behaviorList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>behaviorList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> channel <span class="token operator">=</span> channelList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>channelList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 发出数据</span>        ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> behavior<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的增量聚合函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MarketingCountAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">MarketingUserBehavior</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的全窗口函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MarketingCountResult</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessWindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringStringTuple2<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> elements<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span> channel <span class="token operator">=</span> stringStringTuple2<span class="token punctuation">.</span>f0<span class="token punctuation">;</span>      <span class="token class-name">String</span> behavior <span class="token operator">=</span> stringStringTuple2<span class="token punctuation">.</span>f1<span class="token punctuation">;</span>      <span class="token class-name">String</span> windowEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Long</span> count <span class="token operator">=</span> elements<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> behavior<span class="token punctuation">,</span> windowEnd<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span>'app store'<span class="token punctuation">,</span> behavior<span class="token operator">=</span><span class="token char">'CLICK'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">40.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'weibo'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span>'DOWNLOAD'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">40.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'weibo'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span>'INSTALL'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">40.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span>'DOWNLOAD'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">40.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span>'INSTALL'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">40.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'weibo'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span>'INSTALL'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">45.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span>'app store'<span class="token punctuation">,</span> behavior<span class="token operator">=</span>'DOWNLOAD'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">45.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'weibo'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span><span class="token char">'CLICK'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">45.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span>'app store'<span class="token punctuation">,</span> behavior<span class="token operator">=</span><span class="token char">'CLICK'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">45.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码3-不分渠道代码实现"><a href="#代码3-不分渠道代码实现" class="headerlink" title="代码3-不分渠道代码实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%813-%E4%B8%8D%E5%88%86%E6%B8%A0%E9%81%93%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">代码3-不分渠道代码实现</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">SourceFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 6:19 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppMarketingStatistics</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从自定义数据源中读取数据</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AppMarketingByChannel<span class="token punctuation">.</span>SimulatedMarketingUserBehaviorSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">MarketingUserBehavior</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 开窗统计总量</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> dataStream      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token operator">!</span><span class="token string">"UNINSTALL"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">MarketingUserBehavior</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"total"</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>tuple2 <span class="token operator">-&gt;</span> tuple2<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>      <span class="token comment">// 定义滑窗</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MarketingStatisticsAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MarketingStatisticsResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"app marketing by channel job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的模拟市场用户行为数据源</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SimulatedMarketingUserBehaviorSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 控制是否正常运行的标识位</span>    <span class="token class-name">Boolean</span> running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment">// 定义用户行为和渠道的范围</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> behaviorList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"CLICK"</span><span class="token punctuation">,</span> <span class="token string">"DOWNLOAD"</span><span class="token punctuation">,</span> <span class="token string">"INSTALL"</span><span class="token punctuation">,</span> <span class="token string">"UNINSTALL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> channelList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"app store"</span><span class="token punctuation">,</span> <span class="token string">"wechat"</span><span class="token punctuation">,</span> <span class="token string">"weibo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">&gt;</span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 随机生成所有字段</span>        <span class="token class-name">Long</span> id <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> behavior <span class="token operator">=</span> behaviorList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>behaviorList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> channel <span class="token operator">=</span> channelList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>channelList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 发出数据</span>        ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MarketingUserBehavior</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> behavior<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的增量聚合函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MarketingStatisticsAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的全窗口函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MarketingStatisticsResult</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span> windowEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Long</span> count <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelPromotionCount</span><span class="token punctuation">(</span><span class="token string">"total"</span><span class="token punctuation">,</span> <span class="token string">"total"</span><span class="token punctuation">,</span> windowEnd<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'total'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span><span class="token char">'total'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">15.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'total'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span><span class="token char">'total'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">20.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">75</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>ChannelPromotionCount</span><span class="token punctuation">{</span>channel<span class="token operator">=</span><span class="token char">'total'</span><span class="token punctuation">,</span> behavior<span class="token operator">=</span><span class="token char">'total'</span><span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2021</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">25.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">109</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="14-3-5-市场营销分析——页面广告统计"><a href="#14-3-5-市场营销分析——页面广告统计" class="headerlink" title="14.3.5 市场营销分析——页面广告统计"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1435-%E5%B8%82%E5%9C%BA%E8%90%A5%E9%94%80%E5%88%86%E6%9E%90%E9%A1%B5%E9%9D%A2%E5%B9%BF%E5%91%8A%E7%BB%9F%E8%AE%A1">14.3.5 市场营销分析——页面广告统计</a></h3><ul><li>基本需求<ul><li>  从埋点日志中，统计每小时页面广告的点击量，5秒刷新一次，并按照不同省份进行划分</li><li>  对于”刷单”式的频繁点击行为进行过滤，并将该用户加入黑名单</li></ul></li><li>解决思路<ul><li>  根据省份进行分组，创建长度为1小时、滑动距离为5秒的时间窗口进行统计</li><li>  可以用<code>process function</code>进行黑名单过滤，检测用户对同一广告的点击量，如果超过上限则将用户信息以侧输出流输出到黑名单中</li></ul></li></ul><h4 id="POJO-3"><a href="#POJO-3" class="headerlink" title="POJO"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=pojo-3">POJO</a></h4><ul><li><p>AdClickEvent</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> adId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> province<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>BlackListUserWarning</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> adId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> warningMsg<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码1-基本实现"><a href="#代码1-基本实现" class="headerlink" title="代码1-基本实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%811-%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0">代码1-基本实现</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">AdClickEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 6:41 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdStatisticsByProvince</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从文件中读取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">AdStatisticsByProvince</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/AdClickLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">&gt;</span></span> adClickEventDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AdClickEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">AdClickEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 基于省份分组，开窗聚合</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">&gt;</span></span> adCountStream <span class="token operator">=</span> adClickEventDataStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">AdClickEvent</span><span class="token operator">::</span><span class="token function">getProvince</span><span class="token punctuation">)</span>      <span class="token comment">// 定义滑窗,5min输出一次</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AdCountAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AdCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    adCountStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"ad count by province job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AdCountAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">AdClickEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AdCountResult</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> province<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span> windowEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Long</span> count <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">(</span>province<span class="token punctuation">,</span> windowEnd<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'beijing'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'shanghai'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'guangdong'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'guangdong'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'shanghai'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'beijing'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'shanghai'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'beijing'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'guangdong'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'shanghai'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码2-点击异常行为黑名单过滤"><a href="#代码2-点击异常行为黑名单过滤" class="headerlink" title="代码2-点击异常行为黑名单过滤"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%812-%E7%82%B9%E5%87%BB%E5%BC%82%E5%B8%B8%E8%A1%8C%E4%B8%BA%E9%BB%91%E5%90%8D%E5%8D%95%E8%BF%87%E6%BB%A4">代码2-点击异常行为黑名单过滤</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">AdClickEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">BlackListUserWarning</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">DateUtils</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AggregateFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeySelector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">OutputTag</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/5 6:41 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdStatisticsByProvince</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从文件中读取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">AdStatisticsByProvince</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/AdClickLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">&gt;</span></span> adClickEventDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AdClickEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">AdClickEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 对同一个用户点击同一个广告的行为进行检测报警</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">&gt;</span></span> filterAdClickStream <span class="token operator">=</span> adClickEventDataStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token class-name">AdClickEvent</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getAdId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilterBlackListUser</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 基于省份分组，开窗聚合</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">&gt;</span></span> adCountResultStream <span class="token operator">=</span> filterAdClickStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">AdClickEvent</span><span class="token operator">::</span><span class="token function">getProvince</span><span class="token punctuation">)</span>      <span class="token comment">// 定义滑窗,5min输出一次</span>      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AdCountAgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AdCountResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    adCountResultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    filterAdClickStream      <span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BlackListUserWarning</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"blacklist"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"blacklist-user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"ad count by province job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AdCountAgg</span> <span class="token keyword">implements</span> <span class="token class-name">AggregateFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">AdClickEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> accumulator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Long</span> a<span class="token punctuation">,</span> <span class="token class-name">Long</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AdCountResult</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> province<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> window<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">String</span> windowEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Long</span> count <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AdCountViewByProvince</span><span class="token punctuation">(</span>province<span class="token punctuation">,</span> windowEnd<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义处理函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FilterBlackListUser</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">AdClickEvent</span><span class="token punctuation">,</span> <span class="token class-name">AdClickEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义属性：点击次数上线</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> countUpperBound<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">FilterBlackListUser</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> countUpperBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>countUpperBound <span class="token operator">=</span> countUpperBound<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 定义状态，保存当前用户对某一广告的点击次数</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> countState<span class="token punctuation">;</span>    <span class="token comment">// 定义一个标志状态，保存当前用户是否已经被发送到了黑名单里</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> isSentState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      countState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"ad-count"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      isSentState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"is-sent"</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 清空所有状态</span>      countState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      isSentState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">AdClickEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdClickEvent</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 判断当前用户对同一广告的点击次数，如果不够上限，该count加1正常输出；</span>      <span class="token comment">// 如果到达上限，直接过滤掉，并侧输出流输出黑名单报警</span>      <span class="token comment">// 首先获取当前count值</span>      <span class="token class-name">Long</span> curCount <span class="token operator">=</span> countState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Boolean</span> isSent <span class="token operator">=</span> isSentState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> curCount<span class="token punctuation">)</span><span class="token punctuation">{</span>        curCount <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> isSent<span class="token punctuation">)</span><span class="token punctuation">{</span>        isSent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 1. 判断是否是第一个数据，如果是的话，注册一个第二天0点的定时器</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> ts <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentProcessingTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> fixedTime <span class="token operator">=</span> <span class="token class-name">DateUtils</span><span class="token punctuation">.</span><span class="token function">addDays</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerProcessingTimeTimer</span><span class="token punctuation">(</span>fixedTime<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 2. 判断是否报警</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">&gt;=</span> countUpperBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 判断是否输出到黑名单过，如果没有的话就输出到侧输出流</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>          isSentState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BlackListUserWarning</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"blacklist"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                     <span class="token keyword">new</span> <span class="token class-name">BlackListUserWarning</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getAdId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"click over "</span> <span class="token operator">+</span> countUpperBound <span class="token operator">+</span> <span class="token string">"times."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 不再进行下面操作</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 如果没有返回，点击次数加1，更新状态，正常输出当前数据到主流</span>      countState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>curCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">blacklist<span class="token operator">-</span>user<span class="token operator">&gt;</span> <span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>BlackListUserWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">937166</span><span class="token punctuation">,</span> adId<span class="token operator">=</span><span class="token number">1715</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'click over <span class="token number">100</span>times<span class="token punctuation">.</span>'<span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'beijing'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'shanghai'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'guangdong'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'guangdong'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'shanghai'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'beijing'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'shanghai'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'beijing'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'guangdong'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'shanghai'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token class-name"><span class="token namespace">beans<span class="token punctuation">.</span></span>AdCountViewByProvince</span><span class="token punctuation">{</span>province<span class="token operator">=</span>'guangdong'<span class="token punctuation">,</span> windowEnd<span class="token operator">=</span>'<span class="token number">2017</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">00.0</span>'<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="14-3-6-恶意登录监控"><a href="#14-3-6-恶意登录监控" class="headerlink" title="14.3.6 恶意登录监控"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1436-%E6%81%B6%E6%84%8F%E7%99%BB%E5%BD%95%E7%9B%91%E6%8E%A7">14.3.6 恶意登录监控</a></h3><ul><li>基本需求<ul><li>  用户在短时间内频繁登录失败，有程序恶意攻击的可能</li><li>  同一用户（可以是不同IP）在2秒内连续两次登录失败，需要报警</li></ul></li><li>解决思路<ul><li>  将用户的登录失败行为存入ListState，设定定时器2秒后出发，查看ListState中有几次失败登录</li><li>  更加精确的检测，可以使用CEP库实现事件流的模式匹配</li></ul></li></ul><h4 id="POJO-4"><a href="#POJO-4" class="headerlink" title="POJO"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=pojo-4">POJO</a></h4><ul><li><p>LoginEvent</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> loginState<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>LoginFailWarning</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> firstFailTime<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> lastFailTime<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> warningMsg<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码1-简单代码实现"><a href="#代码1-简单代码实现" class="headerlink" title="代码1-简单代码实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%811-%E7%AE%80%E5%8D%95%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">代码1-简单代码实现</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">LoginEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">Lists</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/6 1:49 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFail</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从文件中读取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">LoginFail</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/LoginLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginEventStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 自定义处理函数检测连续登录失败事件</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> warningStream <span class="token operator">=</span> loginEventStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginFailDetectWarning</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    warningStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"login fail detect job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义KeyedProcessFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LoginFailDetectWarning</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">,</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义属性，最大连续登录失败次数</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> maxFailTimes<span class="token punctuation">;</span>    <span class="token comment">// 定义状态：保存2秒内所有的登录失败事件</span>    <span class="token class-name">ListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginFailEventListState<span class="token punctuation">;</span>    <span class="token comment">// 定义状态：保存注册的定时器时间戳</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> timerTsState<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">LoginFailDetectWarning</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> maxFailTimes<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>maxFailTimes <span class="token operator">=</span> maxFailTimes<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      loginFailEventListState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getListState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"login-fail-list"</span><span class="token punctuation">,</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      timerTsState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"timer-ts"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 定时器触发，说明2秒内没有登录成功，判读ListState中失败的个数</span>      <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginFailEvents <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>loginFailEventListState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">int</span> failTimes <span class="token operator">=</span> loginFailEvents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>failTimes <span class="token operator">&gt;=</span> maxFailTimes<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 如果超出设定的最大失败次数，输出报警</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                         loginFailEvents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                         loginFailEvents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>failTimes <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                         <span class="token string">"login fail in 2s for "</span> <span class="token operator">+</span> failTimes <span class="token operator">+</span> <span class="token string">" times"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 清空状态</span>      loginFailEventListState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      timerTsState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 判断当前登录事件类型</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getLoginState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 1. 如果是失败事件，添加到表状态中</span>        loginFailEventListState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 如果没有定时器，注册一个2秒之后的定时器</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> timerTsState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">long</span> ts <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>          timerTsState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token comment">// 2. 如果是登录成功，删除定时器，清空状态，重新开始</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> timerTsState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteEventTimeTimer</span><span class="token punctuation">(</span>timerTsState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          loginFailEventListState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          timerTsState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">23064</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430826</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430826</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail in <span class="token number">2</span>s <span class="token keyword">for</span> <span class="token number">1</span> times'<span class="token punctuation">}</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">5692</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430833</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430833</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail in <span class="token number">2</span>s <span class="token keyword">for</span> <span class="token number">1</span> times'<span class="token punctuation">}</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">1035</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430844</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430844</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail in <span class="token number">2</span>s <span class="token keyword">for</span> <span class="token number">1</span> times'<span class="token punctuation">}</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">76456</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430859</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430859</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail in <span class="token number">2</span>s <span class="token keyword">for</span> <span class="token number">1</span> times'<span class="token punctuation">}</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">23565</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430862</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430862</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail in <span class="token number">2</span>s <span class="token keyword">for</span> <span class="token number">1</span> times'<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码2-代码实效性改进"><a href="#代码2-代码实效性改进" class="headerlink" title="代码2-代码实效性改进"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%812-%E4%BB%A3%E7%A0%81%E5%AE%9E%E6%95%88%E6%80%A7%E6%94%B9%E8%BF%9B">代码2-代码实效性改进</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">LoginEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>compress<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">Lists</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ListStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/6 1:49 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFail</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从文件中读取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">LoginFail</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/LoginLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginEventStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 自定义处理函数检测连续登录失败事件</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> warningStream <span class="token operator">=</span> loginEventStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginFailDetectWarning</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    warningStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"login fail detect job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义KeyedProcessFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LoginFailDetectWarning0</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">,</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>    <span class="token comment">// 定义属性，最大连续登录失败次数</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> maxFailTimes<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">LoginFailDetectWarning0</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> maxFailTimes<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>maxFailTimes <span class="token operator">=</span> maxFailTimes<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 定义状态：保存2秒内所有的登录失败事件</span>    <span class="token class-name">ListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginFailEventListState<span class="token punctuation">;</span>    <span class="token comment">// 定义状态：保存注册的定时器时间戳</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> timerTsState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      loginFailEventListState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getListState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"login-fail-list"</span><span class="token punctuation">,</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      timerTsState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"timer-ts"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 判断当前登录事件类型</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token string">"fail"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getLoginState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// 1. 如果是失败事件，添加到列表状态中</span>        loginFailEventListState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 如果没有定时器，注册一个2秒之后的定时器</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> timerTsState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>          <span class="token class-name">Long</span> ts <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>          timerTsState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment">// 2. 如果是登录成功，删除定时器，清空状态，重新开始</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> timerTsState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span>          ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteEventTimeTimer</span><span class="token punctuation">(</span>timerTsState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        loginFailEventListState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        timerTsState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 定时器触发，说明2秒内没有登录成功来，判断ListState中失败的个数</span>      <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginFailEvents <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>loginFailEventListState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Integer</span> failTimes <span class="token operator">=</span> loginFailEvents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> failTimes <span class="token operator">&gt;=</span> maxFailTimes <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// 如果超出设定的最大失败次数，输出报警</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                          loginFailEvents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                          loginFailEvents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>failTimes <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                          <span class="token string">"login fail in 2s for "</span> <span class="token operator">+</span> failTimes <span class="token operator">+</span> <span class="token string">" times"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 清空状态</span>      loginFailEventListState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      timerTsState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义KeyedProcessFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LoginFailDetectWarning</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">,</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义属性，最大连续登录失败次数</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> maxFailTimes<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">LoginFailDetectWarning</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> maxFailTimes<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>maxFailTimes <span class="token operator">=</span> maxFailTimes<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 定义状态：保存2秒内所有的登录失败事件</span>    <span class="token class-name">ListState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginFailEventListState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      loginFailEventListState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getListState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"login-fail-list"</span><span class="token punctuation">,</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 以登录事件作为判断报警的触发条件，不再注册定时器</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 判断当前事件登录状态</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token string">"fail"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getLoginState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// 1. 如果是登录失败，获取状态中之前的登录失败事件，继续判断是否已有失败事件</span>        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> loginFailEventListState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>          <span class="token comment">// 1.1 如果已经有登录失败事件，继续判断时间戳是否在2秒之内</span>          <span class="token comment">// 获取已有的登录失败事件</span>          <span class="token class-name">LoginEvent</span> firstFailEvent <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span><span class="token punctuation">(</span> value<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> firstFailEvent<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment">// 1.1.1 如果在2秒之内，输出报警</span>            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> firstFailEvent<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"login fail 2 times in 2s"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token comment">// 不管报不报警，这次都已处理完毕，直接更新状态</span>          loginFailEventListState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          loginFailEventListState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token comment">// 1.2 如果没有登录失败，直接将当前事件存入ListState</span>          loginFailEventListState<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment">// 2. 如果是登录成功，直接清空状态</span>        loginFailEventListState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">1035</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430842</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430843</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail <span class="token number">2</span> times in <span class="token number">2</span>s'<span class="token punctuation">}</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">1035</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430843</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430844</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail <span class="token number">2</span> times in <span class="token number">2</span>s'<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h4 id="代码3-CEP代码实现"><a href="#代码3-CEP代码实现" class="headerlink" title="代码3-CEP代码实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%813-cep%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">代码3-CEP代码实现</a></h4><ul><li><p>pom依赖</p><p>CEP编程</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>  <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>cep_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">LoginEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span>CEP<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span><span class="token class-name">PatternSelectFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span><span class="token class-name">PatternStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span></span><span class="token class-name">SimpleCondition</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/6 3:41 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFailWithCep</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从文件中读取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">LoginFail</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/LoginLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginEventStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 定义一个匹配模式</span>    <span class="token comment">// firstFail -&gt; secondFail, within 2s</span>    <span class="token class-name">Pattern</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">,</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginFailPattern <span class="token operator">=</span> <span class="token class-name">Pattern</span>      <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token string">"firstFail"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleCondition</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"fail"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getLoginState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">"secondFail"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleCondition</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"fail"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getLoginState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">within</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 将匹配模式应用到数据流上，得到一个pattern stream</span>    <span class="token class-name">PatternStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> patternStream <span class="token operator">=</span> CEP<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span>loginEventStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loginFailPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 检出符合匹配条件的复杂事件，进行转换处理，得到报警信息</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> warningStream <span class="token operator">=</span> patternStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginFailMatchDetectWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    warningStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"login fail detect with cep job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的PatternSelectFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LoginFailMatchDetectWarning</span> <span class="token keyword">implements</span> <span class="token class-name">PatternSelectFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">,</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">LoginFailWarning</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pattern<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">LoginEvent</span> firstFailEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"firstFail"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">LoginEvent</span> lastFailEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"secondFail"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">(</span>firstFailEvent<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> firstFailEvent<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lastFailEvent<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"login fail 2 times"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">1035</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430842</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430843</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail <span class="token number">2</span> times'<span class="token punctuation">}</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">1035</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430843</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430844</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail <span class="token number">2</span> times'<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h4 id="代码4-CEP利用循环模式优化"><a href="#代码4-CEP利用循环模式优化" class="headerlink" title="代码4-CEP利用循环模式优化"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%814-cep%E5%88%A9%E7%94%A8%E5%BE%AA%E7%8E%AF%E6%A8%A1%E5%BC%8F%E4%BC%98%E5%8C%96">代码4-CEP利用循环模式优化</a></h4><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">LoginEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span>CEP<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span><span class="token class-name">PatternSelectFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span><span class="token class-name">PatternStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span></span><span class="token class-name">SimpleCondition</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/6 3:41 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFailWithCep</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 从文件中读取数据</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">LoginFail</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/LoginLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginEventStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 定义一个匹配模式</span>    <span class="token comment">// firstFail -&gt; secondFail, within 2s</span>    <span class="token class-name">Pattern</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">,</span> <span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> loginFailPattern <span class="token operator">=</span> <span class="token class-name">Pattern</span>      <span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token string">"failEvents"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleCondition</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"fail"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getLoginState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">consecutive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">within</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 将匹配模式应用到数据流上，得到一个pattern stream</span>    <span class="token class-name">PatternStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span></span> patternStream <span class="token operator">=</span> CEP<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span>loginEventStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">LoginEvent</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loginFailPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 检出符合匹配条件的复杂事件，进行转换处理，得到报警信息</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> warningStream <span class="token operator">=</span> patternStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginFailMatchDetectWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    warningStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"login fail detect with cep job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的PatternSelectFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LoginFailMatchDetectWarning</span> <span class="token keyword">implements</span> <span class="token class-name">PatternSelectFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">,</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">LoginFailWarning</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">LoginEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pattern<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">LoginEvent</span> firstFailEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"failEvents"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">LoginEvent</span> lastFailEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"failEvents"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"failEvents"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginFailWarning</span><span class="token punctuation">(</span>firstFailEvent<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> firstFailEvent<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lastFailEvent<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"login fail "</span> <span class="token operator">+</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"failEvents"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" times"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">LoginFailWarning</span><span class="token punctuation">{</span>userId<span class="token operator">=</span><span class="token number">1035</span><span class="token punctuation">,</span> firstFailTime<span class="token operator">=</span><span class="token number">1558430842</span><span class="token punctuation">,</span> lastFailTime<span class="token operator">=</span><span class="token number">1558430844</span><span class="token punctuation">,</span> warningMsg<span class="token operator">=</span>'login fail <span class="token number">3</span> times'<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="14-3-7-订单支付实时监控"><a href="#14-3-7-订单支付实时监控" class="headerlink" title="14.3.7 订单支付实时监控"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1437-%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98%E5%AE%9E%E6%97%B6%E7%9B%91%E6%8E%A7">14.3.7 订单支付实时监控</a></h3><ul><li>基本需求<ul><li>  用户下单之后，应设置订单失效事件，以提高用户支付的意愿，并降低系统风险</li><li>  用户下单后15分钟未支付，则输出监控信息</li></ul></li><li>解决思路<ul><li>  利用CEP库进行事件流的模式匹配，并设定匹配的时间间隔</li><li>  也可以利用状态编程，用process function实现处理逻辑</li></ul></li></ul><h4 id="POJO-5"><a href="#POJO-5" class="headerlink" title="POJO"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=pojo-5">POJO</a></h4><ul><li><p>OrderEvent</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> eventType<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> txId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>OrderResult</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> resultState<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>ReceiptEvent</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">String</span> txId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> payChannel<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码1-CEP代码实现"><a href="#代码1-CEP代码实现" class="headerlink" title="代码1-CEP代码实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%811-cep%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">代码1-CEP代码实现</a></h4><ul><li><p>pom依赖</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>  <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span><span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>cep_$<span class="token punctuation">{</span>scala<span class="token punctuation">.</span>binary<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span>$<span class="token punctuation">{</span>flink<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>java代码</p><p>（实际如果处理超时订单，应该修改对应的数据库数据，好让下次用户再次操作超时订单时失效）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">OrderEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">OrderResult</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span>CEP<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span><span class="token class-name">PatternSelectFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span><span class="token class-name">PatternStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span><span class="token class-name">PatternTimeoutFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span></span><span class="token class-name">SimpleCondition</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">OutputTag</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/6 5:50 AM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderPayTimeout</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取数据并转换成POJO类型</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">OrderPayTimeout</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/OrderLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span> orderEventDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1. 定义一个待时间限制的模式</span>    <span class="token class-name">Pattern</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span> orderPayPattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleCondition</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"create"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">followedBy</span><span class="token punctuation">(</span><span class="token string">"pay"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleCondition</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token annotation punctuation">@Override</span>      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"pay"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">within</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 定义侧输出流标签，用来表示超时事件</span>    <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> orderTimeoutTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"order-timeout"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 将pattern应用到输入数据上，得到pattern stream</span>    <span class="token class-name">PatternStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span> patternStream <span class="token operator">=</span> CEP<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span>orderEventDataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token operator">::</span><span class="token function">getOrderId</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderPayPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4. 调用select方法，实现对匹配复杂事件和超时复杂事件的提取和处理</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> patternStream      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>orderTimeoutTag<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderTimeoutSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderPaySelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"payed normally"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>orderTimeoutTag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"order timeout detect job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的超时事件处理函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OrderTimeoutSelect</span> <span class="token keyword">implements</span> <span class="token class-name">PatternTimeoutFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">OrderResult</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pattern<span class="token punctuation">,</span> <span class="token keyword">long</span> timeoutTimestamp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">Long</span> timeoutOrderId <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderResult</span><span class="token punctuation">(</span>timeoutOrderId<span class="token punctuation">,</span> <span class="token string">"timeout "</span> <span class="token operator">+</span> timeoutTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义的正常匹配事件处理函数</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OrderPaySelect</span> <span class="token keyword">implements</span> <span class="token class-name">PatternSelectFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">OrderResult</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pattern<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token class-name">Long</span> payedOrderId <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"pay"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderResult</span><span class="token punctuation">(</span>payedOrderId<span class="token punctuation">,</span> <span class="token string">"payed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34729</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>timeout<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34767</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'timeout <span class="token number">1558431249000</span>'<span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34766</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34765</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34764</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34763</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34762</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34761</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34760</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34759</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34758</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34757</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>timeout<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34756</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'timeout <span class="token number">1558431213000</span>'<span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34755</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34754</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34753</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34752</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34751</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34750</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34749</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34748</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34747</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34746</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34745</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34744</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34743</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34742</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34741</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34740</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34739</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34738</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34737</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34736</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34735</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34734</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34733</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34732</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34731</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span>payed normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34730</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span><span class="token char">'payed'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码2-ProcessFunction实现"><a href="#代码2-ProcessFunction实现" class="headerlink" title="代码2-ProcessFunction实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%812-processfunction%E5%AE%9E%E7%8E%B0">代码2-ProcessFunction实现</a></h4><p>CEP虽然更加简洁，但是ProcessFunction能控制的细节操作更多。</p><p>CEP还是比较适合事件之间有复杂联系的场景；</p><p>ProcessFunction用来处理每个独立且靠状态就能联系的事件，灵活性更高。</p><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">OrderEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">OrderResult</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">OutputTag</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/6 4:59 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderTimeoutWithoutCep</span> <span class="token punctuation">{</span>  <span class="token comment">// 定义超时事件的侧输出流标签</span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> orderTimeoutTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"order-timeout"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取数据并转换成POJO类型</span>    <span class="token class-name">URL</span> resource <span class="token operator">=</span> <span class="token class-name">OrderPayTimeout</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/OrderLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span> orderEventDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>      <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 定义自定义处理函数，主流输出正常匹配订单事件，侧输出流输出超时报警事件</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> orderEventDataStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token operator">::</span><span class="token function">getOrderId</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderPayMatchDetect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"pay normally"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>orderTimeoutTag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"order timeout detect without cep job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OrderPayMatchDetect</span> <span class="token keyword">extends</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义状态，保存之前点单是否已经来过create、pay的事件</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> isPayedState<span class="token punctuation">;</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> isCreatedState<span class="token punctuation">;</span>    <span class="token comment">// 定义状态，保存定时器时间戳</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> timerTsState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      isPayedState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"is-payed"</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      isCreatedState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"is-created"</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      timerTsState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"timer-ts"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 先获取当前状态</span>      <span class="token class-name">Boolean</span> isPayed <span class="token operator">=</span> isPayedState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Boolean</span> isCreated <span class="token operator">=</span> isCreatedState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">Long</span> timerTs <span class="token operator">=</span> timerTsState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 判断当前事件类型</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"create"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 1. 如果来的是create，要判断是否支付过</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPayed<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">// 1.1 如果已经正常支付，输出正常匹配结果</span>          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderResult</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"payed successfully"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 清空状态，删除定时器</span>          isCreatedState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          isPayedState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          timerTsState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteEventTimeTimer</span><span class="token punctuation">(</span>timerTs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token comment">// 1.2 如果没有支付过，注册15分钟后的定时器，开始等待支付事件</span>          <span class="token class-name">Long</span> ts <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 更新状态</span>          timerTsState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>          isCreatedState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"pay"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 2. 如果来的是pay，要判断是否有下单事件来过</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCreated<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">// 2.1 已经有过下单事件，要继续判断支付的时间戳是否超过15分钟</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span> <span class="token operator">&lt;</span> timerTs<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 2.1.1 在15分钟内，没有超时，正常匹配输出</span>            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderResult</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"payed successfully"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// 2.1.2 已经超时，输出侧输出流报警</span>            ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>orderTimeoutTag<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderResult</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"payed but already timeout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token comment">// 统一清空状态</span>          isCreatedState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          isPayedState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          timerTsState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteEventTimeTimer</span><span class="token punctuation">(</span>timerTs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token comment">// 2.2 没有下单事件，乱序，注册一个定时器，等待下单事件</span>          ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 更新状态</span>          timerTsState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          isPayedState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderResult</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 定时器触发，说明一定有一个事件没来</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isPayedState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 如果pay来了，说明create没来</span>        ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>orderTimeoutTag<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderResult</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"payed but not found created log"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment">// 如果pay没来，支付超时</span>        ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>orderTimeoutTag<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderResult</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 清空状态</span>      isCreatedState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      isPayedState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      timerTsState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34729</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34730</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34731</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34732</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34734</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34733</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34735</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34736</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34746</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34738</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34745</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34741</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34747</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34743</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34737</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34744</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34742</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34739</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34740</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34753</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34749</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34755</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34752</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34748</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34751</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34750</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34761</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34759</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34754</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34758</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34760</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34757</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34762</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34763</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34764</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34765</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>pay normally<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34766</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed successfully'<span class="token punctuation">}</span>timeout<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34767</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed but already timeout'<span class="token punctuation">}</span>timeout<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34768</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'payed but not found created log'<span class="token punctuation">}</span>timeout<span class="token operator">&gt;</span> <span class="token class-name">OrderResult</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34756</span><span class="token punctuation">,</span> resultState<span class="token operator">=</span>'timeout'<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="14-3-8-订单支付实时对帐"><a href="#14-3-8-订单支付实时对帐" class="headerlink" title="14.3.8 订单支付实时对帐"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1438-%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98%E5%AE%9E%E6%97%B6%E5%AF%B9%E5%B8%90">14.3.8 订单支付实时对帐</a></h3><ul><li>基本需求<ul><li>  用户下单并支付之后，应查询到账信息，进行实时对帐</li><li>  如果有不匹配的支付信息或者到账信息，输出提示信息</li></ul></li><li>解决思路<ul><li>  从两条流中分别读取订单支付信息和到账信息，合并处理</li><li>  用connect连接合并两条流，用coProcessFunction做匹配处理</li></ul></li></ul><h4 id="POJO-6"><a href="#POJO-6" class="headerlink" title="POJO"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=pojo-6">POJO</a></h4><ul><li><p>ReceiptEvent</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">String</span> txId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> payChannel<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码1-具体实现"><a href="#代码1-具体实现" class="headerlink" title="代码1-具体实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%811-%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0">代码1-具体实现</a></h4><ul><li><p>java代码实现</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">OrderEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span></span><span class="token class-name">CoProcessFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">OutputTag</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/6 5:34 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TxPayMatch</span> <span class="token punctuation">{</span>  <span class="token comment">// 定义侧输出流标签</span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span> unmatchedPays <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"unmatched-pays"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span></span> unmatchedReceipts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"unmatched-receipts"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取数据并转换成POJO类型</span>    <span class="token comment">// 读取订单支付事件数据</span>    <span class="token class-name">URL</span> orderResource <span class="token operator">=</span> <span class="token class-name">TxPayMatch</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/OrderLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span> orderEventStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>orderResource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// 交易id不为空，必须是pay事件</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getTxId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取到账事件数据</span>    <span class="token class-name">URL</span> receiptResource <span class="token operator">=</span> <span class="token class-name">TxPayMatch</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/ReceiptLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span></span> receiptEventStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>receiptResource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">ReceiptEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将两条流进行连接合并，进行匹配处理，不匹配的事件输出到侧输出流</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> orderEventStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token operator">::</span><span class="token function">getTxId</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>receiptEventStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">ReceiptEvent</span><span class="token operator">::</span><span class="token function">getTxId</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TxPayMatchDetect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"matched-pays"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>unmatchedPays<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"unmatched-pays"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>unmatchedReceipts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"unmatched-receipts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"tx match detect job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义CoProcessFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TxPayMatchDetect</span> <span class="token keyword">extends</span> <span class="token class-name">CoProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">// 定义状态，保存当前已经到来的订单支付事件和到账时间</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span> payState<span class="token punctuation">;</span>    <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span></span> receiptState<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      payState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"pay"</span><span class="token punctuation">,</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      receiptState <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"receipt"</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement1</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> pay<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 订单支付事件来了，判断是否已经有对应的到账事件</span>      <span class="token class-name">ReceiptEvent</span> receipt <span class="token operator">=</span> receiptState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> receipt <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// 如果receipt不为空，说明到账事件已经来过，输出匹配事件，清空状态</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pay<span class="token punctuation">,</span> receipt<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        payState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        receiptState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment">// 如果receipt没来，注册一个定时器，开始等待</span>        ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>pay<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 等待5秒钟，具体要看数据</span>        <span class="token comment">// 更新状态</span>        payState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>pay<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement2</span><span class="token punctuation">(</span><span class="token class-name">ReceiptEvent</span> receipt<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 到账事件来了，判断是否已经有对应的支付事件</span>      <span class="token class-name">OrderEvent</span> pay <span class="token operator">=</span> payState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> pay <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment">// 如果pay不为空，说明支付事件已经来过，输出匹配事件，清空状态</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pay<span class="token punctuation">,</span> receipt<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>        payState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        receiptState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment">// 如果pay没来，注册一个定时器，开始等待</span>        ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>receipt<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 等待3秒钟，具体要看数据</span>        <span class="token comment">// 更新状态</span>        receiptState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>receipt<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">OnTimerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      <span class="token comment">// 定时器触发，有可能是有一个事件没来，不匹配，也有可能是都来过了，已经输出并清空状态</span>      <span class="token comment">// 判断哪个不为空，那么另一个就没来</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> payState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>unmatchedPays<span class="token punctuation">,</span> payState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> receiptState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>unmatchedReceipts<span class="token punctuation">,</span> receiptState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token comment">// 清空状态</span>      payState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      receiptState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34729</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'sd76f87d6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430844</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'sd76f87d6'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430847</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34730</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">3</span>hu3k2432'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430845</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">3</span>hu3k2432'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430848</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34732</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">32</span>h3h4b4t'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430861</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">32</span>h3h4b4t'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430852</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34733</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">766l</span>k5nk4'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430864</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">766l</span>k5nk4'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430855</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34734</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">435</span>kjb45d'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430863</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">435</span>kjb45d'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430859</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34735</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">5</span>k432k4n'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430869</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">5</span>k432k4n'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430862</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34736</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">435</span>kjb45s'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430875</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">435</span>kjb45s'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430866</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34738</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">43</span>jhin3k4'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430896</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">43</span>jhin3k4'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430871</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34741</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">88d</span>f0wn92'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430896</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">88d</span>f0wn92'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430882</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34737</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">324</span>jnd45s'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430902</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">324</span>jnd45s'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430868</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34743</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">3</span>hefw8jf'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430900</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">3</span>hefw8jf'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430885</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34744</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">499d</span>fano2'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430903</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">499d</span>fano2'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430886</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34742</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">435</span>kjb4432'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430906</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">435</span>kjb4432'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430884</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34745</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">8</span>xz09ddsaf'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430896</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">8</span>xz09ddsaf'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430889</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34739</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">98</span>x0f8asd'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430907</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">98</span>x0f8asd'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430874</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34746</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">3243</span>hr9h9'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430895</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">3243</span>hr9h9'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430892</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34740</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">392094</span>j32'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430913</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">392094</span>j32'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430877</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34747</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">329d</span><span class="token number">09f</span><span class="token number">9f</span>'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430893</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">329d</span><span class="token number">09f</span><span class="token number">9f</span>'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430893</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34749</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">324</span>n0239'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430916</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">324</span>n0239'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430899</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34748</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">809</span>saf0ff'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430934</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">809</span>saf0ff'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430895</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34752</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'rnp435rk'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430925</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'rnp435rk'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430905</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34751</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">24309d</span>sf'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430941</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">24309d</span>sf'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430902</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34753</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">8</span>c6vs8dd'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430913</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">8</span>c6vs8dd'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430906</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34750</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'sad90df3'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430941</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'sad90df3'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430901</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34755</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">8</span>x0zvy8w3'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430918</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">8</span>x0zvy8w3'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430911</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34754</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">3245</span>nbo7'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430950</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">3245</span>nbo7'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430908</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34758</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">32499f</span>d9w'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430950</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">32499f</span>d9w'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430921</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34759</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">9203</span>kmfn'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430950</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">9203</span>kmfn'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430922</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34760</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">390</span>mf2398'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430960</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">390</span>mf2398'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430926</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34757</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'d8938034'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430962</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'d8938034'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430915</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34761</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">902d</span>sqw45'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430943</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">902d</span>sqw45'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430927</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34762</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">84309d</span>w31r'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430983</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">84309d</span>w31r'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430933</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34763</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'sddf9809ew'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558431068</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'sddf9809ew'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430936</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34764</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">832</span>jksmd9'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558431079</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">832</span>jksmd9'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430938</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34765</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'m23sare32e'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558431082</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'m23sare32e'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430940</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34766</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">92</span>nr903msa'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558431095</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">92</span>nr903msa'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430944</span><span class="token punctuation">}</span><span class="token punctuation">)</span>matched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34767</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'sdafen9932'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558432021</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'sdafen9932'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430949</span><span class="token punctuation">}</span><span class="token punctuation">)</span>unmatched<span class="token operator">-</span>receipts<span class="token operator">&gt;</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'ewr342as4'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430845</span><span class="token punctuation">}</span>unmatched<span class="token operator">-</span>receipts<span class="token operator">&gt;</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">8f</span>dsfae83'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430850</span><span class="token punctuation">}</span>unmatched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34731</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">35</span>jue34we'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430849</span><span class="token punctuation">}</span>unmatched<span class="token operator">-</span>receipts<span class="token operator">&gt;</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">9032</span>n4fd2'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430913</span><span class="token punctuation">}</span>unmatched<span class="token operator">-</span>pays<span class="token operator">&gt;</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34768</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">88</span>snrn932'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430950</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="代码2-Join实现"><a href="#代码2-Join实现" class="headerlink" title="代码2-Join实现"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%BB%A3%E7%A0%812-join%E5%AE%9E%E7%8E%B0">代码2-Join实现</a></h4><p><strong>这种方法的缺陷，只能获得正常匹配的结果，不能获得未匹配成功的记录。</strong> </p><ul><li><p>java代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">OrderEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">beans<span class="token punctuation">.</span></span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TimeCharacteristic</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span></span><span class="token class-name">ProcessJoinFunction</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">AscendingTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span><span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarksAdapter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span><span class="token comment">/** * @author : Ashiamd email: ashiamd@foxmail.com * @date : 2021/2/6 7:55 PM */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TxPayMatchByJoin</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取数据并转换成POJO类型</span>    <span class="token comment">// 读取订单支付事件数据</span>    <span class="token class-name">URL</span> orderResource <span class="token operator">=</span> <span class="token class-name">TxPayMatch</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/OrderLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span> orderEventStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>orderResource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// 交易id不为空，必须是pay事件</span>      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getTxId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取到账事件数据</span>    <span class="token class-name">URL</span> receiptResource <span class="token operator">=</span> <span class="token class-name">TxPayMatch</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/ReceiptLog.csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span></span> receiptEventStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>receiptResource<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarksAdapter<span class="token punctuation">.</span>Strategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">ReceiptEvent</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> element<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 区间连接两条流，得到匹配的数据</span>    <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> orderEventStream      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token operator">::</span><span class="token function">getTxId</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">intervalJoin</span><span class="token punctuation">(</span>receiptEventStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">ReceiptEvent</span><span class="token operator">::</span><span class="token function">getTxId</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// -3，5 区间范围</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TxPayMatchDetectByJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"tx pay match by join job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// 实现自定义ProcessJoinFunction</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TxPayMatchDetectByJoin</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessJoinFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span> left<span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span> right<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderEvent</span><span class="token punctuation">,</span> <span class="token class-name">ReceiptEvent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>输出</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34729</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'sd76f87d6'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430844</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'sd76f87d6'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430847</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34730</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">3</span>hu3k2432'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430845</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">3</span>hu3k2432'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430848</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34746</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">3243</span>hr9h9'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430895</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">3243</span>hr9h9'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'wechat'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430892</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">OrderEvent</span><span class="token punctuation">{</span>orderId<span class="token operator">=</span><span class="token number">34747</span><span class="token punctuation">,</span> eventType<span class="token operator">=</span><span class="token char">'pay'</span><span class="token punctuation">,</span> txId<span class="token operator">=</span>'<span class="token number">329d</span><span class="token number">09f</span><span class="token number">9f</span>'<span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430893</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">ReceiptEvent</span><span class="token punctuation">{</span>txId<span class="token operator">=</span>'<span class="token number">329d</span><span class="token number">09f</span><span class="token number">9f</span>'<span class="token punctuation">,</span> payChannel<span class="token operator">=</span><span class="token char">'alipay'</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span><span class="token number">1558430893</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><blockquote><p><a href="https://zhuanlan.zhihu.com/p/43448829">Flink-复杂事件（CEP）</a></p><p><a href="https://blog.csdn.net/qq_37135484/article/details/106327567">Flink之CEP(复杂时间处理)</a></p></blockquote><h2 id="15-1-基本概念"><a href="#15-1-基本概念" class="headerlink" title="15.1 基本概念"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_151-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">15.1 基本概念</a></h2><h3 id="15-1-1-什么是CEP"><a href="#15-1-1-什么是CEP" class="headerlink" title="15.1.1 什么是CEP"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1511-%E4%BB%80%E4%B9%88%E6%98%AFcep">15.1.1 什么是CEP</a></h3><ul><li><p>  复杂事件处理（Complex Event Processing，CEP）</p></li><li><p>  Flink CEP是在Flink中实现的复杂事件处理（CEP）库</p></li><li><p>  CEP允许在<strong>无休止的事件流</strong>中检测事件模式，让我们有机会掌握数据中重要的部分</p></li><li><p>  <strong>一个或多个由简单事件构成的事件流通过一定的规则匹配，然后输出用户想得到的数据——满足规则的复杂事件</strong></p></li></ul><h3 id="15-1-2-CEP特点"><a href="#15-1-2-CEP特点" class="headerlink" title="15.1.2 CEP特点"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1512-cep%E7%89%B9%E7%82%B9">15.1.2 CEP特点</a></h3><p><img src="https://pic1.zhimg.com/80/v2-1c7057bda8a3ba077a3b8059f35d9bc4_1440w.jpg"></p><ul><li><p>  目标：从有序的简单事件流中发现一些高阶特征</p></li><li><p>  输入：一个或多个由简单事件构成的事件流</p></li><li><p>  处理：识别简单事件之间的内在联系，多个符合一定规则的简单事件构成复杂事件</p></li><li><p>  输出：满足规则的复杂事件</p></li></ul><h2 id="15-2-Pattern-API"><a href="#15-2-Pattern-API" class="headerlink" title="15.2 Pattern API"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_152-pattern-api">15.2 Pattern API</a></h2><ul><li><p>处理事件的规则，被叫做”模式”（Pattern）</p></li><li><p>Flink CEP提供了Pattern API，用于对输入流数据进行复杂事件规则定义，用来提取符合规则的时间序列</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> input <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// 定义一个Pattern</span><span class="token class-name">Pattern</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">"middle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtype</span><span class="token punctuation">(</span><span class="token class-name">SubEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">followedBy</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将创建好的Pattern应用到输入事件流上</span><span class="token class-name">PatternStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> patternStream <span class="token operator">=</span> CEP<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 检出匹配事件序列，处理得到结果</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Alert</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> patternStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="个体模式-Individual-Patterns"><a href="#个体模式-Individual-Patterns" class="headerlink" title="个体模式(Individual Patterns)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E4%B8%AA%E4%BD%93%E6%A8%A1%E5%BC%8Findividual-patterns">个体模式(Individual Patterns)</a></h3><ul><li><p>组成复杂规则的每一个单独的模式定义,就是”个体模式”</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">start<span class="token punctuation">.</span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleCondition</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>个体模式可以包括”单例(singleton)模式”和”循环(looping)模式”</p></li><li><p>单例模式只接收一个事件，而循环模式可以接收多个</p></li></ul><hr><ul><li><p>量词（Quantifier）</p><p>可以在一个个体模式后追加量词，也就是指定循环次数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//匹配出现4次</span>start<span class="token punctuation">.</span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">//匹配出现2/3/4次</span>start<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>greedy<span class="token comment">//匹配出现0或者4次</span>start<span class="token punctuation">.</span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>optional<span class="token comment">//匹配出现1次或者多次</span>start<span class="token punctuation">.</span>oneOrMore<span class="token comment">//匹配出现2,3,4次</span>start<span class="token punctuation">.</span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">//匹配出现0次,2次或者多次,并且尽可能多的重复匹配</span>start<span class="token punctuation">.</span><span class="token function">timesOrMore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>optional<span class="token punctuation">.</span>greedy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>条件（Condition）</p><ul><li><p><strong>每个模式都需要指定触发条件</strong>，作为模式是否接受事件进入的判断依据</p></li><li><p>CEP中的个体模式主要通过调用<code>.where()</code>，<code>.or()</code>和<code>.until()</code>来指定条件</p></li><li><p>按不同的调用方式，可以分成以下几类</p><ul><li><p>简单条件（Simple Condition）</p><p>通过<code>.where()</code>方法对事件中的字段进行判断筛选，决定是否接受该事件</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">start<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleCondition</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Event</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> value<span class="token punctuation">.</span>getName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>组合条件（Combining Condition）</p><p>将简单条件进行合并；<code>.or()</code>方法表示或逻辑相连，where的直接组合就是AND</p><p><code>pattern.where(event =&gt; ... /* some condition */).or(event =&gt; ... /* or condition */)</code></p></li><li><p>终止条件（Stop Condition）</p><p>如果使用了<code>oneOrMore</code>或者<code>oneOrMore.optional</code>，建议使用<code>.until()</code>作为终止条件，以便清理状态</p></li><li><p>迭代条件（Iterative Condition）</p><p>能够对模式之前所有接收的事件进行处理</p><p>可以调用<code>ctx.getEventsForPattern("name")</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IterativeCondition</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li></ul></li></ul><h3 id="组合模式-Combining-Patterns"><a href="#组合模式-Combining-Patterns" class="headerlink" title="组合模式(Combining Patterns)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8Fcombining-patterns">组合模式(Combining Patterns)</a></h3><p>组合模式(Combining Patterns)也叫模式序列。</p><ul><li><p>很多个体模式组合起来，就形成了整个的模式序列</p></li><li><p>模式序列必须以一个”初始模式”开始</p><pre class="line-numbers language-none"><code class="language-none">Pattern&lt;Event, Event&gt; start = Pattern.&lt;Event&gt;begin("start")<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p><img src="https://img-blog.csdnimg.cn/20200526221919332.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3MTM1NDg0,size_16,color_FFFFFF,t_70"></p><ul><li><p>严格近邻(Strict Contiguity)</p><ul><li>  <strong>所有事件按照严格的顺序出现</strong>，中间没有任何不匹配的事件，由<code>.next()</code>指定</li><li>  例如对于模式”a next b”,事件序列[a,c,b1,b2]没有匹配</li></ul></li><li><p>宽松近邻(Relaxed Contiguity)</p><ul><li>  允许中间出现不匹配的事件,由<code>.followedBy()</code>指定</li><li>  例如对于模式”a followedBy b”,事件序列[a,c,b1,b2]匹配为[a,b1]</li></ul></li><li><p>非确定性宽松近邻(Non-Deterministic Relaxed Contiguity)</p><ul><li>  进一步放宽条件,之前已经匹配过的事件也可以再次使用，由<code>.followByAny()</code>指定</li><li>  例如对于模式”a followedAny b”,事件序列[a,c,b1,b2]匹配为{a,b1},{a,b2}</li></ul></li><li><p>除了以上模式序列外,还可以定义”不希望出现某种近邻关系”:</p><ul><li><p><code>.notNext()</code> 不严格近邻</p></li><li><p><code>.notFollowedBy()</code>不在两个事件之间发生</p><p>（eg，a not FollowedBy c，a Followed By b，a希望之后出现b，且不希望ab之间出现c）</p></li></ul></li><li><p>需要注意：</p><ul><li><p><strong>所有模式序列必须以<code>.begin()</code>开始</strong></p></li><li><p><strong>模式序列不能以<code>.notFollowedBy()</code>结束</strong></p></li><li><p><strong>“not “类型的模式不能被optional 所修饰</strong></p></li><li><p>此外,还可以为模式指定事件约束，用来要求在多长时间内匹配有效:</p><p><code>next.within(Time.seconds(10))</code></p></li></ul></li></ul><h3 id="模式组-Groups-of-patterns"><a href="#模式组-Groups-of-patterns" class="headerlink" title="模式组(Groups of patterns)"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=%E6%A8%A1%E5%BC%8F%E7%BB%84groups-of-patterns">模式组(Groups of patterns)</a></h3><ul><li>  将一个模式序列作为条件嵌套在个体模式里，成为一组模式</li></ul><h2 id="15-3-模式的检测"><a href="#15-3-模式的检测" class="headerlink" title="15.3 模式的检测"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_153-%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%A3%80%E6%B5%8B">15.3 模式的检测</a></h2><ul><li><p>指定要查找的模式序列后，就可以将其应用于输入流以检测潜在匹配</p></li><li><p>调用<code>CEP.pattern()</code>，给定输入流和模式，就能得到一个PatternStream</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> input <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">Pattern</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">PatternStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> patternStream <span class="token operator">=</span> CEP<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="15-4-匹配事件的提取"><a href="#15-4-匹配事件的提取" class="headerlink" title="15.4 匹配事件的提取"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_154-%E5%8C%B9%E9%85%8D%E4%BA%8B%E4%BB%B6%E7%9A%84%E6%8F%90%E5%8F%96">15.4 匹配事件的提取</a></h2><ul><li><p>创建PatternStrean之后，就可以应用select或者flatselect方法，从检测到的事件序列中提取事件了</p></li><li><p><code>select()</code>方法需要输入一个select function作为参数,每个成功匹配的事件序列都会调用它</p></li><li><p><code>select()</code> 以一个Map&lt;String，List&lt;IN]&gt;&gt; 来接收匹配到的事件序列，其中Key就是每个模式的名称，而value就是所有接收到的事件的List类型</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">OUT</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pattern<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>  <span class="token class-name">IN</span> startEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">IN</span> endEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">OUT</span><span class="token punctuation">(</span>startEvent<span class="token punctuation">,</span> endEvent<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="15-4-超时事件的提取"><a href="#15-4-超时事件的提取" class="headerlink" title="15.4 超时事件的提取"></a><a href="#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_154-%E8%B6%85%E6%97%B6%E4%BA%8B%E4%BB%B6%E7%9A%84%E6%8F%90%E5%8F%96">15.4 超时事件的提取</a></h2><ul><li><p><strong>当一个模式通过within关键字定义了检测窗口时间时，部分事件序列可能因为超过窗口长度而被丢弃；为了能够处理这些超时的部分匹配，select和flatSelect API调用允许指定超时处理程序</strong></p></li><li><p><strong>超时处理程序会接收到目前为止由模式匹配到的所有事件，由一个OutputTag定义接收到的超时事件序列</strong></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PatternStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> patternStream <span class="token operator">=</span> CEP<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> outputTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"side-output"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComplexEvent</span><span class="token punctuation">&gt;</span></span> flatResult <span class="token operator">=</span>   patternStream<span class="token punctuation">.</span><span class="token function">flatSelect</span><span class="token punctuation">(</span>  outputTag<span class="token punctuation">,</span>  <span class="token keyword">new</span> <span class="token class-name">PatternFlatTimeoutFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token keyword">new</span> <span class="token class-name">PatternFlatSelectFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">ComplexEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TimeoutEvent</span><span class="token punctuation">&gt;</span></span> timeoutFlatResult <span class="token operator">=</span>   flatResult<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> 大数据 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flink </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/03/03/hello-world/"/>
      <url>/2022/03/03/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
